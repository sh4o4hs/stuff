import e from"mithril";import*as t from"nuts";import{d as a,r as n,a as o,h as r,M as i,o as s,O as c}from"./agent.f0097e82.js";import{b as d,c as l,h as p,f as m,C as g,g as y}from"./agent.782564cd.js";import{C as u,a as O}from"./agent.81baa7c2.js";import{getGameEvent as f}from"./agent.a3dacac3.js";import"localforage";let E=null,N={INIT:"init",CONNECT:"connect",LOGIN:"login",INGAME:"ingame",TOGAME:"togame",REGISTER:"register",ON_REFRESH:"onrefresh",ON_MESSAGE:"onmessage",ON_ERROR:"onerror",ON_BROADCAST:"onbroadcast",ON_CLOSE:"onclose",ON_TOGAME:"ontogame"},R={},T={async connect(e,t){E&&(t&&(R=t),await E.postMessage({type:N.CONNECT,config:e}))},async login(e){if(E){return await E.postMessage({type:N.LOGIN,info:e})}},async ingame(e){if(E){return await E.postMessage({type:N.INGAME,info:e})}},async togame(e){if(E){return await E.postMessage({type:N.TOGAME,info:e})}},async register(e){if(E){return await E.postMessage({type:N.REGISTER,config:e})}}};function A(e){if(!Array.isArray(e.data)){let t=e.data;switch(t.type){case N.ON_REFRESH:return void t.offsetTime;case N.ON_CLOSE:return void(R.onclose&&R.onclose());case N.ON_ERROR:return void(R.onerror&&R.onerror(t.data));case N.ON_MESSAGE:return void(R.onmessage&&R.onmessage(t.data));case N.ON_BROADCAST:return void(R.onbroadcast&&R.onbroadcast(t.data));case N.ON_TOGAME:return void(R.ontogame&&R.ontogame(t.data))}}}var h={nested:{Game:{nested:{Share:{nested:{ActionType:{values:{NULL:0}},CheckAction:{fields:{actionType:{type:"ActionType",id:1}},reserved:[[2,2]]},Jackpot:{nested:{ActionType:{values:{NORMAL:0}},BaseResponse:{fields:{actionType:{type:"ActionType",id:1},mJpOutIdx:{type:"uint32",id:3},mJpOutValue:{type:"uint64",id:4},mJpValue:{rule:"repeated",type:"uint64",id:5},resultCode:{type:"uint32",id:6}},reserved:[[2,2]]}}},Setting:{nested:{ActionType:{values:{NORMAL:0}},BaseResponse:{fields:{actionType:{type:"ActionType",id:1},betForm:{rule:"repeated",type:"uint32",id:3},betFormIndex:{type:"uint32",id:4},decimalPosition:{type:"uint32",id:5},enableJP:{type:"bool",id:6},isDemo:{type:"bool",id:7},lastBet:{type:"uint32",id:8},lineAmount:{type:"uint32",id:9}},reserved:[[2,2]]}}},Info:{nested:{ActionType:{values:{NORMAL:0}},BaseResponse:{fields:{actionType:{type:"ActionType",id:1},aPIVersion:{type:"string",id:3},chanceVersion:{type:"string",id:4},libVersion:{type:"string",id:5},packageVersion:{type:"string",id:6},slotServerVersion:{type:"string",id:7}},reserved:[[2,2]]}}}}}}}}};const v={ERROR:0,OK:1},b={SEND_LOCK:-3,CONNECT_TIMEOUT:-2,BUFFER_FULL:-1,ERROR:0,OK:1,LOGIN:3,ROOM:4,CONNECT:2};let M=!1,L=!0;function w(){if(r.state="未連線",o.isInGame&&globalThis.scene){Object.getOwnPropertyNames(globalThis.scene).forEach((e=>{let t=globalThis.scene[e];t&&t.game&&t.game.disconnect&&t.game.disconnect()}))}if(M)return;s[c.GAME_DIALOG_CUSTOM]&&(r.isError||t.updateManager.setTimeout((()=>{r.isError||d({title:"errorLow",msg:"disconnect"})}),2))}function G(e){if(M)return;s[c.GAME_DIALOG_CUSTOM]&&t.updateManager.setTimeout((()=>{r.isError||d({title:"errorLow",msg:`[agent onerror] ${e}`})}),.5)}function S(e){}function C(e,t){let a=b.OK;return e?(e.resultCode!==v.OK?(a=b.ERROR,t&&t.error&&t.error(e)):t&&t.handle&&t.handle(e),a):(a=b.ERROR,a)}function I(e){if(L&&(L=!1),e&&e.gid){let t=f()[e.gid];t&&t.recvGameData&&t.recvGameData(e.packet)}}function _(e){O.handle(e);let t=f();Object.getOwnPropertyNames(t).forEach((a=>{let n=t[a];if(n&&n.recvBroadcast){let t=JSON.stringify(e);n.recvBroadcast(t)}}))}let B=null;async function k(e){await async function(e){let t=!1;const{getProject:n}=await import("./agent.94fe222a.js");let o=await n("lib/abcd",{mode:"blob"}),r=new Worker(o.blobURL);r.addEventListener("message",A),E=new a.PromiseWorker(r),e.root=o.root,e.pathname=o.pathname;try{await E.postMessage({type:N.INIT,config:e}),t=!0}catch(e){}return t}(e),B=T}async function j(e){let t={ontogame:I,onclose:w,onerror:G,onbroadcast:_,onmessage:S},a=r;a.state="連線中",await B.connect(e,t),a.state="已連線"}async function D(t){try{n.serviceBegin(u.report);let a=o,i=r;i.state="登入中";let s=await B.login(t);return C(s)?(i.isLogin=!0,i.state="登入成功",globalThis.lobby.currentUser=s.userInfo,l&&p(),e.redraw(),n.serviceEnd(u.report),n.log({label:"net",category:"登入"}),a.isManual||m(),s):(i.state="登入失敗",void d({title:"errorLow",msg:"disconnect"}))}catch(e){}}async function P(e){let t=y();try{n.serviceBegin(g.report);let a=r;a.state="進入遊戲";let s=await B.ingame(e);if(!C(s))return a.state="進入遊戲失敗",void d({title:"errorLow",msg:"disconnect"});a.state="遊戲中",p(),n.serviceEnd(g.report),n.log({label:"net",category:"進入遊戲"});let c=o;if(c.module){let e=i;if("p"===c.module[e.PROTOCOL]){let e={gid:s.gid,schema:h,checkName:"Game.Share.CheckAction",fields:[{name:"info",rootName:"Game.Share.Info",typeName:"ActionType",cmdList:["BaseResponse"]},{name:"jackpot",rootName:"Game.Share.Jackpot",typeName:"ActionType",cmdList:["BaseResponse"]},{name:"setting",rootName:"Game.Share.Setting",typeName:"ActionType",cmdList:["BaseResponse"]}]};await B.register(e)}}let l={id:s.gid},m=t.scene[l.id];m&&m.localEvent&&(m.localEvent.enter(l),M=!0)}catch(e){}}async function U(e){try{let t=await B.togame(e);return L&&(L=!1),t&&t.packet}catch(e){}}async function F(e){return await B.register(e)}export{v as RESULT,b as STATE,j as connect,P as ingame,k as init,D as login,F as register,U as togame};
