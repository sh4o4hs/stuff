import{b as e,f as t,g as a,m as n,i as o,C as r,j as s}from"./agent.c4717384.js";import{u as i}from"./agent.b38a3088.js";import{s as c,b as l,M as d,o as p,O as g}from"./agent.c55f3b95.js";import{C as u,n as m,c as f,a as y}from"./agent.56e0e82e.js";import{r as O}from"./agent.e16c05fc.js";import{getGameEvent as E}from"./agent.7712a682.js";import"./agent.bb55f172.js";var v=0;function R(e,t){var a=t.data;if(Array.isArray(a)&&!(a.length<2)){var n=a[0],o=a[1],r=a[2],s=e._callbacks[n];s&&(delete e._callbacks[n],s(o,r))}}function N(e){var t=this;t._worker=e,t._callbacks={},e.addEventListener("message",(function(e){R(t,e)}))}N.prototype.postMessage=function(e){var t=this,a=v++,n=[a,e];return new Promise((function(e,o){if(t._callbacks[a]=function(t,a){if(t)return o(new Error(t.message));e(a)},void 0!==t._worker.controller){var r=new MessageChannel;r.port1.onmessage=function(e){R(t,e)},t._worker.controller.postMessage(n,[r.port2])}else t._worker.postMessage(n)}))};var T=N;let h=null,w={INIT:"init",CONNECT:"connect",LOGIN:"login",INGAME:"ingame",TOGAME:"togame",REGISTER:"register",ON_REFRESH:"onrefresh",ON_MESSAGE:"onmessage",ON_ERROR:"onerror",ON_BROADCAST:"onbroadcast",ON_CLOSE:"onclose",ON_TOGAME:"ontogame"},A={},b={async connect(e,t){h&&(t&&(A=t),await h.postMessage({type:w.CONNECT,config:e}))},async login(e){if(h){const t=(await import("./agent.25a3dda8.js").then((function(e){return e.f}))).default;let a=(await t.getPromise({excludes:{webglVendorAndRenderer:!0,language:!0,canvas:!0,hasLiedOs:!0,hasLiedBrowser:!0,availableScreenResolution:!0,webdriver:!0,deviceMemory:!0,hardwareConcurrency:!0,timezoneOffset:!0,timezone:!0,sessionStorage:!0,localStorage:!0,indexedDb:!0,addBehavior:!0,openDatabase:!0,cpuClass:!0,platform:!0,doNotTrack:!0,plugins:!0,adBlock:!0,hasLiedLanguages:!0,hasLiedResolution:!0,fonts:!0,fontsFlash:!0,audio:!0,enumerateDevices:!0}})).map((function(e){return e.value})),n=t.x64hash128(a.join(""),31);return e.fingerprint=n,await h.postMessage({type:w.LOGIN,info:e})}},async ingame(e){if(h){return await h.postMessage({type:w.INGAME,info:e})}},async togame(e){if(h){return await h.postMessage({type:w.TOGAME,info:e})}},async register(e){if(h){return await h.postMessage({type:w.REGISTER,config:e})}}};function L(e){if(!Array.isArray(e.data)){let t=e.data;switch(t.type){case w.ON_REFRESH:return void t.offsetTime;case w.ON_CLOSE:return void(A.onclose&&A.onclose());case w.ON_ERROR:return void(A.onerror&&A.onerror(t.data));case w.ON_MESSAGE:return void(A.onmessage&&A.onmessage(t.data));case w.ON_BROADCAST:return void(A.onbroadcast&&A.onbroadcast(t.data));case w.ON_TOGAME:return void(A.ontogame&&A.ontogame(t.data))}}}var M={nested:{Game:{nested:{Share:{nested:{ActionType:{values:{NULL:0}},CheckAction:{fields:{actionType:{type:"ActionType",id:1}},reserved:[[2,2]]},Jackpot:{nested:{ActionType:{values:{NORMAL:0}},BaseResponse:{fields:{actionType:{type:"ActionType",id:1},mJpOutIdx:{type:"uint32",id:3},mJpOutValue:{type:"uint64",id:4},mJpValue:{rule:"repeated",type:"uint64",id:5},resultCode:{type:"uint32",id:6}},reserved:[[2,2]]}}},Setting:{nested:{ActionType:{values:{NORMAL:0}},BaseResponse:{fields:{actionType:{type:"ActionType",id:1},betForm:{rule:"repeated",type:"uint32",id:3},betFormIndex:{type:"uint32",id:4},decimalPosition:{type:"uint32",id:5},enableJP:{type:"bool",id:6},isDemo:{type:"bool",id:7},lastBet:{type:"uint32",id:8},lineAmount:{type:"uint32",id:9}},reserved:[[2,2]]}}},Info:{nested:{ActionType:{values:{NORMAL:0}},BaseResponse:{fields:{actionType:{type:"ActionType",id:1},aPIVersion:{type:"string",id:3},chanceVersion:{type:"string",id:4},libVersion:{type:"string",id:5},packageVersion:{type:"string",id:6},slotServerVersion:{type:"string",id:7}},reserved:[[2,2]]}}}}}}}}};const S={ERROR:0,OK:1},_={SEND_LOCK:-3,CONNECT_TIMEOUT:-2,BUFFER_FULL:-1,ERROR:0,OK:1,LOGIN:3,ROOM:4,CONNECT:2};let C=!1,G=!0;function I(){if(l.state="未連線",c.isInGame&&globalThis.scene){Object.getOwnPropertyNames(globalThis.scene).forEach((e=>{let t=globalThis.scene[e];t&&t.game&&t.game.disconnect&&t.game.disconnect()}))}if(C)return;p[g.GAME_DIALOG_CUSTOM]&&(l.isError||i.setTimeout((()=>{l.isError||e({title:"errorLow",msg:"disconnect"})}),2))}function k(t){if(C)return;p[g.GAME_DIALOG_CUSTOM]&&i.setTimeout((()=>{l.isError||e({title:"errorLow",msg:`[agent onerror] ${t}`})}),.5)}function B(e){}function j(e,t){let a=_.OK;return e?(e.resultCode!==S.OK?(a=_.ERROR,t&&t.error&&t.error(e)):t&&t.handle&&t.handle(e),a):(a=_.ERROR,a)}function D(e){if(G&&(G=!1),e&&e.gid){let t=E()[e.gid];t&&t.recvGameData&&t.recvGameData(e.packet)}}function P(e){y.handle(e);let t=E();Object.getOwnPropertyNames(t).forEach((a=>{let n=t[a];if(n&&n.recvBroadcast){let t=JSON.stringify(e);n.recvBroadcast(t)}}))}let F=null;async function U(e){await async function(e){let t=!1;const{getProject:a}=await import("./agent.4852d766.js");let n=await a("lib/abcd",{mode:"blob"}),o=new Worker(n.blobURL);o.addEventListener("message",L),h=new T(o),e.root=n.root,e.pathname=n.pathname;try{await h.postMessage({type:w.INIT,config:e}),t=!0}catch(e){}return t}(e),F=b}async function V(e){let t={ontogame:D,onclose:I,onerror:k,onbroadcast:P,onmessage:B},a=l;a.state="連線中",await F.connect(e,t),a.state="已連線"}async function J(r){try{O.serviceBegin(u.report);let s=c,i=l;i.state="登入中";let d=await F.login(r);return j(d)?(i.isLogin=!0,i.state="登入成功",globalThis.lobby.currentUser=d.userInfo,m&&f(),t&&a(),n.redraw(),O.serviceEnd(u.report),O.log({label:"net",category:"登入"}),s.isManual||o(),d):(i.state="登入失敗",void e({title:"errorLow",msg:"disconnect"}))}catch(e){}}async function x(t){let n=s();try{O.serviceBegin(r.report);let o=l;o.state="進入遊戲";let s=await F.ingame(t);if(!j(s))return o.state="進入遊戲失敗",void e({title:"errorLow",msg:"disconnect"});o.state="遊戲中",a(),f(),O.serviceEnd(r.report),O.log({label:"net",category:"進入遊戲"});let i=c;if(i.module){let e=d;if("p"===i.module[e.PROTOCOL]){let e={gid:s.gid,schema:M,checkName:"Game.Share.CheckAction",fields:[{name:"info",rootName:"Game.Share.Info",typeName:"ActionType",cmdList:["BaseResponse"]},{name:"jackpot",rootName:"Game.Share.Jackpot",typeName:"ActionType",cmdList:["BaseResponse"]},{name:"setting",rootName:"Game.Share.Setting",typeName:"ActionType",cmdList:["BaseResponse"]}]};await F.register(e)}}let p={id:s.gid},g=n.scene[p.id];g&&g.localEvent&&(g.localEvent.enter(p),C=!0)}catch(e){}}async function K(e){try{let t=await F.togame(e);return G&&(G=!1),t&&t.packet}catch(e){}}async function z(e){return await F.register(e)}export{S as RESULT,_ as STATE,V as connect,x as ingame,U as init,J as login,z as register,K as togame};
