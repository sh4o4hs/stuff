import*as e from"nuts";import{r as a}from"./agent.95d98b24.js";import"mithril";async function t(e,t){let l=e;if(!Array.isArray(l))return Promise.reject("channels is not array");let n=l.length;for(let e=0;e<n;e+=1){let n=l[e];if(!n||!n.id||!Array.isArray(n.tables))continue;let o=n.tables,i=[];n.results=i;for(let e=0;e<o.length;e+=1){let l=o[e];i[e]={value:0,delay:9999};let s=`${t.getLabel()}`,c=`${t.name} 頻道:${n.id} 桌號:${e+1} ${l}`,y=await r(l,s,c,t.category);i[e]=y,a.log0({eventName:c,label:s,value:y.value,category:`${t.category} 容量`},!0),a.log0({eventName:c,label:s,value:y.delay,category:`${t.category} 延時`},!0)}}return e}async function r(t,r,l,n){return new Promise((o=>{let i=!1,s={value:0,delay:9999},c=!1,y={name:l,category:n,getLabel:()=>r};a.serviceBegin(y);let g=new WebSocket(t);g.binaryType="arraybuffer",g.onopen=()=>{e.updateManager.setTimeout((()=>{i||(i=!0,g.close(),o(s))}),5)},g.onclose=()=>{i=!0},g.onerror=()=>{i=!0,o(s)},g.onmessage=t=>{const r=new Uint8Array(t.data);s.value+=r.length,c||(c=!0,y.category=`${n} 延時`,a.serviceEnd(y),s.delay=y.time,e.updateManager.setTimeout((()=>{i||(i=!0,g.close(),y.category=`${n} 容量`,y.time=s.value,a.serviceEnd(y,!0),o(s))}),.2))}}))}export{t as scan,r as test};
