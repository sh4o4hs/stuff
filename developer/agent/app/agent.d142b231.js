import{r as e,s as t,a,m as n,M as o,o as r,u as i,O as s}from"./agent.9fb827c0.js";import{b as c,f as l,g as d,i as g,C as p,j as u}from"./agent.39caac23.js";import{C as m,n as y,c as f,a as b}from"./agent.d87738a4.js";import{getGameEvent as v}from"./agent.83e1ce48.js";var h=0;function w(e,t){var a=t.data;if(Array.isArray(a)&&!(a.length<2)){var n=a[0],o=a[1],r=a[2],i=e._callbacks[n];i&&(delete e._callbacks[n],i(o,r))}}function L(e){var t=this;t._worker=e,t._callbacks={},e.addEventListener("message",(function(e){w(t,e)}))}L.prototype.postMessage=function(e){var t=this,a=h++,n=[a,e];return new Promise((function(e,o){if(t._callbacks[a]=function(t,a){if(t)return o(new Error(t.message));e(a)},void 0!==t._worker.controller){var r=new MessageChannel;r.port1.onmessage=function(e){w(t,e)},t._worker.controller.postMessage(n,[r.port2])}else t._worker.postMessage(n)}))};var O=L;let T=null,R="init",A="connect",E="login",M="ingame",N="togame",k="register",_="onrefresh",B="onmessage",U="onerror",C="onbroadcast",S="onclose",G="ontogame",j={},I={async connect(e,t){T&&(t&&(j=t),await T.postMessage({type:A,config:e}))},async login(e){if(T){const t=(await import("./agent.77e21db4.js").then((function(e){return e.f}))).default;let a=(await t.getPromise({excludes:{webglVendorAndRenderer:!0,language:!0,canvas:!0,hasLiedOs:!0,hasLiedBrowser:!0,availableScreenResolution:!0,webdriver:!0,deviceMemory:!0,hardwareConcurrency:!0,timezoneOffset:!0,timezone:!0,sessionStorage:!0,localStorage:!0,indexedDb:!0,addBehavior:!0,openDatabase:!0,cpuClass:!0,platform:!0,doNotTrack:!0,plugins:!0,adBlock:!0,hasLiedLanguages:!0,hasLiedResolution:!0,fonts:!0,fontsFlash:!0,audio:!0,enumerateDevices:!0}})).map((function(e){return e.value})),n=t.x64hash128(a.join(""),31);return e.fingerprint=n,await T.postMessage({type:E,info:e})}},async ingame(e){if(T){return await T.postMessage({type:M,info:e})}},async togame(e){if(T){return await T.postMessage({type:N,info:e})}},async register(e){if(T){return await T.postMessage({type:k,config:e})}}};function D(e){if(!Array.isArray(e.data)){let t=e.data;switch(t.type){case _:return void t.offsetTime;case S:return void(j.onclose&&j.onclose());case U:return void(j.onerror&&j.onerror(t.data));case B:return void(j.onmessage&&j.onmessage(t.data));case C:return void(j.onbroadcast&&j.onbroadcast(t.data));case G:return void(j.ontogame&&j.ontogame(t.data))}}}var P={nested:{Game:{nested:{Share:{nested:{ActionType:{values:{NULL:0}},CheckAction:{fields:{actionType:{type:"ActionType",id:1}},reserved:[[2,2]]},Jackpot:{nested:{ActionType:{values:{NORMAL:0}},BaseResponse:{fields:{actionType:{type:"ActionType",id:1},mJpOutIdx:{type:"uint32",id:3},mJpOutValue:{type:"uint64",id:4},mJpValue:{rule:"repeated",type:"uint64",id:5},resultCode:{type:"uint32",id:6}},reserved:[[2,2]]}}},Setting:{nested:{ActionType:{values:{NORMAL:0}},BaseResponse:{fields:{actionType:{type:"ActionType",id:1},betForm:{rule:"repeated",type:"uint32",id:3},betFormIndex:{type:"uint32",id:4},decimalPosition:{type:"uint32",id:5},enableJP:{type:"bool",id:6},isDemo:{type:"bool",id:7},lastBet:{type:"uint32",id:8},lineAmount:{type:"uint32",id:9}},reserved:[[2,2]]}}},Info:{nested:{ActionType:{values:{NORMAL:0}},BaseResponse:{fields:{actionType:{type:"ActionType",id:1},aPIVersion:{type:"string",id:3},chanceVersion:{type:"string",id:4},libVersion:{type:"string",id:5},packageVersion:{type:"string",id:6},slotServerVersion:{type:"string",id:7}},reserved:[[2,2]]}}}}}}}}};const V={ERROR:0,OK:1},J={SEND_LOCK:-3,CONNECT_TIMEOUT:-2,BUFFER_FULL:-1,ERROR:0,OK:1,LOGIN:3,ROOM:4,CONNECT:2};let x=!1,F=!0;function K(){if(a.state="未連線",t.isInGame&&globalThis.scene){Object.getOwnPropertyNames(globalThis.scene).forEach((e=>{let t=globalThis.scene[e];t&&t.game&&t.game.disconnect&&t.game.disconnect()}))}if(x)return;r[s.GAME_DIALOG_CUSTOM]&&(a.isError||i.setTimeout((()=>{a.isError||c({title:"errorLow",msg:"disconnect"})}),2))}function z(e){if(x)return;r[s.GAME_DIALOG_CUSTOM]&&i.setTimeout((()=>{a.isError||c({title:"errorLow",msg:`[agent onerror] ${e}`})}),.5)}function W(e){}function $(e,t){let a=J.OK;return e?(e.resultCode!==V.OK?(a=J.ERROR,t&&t.error&&t.error(e)):t&&t.handle&&t.handle(e),a):(a=J.ERROR,a)}function q(e){if(F&&(F=!1),e&&e.gid){let t=v()[e.gid];t&&t.recvGameData&&t.recvGameData(e.packet)}}function H(e){b.handle(e);let t=v();Object.getOwnPropertyNames(t).forEach((a=>{let n=t[a];if(n&&n.recvBroadcast){let t=JSON.stringify(e);n.recvBroadcast(t)}}))}let Q=null;async function X(e){await async function(e){let t=!1;const{getProject:a}=await import("./agent.2496807a.js");let n=await a("lib/abcd",{mode:"blob"}),o=new Worker(n.blobURL);o.addEventListener("message",D),T=new O(o),e.root=n.root,e.pathname=n.pathname;try{await T.postMessage({type:R,config:e}),t=!0}catch(e){}return t}(e),Q=I}async function Y(e){let t={ontogame:q,onclose:K,onerror:z,onbroadcast:H,onmessage:W},n=a;n.state="連線中",await Q.connect(e,t),n.state="已連線"}async function Z(o){try{e.serviceBegin(m.report);let r=t,i=a;i.state="登入中";let s=await Q.login(o);if(!$(s))return i.state="登入失敗",void c({title:"errorLow",msg:"disconnect"});if(i.isLogin=!0,i.state="登入成功",globalThis.lobby.currentUser=s.userInfo,"string"==typeof r.gtiLobbyUrl&&r.gtiLobbyUrl.length>0){let e={list:r.gtiLobbyUrl+"/gameplay/bet_list/",deposit:r.gtiLobbyUrl+"/gameplay/goto_deposit/",official:r.gtiLobbyUrl+"/gameplay/goto_official/",lobby:r.gtiLobbyUrl+"/"};r.gtiBetTracerUrl&&r.gtiBetTracerUrl.length>0&&(e.list=r.gtiBetTracerUrl+"/gameplay/bet_list/"),i.URLs=e}return y&&f(),l&&d(),n.redraw(),e.serviceEnd(m.report),e.log({label:"net",category:"登入"}),r.isManual||g(),s}catch(e){}}async function ee(n){let r=u();try{e.serviceBegin(p.report);let i=a;i.state="進入遊戲";let s=await Q.ingame(n);if(!$(s))return i.state="進入遊戲失敗",void c({title:"errorLow",msg:"disconnect"});i.state="遊戲中",d(),f(),e.serviceEnd(p.report),e.log({label:"net",category:"進入遊戲"});let l=t;if(l.module){let e=o;if("p"===l.module[e.PROTOCOL]){let e={gid:s.gid,schema:P,checkName:"Game.Share.CheckAction",fields:[{name:"info",rootName:"Game.Share.Info",typeName:"ActionType",cmdList:["BaseResponse"]},{name:"jackpot",rootName:"Game.Share.Jackpot",typeName:"ActionType",cmdList:["BaseResponse"]},{name:"setting",rootName:"Game.Share.Setting",typeName:"ActionType",cmdList:["BaseResponse"]}]};await Q.register(e)}}let g={id:s.gid},u=r.scene[g.id];u&&u.localEvent&&(u.localEvent.enter(g),x=!0)}catch(e){}}async function te(e){try{let t=await Q.togame(e);return F&&(F=!1),t&&t.packet}catch(e){}}async function ae(e){return await Q.register(e)}export{V as RESULT,J as STATE,Y as connect,ee as ingame,X as init,Z as login,ae as register,te as togame};
