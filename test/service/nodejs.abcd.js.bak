"use strict";function _interopDefault(ex){return ex&&"object"==typeof ex&&"default"in ex?ex.default:ex}var GAME,lightFormat=_interopDefault(require("date-fns/lightFormat")),uws=_interopDefault(require("uWebSockets.js")),pino=_interopDefault(require("pino")),fs=_interopDefault(require("fs")),jsyaml=_interopDefault(require("js-yaml")),path=_interopDefault(require("path")),avro=_interopDefault(require("avsc")),grunt=_interopDefault(require("grunt")),hash=_interopDefault(require("hash-it")),io=_interopDefault(require("socket.io-client")),WebSocket=_interopDefault(require("ws")),protobuf=_interopDefault(require("protobufjs"));!function(GAME){GAME.REQUEST="request",GAME.RESPONSE="response"}(GAME||(GAME={}));var logger={error:function(){},info:function(){}},typeCache={},commonSchema={};function init(config,log){(logger=log.child({module:"schema manager"})).info("init"),config&&preload(config)}function getCurrent(info){var group=null,current=null;info.group&&(typeCache[info.group]?group=typeCache[info.group]:(group={},typeCache[info.group]=group));var object=null;return info.name&&(group[info.name]?object=group[info.name]:((object={}).types={},object.schemas={},group[info.name]=object)),info.sub?(current=object[info.sub])||((current={}).types={},current.schemas={},object[info.sub]=current):current=object,current}function save(info,data){var id=null,value=data;if("string"==typeof data){if("{"!==data[0])return id;try{if(value=JSON.parse(data),0===Object.getOwnPropertyNames(value).length)return id}catch(err){logger.error(err)}}try{var type=avro.Type.forValue(value),schema=JSON.stringify(type.schema()),filename=""+hash(type);id=filename;var current=getCurrent(info);current.types&&(current.types[filename]=type),current.schemas&&(current.schemas[filename]=schema);var dir="schema";info.group&&(dir+="/"+info.group),info.name&&(dir+="/"+info.name),info.sub&&(dir+="/"+info.sub),process.env.APP_ENABLE_SAVEFILE&&(fs.existsSync(dir)||fs.mkdirSync(dir,{recursive:!0}),filename=dir+"/"+filename+".json",console.log("[save schema]"+filename),fs.writeFileSync(filename,schema,"utf8")),"common"===info.group&&(commonSchema[info.name]=current)}catch(e){console.error("[schemaManager save]"),console.error(e)}return id}function preload(config){logger.info("preload"),(config.preloads||[]).forEach((function(info){load(info)}))}function load(info){var srcDir=null,current=null;return(current=getCurrent(info)).schemas={},current.types={},srcDir="schema",info.group&&(srcDir+="/"+info.group),info.name&&(srcDir+="/"+info.name),info.sub&&(srcDir+="/"+info.sub),grunt.file.expand(srcDir+"/*.json").forEach((function(filename){console.log("filename : "+filename);try{var schema=fs.readFileSync(filename,"utf8"),obj=JSON.parse(schema),id=path.parse(filename).name,type=avro.Type.forSchema(obj);current.types[id]=type,current.schemas[id]=schema}catch(err){logger.error(err)}})),info.isCommon&&(commonSchema[info.name]=current),current}function checkBuffer(types,buf,config){void 0===config&&(config={});var data=null;if(types){console.log("[checkBuffer types]");var idList=Object.getOwnPropertyNames(types);console.log(idList);for(var i=0;i<idList.length;i+=1){var id=idList[i],type=types[id];try{return console.log("[buf]"+id),data=type.fromBuffer(buf),config.useJSON&&"string"!=typeof data&&(data=JSON.stringify(data)),console.log("checkBuffer id is : "+id),data}catch(e){console.log("[checkBuffer error id]"+id)}}}return data}function checkObject(types,obj){var format={buf:null};if(!obj)return format;if(!types)return format;try{console.log("[checkObject types]");var idList=Object.getOwnPropertyNames(types);console.log(idList);for(var i=idList.length-1;i>=0;i-=1){var id=idList[i];console.log("check type id :"+id);var type=types[id];if(type.isValid(obj,{noUndeclaredFields:!0}))return console.log("checkObject type id : "+id),format.buf=type.toBuffer(obj),format.id=id,format}}catch(e){logger.error("checkObject"),console.error(e)}return format}function checkData(types,data,info,updateSchema){var format={buf:null},obj=data;if(!obj)return format;if("string"==typeof obj){if("{"===obj[0])try{format=checkObject(types,obj=JSON.parse(obj))}catch(err){logger.error(err)}}else format=checkObject(types,obj);if(!format.buf){var id=save(info,obj);if(id)info.schemas=[id],updateSchema(info),format=checkObject(getCurrent(info).types,obj)}return format}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */function __awaiter(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))}function __generator(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=(t=_.trys).length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}}var namespace="game.agent.avro",name="LoginRequest",type="record",doc="登入命令 (傳送)",fields=[{doc:"索引",name:"funcIndex",type:"int"},{doc:"認證碼",name:"fingerprint",type:"string"},{doc:"指紋",name:"token",type:"string"},{doc:"視訊用",name:"tablekey",type:["null","string"],default:null}],LoginRequest={namespace:namespace,name:name,type:type,doc:doc,fields:fields},namespace$1="game.agent.avro",name$1="LoginResponseGti",type$1="record",doc$1="登入命令 (接收)",fields$1=[{doc:"玩家資訊 (目前沒使用)",name:"userInfo",type:["null",{name:"UserInfo",type:"record",fields:[{name:"nickname",type:"string"},{name:"coin",type:["null","int"],default:null}]}],default:null},{doc:"索引",name:"funcIndex",type:"int"},{doc:"認證碼",name:"token",type:["null","string"],default:null},{doc:"結果代碼",name:"resultCode",type:"int"}],LoginResponseGti={namespace:namespace$1,name:name$1,type:type$1,doc:doc$1,fields:fields$1},namespace$2="game.agent.avro",name$2="LoginResponseVideo",type$2="record",doc$2="登入命令 (接收)",fields$2=[{name:"resultCode",type:"int"},{name:"loginKey",type:"string"},{name:"userInfo",type:{type:"record",fields:[{name:"id",type:"string"},{name:"platform",type:"string"},{name:"currency",type:"string"},{name:"userID",type:"string"},{name:"nickname",type:"string"},{name:"house",type:"string"},{name:"agent",type:"string"},{name:"gameData",type:{type:"record",fields:[{name:"roomID",type:"string"}]}},{name:"aboId",type:"string"}]}},{name:"funcIndex",type:"int"}],LoginResponseVideo={namespace:namespace$2,name:name$2,type:type$2,doc:doc$2,fields:fields$2},typeRequest=avro.Type.forSchema(LoginRequest),typeResponseGti=avro.Type.forSchema(LoginResponseGti),typeResponseVideo=avro.Type.forSchema(LoginResponseVideo),namespace$3="game.agent.avro",name$3="InGameRequest",type$3="record",doc$3="進入遊戲 (傳送)",fields$3=[{doc:"索引",name:"funcIndex",type:"int"},{doc:"名稱",name:"name",type:"string"},{doc:"群組",name:"group",type:"string"},{doc:"遊戲代碼",name:"gid",type:"string"}],InGameRequest={namespace:namespace$3,name:name$3,type:type$3,doc:doc$3,fields:fields$3},namespace$4="game.agent.avro",name$4="InGameResponse",type$4="record",doc$4="進入遊戲 (接收)",fields$4=[{doc:"遊戲代碼",name:"gid",type:"string"},{doc:"索引",name:"funcIndex",type:"int"},{name:"updateSchemaList",type:{type:"array",items:{name:"UpdateSchemaRequest",type:"record",fields:[{doc:"名稱",name:"name",type:"string"},{doc:"群組",name:"group",type:"string"},{doc:"訂閱",name:"sub",type:{type:"enum",symbols:["request","response"]}},{name:"schemas",type:{type:"array",items:"string"}}]}}},{name:"resultCode",type:"int"}],InGameResponse={namespace:namespace$4,name:name$4,type:type$4,doc:doc$4,fields:fields$4},typeRequest$1=avro.Type.forSchema(InGameRequest),typeResponse=avro.Type.forSchema(InGameResponse),namespace$5="game.agent.avro",name$5="ToGameRequest",type$5="record",doc$5="遊戲命令 (傳送)",fields$5=[{doc:"索引",name:"funcIndex",type:"int"},{doc:"遊戲代碼",name:"gid",type:"string"},{doc:"封包",name:"packet",type:{name:"packet",type:"record",fields:[{doc:"命令",name:"command",type:["string","null"]},{doc:"資料",name:"data",type:["bytes","string"]}]}}],ToGameRequest={namespace:namespace$5,name:name$5,type:type$5,doc:doc$5,fields:fields$5},namespace$6="game.agent.avro",name$6="ToGameResponse",type$6="record",doc$6="遊戲命令 (接收)",fields$6=[{doc:"索引",name:"funcIndex",type:"int"},{doc:"遊戲代碼",name:"gid",type:"string"},{doc:"結果代碼",name:"resultCode",type:"int"},{doc:"資料",name:"packet",type:["null","bytes"]},{name:"schemas",doc:"資料描述",type:{type:"array",items:{name:"schema",type:"record",fields:[{name:"name",type:"string"},{name:"hash",type:"string"}]}}}],ToGameResponse={namespace:namespace$6,name:name$6,type:type$6,doc:doc$6,fields:fields$6},typeRequest$2=avro.Type.forSchema(ToGameRequest),typeResponse$1=avro.Type.forSchema(ToGameResponse),namespace$7="game.agent.avro",name$7="BroadcastResponse",doc$7="廣播用 (接收)",type$7="record",fields$7=[{doc:"種類",name:"proto",type:"string"},{doc:"內容",name:"json",type:"string"}],BroadcastResponse={namespace:namespace$7,name:name$7,doc:doc$7,type:type$7,fields:fields$7},typeResponse$2=avro.Type.forSchema(BroadcastResponse),logger$1={error:function(){},info:function(){}},GAME$1=GAME,commonSchema$1=null;function init$1(config){return(logger$1=config.logger.child({proxy:"ioGti"})).info("init"),commonSchema$1=commonSchema,[{name:"toGame",type:typeRequest$2,func:toGame},{name:"login",type:typeRequest,func:login},{name:"inGame",type:typeRequest$1,func:inGame}]}function login(ws,data){return __awaiter(this,void 0,void 0,(function(){var funcIndex,socketio,info;return __generator(this,(function(_a){return funcIndex=data.funcIndex,delete data.funcIndex,(socketio=ws.socketio)?socketio.curLoginData?logger$1.error("重複收到登入命令"):(socketio.curLoginData=data,socketio.loginFuncIndex=funcIndex,(info=ws.info).index=info.generateIndex(),console.log("index:"+info.index+" is "+data.token),socketio.emit("login",data)):logger$1.error("disconnect"),[2]}))}))}function inGame(ws,data){return __awaiter(this,void 0,void 0,(function(){var socketio,info,funcIndex;return __generator(this,(function(_a){return socketio=ws.socketio,info=ws.info,funcIndex=data.funcIndex,data.group.length>32||data.name.length,delete data.funcIndex,info.game=data,socketio?socketio.curInGameData?logger$1.error("重複收到進入遊戲命令"):(socketio.curInGameData=data,info.inGameFuncIndex=funcIndex,socketio.emit("inGame",data)):logger$1.error("disconnect"),[2]}))}))}function toGame(ws,data){var _a,_b;return __awaiter(this,void 0,void 0,(function(){var game,buf,id,info,types;return __generator(this,(function(_c){return(null===(_b=null===(_a=data)||void 0===_a?void 0:_a.packet)||void 0===_b?void 0:_b.data)&&(game=ws.info.game,(buf=data.packet.data)&&("string"==typeof buf?(game.sub=GAME$1.REQUEST,(id=save(game,buf))&&(info={name:game.name,group:game.group,sub:game.sub,schemas:[id]},ws.updateSchema(info))):Buffer.isBuffer(buf)&&(types=ws.info.typesRequest,data.packet.data=checkBuffer(types,buf,{useJSON:!0})))),ws.socketio?ws.socketio.emit("toGame",data):logger$1.error("disconnect"),[2]}))}))}function close(ws){ws&&ws.socketio&&(ws.socketio.close(),delete ws.socketio)}function open(ws,message){var socketio=new io(process.env.PROXY_SERVER,{forceNew:!1,reconnection:!1,transports:["websocket"]});ws.socketio=socketio,ws.isConnected=!1,socketio.on("connect",(function(){logger$1.info("connect"),ws.isConnected=!0,ws.firstBuf&&message(ws,null)})),socketio.on("disconnect",(function(){logger$1.info("disconnect"),ws.isConnected=!1,delete ws.socketio,ws.close&&ws.close()})),socketio.on("connect_error",(function(error){logger$1.info("connect_error"),console.log(error)})),socketio.on("error",(function(error){logger$1.info("error"),console.log(error)})),socketio.on("connect_timeout",(function(){logger$1.info("connect_timeout"),ws.close&&ws.close()})),socketio.on("login",(function(data){var info=ws.info;logger$1.info(info.index+"[result]login");var funcIndex=-1;if(socketio.curLoginData&&(socketio.curLoginData=null,funcIndex=socketio.loginFuncIndex,delete socketio.loginFuncIndex),data){data.funcIndex=funcIndex,data.userData&&delete data.userData;var check=!0;if(typeResponseGti.isValid(data)){var buffer=typeResponseGti.toBuffer(data);ws.send(buffer)}else check=!1,logger$1.error("格式錯誤"),console.log(data);check&&(info.user=data.userInfo)}else logger$1.error("login data is undefined")})),socketio.on("inGame",(function(data){var info=ws.info;logger$1.info(info.index+"[result]inGame");var funcIndex=-1;socketio.curInGameData&&(socketio.curInGameData=null,funcIndex=info.inGameFuncIndex,delete info.inGameFuncIndex);var type=typeResponse;if(data){delete data.packet,data.funcIndex=funcIndex;var current=null,schemas=null,updateSchemaList=[];if(data.updateSchemaList=updateSchemaList,info.game.sub=GAME$1.REQUEST,schemas=(current=getCurrent(info.game)).schemas,info.typesRequest=current.types,(schemas=schemas&&Object.getOwnPropertyNames(schemas))&&schemas.length>0){var obj={name:info.game.name,group:info.game.group,sub:GAME$1.REQUEST,schemas:schemas};updateSchemaList.push(obj)}if(info.game.sub=GAME$1.RESPONSE,current=getCurrent(info.game),info.typesResponse=current.types,(schemas=(schemas=current.schemas)&&Object.getOwnPropertyNames(schemas))&&schemas.length>0){obj={name:info.game.name,group:info.game.group,sub:GAME$1.RESPONSE,schemas:schemas};updateSchemaList.push(obj)}if((schemas=(schemas=(current=getCurrent({group:info.game.group,name:"packet",sub:GAME$1.RESPONSE})).schemas)&&Object.getOwnPropertyNames(schemas))&&schemas.length>0){obj={group:info.game.group,name:"packet",sub:GAME$1.RESPONSE,schemas:schemas};updateSchemaList.push(obj)}if(commonSchema$1.jackpot&&commonSchema$1.jackpot.schemas&&(schemas=Object.getOwnPropertyNames(commonSchema$1.jackpot.schemas)).length>0){obj={name:"jackpot",group:"common",sub:GAME$1.RESPONSE,schemas:schemas};updateSchemaList.push(obj)}if(commonSchema$1.info&&commonSchema$1.info.schemas&&(schemas=Object.getOwnPropertyNames(commonSchema$1.info.schemas)).length>0){obj={name:"info",group:"common",sub:GAME$1.RESPONSE,schemas:schemas};updateSchemaList.push(obj)}if(commonSchema$1.setting&&commonSchema$1.setting.schemas&&(schemas=Object.getOwnPropertyNames(commonSchema$1.setting.schemas)).length>0){obj={name:"setting",group:"common",sub:GAME$1.RESPONSE,schemas:schemas};updateSchemaList.push(obj)}if(console.log(data),type.isValid(data,{noUndeclaredFields:!0})){var buffer=type.toBuffer(data);ws.send(buffer)}else logger$1.error("格式錯誤")}else logger$1.error("inGame data is undefined")})),socketio.on("toGame",(function(data){var info=ws.info;logger$1.info(info.index+"[result]toGame");var game=info.game,type=typeResponse$1;if(game){console.log(data);var packet=data.packet;if(data.funcIndex=-1,data.packet=null,data.schemas=[],type.isValid(data)){var format_1=null;if(packet){Object.getOwnPropertyNames(packet).forEach((function(name){console.log("packet."+name);var obj=packet[name];if("string"==typeof obj&&"{"!==obj[0])return!0;var info={group:game.group,name:name,sub:GAME$1.RESPONSE};"data"===name&&(info.name=game.name);var types=getCurrent(info).types;(format_1=checkData(types,obj,info,ws.updateSchema)).buf&&(packet[name]=format_1.buf,data.schemas.push({name:name,hash:format_1.id}))}));var obj=packet,info_1={group:game.group,name:"packet",sub:GAME$1.RESPONSE},types=getCurrent(info_1).types;(format_1=checkData(types,obj,info_1,ws.updateSchema)).buf&&(data.packet=format_1.buf,data.schemas.push({name:"packet",hash:format_1.id}))}var buffer=type.toBuffer(data);ws.send(buffer)}else logger$1.error("格式錯誤"),console.log(data)}else logger$1.error("未執行 inGame 命令")})),socketio.on("broadCastMsg",(function(data){var info=ws.info;logger$1.info(info.index+"[result]broadcast");var type=typeResponse$2;if("string"==typeof data){var cmd=JSON.parse(data);if(type.isValid(cmd,{noUndeclaredFields:!0})){var buffer=type.toBuffer(cmd);ws.send(buffer)}else logger$1.error("廣播封包格式不正確")}else logger$1.error("廣播封包格式不正確 (不是 json 字串)")})),logger$1.info("open")}var socketioGti=Object.freeze({__proto__:null,init:init$1,login:login,inGame:inGame,toGame:toGame,close:close,open:open}),nested={Game:{nested:{Agent:{nested:{ActionType:{values:{LOGIN:0,INGAME:1,TOGAME:2,BROADCAST:3}},CheckAction:{fields:{actionType:{type:"ActionType",id:1}},reserved:[[2,2]]},BroadcastResponse:{fields:{actionType:{type:"ActionType",id:1},format:{type:"CustomFormat",id:2},proto:{type:"string",id:3},json:{type:"string",id:4},data:{type:"bytes",id:5}},reserved:[[6,6]]},LoginRequest:{fields:{actionType:{type:"ActionType",id:1},funcIndex:{type:"int32",id:3},token:{type:"string",id:4},tablekey:{type:"string",id:5},fingerprint:{type:"string",id:6},formatBroadcast:{type:"CustomFormat",id:7}},reserved:[[2,2]]},LoginResponse:{fields:{actionType:{type:"ActionType",id:1},funcIndex:{type:"int32",id:3},userInfo:{type:"UserInfo",id:4},token:{type:"string",id:5},resultCode:{type:"int32",id:7}},reserved:[[2,2],[6,6]]},UserInfo:{fields:{nickname:{type:"string",id:1},coin:{type:"int64",id:3}},reserved:[[2,2],[6,6]]},InGameRequest:{fields:{actionType:{type:"ActionType",id:1},funcIndex:{type:"int32",id:3},gid:{type:"string",id:4},name:{type:"string",id:6},group:{type:"string",id:7}},reserved:[[2,2],[5,5]]},Custom:{fields:{name:{type:"string",id:1}}},InGameResponse:{fields:{actionType:{type:"ActionType",id:1},funcIndex:{type:"int32",id:3},gid:{type:"string",id:4},resultCode:{type:"int32",id:5}},reserved:[[2,2]]},CustomFormat:{values:{JSON:0,RAW:1,PROTOBUF:2}},CustomType:{values:{A:0,B:1}},ToGameRequest:{fields:{actionType:{type:"ActionType",id:1},funcIndex:{type:"int32",id:3},gid:{type:"string",id:4},packet:{type:"GameRequest",id:5}},reserved:[[2,2],[6,6]]},GameRequest:{fields:{format:{type:"CustomFormat",id:1},funcIndex:{type:"int32",id:2},command:{type:"string",id:3},data:{type:"bytes",id:4}},reserved:[[6,6]]},ToGameResponse:{fields:{actionType:{type:"ActionType",id:1},funcIndex:{type:"int32",id:3},gid:{type:"string",id:4},resultCode:{type:"int32",id:5},packet:{type:"GameResponse",id:7}},reserved:[[2,2],[6,6]]},GameResponse:{fields:{format:{type:"CustomFormat",id:1},funcIndex:{type:"int32",id:2},command:{type:"string",id:3},data:{type:"bytes",id:4},jackpot:{type:"Jackpot",id:6},info:{type:"Info",id:7},setting:{type:"Setting",id:8},errorCode:{type:"string",id:9}},reserved:[[5,5]]},Jackpot:{fields:{format:{type:"CustomFormat",id:1},data:{type:"bytes",id:3}},reserved:[[2,2]]},Setting:{fields:{format:{type:"CustomFormat",id:1},data:{type:"bytes",id:3}},reserved:[[2,2]]},Info:{fields:{format:{type:"CustomFormat",id:1},data:{type:"bytes",id:3}},reserved:[[2,2]]}}}}}},protocol={nested:nested},logger$2={error:function(){},info:function(){}},utf8Decoder=null,utf8Encoder=null,GAME$2=GAME,Agent=null,ActionType=null,CustomFormat=null,LoginRequest$1=null,LoginResponse=null,InGameRequest$1=null,InGameResponse$1=null,ToGameRequest$1=null,ToGameResponse$1=null,BroadcastResponse$1=null;function init$2(config){(logger$2=config.logger.child({proxy:"wsGti"})).info("init"),utf8Decoder=new TextDecoder,utf8Encoder=new TextEncoder;var root=protobuf.Root.fromJSON(protocol);return Agent=root.Game.Agent,ActionType=Agent.ActionType,CustomFormat=Agent.CustomFormat,LoginRequest$1=Agent.LoginRequest,LoginResponse=Agent.LoginResponse,InGameRequest$1=Agent.InGameRequest,InGameResponse$1=Agent.InGameResponse,ToGameRequest$1=Agent.ToGameRequest,ToGameResponse$1=Agent.ToGameResponse,BroadcastResponse$1=Agent.BroadcastResponse,[{name:"toGame",type:typeRequest$2,func:toGame$1},{name:"login",type:typeRequest,func:login$1},{name:"inGame",type:typeRequest$1,func:inGame$1}]}function sendBroadcast(ws,data){var info=ws.info;logger$2.info(info.index+"[send]broadcast");var type=typeResponse$2;if(type.isValid(data,{noUndeclaredFields:!0})){var buffer=type.toBuffer(data);ws.send(buffer)}else logger$2.error("格式錯誤"),console.log(data)}function sendLogin(ws,data){var info=ws.info;if(logger$2.info(info.index+"[send]login"),data.funcIndex=data.funcIndex,delete data.actionType,typeResponseGti.isValid(data,{noUndeclaredFields:!0})){var buffer=typeResponseGti.toBuffer(data);ws.send(buffer),info.user=data.userInfo}else logger$2.error("格式錯誤"),console.log(data)}function login$1(ws,data){return __awaiter(this,void 0,void 0,(function(){var service,err,value,buffer,info;return __generator(this,(function(_a){return(service=ws.service)?(ws.curLoginData?logger$2.error("重複收到登入命令"):(ws.curLoginData=data,data.actionType=ActionType.LOGIN,(err=LoginRequest$1.verify(data))?logger$2.error(err):(value=LoginRequest$1.create(data),buffer=LoginRequest$1.encode(value).finish(),service.send(buffer),(info=ws.info).index=info.generateIndex(),console.log("index:"+info.index+" is "+data.token))),[2]):(logger$2.error("service is undefined"),[2])}))}))}function sendInGame(ws,data){var info=ws.info;if(logger$2.info(info.index+"[send]inGame"),info.game){data.funcIndex=data.funcIndex,delete data.actionType;var current=null,schemas=null,updateSchemaList=[];if(data.updateSchemaList=updateSchemaList,info.game.sub=GAME$2.REQUEST,current=getCurrent(info.game),schemas=current.schemas,info.typesRequest=current.types,(schemas=schemas&&Object.getOwnPropertyNames(schemas))&&schemas.length>0){var obj={name:info.game.name,group:info.game.group,sub:GAME$2.REQUEST,schemas:schemas};updateSchemaList.push(obj)}if(info.game.sub=GAME$2.RESPONSE,current=getCurrent(info.game),info.typesResponse=current.types,(schemas=(schemas=current.schemas)&&Object.getOwnPropertyNames(schemas))&&schemas.length>0){obj={name:info.game.name,group:info.game.group,sub:GAME$2.RESPONSE,schemas:schemas};updateSchemaList.push(obj)}if(["packet","jackpot","info","setting"].forEach((function(name){if(current=getCurrent({group:info.game.group,name:name,sub:GAME$2.RESPONSE}),(schemas=(schemas=current.schemas)&&Object.getOwnPropertyNames(schemas))&&schemas.length>0){var obj={group:info.game.group,name:name,sub:GAME$2.RESPONSE,schemas:schemas};updateSchemaList.push(obj)}})),console.log(data),typeResponse.isValid(data,{noUndeclaredFields:!0})){var buffer=typeResponse.toBuffer(data);ws.send(buffer)}else logger$2.error("格式錯誤"),console.log(data)}else logger$2.error("info.game is null")}function inGame$1(ws,data){return __awaiter(this,void 0,void 0,(function(){var service,err,value,buffer;return __generator(this,(function(_a){return(service=ws.service)?(ws.info.game=data,data.actionType=ActionType.INGAME,(err=InGameRequest$1.verify(data))?logger$2.error(err):(value=InGameRequest$1.create(data),buffer=InGameRequest$1.encode(value).finish(),service.send(buffer)),[2]):(logger$2.error("service is undefined"),[2])}))}))}function sendToGame(ws,data){var _a,_b,_c,_d,_e,_f,_g,info=ws.info;logger$2.info(info.index+"[send]toGame");var game=info.game;if(game){console.log(data);var packet=data.packet;data.funcIndex=-1,data.packet=null,data.schemas=[],delete data.actionType;var type=typeResponse$1;if(type.isValid(data,{noUndeclaredFields:!0})){var format_1=null;if(packet){if((null===(_b=null===(_a=packet.jackpot)||void 0===_a?void 0:_a.data)||void 0===_b?void 0:_b.length)&&packet.jackpot.data.length>0)switch(packet.jackpot.format){case CustomFormat.JSON:packet.jackpot=utf8Decoder.decode(packet.jackpot.data)}if((null===(_d=null===(_c=packet.setting)||void 0===_c?void 0:_c.data)||void 0===_d?void 0:_d.length)&&packet.setting.data.length>0)switch(packet.setting.format){case CustomFormat.JSON:packet.setting=utf8Decoder.decode(packet.setting.data)}if((null===(_f=null===(_e=packet.info)||void 0===_e?void 0:_e.data)||void 0===_f?void 0:_f.length)&&packet.info.data.length>0)switch(packet.info.format){case CustomFormat.JSON:packet.info=utf8Decoder.decode(packet.info.data)}if((null===(_g=packet.data)||void 0===_g?void 0:_g.length)&&packet.data.length>0)switch(packet.format){case CustomFormat.JSON:packet.data=utf8Decoder.decode(packet.data)}Object.getOwnPropertyNames(packet).forEach((function(name){console.log("packet."+name);var obj=packet[name];if("string"==typeof obj&&"{"!==obj[0])return!0;var info={group:game.group,name:name,sub:GAME$2.RESPONSE};"data"===name&&(info.name=game.name);var types=getCurrent(info).types;(format_1=checkData(types,obj,info,ws.updateSchema)).buf&&(packet[name]=format_1.buf,data.schemas.push({name:name,hash:format_1.id}))}));var obj=packet,info_1={group:game.group,name:"packet",sub:GAME$2.RESPONSE},types=getCurrent(info_1).types;(format_1=checkData(types,obj,info_1,ws.updateSchema)).buf?(data.packet=format_1.buf,data.schemas.push({name:"packet",hash:format_1.id})):console.error("無法處理主要封包")}try{var buffer=type.toBuffer(data);ws.send(buffer)}catch(err){logger$2.error("type.toBuffer has problem")}}else logger$2.error("格式錯誤")}else logger$2.error("未執行 inGame 命令")}function toGame$1(ws,data){var _a,_b;return __awaiter(this,void 0,void 0,(function(){var service,game,buf,id,info,types,err,value,buffer;return __generator(this,(function(_c){return(service=ws.service)||logger$2.error("service is undefined"),console.log(data),(game=ws.info.game)&&(null===(_b=null===(_a=data)||void 0===_a?void 0:_a.packet)||void 0===_b?void 0:_b.data)&&("string"==typeof(buf=data.packet.data)?(game.sub=GAME$2.REQUEST,(id=save(game,buf))&&(info={name:game.name,group:game.group,sub:game.sub,schemas:[id]},ws.updateSchema(info))):Buffer.isBuffer(buf)&&(types=ws.info.typesRequest,data.packet.data=checkBuffer(types,buf,{useJSON:!0})),data.actionType=ActionType.TOGAME,data.packet.data=utf8Encoder.encode(data.packet.data),(err=ToGameRequest$1.verify(data))?logger$2.error(err):(value=ToGameRequest$1.create(data),buffer=ToGameRequest$1.encode(value).finish(),service.send(buffer))),[2]}))}))}function close$1(ws){ws&&ws.service&&(ws.service.terminate(),delete ws.service)}function open$1(ws,message){logger$2.info("open");var service=new WebSocket(process.env.PROXY_SERVER);service.binaryType="arraybuffer",ws.service=service,ws.isConnected=!1,service.on("open",(function(){logger$2.info("service connect"),ws.isConnected=!0,ws.firstBuf&&message(ws,null)})),service.on("error",(function(err){logger$2.error("service error"),console.log(err)})),service.on("close",(function(){logger$2.info("service disconnect"),ws.isConnected=!1,delete ws.service,ws.close&&ws.close()})),service.on("message",(function(data){var view=new Uint8Array(data),buf=Buffer.from(view);try{if((value=ToGameResponse$1.decode(buf))&&value.actionType===ActionType.TOGAME)return void sendToGame(ws,value)}catch(e){}try{if((value=BroadcastResponse$1.decode(buf))&&value.actionType===ActionType.BROADCAST)return void sendBroadcast(ws,value)}catch(e){}try{if((value=InGameResponse$1.decode(buf))&&value.actionType===ActionType.INGAME)return void sendInGame(ws,value)}catch(e){}try{var value;if((value=LoginResponse.decode(buf))&&value.actionType===ActionType.LOGIN)return void sendLogin(ws,value)}catch(e){}logger$2.error("!!!! unknown format !!!!"),console.log(view)}))}var websocketGti=Object.freeze({__proto__:null,init:init$2,login:login$1,inGame:inGame$1,toGame:toGame$1,close:close$1,open:open$1}),logger$3={error:function(){},info:function(){}},GAME$3=GAME;function init$3(config){return(logger$3=config.logger.child({proxy:"ioVideo"})).info("init"),[{name:"toGame",type:typeRequest$2,func:toGame$2},{name:"login",type:typeRequest,func:login$2},{name:"inGame",type:typeRequest$1,func:inGame$2}]}function login$2(ws,data){return __awaiter(this,void 0,void 0,(function(){var funcIndex,socketio,info;return __generator(this,(function(_a){return funcIndex=data.funcIndex,delete data.funcIndex,(socketio=ws.socketio)?socketio.curLoginData?logger$3.error("重複收到登入命令"):(socketio.curLoginData=data,socketio.loginFuncIndex=funcIndex,(info=ws.info).index=info.generateIndex(),console.log("index:"+info.index+" is "+data.token),socketio.emit("login",data)):logger$3.error("disconnect"),[2]}))}))}function inGame$2(ws,data){return __awaiter(this,void 0,void 0,(function(){var info,socketio;return __generator(this,(function(_a){return(info=ws.info).game?[2]:(info.game=data,(socketio=ws.socketio)?socketio.emit("inGame",data):logger$3.error("disconnect"),[2])}))}))}function toGame$2(ws,data){var _a,_b;return __awaiter(this,void 0,void 0,(function(){var game,buf,id,info,types;return __generator(this,(function(_c){return(null===(_b=null===(_a=data)||void 0===_a?void 0:_a.packet)||void 0===_b?void 0:_b.data)&&(game=ws.info.game,(buf=data.packet.data)&&("string"==typeof buf?(game.sub=GAME$3.REQUEST,(id=save(game,buf))&&(info={name:game.name,group:game.group,sub:game.sub,schemas:[id]},ws.updateSchema(info))):Buffer.isBuffer(buf)&&(types=ws.info.typesRequest,data.packet.data=checkBuffer(types,buf,{useJSON:!0})))),ws.socketio?ws.socketio.emit("toGame",data):logger$3.error("disconnect"),[2]}))}))}function close$2(ws){ws&&ws.socketio&&(ws.socketio.close(),delete ws.socketio)}function open$2(ws,message){var socketio=new io(process.env.PROXY_SERVER,{forceNew:!1,reconnection:!1,transports:["websocket"]});ws.socketio=socketio,ws.isConnected=!1,socketio.on("connect",(function(){logger$3.info("connect"),ws.isConnected=!0,ws.firstBuf&&message(ws,null)})),socketio.on("disconnect",(function(){logger$3.info(ws.info.index+" disconnect"),ws.isConnected=!1,delete ws.socketio,ws.close&&ws.close()})),socketio.on("connect_error",(function(error){logger$3.info("connect_error"),console.log(error)})),socketio.on("error",(function(error){logger$3.info("error"),console.log(error)})),socketio.on("connect_timeout",(function(){logger$3.info("connect_timeout"),ws.close&&ws.close()})),socketio.on("login",(function(data){logger$3.info(ws.info.index+"[result]login");var funcIndex=-1;if(socketio.curLoginData&&(socketio.curLoginData=null,funcIndex=socketio.loginFuncIndex,delete socketio.loginFuncIndex),data){data.funcIndex=funcIndex,data.userData&&delete data.userData;var check=!0;if(typeResponseVideo.isValid(data)){var buffer=typeResponseVideo.toBuffer(data);ws.send(buffer)}else check=!1,logger$3.error("格式錯誤");check&&(ws.info.user=data.userInfo)}else logger$3.error("login data is undefined")})),socketio.on("inGame",(function(data){var info=ws.info;logger$3.info(info.index+"[result]inGame");var funcIndex=info.game.funcIndex,type=typeResponse;if(data){delete data.packet,data.funcIndex=funcIndex;var current=null,schemas=null,updateSchemaList=[];if(data.updateSchemaList=updateSchemaList,info.game.sub=GAME$3.REQUEST,schemas=(current=getCurrent(info.game)).schemas,info.typesRequest=current.types,(schemas=schemas&&Object.getOwnPropertyNames(schemas))&&schemas.length>0){var obj={name:info.game.name,group:info.game.group,sub:GAME$3.REQUEST,schemas:schemas};updateSchemaList.push(obj)}if(info.game.sub=GAME$3.RESPONSE,current=getCurrent(info.game),info.typesResponse=current.types,(schemas=(schemas=current.schemas)&&Object.getOwnPropertyNames(schemas))&&schemas.length>0){obj={name:info.game.name,group:info.game.group,sub:GAME$3.RESPONSE,schemas:schemas};updateSchemaList.push(obj)}if((schemas=(schemas=(current=getCurrent({group:info.game.group,name:"packet",sub:GAME$3.RESPONSE})).schemas)&&Object.getOwnPropertyNames(schemas))&&schemas.length>0){obj={group:info.game.group,name:"packet",sub:GAME$3.RESPONSE,schemas:schemas};updateSchemaList.push(obj)}if(type.isValid(data,{noUndeclaredFields:!0})){var buffer=type.toBuffer(data);ws.send(buffer)}else logger$3.error("格式錯誤")}else logger$3.error("inGame data is undefined")})),socketio.on("toGame",(function(data){logger$3.info(ws.info.index+"[result]toGame");var game=ws.info.game;if(game){var type=typeResponse$1,packet=data.packet;if(data.funcIndex=-1,data.packet=null,data.schemas=[],type.isValid(data)){var format_1=null;if(packet){Object.getOwnPropertyNames(packet).forEach((function(name){console.log("packet."+name);var obj=packet[name];if("string"==typeof obj&&"{"!==obj[0])return!0;var info={group:game.group,name:name,sub:GAME$3.RESPONSE};"data"===name&&(info.name=game.name);var types=getCurrent(info).types;(format_1=checkData(types,obj,info,ws.updateSchema)).buf&&(packet[name]=format_1.buf,data.schemas.push({name:name,hash:format_1.id}))}));var obj=packet,info={group:game.group,name:"packet",sub:GAME$3.RESPONSE},types=getCurrent(info).types;(format_1=checkData(types,obj,info,ws.updateSchema)).buf&&(data.packet=format_1.buf,data.schemas.push({name:"packet",hash:format_1.id}))}var buffer=type.toBuffer(data);ws.send(buffer)}else logger$3.error("格式錯誤"),console.log(data)}else logger$3.error("未執行 inGame 命令")})),logger$3.info("open")}var socketioVideo=Object.freeze({__proto__:null,init:init$3,login:login$2,inGame:inGame$2,toGame:toGame$2,close:close$2,open:open$2}),namespace$8="game.agent.avro",name$8="UpdateSchemaRequest",type$8="record",doc$8=" 更新 schema (請求)",fields$8=[{doc:"索引",name:"funcIndex",type:"int"},{doc:"名稱",name:"name",type:"string"},{doc:"群組",name:"group",type:"string"},{doc:"訂閱",name:"sub",type:{type:"enum",symbols:["request","response"]}},{name:"schemas",type:{type:"array",items:"string"}}],UpdateSchemaRequest={namespace:namespace$8,name:name$8,type:type$8,doc:doc$8,fields:fields$8},namespace$9="game.agent.avro",name$9="UpdateSchemaResponse",type$9="record",doc$9=" 更新 schema (回應)",fields$9=[{doc:"索引",name:"funcIndex",type:"int"},{doc:"名稱",name:"name",type:"string"},{doc:"群組",name:"group",type:"string"},{doc:"訂閱",name:"sub",type:{type:"enum",symbols:["request","response"]}},{name:"schemas",doc:"資料描述",type:{type:"array",items:{name:"schema",type:"record",fields:[{name:"json",type:"string"},{name:"id",type:"string"}]}}}],UpdateSchemaResponse={namespace:namespace$9,name:name$9,type:type$9,doc:doc$9,fields:fields$9},typeRequest$3=avro.Type.forSchema(UpdateSchemaRequest),typeResponse$3=avro.Type.forSchema(UpdateSchemaResponse),logger$4={error:function(){},info:function(){}},proxy=null,procList=null,procCounts=0;function updateSchema(ws,info){logger$4.info(ws.info.index+"[update schema] "+info.group+" "+info.name+" "+info.sub),"number"!=typeof info.funcIndex&&(info.funcIndex=-1);var type=typeResponse$3,current=getCurrent(info);if(!info.schemas||!Array.isArray(info.schemas))return!1;var schemas=[];if(current.schemas){for(var i=0;i<info.schemas.length;i+=1){var id=info.schemas[i],schema=current.schemas[id];schema&&"string"==typeof schema?schemas.push({id:id,json:schema}):console.error("schema "+id+" is "+typeof schema)}info.schemas=schemas}else info.schemas=[];try{if(type.isValid(info,{noUndeclaredFields:!0})){var buffer=type.toBuffer(info);ws.send(buffer)}else logger$4.error("unknown format"),console.log(info)}catch(err){logger$4.error(err)}return!0}function init$4(config){logger$4=config.logger.child({module:"avro"});var filename=process.env.APP_CONFIG||"config/base.yml";console.log("config filename : "+filename);var baseConfig=null;if(fs.existsSync(filename))try{var data=fs.readFileSync(filename,"utf8");baseConfig=jsyaml.safeLoad(data)}catch(err){logger$4.error(err)}init(baseConfig,logger$4);var moduleName=process.env.PROXY_MODULE||"ioVideo";"ioGti"===moduleName?proxy=socketioGti:"ioVideo"===moduleName?proxy=socketioVideo:"wsGti"===moduleName&&(proxy=websocketGti),proxy?((procList=proxy.init(config)).push({name:"updateSchema",type:typeRequest$3,func:updateSchema}),procCounts=procList.length):logger$4.error("未知的模組名稱 moduleName : "+moduleName)}function open$3(ws){ws.updateSchema=function(info){updateSchema(ws,info)},proxy.open(ws,message)}function message(ws,view,isBinary){var buf=null;if(view){if(buf=Buffer.from(view),!ws.isConnected&&!ws.firstBuf)return void(ws.firstBuf=buf)}else buf=ws.firstBuf;for(var info=ws.info,i=0;i<procCounts;i+=1){var proc=procList[i];try{var value=proc.type.fromBuffer(buf);return proc.name&&logger$4.info(info.index+"[recv]"+proc.name),void proc.func(ws,value,buf)}catch(e){}}logger$4.error("[recv]未知的格式"),console.log(buf)}function close$3(ws,code,msg){proxy.close(ws)}var cmdAvro=Object.freeze({__proto__:null,init:init$4,open:open$3,close:close$3,message:message}),Agent$1=null,ActionType$1=null,CustomFormat$1=null,logger$5={error:function(){},info:function(){}},LoginRequest$2=null,LoginResponse$1=null,InGameRequest$2=null,InGameResponse$2=null,ToGameRequest$2=null,ToGameResponse$2=null,GameRequest=null,GameResponse=null,BroadcastResponse$2=null,utf8Decoder$1=null,utf8Encoder$1=null;function init$5(config){return __awaiter(this,void 0,void 0,(function(){var root;return __generator(this,(function(_a){return logger$5=config.logger,utf8Decoder$1=new TextDecoder,utf8Encoder$1=new TextEncoder,root=protobuf.Root.fromJSON(protocol),Agent$1=root.Game.Agent,ActionType$1=Agent$1.ActionType,CustomFormat$1=Agent$1.CustomFormat,LoginRequest$2=Agent$1.LoginRequest,LoginResponse$1=Agent$1.LoginResponse,InGameRequest$2=Agent$1.InGameRequest,InGameResponse$2=Agent$1.InGameResponse,ToGameRequest$2=Agent$1.ToGameRequest,ToGameResponse$2=Agent$1.ToGameResponse,GameRequest=Agent$1.GameRequest,GameResponse=Agent$1.GameResponse,BroadcastResponse$2=Agent$1.BroadcastResponse,[2]}))}))}var testTimeIndex=0,testTimeoutList=[50];function proxyLogin(ws,value){return __awaiter(this,void 0,void 0,(function(){var obj;return __generator(this,(function(_a){return obj=LoginRequest$2.toObject(value,{defaults:!0,arrays:!1,objects:!1,oneofs:!1}),console.log(obj),[2,new Promise((function(resolve,reject){var data={token:"abcd1234",resultCode:1};data.actionType=ActionType$1.LOGIN,data.funcIndex=obj.funcIndex;var err=LoginResponse$1.verify(data);if(err)logger$5.error(err),reject();else{var val=LoginResponse$1.create(data),buffer_1=LoginResponse$1.encode(val).finish(),timeout=testTimeoutList[testTimeIndex];(testTimeIndex+=1)>=testTimeoutList.length&&(testTimeIndex=0),setTimeout((function(){logger$5.info("傳送登入命令 data.funcIndex : "+data.funcIndex),ws.send(buffer_1,!0),resolve()}),timeout)}}))]}))}))}function proxyInGame(ws,value){return __awaiter(this,void 0,void 0,(function(){var obj,info;return __generator(this,(function(_a){return obj=InGameRequest$2.toObject(value,{defaults:!0,arrays:!1,objects:!1,oneofs:!1}),info=ws.info,[2,new Promise((function(resolve,reject){var data={resultCode:1};data.actionType=ActionType$1.INGAME,data.gid=obj.gid,data.funcIndex=obj.funcIndex;var game={};info[obj.gid]=game,game.gid=obj.gid,ws.service&&(ws.service.close(),delete ws.service);var service=new WebSocket("ws://127.0.0.1:3500/"+obj.group+"/"+obj.name);service.binaryType="arraybuffer",ws.service=service,service.on("open",(function(){logger$5.info("connect to game server");var err=InGameResponse$2.verify(data);if(err)logger$5.error(err),service.close(),delete ws.service,reject();else{var val=InGameResponse$2.create(data),buffer=InGameResponse$2.encode(val).finish();ws.send(buffer,!0),resolve()}})),service.on("error",(function(err){logger$5.error("service error"),logger$5.error(err),reject()})),service.on("close",(function(){logger$5.info("service disconnect"),delete ws.service})),service.on("message",(function(data){var view=new Uint8Array(data),buf=Buffer.from(view),value=GameResponse.decode(buf),packet=GameResponse.toObject(value,{defaults:!0,arrays:!1,objects:!1,oneofs:!1});logger$5.info("收到遊戲結果"),(data={}).actionType=ActionType$1.TOGAME,data.funcIndex=parseInt(packet.funcIndex)||0,data.gid=game.gid,data.resultCode=1,data.packet=packet;var err=ToGameResponse$2.verify(data);if(err)logger$5.error(err);else{var value_1=ToGameResponse$2.create(data),buffer_2=ToGameResponse$2.encode(value_1).finish();console.log("data size : "+buffer_2.length+" data.packet size : "+buf.length),console.log(data),setTimeout((function(){ws.send(buffer_2,!0),logger$5.info("傳送遊戲結果")}),2e3)}}))}))]}))}))}function proxyToGame(ws,value){return __awaiter(this,void 0,void 0,(function(){var obj,packet;return __generator(this,(function(_a){if(obj=ToGameRequest$2.toObject(value,{defaults:!0,arrays:!1,objects:!1,oneofs:!1}),console.log(obj),packet=obj.packet){packet.funcIndex=parseInt(obj.funcIndex)||0,function(){var _a;if(null===(_a=ws)||void 0===_a?void 0:_a.service){var value_2=GameRequest.create(packet),buf=GameRequest.encode(value_2).finish();console.log("data.packet size : "+buf.length),ws.service.send(buf)}}()}return[2]}))}))}function open$4(){logger$5.info("use protobuf")}function message$1(ws,view,isBinary){var buf=Buffer.from(view);try{if((value=ToGameRequest$2.decode(buf))&&value.actionType===ActionType$1.TOGAME)return logger$5.info("收到遊戲命令"),void proxyToGame(ws,value)}catch(e){}try{if((value=LoginRequest$2.decode(buf))&&value.actionType===ActionType$1.LOGIN)return logger$5.info("收到登入命令"),void proxyLogin(ws,value)}catch(e){}try{var value;return void((value=InGameRequest$2.decode(buf))&&value.actionType===ActionType$1.INGAME&&(logger$5.info("收到進入遊戲命令"),proxyInGame(ws,value)))}catch(e){}}function close$4(ws,code,message){ws.service&&(ws.service.close(),delete ws.service)}var cmdProtobuf=Object.freeze({__proto__:null,init:init$5,open:open$4,close:close$4,message:message$1}),logger$6=pino({redact:["key","token"],remove:!0,prettyPrint:{colorize:!0,translateTime:"SYS:yyyy-mm-dd HH:MM:ss.l o"}}),currentIndex=0,currentDay=lightFormat(new Date,"dd");function generateIndex(){var day=lightFormat(new Date,"dd");return currentDay!==day&&(currentIndex=0,currentDay=day),""+currentDay+(currentIndex+=1)}console.log("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");var meterSend=null,meterRecv=null,histogramSend=null,histogramRecv=null;init$4({logger:logger$6}),init$5({logger:logger$6});var port=parseInt(process.env.PORT)||4321;process.env.PROXY_SERVER||(process.env.PROXY_SERVER="http://localhost:11102/1.00.0");var App=uws.App;process.env.APP_USE_SSL&&"true"===process.env.APP_USE_SSL&&(App=uws.SSLApp);var listenSocket=null,app=App({ssl_prefer_low_memory_usage:!1,key_file_name:process.env.APP_KEY||"keys/test/server.key",cert_file_name:process.env.APP_CERT||"keys/test/server.crt",passphrase:process.env.APP_PASSPHRASE||"abcd1234"}).ws("/*",{compression:parseInt(process.env.APP_COMPRESSION||"1"),maxPayloadLength:4194304,idleTimeout:parseInt(process.env.APP_IDLE_TIMEOUT||"0"),open:function(ws,req){logger$6.info("A WebSocket connected via URL: "+req.getUrl()+"!");var channel=req.getUrl(),info={generateIndex:generateIndex,index:0};ws.info=info,"/avro"===channel?ws.cmdProxy=cmdAvro:"/protobuf"===channel&&(ws.cmdProxy=cmdProtobuf);var websocket={info:info,send:function(buf){var _a,_b;null===(_a=meterSend)||void 0===_a||_a.mark();var view=new Uint8Array(buf);null===(_b=histogramSend)||void 0===_b||_b.update(view.length),ws.send(buf,!0)},close:function(){if(logger$6.info(ws.info.index+" close"),!ws.info.isClosed){ws.info.isClosed=!0;try{ws.close()}catch(e){console.log(e)}}}};ws.websocket=websocket,ws.cmdProxy&&ws.cmdProxy.open(websocket)},message:function(ws,message,isBinary){var _a,_b,view=new Uint8Array(message);if(null===(_a=histogramRecv)||void 0===_a||_a.update(view.length),view.length<3||view.length>=4096)logger$6.error("收到指定範圍之外的資料");else{null===(_b=meterRecv)||void 0===_b||_b.mark();var websocket=ws.websocket;ws.cmdProxy&&ws.cmdProxy.message(websocket,view,isBinary)}},drain:function(ws){logger$6.info("WebSocket backpressure: "+ws.getBufferedAmount())},close:function(ws,code,message){logger$6.info(ws.info.index+" websocket closed"),ws.info.isClosed=!0;var websocket=ws.websocket;ws.cmdProxy&&ws.cmdProxy.close(websocket,code,message)}}).any("/*",(function(res,req){console.log("[any]"),console.log(req),res.end("Nothing to see here!")})).listen(port,(function(token){listenSocket=token,token?(logger$6.info("Listening to port "+port),!process.connected&&process.send&&process.send("ready")):logger$6.info("Failed to listen to port "+port)}));process.on("SIGINT",(function(){listenSocket&&(uws.us_listen_socket_close(listenSocket),listenSocket=null),process.exit(0)})),console.log(app);