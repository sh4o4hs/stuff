var abcd=function(exports){"use strict";function isPromise(obj){return!!obj&&(typeof obj==="object"||typeof obj==="function")&&typeof obj.then==="function"}function registerPromiseWorker(callback){function postOutgoingMessage(e,messageId,error,result){function postMessage(msg){if(typeof self.postMessage!=="function"){e.ports[0].postMessage(msg)}else{self.postMessage(msg)}}if(error){if(typeof console!=="undefined"&&"error"in console){console.error("Worker caught an error:",error)}postMessage([messageId,{message:error.message}])}else{postMessage([messageId,null,result])}}function tryCatchFunc(callback,message){try{return{res:callback(message)}}catch(e){return{err:e}}}function handleIncomingMessage(e,callback,messageId,message){var result=tryCatchFunc(callback,message);if(result.err){postOutgoingMessage(e,messageId,result.err)}else if(!isPromise(result.res)){postOutgoingMessage(e,messageId,null,result.res)}else{result.res.then((function(finalResult){postOutgoingMessage(e,messageId,null,finalResult)}),(function(finalError){postOutgoingMessage(e,messageId,finalError)}))}}function onIncomingMessage(e){var payload=e.data;if(!Array.isArray(payload)||payload.length!==2){return}var messageId=payload[0];var message=payload[1];if(typeof callback!=="function"){postOutgoingMessage(e,messageId,new Error("Please pass a function into register()."))}else{handleIncomingMessage(e,callback,messageId,message)}}self.addEventListener("message",onIncomingMessage)}var register=registerPromiseWorker;var global$1=typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{};var lookup=[];var revLookup=[];var Arr=typeof Uint8Array!=="undefined"?Uint8Array:Array;var inited=false;function init(){inited=true;var code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var i=0,len=code.length;i<len;++i){lookup[i]=code[i];revLookup[code.charCodeAt(i)]=i}revLookup["-".charCodeAt(0)]=62;revLookup["_".charCodeAt(0)]=63}function toByteArray(b64){if(!inited){init()}var i,j,l,tmp,placeHolders,arr;var len=b64.length;if(len%4>0){throw new Error("Invalid string. Length must be a multiple of 4")}placeHolders=b64[len-2]==="="?2:b64[len-1]==="="?1:0;arr=new Arr(len*3/4-placeHolders);l=placeHolders>0?len-4:len;var L=0;for(i=0,j=0;i<l;i+=4,j+=3){tmp=revLookup[b64.charCodeAt(i)]<<18|revLookup[b64.charCodeAt(i+1)]<<12|revLookup[b64.charCodeAt(i+2)]<<6|revLookup[b64.charCodeAt(i+3)];arr[L++]=tmp>>16&255;arr[L++]=tmp>>8&255;arr[L++]=tmp&255}if(placeHolders===2){tmp=revLookup[b64.charCodeAt(i)]<<2|revLookup[b64.charCodeAt(i+1)]>>4;arr[L++]=tmp&255}else if(placeHolders===1){tmp=revLookup[b64.charCodeAt(i)]<<10|revLookup[b64.charCodeAt(i+1)]<<4|revLookup[b64.charCodeAt(i+2)]>>2;arr[L++]=tmp>>8&255;arr[L++]=tmp&255}return arr}function tripletToBase64(num){return lookup[num>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[num&63]}function encodeChunk(uint8,start,end){var tmp;var output=[];for(var i=start;i<end;i+=3){tmp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2];output.push(tripletToBase64(tmp))}return output.join("")}function fromByteArray(uint8){if(!inited){init()}var tmp;var len=uint8.length;var extraBytes=len%3;var output="";var parts=[];var maxChunkLength=16383;for(var i=0,len2=len-extraBytes;i<len2;i+=maxChunkLength){parts.push(encodeChunk(uint8,i,i+maxChunkLength>len2?len2:i+maxChunkLength))}if(extraBytes===1){tmp=uint8[len-1];output+=lookup[tmp>>2];output+=lookup[tmp<<4&63];output+="=="}else if(extraBytes===2){tmp=(uint8[len-2]<<8)+uint8[len-1];output+=lookup[tmp>>10];output+=lookup[tmp>>4&63];output+=lookup[tmp<<2&63];output+="="}parts.push(output);return parts.join("")}function read(buffer,offset,isLE,mLen,nBytes){var e,m;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var nBits=-7;var i=isLE?nBytes-1:0;var d=isLE?-1:1;var s=buffer[offset+i];i+=d;e=s&(1<<-nBits)-1;s>>=-nBits;nBits+=eLen;for(;nBits>0;e=e*256+buffer[offset+i],i+=d,nBits-=8){}m=e&(1<<-nBits)-1;e>>=-nBits;nBits+=mLen;for(;nBits>0;m=m*256+buffer[offset+i],i+=d,nBits-=8){}if(e===0){e=1-eBias}else if(e===eMax){return m?NaN:(s?-1:1)*Infinity}else{m=m+Math.pow(2,mLen);e=e-eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)}function write(buffer,value,offset,isLE,mLen,nBytes){var e,m,c;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var rt=mLen===23?Math.pow(2,-24)-Math.pow(2,-77):0;var i=isLE?0:nBytes-1;var d=isLE?1:-1;var s=value<0||value===0&&1/value<0?1:0;value=Math.abs(value);if(isNaN(value)||value===Infinity){m=isNaN(value)?1:0;e=eMax}else{e=Math.floor(Math.log(value)/Math.LN2);if(value*(c=Math.pow(2,-e))<1){e--;c*=2}if(e+eBias>=1){value+=rt/c}else{value+=rt*Math.pow(2,1-eBias)}if(value*c>=2){e++;c/=2}if(e+eBias>=eMax){m=0;e=eMax}else if(e+eBias>=1){m=(value*c-1)*Math.pow(2,mLen);e=e+eBias}else{m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen);e=0}}for(;mLen>=8;buffer[offset+i]=m&255,i+=d,m/=256,mLen-=8){}e=e<<mLen|m;eLen+=mLen;for(;eLen>0;buffer[offset+i]=e&255,i+=d,e/=256,eLen-=8){}buffer[offset+i-d]|=s*128}var toString={}.toString;var isArray=Array.isArray||function(arr){return toString.call(arr)=="[object Array]"};var INSPECT_MAX_BYTES=50;Buffer.TYPED_ARRAY_SUPPORT=global$1.TYPED_ARRAY_SUPPORT!==undefined?global$1.TYPED_ARRAY_SUPPORT:true;var _kMaxLength=kMaxLength();function kMaxLength(){return Buffer.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function createBuffer(that,length){if(kMaxLength()<length){throw new RangeError("Invalid typed array length")}if(Buffer.TYPED_ARRAY_SUPPORT){that=new Uint8Array(length);that.__proto__=Buffer.prototype}else{if(that===null){that=new Buffer(length)}that.length=length}return that}function Buffer(arg,encodingOrOffset,length){if(!Buffer.TYPED_ARRAY_SUPPORT&&!(this instanceof Buffer)){return new Buffer(arg,encodingOrOffset,length)}if(typeof arg==="number"){if(typeof encodingOrOffset==="string"){throw new Error("If encoding is specified then the first argument must be a string")}return allocUnsafe(this,arg)}return from(this,arg,encodingOrOffset,length)}Buffer.poolSize=8192;Buffer._augment=function(arr){arr.__proto__=Buffer.prototype;return arr};function from(that,value,encodingOrOffset,length){if(typeof value==="number"){throw new TypeError('"value" argument must not be a number')}if(typeof ArrayBuffer!=="undefined"&&value instanceof ArrayBuffer){return fromArrayBuffer(that,value,encodingOrOffset,length)}if(typeof value==="string"){return fromString(that,value,encodingOrOffset)}return fromObject(that,value)}Buffer.from=function(value,encodingOrOffset,length){return from(null,value,encodingOrOffset,length)};if(Buffer.TYPED_ARRAY_SUPPORT){Buffer.prototype.__proto__=Uint8Array.prototype;Buffer.__proto__=Uint8Array}function assertSize(size){if(typeof size!=="number"){throw new TypeError('"size" argument must be a number')}else if(size<0){throw new RangeError('"size" argument must not be negative')}}function alloc(that,size,fill,encoding){assertSize(size);if(size<=0){return createBuffer(that,size)}if(fill!==undefined){return typeof encoding==="string"?createBuffer(that,size).fill(fill,encoding):createBuffer(that,size).fill(fill)}return createBuffer(that,size)}Buffer.alloc=function(size,fill,encoding){return alloc(null,size,fill,encoding)};function allocUnsafe(that,size){assertSize(size);that=createBuffer(that,size<0?0:checked(size)|0);if(!Buffer.TYPED_ARRAY_SUPPORT){for(var i=0;i<size;++i){that[i]=0}}return that}Buffer.allocUnsafe=function(size){return allocUnsafe(null,size)};Buffer.allocUnsafeSlow=function(size){return allocUnsafe(null,size)};function fromString(that,string,encoding){if(typeof encoding!=="string"||encoding===""){encoding="utf8"}if(!Buffer.isEncoding(encoding)){throw new TypeError('"encoding" must be a valid string encoding')}var length=byteLength(string,encoding)|0;that=createBuffer(that,length);var actual=that.write(string,encoding);if(actual!==length){that=that.slice(0,actual)}return that}function fromArrayLike(that,array){var length=array.length<0?0:checked(array.length)|0;that=createBuffer(that,length);for(var i=0;i<length;i+=1){that[i]=array[i]&255}return that}function fromArrayBuffer(that,array,byteOffset,length){array.byteLength;if(byteOffset<0||array.byteLength<byteOffset){throw new RangeError("'offset' is out of bounds")}if(array.byteLength<byteOffset+(length||0)){throw new RangeError("'length' is out of bounds")}if(byteOffset===undefined&&length===undefined){array=new Uint8Array(array)}else if(length===undefined){array=new Uint8Array(array,byteOffset)}else{array=new Uint8Array(array,byteOffset,length)}if(Buffer.TYPED_ARRAY_SUPPORT){that=array;that.__proto__=Buffer.prototype}else{that=fromArrayLike(that,array)}return that}function fromObject(that,obj){if(internalIsBuffer(obj)){var len=checked(obj.length)|0;that=createBuffer(that,len);if(that.length===0){return that}obj.copy(that,0,0,len);return that}if(obj){if(typeof ArrayBuffer!=="undefined"&&obj.buffer instanceof ArrayBuffer||"length"in obj){if(typeof obj.length!=="number"||isnan(obj.length)){return createBuffer(that,0)}return fromArrayLike(that,obj)}if(obj.type==="Buffer"&&isArray(obj.data)){return fromArrayLike(that,obj.data)}}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}function checked(length){if(length>=kMaxLength()){throw new RangeError("Attempt to allocate Buffer larger than maximum "+"size: 0x"+kMaxLength().toString(16)+" bytes")}return length|0}function SlowBuffer(length){if(+length!=length){length=0}return Buffer.alloc(+length)}Buffer.isBuffer=isBuffer;function internalIsBuffer(b){return!!(b!=null&&b._isBuffer)}Buffer.compare=function compare(a,b){if(!internalIsBuffer(a)||!internalIsBuffer(b)){throw new TypeError("Arguments must be Buffers")}if(a===b)return 0;var x=a.length;var y=b.length;for(var i=0,len=Math.min(x,y);i<len;++i){if(a[i]!==b[i]){x=a[i];y=b[i];break}}if(x<y)return-1;if(y<x)return 1;return 0};Buffer.isEncoding=function isEncoding(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return true;default:return false}};Buffer.concat=function concat(list,length){if(!isArray(list)){throw new TypeError('"list" argument must be an Array of Buffers')}if(list.length===0){return Buffer.alloc(0)}var i;if(length===undefined){length=0;for(i=0;i<list.length;++i){length+=list[i].length}}var buffer=Buffer.allocUnsafe(length);var pos=0;for(i=0;i<list.length;++i){var buf=list[i];if(!internalIsBuffer(buf)){throw new TypeError('"list" argument must be an Array of Buffers')}buf.copy(buffer,pos);pos+=buf.length}return buffer};function byteLength(string,encoding){if(internalIsBuffer(string)){return string.length}if(typeof ArrayBuffer!=="undefined"&&typeof ArrayBuffer.isView==="function"&&(ArrayBuffer.isView(string)||string instanceof ArrayBuffer)){return string.byteLength}if(typeof string!=="string"){string=""+string}var len=string.length;if(len===0)return 0;var loweredCase=false;for(;;){switch(encoding){case"ascii":case"latin1":case"binary":return len;case"utf8":case"utf-8":case undefined:return utf8ToBytes(string).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return len*2;case"hex":return len>>>1;case"base64":return base64ToBytes(string).length;default:if(loweredCase)return utf8ToBytes(string).length;encoding=(""+encoding).toLowerCase();loweredCase=true}}}Buffer.byteLength=byteLength;function slowToString(encoding,start,end){var loweredCase=false;if(start===undefined||start<0){start=0}if(start>this.length){return""}if(end===undefined||end>this.length){end=this.length}if(end<=0){return""}end>>>=0;start>>>=0;if(end<=start){return""}if(!encoding)encoding="utf8";while(true){switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"latin1":case"binary":return latin1Slice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase();loweredCase=true}}}Buffer.prototype._isBuffer=true;function swap(b,n,m){var i=b[n];b[n]=b[m];b[m]=i}Buffer.prototype.swap16=function swap16(){var len=this.length;if(len%2!==0){throw new RangeError("Buffer size must be a multiple of 16-bits")}for(var i=0;i<len;i+=2){swap(this,i,i+1)}return this};Buffer.prototype.swap32=function swap32(){var len=this.length;if(len%4!==0){throw new RangeError("Buffer size must be a multiple of 32-bits")}for(var i=0;i<len;i+=4){swap(this,i,i+3);swap(this,i+1,i+2)}return this};Buffer.prototype.swap64=function swap64(){var len=this.length;if(len%8!==0){throw new RangeError("Buffer size must be a multiple of 64-bits")}for(var i=0;i<len;i+=8){swap(this,i,i+7);swap(this,i+1,i+6);swap(this,i+2,i+5);swap(this,i+3,i+4)}return this};Buffer.prototype.toString=function toString(){var length=this.length|0;if(length===0)return"";if(arguments.length===0)return utf8Slice(this,0,length);return slowToString.apply(this,arguments)};Buffer.prototype.equals=function equals(b){if(!internalIsBuffer(b))throw new TypeError("Argument must be a Buffer");if(this===b)return true;return Buffer.compare(this,b)===0};Buffer.prototype.inspect=function inspect(){var str="";var max=INSPECT_MAX_BYTES;if(this.length>0){str=this.toString("hex",0,max).match(/.{2}/g).join(" ");if(this.length>max)str+=" ... "}return"<Buffer "+str+">"};Buffer.prototype.compare=function compare(target,start,end,thisStart,thisEnd){if(!internalIsBuffer(target)){throw new TypeError("Argument must be a Buffer")}if(start===undefined){start=0}if(end===undefined){end=target?target.length:0}if(thisStart===undefined){thisStart=0}if(thisEnd===undefined){thisEnd=this.length}if(start<0||end>target.length||thisStart<0||thisEnd>this.length){throw new RangeError("out of range index")}if(thisStart>=thisEnd&&start>=end){return 0}if(thisStart>=thisEnd){return-1}if(start>=end){return 1}start>>>=0;end>>>=0;thisStart>>>=0;thisEnd>>>=0;if(this===target)return 0;var x=thisEnd-thisStart;var y=end-start;var len=Math.min(x,y);var thisCopy=this.slice(thisStart,thisEnd);var targetCopy=target.slice(start,end);for(var i=0;i<len;++i){if(thisCopy[i]!==targetCopy[i]){x=thisCopy[i];y=targetCopy[i];break}}if(x<y)return-1;if(y<x)return 1;return 0};function bidirectionalIndexOf(buffer,val,byteOffset,encoding,dir){if(buffer.length===0)return-1;if(typeof byteOffset==="string"){encoding=byteOffset;byteOffset=0}else if(byteOffset>2147483647){byteOffset=2147483647}else if(byteOffset<-2147483648){byteOffset=-2147483648}byteOffset=+byteOffset;if(isNaN(byteOffset)){byteOffset=dir?0:buffer.length-1}if(byteOffset<0)byteOffset=buffer.length+byteOffset;if(byteOffset>=buffer.length){if(dir)return-1;else byteOffset=buffer.length-1}else if(byteOffset<0){if(dir)byteOffset=0;else return-1}if(typeof val==="string"){val=Buffer.from(val,encoding)}if(internalIsBuffer(val)){if(val.length===0){return-1}return arrayIndexOf(buffer,val,byteOffset,encoding,dir)}else if(typeof val==="number"){val=val&255;if(Buffer.TYPED_ARRAY_SUPPORT&&typeof Uint8Array.prototype.indexOf==="function"){if(dir){return Uint8Array.prototype.indexOf.call(buffer,val,byteOffset)}else{return Uint8Array.prototype.lastIndexOf.call(buffer,val,byteOffset)}}return arrayIndexOf(buffer,[val],byteOffset,encoding,dir)}throw new TypeError("val must be string, number or Buffer")}function arrayIndexOf(arr,val,byteOffset,encoding,dir){var indexSize=1;var arrLength=arr.length;var valLength=val.length;if(encoding!==undefined){encoding=String(encoding).toLowerCase();if(encoding==="ucs2"||encoding==="ucs-2"||encoding==="utf16le"||encoding==="utf-16le"){if(arr.length<2||val.length<2){return-1}indexSize=2;arrLength/=2;valLength/=2;byteOffset/=2}}function read(buf,i){if(indexSize===1){return buf[i]}else{return buf.readUInt16BE(i*indexSize)}}var i;if(dir){var foundIndex=-1;for(i=byteOffset;i<arrLength;i++){if(read(arr,i)===read(val,foundIndex===-1?0:i-foundIndex)){if(foundIndex===-1)foundIndex=i;if(i-foundIndex+1===valLength)return foundIndex*indexSize}else{if(foundIndex!==-1)i-=i-foundIndex;foundIndex=-1}}}else{if(byteOffset+valLength>arrLength)byteOffset=arrLength-valLength;for(i=byteOffset;i>=0;i--){var found=true;for(var j=0;j<valLength;j++){if(read(arr,i+j)!==read(val,j)){found=false;break}}if(found)return i}}return-1}Buffer.prototype.includes=function includes(val,byteOffset,encoding){return this.indexOf(val,byteOffset,encoding)!==-1};Buffer.prototype.indexOf=function indexOf(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,true)};Buffer.prototype.lastIndexOf=function lastIndexOf(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,false)};function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;if(!length){length=remaining}else{length=Number(length);if(length>remaining){length=remaining}}var strLen=string.length;if(strLen%2!==0)throw new TypeError("Invalid hex string");if(length>strLen/2){length=strLen/2}for(var i=0;i<length;++i){var parsed=parseInt(string.substr(i*2,2),16);if(isNaN(parsed))return i;buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(asciiToBytes(string),buf,offset,length)}function latin1Write(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(utf16leToBytes(string,buf.length-offset),buf,offset,length)}Buffer.prototype.write=function write(string,offset,length,encoding){if(offset===undefined){encoding="utf8";length=this.length;offset=0}else if(length===undefined&&typeof offset==="string"){encoding=offset;length=this.length;offset=0}else if(isFinite(offset)){offset=offset|0;if(isFinite(length)){length=length|0;if(encoding===undefined)encoding="utf8"}else{encoding=length;length=undefined}}else{throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported")}var remaining=this.length-offset;if(length===undefined||length>remaining)length=remaining;if(string.length>0&&(length<0||offset<0)||offset>this.length){throw new RangeError("Attempt to write outside buffer bounds")}if(!encoding)encoding="utf8";var loweredCase=false;for(;;){switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"latin1":case"binary":return latin1Write(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase();loweredCase=true}}};Buffer.prototype.toJSON=function toJSON(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function base64Slice(buf,start,end){if(start===0&&end===buf.length){return fromByteArray(buf)}else{return fromByteArray(buf.slice(start,end))}}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);var res=[];var i=start;while(i<end){var firstByte=buf[i];var codePoint=null;var bytesPerSequence=firstByte>239?4:firstByte>223?3:firstByte>191?2:1;if(i+bytesPerSequence<=end){var secondByte,thirdByte,fourthByte,tempCodePoint;switch(bytesPerSequence){case 1:if(firstByte<128){codePoint=firstByte}break;case 2:secondByte=buf[i+1];if((secondByte&192)===128){tempCodePoint=(firstByte&31)<<6|secondByte&63;if(tempCodePoint>127){codePoint=tempCodePoint}}break;case 3:secondByte=buf[i+1];thirdByte=buf[i+2];if((secondByte&192)===128&&(thirdByte&192)===128){tempCodePoint=(firstByte&15)<<12|(secondByte&63)<<6|thirdByte&63;if(tempCodePoint>2047&&(tempCodePoint<55296||tempCodePoint>57343)){codePoint=tempCodePoint}}break;case 4:secondByte=buf[i+1];thirdByte=buf[i+2];fourthByte=buf[i+3];if((secondByte&192)===128&&(thirdByte&192)===128&&(fourthByte&192)===128){tempCodePoint=(firstByte&15)<<18|(secondByte&63)<<12|(thirdByte&63)<<6|fourthByte&63;if(tempCodePoint>65535&&tempCodePoint<1114112){codePoint=tempCodePoint}}}}if(codePoint===null){codePoint=65533;bytesPerSequence=1}else if(codePoint>65535){codePoint-=65536;res.push(codePoint>>>10&1023|55296);codePoint=56320|codePoint&1023}res.push(codePoint);i+=bytesPerSequence}return decodeCodePointsArray(res)}var MAX_ARGUMENTS_LENGTH=4096;function decodeCodePointsArray(codePoints){var len=codePoints.length;if(len<=MAX_ARGUMENTS_LENGTH){return String.fromCharCode.apply(String,codePoints)}var res="";var i=0;while(i<len){res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=MAX_ARGUMENTS_LENGTH))}return res}function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i){ret+=String.fromCharCode(buf[i]&127)}return ret}function latin1Slice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i){ret+=String.fromCharCode(buf[i])}return ret}function hexSlice(buf,start,end){var len=buf.length;if(!start||start<0)start=0;if(!end||end<0||end>len)end=len;var out="";for(var i=start;i<end;++i){out+=toHex(buf[i])}return out}function utf16leSlice(buf,start,end){var bytes=buf.slice(start,end);var res="";for(var i=0;i<bytes.length;i+=2){res+=String.fromCharCode(bytes[i]+bytes[i+1]*256)}return res}Buffer.prototype.slice=function slice(start,end){var len=this.length;start=~~start;end=end===undefined?len:~~end;if(start<0){start+=len;if(start<0)start=0}else if(start>len){start=len}if(end<0){end+=len;if(end<0)end=0}else if(end>len){end=len}if(end<start)end=start;var newBuf;if(Buffer.TYPED_ARRAY_SUPPORT){newBuf=this.subarray(start,end);newBuf.__proto__=Buffer.prototype}else{var sliceLen=end-start;newBuf=new Buffer(sliceLen,undefined);for(var i=0;i<sliceLen;++i){newBuf[i]=this[i+start]}}return newBuf};function checkOffset(offset,ext,length){if(offset%1!==0||offset<0)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}Buffer.prototype.readUIntLE=function readUIntLE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;while(++i<byteLength&&(mul*=256)){val+=this[offset+i]*mul}return val};Buffer.prototype.readUIntBE=function readUIntBE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert){checkOffset(offset,byteLength,this.length)}var val=this[offset+--byteLength];var mul=1;while(byteLength>0&&(mul*=256)){val+=this[offset+--byteLength]*mul}return val};Buffer.prototype.readUInt8=function readUInt8(offset,noAssert){if(!noAssert)checkOffset(offset,1,this.length);return this[offset]};Buffer.prototype.readUInt16LE=function readUInt16LE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);return this[offset]|this[offset+1]<<8};Buffer.prototype.readUInt16BE=function readUInt16BE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);return this[offset]<<8|this[offset+1]};Buffer.prototype.readUInt32LE=function readUInt32LE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+this[offset+3]*16777216};Buffer.prototype.readUInt32BE=function readUInt32BE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return this[offset]*16777216+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])};Buffer.prototype.readIntLE=function readIntLE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;while(++i<byteLength&&(mul*=256)){val+=this[offset+i]*mul}mul*=128;if(val>=mul)val-=Math.pow(2,8*byteLength);return val};Buffer.prototype.readIntBE=function readIntBE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkOffset(offset,byteLength,this.length);var i=byteLength;var mul=1;var val=this[offset+--i];while(i>0&&(mul*=256)){val+=this[offset+--i]*mul}mul*=128;if(val>=mul)val-=Math.pow(2,8*byteLength);return val};Buffer.prototype.readInt8=function readInt8(offset,noAssert){if(!noAssert)checkOffset(offset,1,this.length);if(!(this[offset]&128))return this[offset];return(255-this[offset]+1)*-1};Buffer.prototype.readInt16LE=function readInt16LE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return val&32768?val|4294901760:val};Buffer.prototype.readInt16BE=function readInt16BE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return val&32768?val|4294901760:val};Buffer.prototype.readInt32LE=function readInt32LE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24};Buffer.prototype.readInt32BE=function readInt32BE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]};Buffer.prototype.readFloatLE=function readFloatLE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return read(this,offset,true,23,4)};Buffer.prototype.readFloatBE=function readFloatBE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return read(this,offset,false,23,4)};Buffer.prototype.readDoubleLE=function readDoubleLE(offset,noAssert){if(!noAssert)checkOffset(offset,8,this.length);return read(this,offset,true,52,8)};Buffer.prototype.readDoubleBE=function readDoubleBE(offset,noAssert){if(!noAssert)checkOffset(offset,8,this.length);return read(this,offset,false,52,8)};function checkInt(buf,value,offset,ext,max,min){if(!internalIsBuffer(buf))throw new TypeError('"buffer" argument must be a Buffer instance');if(value>max||value<min)throw new RangeError('"value" argument is out of bounds');if(offset+ext>buf.length)throw new RangeError("Index out of range")}Buffer.prototype.writeUIntLE=function writeUIntLE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;byteLength=byteLength|0;if(!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var mul=1;var i=0;this[offset]=value&255;while(++i<byteLength&&(mul*=256)){this[offset+i]=value/mul&255}return offset+byteLength};Buffer.prototype.writeUIntBE=function writeUIntBE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;byteLength=byteLength|0;if(!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var i=byteLength-1;var mul=1;this[offset+i]=value&255;while(--i>=0&&(mul*=256)){this[offset+i]=value/mul&255}return offset+byteLength};Buffer.prototype.writeUInt8=function writeUInt8(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,1,255,0);if(!Buffer.TYPED_ARRAY_SUPPORT)value=Math.floor(value);this[offset]=value&255;return offset+1};function objectWriteUInt16(buf,value,offset,littleEndian){if(value<0)value=65535+value+1;for(var i=0,j=Math.min(buf.length-offset,2);i<j;++i){buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>(littleEndian?i:1-i)*8}}Buffer.prototype.writeUInt16LE=function writeUInt16LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,65535,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value&255;this[offset+1]=value>>>8}else{objectWriteUInt16(this,value,offset,true)}return offset+2};Buffer.prototype.writeUInt16BE=function writeUInt16BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,65535,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>8;this[offset+1]=value&255}else{objectWriteUInt16(this,value,offset,false)}return offset+2};function objectWriteUInt32(buf,value,offset,littleEndian){if(value<0)value=4294967295+value+1;for(var i=0,j=Math.min(buf.length-offset,4);i<j;++i){buf[offset+i]=value>>>(littleEndian?i:3-i)*8&255}}Buffer.prototype.writeUInt32LE=function writeUInt32LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,4294967295,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset+3]=value>>>24;this[offset+2]=value>>>16;this[offset+1]=value>>>8;this[offset]=value&255}else{objectWriteUInt32(this,value,offset,true)}return offset+4};Buffer.prototype.writeUInt32BE=function writeUInt32BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,4294967295,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>24;this[offset+1]=value>>>16;this[offset+2]=value>>>8;this[offset+3]=value&255}else{objectWriteUInt32(this,value,offset,false)}return offset+4};Buffer.prototype.writeIntLE=function writeIntLE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;if(!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0;var mul=1;var sub=0;this[offset]=value&255;while(++i<byteLength&&(mul*=256)){if(value<0&&sub===0&&this[offset+i-1]!==0){sub=1}this[offset+i]=(value/mul>>0)-sub&255}return offset+byteLength};Buffer.prototype.writeIntBE=function writeIntBE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;if(!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1;var mul=1;var sub=0;this[offset+i]=value&255;while(--i>=0&&(mul*=256)){if(value<0&&sub===0&&this[offset+i+1]!==0){sub=1}this[offset+i]=(value/mul>>0)-sub&255}return offset+byteLength};Buffer.prototype.writeInt8=function writeInt8(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,1,127,-128);if(!Buffer.TYPED_ARRAY_SUPPORT)value=Math.floor(value);if(value<0)value=255+value+1;this[offset]=value&255;return offset+1};Buffer.prototype.writeInt16LE=function writeInt16LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,32767,-32768);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value&255;this[offset+1]=value>>>8}else{objectWriteUInt16(this,value,offset,true)}return offset+2};Buffer.prototype.writeInt16BE=function writeInt16BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,32767,-32768);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>8;this[offset+1]=value&255}else{objectWriteUInt16(this,value,offset,false)}return offset+2};Buffer.prototype.writeInt32LE=function writeInt32LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,2147483647,-2147483648);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value&255;this[offset+1]=value>>>8;this[offset+2]=value>>>16;this[offset+3]=value>>>24}else{objectWriteUInt32(this,value,offset,true)}return offset+4};Buffer.prototype.writeInt32BE=function writeInt32BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,2147483647,-2147483648);if(value<0)value=4294967295+value+1;if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>24;this[offset+1]=value>>>16;this[offset+2]=value>>>8;this[offset+3]=value&255}else{objectWriteUInt32(this,value,offset,false)}return offset+4};function checkIEEE754(buf,value,offset,ext,max,min){if(offset+ext>buf.length)throw new RangeError("Index out of range");if(offset<0)throw new RangeError("Index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){if(!noAssert){checkIEEE754(buf,value,offset,4)}write(buf,value,offset,littleEndian,23,4);return offset+4}Buffer.prototype.writeFloatLE=function writeFloatLE(value,offset,noAssert){return writeFloat(this,value,offset,true,noAssert)};Buffer.prototype.writeFloatBE=function writeFloatBE(value,offset,noAssert){return writeFloat(this,value,offset,false,noAssert)};function writeDouble(buf,value,offset,littleEndian,noAssert){if(!noAssert){checkIEEE754(buf,value,offset,8)}write(buf,value,offset,littleEndian,52,8);return offset+8}Buffer.prototype.writeDoubleLE=function writeDoubleLE(value,offset,noAssert){return writeDouble(this,value,offset,true,noAssert)};Buffer.prototype.writeDoubleBE=function writeDoubleBE(value,offset,noAssert){return writeDouble(this,value,offset,false,noAssert)};Buffer.prototype.copy=function copy(target,targetStart,start,end){if(!start)start=0;if(!end&&end!==0)end=this.length;if(targetStart>=target.length)targetStart=target.length;if(!targetStart)targetStart=0;if(end>0&&end<start)end=start;if(end===start)return 0;if(target.length===0||this.length===0)return 0;if(targetStart<0){throw new RangeError("targetStart out of bounds")}if(start<0||start>=this.length)throw new RangeError("sourceStart out of bounds");if(end<0)throw new RangeError("sourceEnd out of bounds");if(end>this.length)end=this.length;if(target.length-targetStart<end-start){end=target.length-targetStart+start}var len=end-start;var i;if(this===target&&start<targetStart&&targetStart<end){for(i=len-1;i>=0;--i){target[i+targetStart]=this[i+start]}}else if(len<1e3||!Buffer.TYPED_ARRAY_SUPPORT){for(i=0;i<len;++i){target[i+targetStart]=this[i+start]}}else{Uint8Array.prototype.set.call(target,this.subarray(start,start+len),targetStart)}return len};Buffer.prototype.fill=function fill(val,start,end,encoding){if(typeof val==="string"){if(typeof start==="string"){encoding=start;start=0;end=this.length}else if(typeof end==="string"){encoding=end;end=this.length}if(val.length===1){var code=val.charCodeAt(0);if(code<256){val=code}}if(encoding!==undefined&&typeof encoding!=="string"){throw new TypeError("encoding must be a string")}if(typeof encoding==="string"&&!Buffer.isEncoding(encoding)){throw new TypeError("Unknown encoding: "+encoding)}}else if(typeof val==="number"){val=val&255}if(start<0||this.length<start||this.length<end){throw new RangeError("Out of range index")}if(end<=start){return this}start=start>>>0;end=end===undefined?this.length:end>>>0;if(!val)val=0;var i;if(typeof val==="number"){for(i=start;i<end;++i){this[i]=val}}else{var bytes=internalIsBuffer(val)?val:utf8ToBytes(new Buffer(val,encoding).toString());var len=bytes.length;for(i=0;i<end-start;++i){this[i+start]=bytes[i%len]}}return this};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g;function base64clean(str){str=stringtrim(str).replace(INVALID_BASE64_RE,"");if(str.length<2)return"";while(str.length%4!==0){str=str+"="}return str}function stringtrim(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,"")}function toHex(n){if(n<16)return"0"+n.toString(16);return n.toString(16)}function utf8ToBytes(string,units){units=units||Infinity;var codePoint;var length=string.length;var leadSurrogate=null;var bytes=[];for(var i=0;i<length;++i){codePoint=string.charCodeAt(i);if(codePoint>55295&&codePoint<57344){if(!leadSurrogate){if(codePoint>56319){if((units-=3)>-1)bytes.push(239,191,189);continue}else if(i+1===length){if((units-=3)>-1)bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(codePoint<56320){if((units-=3)>-1)bytes.push(239,191,189);leadSurrogate=codePoint;continue}codePoint=(leadSurrogate-55296<<10|codePoint-56320)+65536}else if(leadSurrogate){if((units-=3)>-1)bytes.push(239,191,189)}leadSurrogate=null;if(codePoint<128){if((units-=1)<0)break;bytes.push(codePoint)}else if(codePoint<2048){if((units-=2)<0)break;bytes.push(codePoint>>6|192,codePoint&63|128)}else if(codePoint<65536){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,codePoint&63|128)}else if(codePoint<1114112){if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,codePoint&63|128)}else{throw new Error("Invalid code point")}}return bytes}function asciiToBytes(str){var byteArray=[];for(var i=0;i<str.length;++i){byteArray.push(str.charCodeAt(i)&255)}return byteArray}function utf16leToBytes(str,units){var c,hi,lo;var byteArray=[];for(var i=0;i<str.length;++i){if((units-=2)<0)break;c=str.charCodeAt(i);hi=c>>8;lo=c%256;byteArray.push(lo);byteArray.push(hi)}return byteArray}function base64ToBytes(str){return toByteArray(base64clean(str))}function blitBuffer(src,dst,offset,length){for(var i=0;i<length;++i){if(i+offset>=dst.length||i>=src.length)break;dst[i+offset]=src[i]}return i}function isnan(val){return val!==val}function isBuffer(obj){return obj!=null&&(!!obj._isBuffer||isFastBuffer(obj)||isSlowBuffer(obj))}function isFastBuffer(obj){return!!obj.constructor&&typeof obj.constructor.isBuffer==="function"&&obj.constructor.isBuffer(obj)}function isSlowBuffer(obj){return typeof obj.readFloatLE==="function"&&typeof obj.slice==="function"&&isFastBuffer(obj.slice(0,0))}var bufferEs6=Object.freeze({__proto__:null,INSPECT_MAX_BYTES:INSPECT_MAX_BYTES,kMaxLength:_kMaxLength,Buffer:Buffer,SlowBuffer:SlowBuffer,isBuffer:isBuffer});function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}var cachedSetTimeout=defaultSetTimout;var cachedClearTimeout=defaultClearTimeout;if(typeof global$1.setTimeout==="function"){cachedSetTimeout=setTimeout}if(typeof global$1.clearTimeout==="function"){cachedClearTimeout=clearTimeout}function runTimeout(fun){if(cachedSetTimeout===setTimeout){return setTimeout(fun,0)}if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0)}try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){return clearTimeout(marker)}if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker)}try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue)}else{queueIndex=-1}if(queue.length){drainQueue()}}function drainQueue(){if(draining){return}var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run()}}queueIndex=-1;len=queue.length}currentQueue=null;draining=false;runClearTimeout(timeout)}function nextTick(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue)}}function Item(fun,array){this.fun=fun;this.array=array}Item.prototype.run=function(){this.fun.apply(null,this.array)};var performance$1=global$1.performance||{};var performanceNow=performance$1.now||performance$1.mozNow||performance$1.msNow||performance$1.oNow||performance$1.webkitNow||function(){return(new Date).getTime()};var fs={};var inherits;if(typeof Object.create==="function"){inherits=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}}else{inherits=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor;ctor.prototype.constructor=ctor}}var inherits$1=inherits;var formatRegExp=/%[sdj%]/g;function format(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]))}return objects.join(" ")}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,(function(x){if(x==="%%")return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}}));for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=" "+x}else{str+=" "+inspect(x)}}return str}function deprecate(fn,msg){if(isUndefined(global$1.process)){return function(){return deprecate(fn,msg).apply(this,arguments)}}var warned=false;function deprecated(){if(!warned){{console.error(msg)}warned=true}return fn.apply(this,arguments)}return deprecated}var debugs={};var debugEnviron;function debuglog(set){if(isUndefined(debugEnviron))debugEnviron="";set=set.toUpperCase();if(!debugs[set]){if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=0;debugs[set]=function(){var msg=format.apply(null,arguments);console.error("%s %d: %s",set,pid,msg)}}else{debugs[set]=function(){}}}return debugs[set]}function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts}else if(opts){_extend(ctx,opts)}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth)}inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]};inspect.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m"}else{return str}}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};array.forEach((function(val,idx){hash[val]=true}));return hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes)}return ret}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive}var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value)}if(isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0)){return formatError(value)}if(keys.length===0){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),"date")}if(isError(value)){return formatError(value)}}var base="",array=false,braces=["{","}"];if(isArray$1(value)){array=true;braces=["[","]"]}if(isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)){base=" "+RegExp.prototype.toString.call(value)}if(isDate(value)){base=" "+Date.prototype.toUTCString.call(value)}if(isError(value)){base=" "+formatError(value)}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1]}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}else{return ctx.stylize("[Object]","special")}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys)}else{output=keys.map((function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)}))}ctx.seen.pop();return reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}if(isNumber(value))return ctx.stylize(""+value,"number");if(isBoolean(value))return ctx.stylize(""+value,"boolean");if(isNull(value))return ctx.stylize("null","null")}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true))}else{output.push("")}}keys.forEach((function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true))}}));return output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize("[Getter/Setter]","special")}else{str=ctx.stylize("[Getter]","special")}}else{if(desc.set){str=ctx.stylize("[Setter]","special")}}if(!hasOwnProperty(visibleKeys,key)){name="["+key+"]"}if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null)}else{str=formatValue(ctx,desc.value,recurseTimes-1)}if(str.indexOf("\n")>-1){if(array){str=str.split("\n").map((function(line){return"  "+line})).join("\n").substr(2)}else{str="\n"+str.split("\n").map((function(line){return"   "+line})).join("\n")}}}else{str=ctx.stylize("[Circular]","special")}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str}name=JSON.stringify(""+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,"name")}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,"string")}}return name+": "+str}function reduceToSingleString(output,base,braces){var length=output.reduce((function(prev,cur){if(cur.indexOf("\n")>=0);return prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1}),0);if(length>60){return braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]}return braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray$1(ar){return Array.isArray(ar)}function isBoolean(arg){return typeof arg==="boolean"}function isNull(arg){return arg===null}function isNullOrUndefined(arg){return arg==null}function isNumber(arg){return typeof arg==="number"}function isString(arg){return typeof arg==="string"}function isSymbol(arg){return typeof arg==="symbol"}function isUndefined(arg){return arg===void 0}function isRegExp(re){return isObject(re)&&objectToString(re)==="[object RegExp]"}function isObject(arg){return typeof arg==="object"&&arg!==null}function isDate(d){return isObject(d)&&objectToString(d)==="[object Date]"}function isError(e){return isObject(e)&&(objectToString(e)==="[object Error]"||e instanceof Error)}function isFunction(arg){return typeof arg==="function"}function isPrimitive(arg){return arg===null||typeof arg==="boolean"||typeof arg==="number"||typeof arg==="string"||typeof arg==="symbol"||typeof arg==="undefined"}function isBuffer$1(maybeBuf){return isBuffer(maybeBuf)}function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var d=new Date;var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}function log(){console.log("%s - %s",timestamp(),format.apply(null,arguments))}function _extend(origin,add){if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]]}return origin}function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}var util={inherits:inherits$1,_extend:_extend,log:log,isBuffer:isBuffer$1,isPrimitive:isPrimitive,isFunction:isFunction,isError:isError,isDate:isDate,isObject:isObject,isRegExp:isRegExp,isUndefined:isUndefined,isSymbol:isSymbol,isString:isString,isNumber:isNumber,isNullOrUndefined:isNullOrUndefined,isNull:isNull,isBoolean:isBoolean,isArray:isArray$1,inspect:inspect,deprecate:deprecate,format:format,debuglog:debuglog};var POOL=new BufferPool(4096);function newBuffer(size){if(typeof Buffer.alloc=="function"){return Buffer.alloc(size)}else{return new Buffer(size)}}function bufferFrom(data,enc){if(typeof Buffer.from=="function"){return Buffer.from(data,enc)}else{return new Buffer(data,enc)}}function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1)}function compare(n1,n2){return n1===n2?0:n1<n2?-1:1}function getOption(opts,key,def){var value=opts[key];return value===undefined?def:value}function getHash(str,algorithm){algorithm=algorithm||"md5";var hash=fs.createHash(algorithm);hash.end(str);return hash.read()}function singleIndexOf(arr,v){var pos=-1;var i,l;if(!arr){return-1}for(i=0,l=arr.length;i<l;i++){if(arr[i]===v){if(pos>=0){return-2}pos=i}}return pos}function toMap(arr,fn){var obj={};var i,elem;for(i=0;i<arr.length;i++){elem=arr[i];obj[fn(elem)]=elem}return obj}function objectValues(obj){return Object.keys(obj).map((function(key){return obj[key]}))}function hasDuplicates(arr,fn){var obj=Object.create(null);var i,l,elem;for(i=0,l=arr.length;i<l;i++){elem=arr[i];if(fn){elem=fn(elem)}if(obj[elem]){return true}obj[elem]=true}return false}function copyOwnProperties(src,dst,overwrite){var names=Object.getOwnPropertyNames(src);var i,l,name;for(i=0,l=names.length;i<l;i++){name=names[i];if(!dst.hasOwnProperty(name)||overwrite){var descriptor=Object.getOwnPropertyDescriptor(src,name);Object.defineProperty(dst,name,descriptor)}}return dst}function jsonEnd(str,pos){pos=pos|0;var c=str.charAt(pos++);if(/[\d-]/.test(c)){while(/[eE\d.+-]/.test(str.charAt(pos))){pos++}return pos}else if(/true|null/.test(str.slice(pos-1,pos+3))){return pos+3}else if(/false/.test(str.slice(pos-1,pos+4))){return pos+4}var depth=0;var literal=false;do{switch(c){case"{":case"[":if(!literal){depth++}break;case"}":case"]":if(!literal&&!--depth){return pos}break;case'"':literal=!literal;if(!depth&&!literal){return pos}break;case"\\":pos++}}while(c=str.charAt(pos++));return-1}function abstractFunction(){throw new Error("abstract")}function addDeprecatedGetters(obj,props){var proto=obj.prototype;var i,l,prop,getter;for(i=0,l=props.length;i<l;i++){prop=props[i];getter="get"+capitalize(prop);proto[getter]=util.deprecate(createGetter(prop),"use `."+prop+"` instead of `."+getter+"()`")}function createGetter(prop){return function(){var delegate=this[prop];return typeof delegate=="function"?delegate.apply(this,arguments):delegate}}}function BufferPool(len){this._len=len|0;this._pos=0;this._slab=newBuffer(this._len)}BufferPool.prototype.alloc=function(len){if(len<0){throw new Error("negative length")}var maxLen=this._len;if(len>maxLen){return newBuffer(len)}if(this._pos+len>maxLen){this._slab=newBuffer(maxLen);this._pos=0}return this._slab.slice(this._pos,this._pos+=len)};function Lcg(seed){var a=1103515245;var c=12345;var m=Math.pow(2,31);var state=Math.floor(seed||Math.random()*(m-1));this._max=m;this._nextInt=function(){return state=(a*state+c)%m}}Lcg.prototype.nextBoolean=function(){return!!(this._nextInt()%2)};Lcg.prototype.nextInt=function(start,end){if(end===undefined){end=start;start=0}end=end===undefined?this._max:end;return start+Math.floor(this.nextFloat()*(end-start))};Lcg.prototype.nextFloat=function(start,end){if(end===undefined){end=start;start=0}end=end===undefined?1:end;return start+(end-start)*this._nextInt()/this._max};Lcg.prototype.nextString=function(len,flags){len|=0;flags=flags||"aA";var mask="";if(flags.indexOf("a")>-1){mask+="abcdefghijklmnopqrstuvwxyz"}if(flags.indexOf("A")>-1){mask+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"}if(flags.indexOf("#")>-1){mask+="0123456789"}if(flags.indexOf("!")>-1){mask+="~`!@#$%^&*()_+-={}[]:\";'<>?,./|\\"}var result=[];for(var i=0;i<len;i++){result.push(this.choice(mask))}return result.join("")};Lcg.prototype.nextBuffer=function(len){var arr=[];var i;for(i=0;i<len;i++){arr.push(this.nextInt(256))}return bufferFrom(arr)};Lcg.prototype.choice=function(arr){var len=arr.length;if(!len){throw new Error("choosing from empty array")}return arr[this.nextInt(len)]};function OrderedQueue(){this._index=0;this._items=[]}OrderedQueue.prototype.push=function(item){var items=this._items;var i=items.length|0;var j;items.push(item);while(i>0&&items[i].index<items[j=i-1>>1].index){item=items[i];items[i]=items[j];items[j]=item;i=j}};OrderedQueue.prototype.pop=function(){var items=this._items;var len=items.length-1|0;var first=items[0];if(!first||first.index>this._index){return null}this._index++;if(!len){items.pop();return first}items[0]=items.pop();var mid=len>>1;var i=0;var i1,i2,j,item,c,c1,c2;while(i<mid){item=items[i];i1=(i<<1)+1;i2=i+1<<1;c1=items[i1];c2=items[i2];if(!c2||c1.index<=c2.index){c=c1;j=i1}else{c=c2;j=i2}if(c.index>=item.index){break}items[j]=item;items[i]=c;i=j}return first};function Tap(buf,pos){this.buf=buf;this.pos=pos|0;if(this.pos<0){throw new Error("negative offset")}}Tap.prototype.isValid=function(){return this.pos<=this.buf.length};Tap.prototype._invalidate=function(){this.pos=this.buf.length+1};Tap.prototype.readBoolean=function(){return!!this.buf[this.pos++]};Tap.prototype.skipBoolean=function(){this.pos++};Tap.prototype.writeBoolean=function(b){this.buf[this.pos++]=!!b};Tap.prototype.readInt=Tap.prototype.readLong=function(){var n=0;var k=0;var buf=this.buf;var b,h,f,fk;do{b=buf[this.pos++];h=b&128;n|=(b&127)<<k;k+=7}while(h&&k<28);if(h){f=n;fk=268435456;do{b=buf[this.pos++];f+=(b&127)*fk;fk*=128}while(b&128);return(f%2?-(f+1):f)/2}return n>>1^-(n&1)};Tap.prototype.skipInt=Tap.prototype.skipLong=function(){var buf=this.buf;while(buf[this.pos++]&128){}};Tap.prototype.writeInt=Tap.prototype.writeLong=function(n){var buf=this.buf;var f,m;if(n>=-1073741824&&n<1073741824){m=n>=0?n<<1:~n<<1|1;do{buf[this.pos]=m&127;m>>=7}while(m&&(buf[this.pos++]|=128))}else{f=n>=0?n*2:-n*2-1;do{buf[this.pos]=f&127;f/=128}while(f>=1&&(buf[this.pos++]|=128))}this.pos++};Tap.prototype.readFloat=function(){var buf=this.buf;var pos=this.pos;this.pos+=4;if(this.pos>buf.length){return 0}return this.buf.readFloatLE(pos)};Tap.prototype.skipFloat=function(){this.pos+=4};Tap.prototype.writeFloat=function(f){var buf=this.buf;var pos=this.pos;this.pos+=4;if(this.pos>buf.length){return}return this.buf.writeFloatLE(f,pos)};Tap.prototype.readDouble=function(){var buf=this.buf;var pos=this.pos;this.pos+=8;if(this.pos>buf.length){return 0}return this.buf.readDoubleLE(pos)};Tap.prototype.skipDouble=function(){this.pos+=8};Tap.prototype.writeDouble=function(d){var buf=this.buf;var pos=this.pos;this.pos+=8;if(this.pos>buf.length){return}return this.buf.writeDoubleLE(d,pos)};Tap.prototype.readFixed=function(len){var pos=this.pos;this.pos+=len;if(this.pos>this.buf.length){return}var fixed=POOL.alloc(len);this.buf.copy(fixed,0,pos,pos+len);return fixed};Tap.prototype.skipFixed=function(len){this.pos+=len};Tap.prototype.writeFixed=function(buf,len){len=len||buf.length;var pos=this.pos;this.pos+=len;if(this.pos>this.buf.length){return}buf.copy(this.buf,pos,0,len)};Tap.prototype.readBytes=function(){var len=this.readLong();if(len<0){this._invalidate();return}return this.readFixed(len)};Tap.prototype.skipBytes=function(){var len=this.readLong();if(len<0){this._invalidate();return}this.pos+=len};Tap.prototype.writeBytes=function(buf){var len=buf.length;this.writeLong(len);this.writeFixed(buf,len)};if(typeof Buffer.prototype.utf8Slice=="function"){Tap.prototype.readString=function(){var len=this.readLong();if(len<0){this._invalidate();return""}var pos=this.pos;var buf=this.buf;this.pos+=len;if(this.pos>buf.length){return}return this.buf.utf8Slice(pos,pos+len)}}else{Tap.prototype.readString=function(){var len=this.readLong();if(len<0){this._invalidate();return""}var pos=this.pos;var buf=this.buf;this.pos+=len;if(this.pos>buf.length){return}return this.buf.slice(pos,pos+len).toString()}}Tap.prototype.skipString=function(){var len=this.readLong();if(len<0){this._invalidate();return}this.pos+=len};Tap.prototype.writeString=function(s){var len=Buffer.byteLength(s);var buf=this.buf;this.writeLong(len);var pos=this.pos;this.pos+=len;if(this.pos>buf.length){return}if(len>64&&typeof Buffer.prototype.utf8Write=="function"){buf.utf8Write(s,pos,len)}else{var i,l,c1,c2;for(i=0,l=len;i<l;i++){c1=s.charCodeAt(i);if(c1<128){buf[pos++]=c1}else if(c1<2048){buf[pos++]=c1>>6|192;buf[pos++]=c1&63|128}else if((c1&64512)===55296&&((c2=s.charCodeAt(i+1))&64512)===56320){c1=65536+((c1&1023)<<10)+(c2&1023);i++;buf[pos++]=c1>>18|240;buf[pos++]=c1>>12&63|128;buf[pos++]=c1>>6&63|128;buf[pos++]=c1&63|128}else{buf[pos++]=c1>>12|224;buf[pos++]=c1>>6&63|128;buf[pos++]=c1&63|128}}}};if(typeof Buffer.prototype.latin1Write=="function"){Tap.prototype.writeBinary=function(str,len){var pos=this.pos;this.pos+=len;if(this.pos>this.buf.length){return}this.buf.latin1Write(str,pos,len)}}else if(typeof Buffer.prototype.binaryWrite=="function"){Tap.prototype.writeBinary=function(str,len){var pos=this.pos;this.pos+=len;if(this.pos>this.buf.length){return}this.buf.binaryWrite(str,pos,len)}}else{Tap.prototype.writeBinary=function(s,len){var pos=this.pos;this.pos+=len;if(this.pos>this.buf.length){return}this.buf.write(s,pos,len,"binary")}}Tap.prototype.matchBoolean=function(tap){return this.buf[this.pos++]-tap.buf[tap.pos++]};Tap.prototype.matchInt=Tap.prototype.matchLong=function(tap){var n1=this.readLong();var n2=tap.readLong();return n1===n2?0:n1<n2?-1:1};Tap.prototype.matchFloat=function(tap){var n1=this.readFloat();var n2=tap.readFloat();return n1===n2?0:n1<n2?-1:1};Tap.prototype.matchDouble=function(tap){var n1=this.readDouble();var n2=tap.readDouble();return n1===n2?0:n1<n2?-1:1};Tap.prototype.matchFixed=function(tap,len){return this.readFixed(len).compare(tap.readFixed(len))};Tap.prototype.matchBytes=Tap.prototype.matchString=function(tap){var l1=this.readLong();var p1=this.pos;this.pos+=l1;var l2=tap.readLong();var p2=tap.pos;tap.pos+=l2;var b1=this.buf.slice(p1,this.pos);var b2=tap.buf.slice(p2,tap.pos);return b1.compare(b2)};Tap.prototype.unpackLongBytes=function(){var res=newBuffer(8);var n=0;var i=0;var j=6;var buf=this.buf;var b,neg;b=buf[this.pos++];neg=b&1;res.fill(0);n|=(b&127)>>1;while(b&128){b=buf[this.pos++];n|=(b&127)<<j;j+=7;if(j>=8){j-=8;res[i++]=n;n>>=8}}res[i]=n;if(neg){invert(res,8)}return res};Tap.prototype.packLongBytes=function(buf){var neg=(buf[7]&128)>>7;var res=this.buf;var j=1;var k=0;var m=3;var n;if(neg){invert(buf,8);n=1}else{n=0}var parts=[buf.readUIntLE(0,3),buf.readUIntLE(3,3),buf.readUIntLE(6,2)];while(m&&!parts[--m]){}while(k<m){n|=parts[k++]<<j;j+=24;while(j>7){res[this.pos++]=n&127|128;n>>=7;j-=7}}n|=parts[m]<<j;do{res[this.pos]=n&127;n>>=7}while(n&&(res[this.pos++]|=128));this.pos++;if(neg){invert(buf,8)}};function invert(buf,len){while(len--){buf[len]=~buf[len]}}var utils={abstractFunction:abstractFunction,addDeprecatedGetters:addDeprecatedGetters,bufferFrom:bufferFrom,capitalize:capitalize,copyOwnProperties:copyOwnProperties,getHash:getHash,compare:compare,getOption:getOption,jsonEnd:jsonEnd,newBuffer:newBuffer,objectValues:objectValues,toMap:toMap,singleIndexOf:singleIndexOf,hasDuplicates:hasDuplicates,BufferPool:BufferPool,Lcg:Lcg,OrderedQueue:OrderedQueue,Tap:Tap};var Tap$1=utils.Tap;var debug=util.debuglog("avsc:types");var f=util.format;var TYPES={array:ArrayType,boolean:BooleanType,bytes:BytesType,double:DoubleType,enum:EnumType,error:RecordType,fixed:FixedType,float:FloatType,int:IntType,long:LongType,map:MapType,null:NullType,record:RecordType,string:StringType};var NAME_PATTERN=/^[A-Za-z_][A-Za-z0-9_]*$/;var RANDOM=new utils.Lcg;var TAP=new Tap$1(new bufferEs6.SlowBuffer(1024));var LOGICAL_TYPE=null;var UNDERLYING_TYPES=[];function Type(schema,opts){var type;if(LOGICAL_TYPE){type=LOGICAL_TYPE;UNDERLYING_TYPES.push([LOGICAL_TYPE,this]);LOGICAL_TYPE=null}else{type=this}this._hash=new Hash;this.name=undefined;this.aliases=undefined;this.doc=schema&&schema.doc?""+schema.doc:undefined;if(schema){var name=schema.name;var namespace=schema.namespace===undefined?opts&&opts.namespace:schema.namespace;if(name!==undefined){name=qualify(name,namespace);if(isPrimitive$1(name)){throw new Error(f("cannot rename primitive type: %j",name))}var registry=opts&&opts.registry;if(registry){if(registry[name]!==undefined){throw new Error(f("duplicate type name: %s",name))}registry[name]=type}}else if(opts&&opts.noAnonymousTypes){throw new Error(f("missing name property in schema: %j",schema))}this.name=name;this.aliases=schema.aliases?schema.aliases.map((function(s){return qualify(s,namespace)})):[]}}Type.forSchema=function(schema,opts){opts=opts||{};opts.registry=opts.registry||{};var UnionType=function(wrapUnions){if(wrapUnions===true){wrapUnions="always"}else if(wrapUnions===false){wrapUnions="never"}else if(wrapUnions===undefined){wrapUnions="auto"}else if(typeof wrapUnions=="string"){wrapUnions=wrapUnions.toLowerCase()}switch(wrapUnions){case"always":return WrappedUnionType;case"never":return UnwrappedUnionType;case"auto":return undefined;default:throw new Error(f("invalid wrap unions option: %j",wrapUnions))}}(opts.wrapUnions);if(schema===null){throw new Error('invalid type: null (did you mean "null"?)')}if(Type.isType(schema)){return schema}var type;if(opts.typeHook&&(type=opts.typeHook(schema,opts))){if(!Type.isType(type)){throw new Error(f("invalid typehook return value: %j",type))}return type}if(typeof schema=="string"){schema=qualify(schema,opts.namespace);type=opts.registry[schema];if(type){return type}if(isPrimitive$1(schema)){return opts.registry[schema]=Type.forSchema({type:schema},opts)}throw new Error(f("undefined type name: %s",schema))}if(schema.logicalType&&opts.logicalTypes&&!LOGICAL_TYPE){var DerivedType=opts.logicalTypes[schema.logicalType];if(DerivedType){var namespace=opts.namespace;var registry={};Object.keys(opts.registry).forEach((function(key){registry[key]=opts.registry[key]}));try{debug("instantiating logical type for %s",schema.logicalType);return new DerivedType(schema,opts)}catch(err){debug("failed to instantiate logical type for %s",schema.logicalType);if(opts.assertLogicalTypes){throw err}LOGICAL_TYPE=null;opts.namespace=namespace;opts.registry=registry}}}if(Array.isArray(schema)){var logicalType=LOGICAL_TYPE;LOGICAL_TYPE=null;var types=schema.map((function(obj){return Type.forSchema(obj,opts)}));if(!UnionType){UnionType=isAmbiguous(types)?WrappedUnionType:UnwrappedUnionType}LOGICAL_TYPE=logicalType;type=new UnionType(types,opts)}else{type=function(typeName){var Type=TYPES[typeName];if(Type===undefined){throw new Error(f("unknown type: %j",typeName))}return new Type(schema,opts)}(schema.type)}return type};Type.forValue=function(val,opts){opts=opts||{};opts.emptyArrayType=opts.emptyArrayType||Type.forSchema({type:"array",items:"null"});if(opts.valueHook){var type=opts.valueHook(val,opts);if(type!==undefined){if(!Type.isType(type)){throw new Error(f("invalid value hook return value: %j",type))}return type}}switch(typeof val){case"string":return Type.forSchema("string",opts);case"boolean":return Type.forSchema("boolean",opts);case"number":if((val|0)===val){return Type.forSchema("int",opts)}else if(Math.abs(val)<9007199254740991){return Type.forSchema("float",opts)}return Type.forSchema("double",opts);case"object":if(val===null){return Type.forSchema("null",opts)}else if(Array.isArray(val)){if(!val.length){return opts.emptyArrayType}return Type.forSchema({type:"array",items:Type.forTypes(val.map((function(v){return Type.forValue(v,opts)})),opts)},opts)}else if(isBuffer(val)){return Type.forSchema("bytes",opts)}var fieldNames=Object.keys(val);if(fieldNames.some((function(s){return!isValidName(s)}))){return Type.forSchema({type:"map",values:Type.forTypes(fieldNames.map((function(s){return Type.forValue(val[s],opts)})),opts)},opts)}return Type.forSchema({type:"record",fields:fieldNames.map((function(s){return{name:s,type:Type.forValue(val[s],opts)}}))},opts);default:throw new Error(f("cannot infer type from: %j",val))}};Type.forTypes=function(types,opts){if(!types.length){throw new Error("no types to combine")}if(types.length===1){return types[0]}opts=opts||{};var expanded=[];var numWrappedUnions=0;var isValidWrappedUnion=true;types.forEach((function(type){switch(type.typeName){case"union:unwrapped":isValidWrappedUnion=false;expanded=expanded.concat(type.types);break;case"union:wrapped":numWrappedUnions++;expanded=expanded.concat(type.types);break;case"null":expanded.push(type);break;default:isValidWrappedUnion=false;expanded.push(type)}}));if(numWrappedUnions){if(!isValidWrappedUnion){throw new Error("cannot combine wrapped union")}var branchTypes={};expanded.forEach((function(type){var name=type.branchName;var branchType=branchTypes[name];if(!branchType){branchTypes[name]=type}else if(!type.equals(branchType)){throw new Error("inconsistent branch type")}}));var wrapUnions=opts.wrapUnions;var unionType;opts.wrapUnions=true;try{unionType=Type.forSchema(Object.keys(branchTypes).map((function(name){return branchTypes[name]})),opts)}catch(err){opts.wrapUnions=wrapUnions;throw err}opts.wrapUnions=wrapUnions;return unionType}var bucketized={};expanded.forEach((function(type){var bucket=getTypeBucket(type);var bucketTypes=bucketized[bucket];if(!bucketTypes){bucketized[bucket]=bucketTypes=[]}bucketTypes.push(type)}));var buckets=Object.keys(bucketized);var augmented=buckets.map((function(bucket){var bucketTypes=bucketized[bucket];if(bucketTypes.length===1){return bucketTypes[0]}else{switch(bucket){case"null":case"boolean":return bucketTypes[0];case"number":return combineNumbers(bucketTypes);case"string":return combineStrings(bucketTypes,opts);case"buffer":return combineBuffers(bucketTypes,opts);case"array":bucketTypes=bucketTypes.filter((function(t){return t!==opts.emptyArrayType}));if(!bucketTypes.length){return opts.emptyArrayType}return Type.forSchema({type:"array",items:Type.forTypes(bucketTypes.map((function(t){return t.itemsType})),opts)},opts);default:return combineObjects(bucketTypes,opts)}}}));if(augmented.length===1){return augmented[0]}else{return Type.forSchema(augmented,opts)}};Type.isType=function(){var l=arguments.length;if(!l){return false}var any=arguments[0];if(!any||typeof any._update!="function"||typeof any.fingerprint!="function"){return false}if(l===1){return true}var typeName=any.typeName;var i;for(i=1;i<l;i++){if(typeName.indexOf(arguments[i])===0){return true}}return false};Type.__reset=function(size){debug("resetting type buffer to %d",size);TAP.buf=new bufferEs6.SlowBuffer(size)};Object.defineProperty(Type.prototype,"branchName",{enumerable:true,get:function(){var type=Type.isType(this,"logical")?this.underlyingType:this;if(type.name){return type.name}if(Type.isType(type,"abstract")){return type._concreteTypeName}return Type.isType(type,"union")?undefined:type.typeName}});Type.prototype.clone=function(val,opts){if(opts){opts={coerce:!!opts.coerceBuffers|0,fieldHook:opts.fieldHook,qualifyNames:!!opts.qualifyNames,skip:!!opts.skipMissingFields,wrap:!!opts.wrapUnions|0};return this._copy(val,opts)}else{return this.fromBuffer(this.toBuffer(val))}};Type.prototype.compare=utils.abstractFunction;Type.prototype.compareBuffers=function(buf1,buf2){return this._match(new Tap$1(buf1),new Tap$1(buf2))};Type.prototype.createResolver=function(type,opts){if(!Type.isType(type)){throw new Error(f("not a type: %j",type))}if(!Type.isType(this,"union","logical")&&Type.isType(type,"logical")){return this.createResolver(type.underlyingType,opts)}opts=opts||{};opts.registry=opts.registry||{};var resolver,key;if(Type.isType(this,"record","error")&&Type.isType(type,"record","error")){key=this.name+":"+type.name;resolver=opts.registry[key];if(resolver){return resolver}}resolver=new Resolver(this);if(key){opts.registry[key]=resolver}if(Type.isType(type,"union")){var resolvers=type.types.map((function(t){return this.createResolver(t,opts)}),this);resolver._read=function(tap){var index=tap.readLong();var resolver=resolvers[index];if(resolver===undefined){throw new Error(f("invalid union index: %s",index))}return resolvers[index]._read(tap)}}else{this._update(resolver,type,opts)}if(!resolver._read){throw new Error(f("cannot read %s as %s",type,this))}return Object.freeze(resolver)};Type.prototype.decode=function(buf,pos,resolver){var tap=new Tap$1(buf,pos);var val=readValue(this,tap,resolver);if(!tap.isValid()){return{value:undefined,offset:-1}}return{value:val,offset:tap.pos}};Type.prototype.encode=function(val,buf,pos){var tap=new Tap$1(buf,pos);this._write(tap,val);if(!tap.isValid()){return buf.length-tap.pos}return tap.pos};Type.prototype.equals=function(type){return Type.isType(type)&&this.fingerprint().equals(type.fingerprint())};Type.prototype.fingerprint=function(algorithm){if(!algorithm){if(!this._hash.str){var schemaStr=JSON.stringify(this.schema());this._hash.str=utils.getHash(schemaStr).toString("binary")}return utils.bufferFrom(this._hash.str,"binary")}else{return utils.getHash(JSON.stringify(this.schema()),algorithm)}};Type.prototype.fromBuffer=function(buf,resolver,noCheck){var tap=new Tap$1(buf);var val=readValue(this,tap,resolver,noCheck);if(!tap.isValid()){throw new Error("truncated buffer")}if(!noCheck&&tap.pos<buf.length){throw new Error("trailing data")}return val};Type.prototype.fromString=function(str){return this._copy(JSON.parse(str),{coerce:2})};Type.prototype.inspect=function(){var typeName=this.typeName;var className=getClassName(typeName);if(isPrimitive$1(typeName)){return f("<%s>",className)}else{var obj=this.schema({exportAttrs:true,noDeref:true});if(typeof obj=="object"&&!Type.isType(this,"logical")){obj.type=undefined}return f("<%s %j>",className,obj)}};Type.prototype.isValid=function(val,opts){var flags=(opts&&opts.noUndeclaredFields)|0;var errorHook=opts&&opts.errorHook;var hook,path;if(errorHook){path=[];hook=function(any,type){errorHook.call(this,path.slice(),any,type,val)}}return this._check(val,flags,hook,path)};Type.prototype.random=utils.abstractFunction;Type.prototype.schema=function(opts){return this._attrs({exportAttrs:!!(opts&&opts.exportAttrs),noDeref:!!(opts&&opts.noDeref)})};Type.prototype.toBuffer=function(val){TAP.pos=0;this._write(TAP,val);var buf=utils.newBuffer(TAP.pos);if(TAP.isValid()){TAP.buf.copy(buf,0,0,TAP.pos)}else{this._write(new Tap$1(buf),val)}return buf};Type.prototype.toJSON=function(){return this.schema({exportAttrs:true})};Type.prototype.toString=function(val){if(val===undefined){return JSON.stringify(this.schema({noDeref:true}))}return JSON.stringify(this._copy(val,{coerce:3}))};Type.prototype.wrap=function(val){var Branch=this._branchConstructor;return Branch===null?null:new Branch(val)};Type.prototype._attrs=function(opts){opts.derefed=opts.derefed||{};var name=this.name;if(name!==undefined){if(opts.noDeref||opts.derefed[name]){return name}opts.derefed[name]=true}var schema={};if(this.name!==undefined){schema.name=name}schema.type=this.typeName;var derefedSchema=this._deref(schema,opts);if(derefedSchema!==undefined){schema=derefedSchema}if(opts.exportAttrs){if(this.aliases&&this.aliases.length){schema.aliases=this.aliases}if(this.doc!==undefined){schema.doc=this.doc}}return schema};Type.prototype._createBranchConstructor=function(){var name=this.branchName;if(name==="null"){return null}var attr=~name.indexOf(".")?"this['"+name+"']":"this."+name;var body="return function Branch$(val) { "+attr+" = val; };";var Branch=new Function(body)();Branch.type=this;Branch.prototype.unwrap=new Function("return "+attr+";");Branch.prototype.unwrapped=Branch.prototype.unwrap;return Branch};Type.prototype._peek=function(tap){var pos=tap.pos;var val=this._read(tap);tap.pos=pos;return val};Type.prototype._check=utils.abstractFunction;Type.prototype._copy=utils.abstractFunction;Type.prototype._deref=utils.abstractFunction;Type.prototype._match=utils.abstractFunction;Type.prototype._read=utils.abstractFunction;Type.prototype._skip=utils.abstractFunction;Type.prototype._update=utils.abstractFunction;Type.prototype._write=utils.abstractFunction;Type.prototype.getAliases=function(){return this.aliases};Type.prototype.getFingerprint=Type.prototype.fingerprint;Type.prototype.getName=function(asBranch){return this.name||!asBranch?this.name:this.branchName};Type.prototype.getSchema=Type.prototype.schema;Type.prototype.getTypeName=function(){return this.typeName};function PrimitiveType(noFreeze){Type.call(this);this._branchConstructor=this._createBranchConstructor();if(!noFreeze){Object.freeze(this)}}util.inherits(PrimitiveType,Type);PrimitiveType.prototype._update=function(resolver,type){if(type.typeName===this.typeName){resolver._read=this._read}};PrimitiveType.prototype._copy=function(val){this._check(val,undefined,throwInvalidError);return val};PrimitiveType.prototype._deref=function(){return this.typeName};PrimitiveType.prototype.compare=utils.compare;function NullType(){PrimitiveType.call(this)}util.inherits(NullType,PrimitiveType);NullType.prototype._check=function(val,flags,hook){var b=val===null;if(!b&&hook){hook(val,this)}return b};NullType.prototype._read=function(){return null};NullType.prototype._skip=function(){};NullType.prototype._write=function(tap,val){if(val!==null){throwInvalidError(val,this)}};NullType.prototype._match=function(){return 0};NullType.prototype.compare=NullType.prototype._match;NullType.prototype.typeName="null";NullType.prototype.random=NullType.prototype._read;function BooleanType(){PrimitiveType.call(this)}util.inherits(BooleanType,PrimitiveType);BooleanType.prototype._check=function(val,flags,hook){var b=typeof val=="boolean";if(!b&&hook){hook(val,this)}return b};BooleanType.prototype._read=function(tap){return tap.readBoolean()};BooleanType.prototype._skip=function(tap){tap.skipBoolean()};BooleanType.prototype._write=function(tap,val){if(typeof val!="boolean"){throwInvalidError(val,this)}tap.writeBoolean(val)};BooleanType.prototype._match=function(tap1,tap2){return tap1.matchBoolean(tap2)};BooleanType.prototype.typeName="boolean";BooleanType.prototype.random=function(){return RANDOM.nextBoolean()};function IntType(){PrimitiveType.call(this)}util.inherits(IntType,PrimitiveType);IntType.prototype._check=function(val,flags,hook){var b=val===(val|0);if(!b&&hook){hook(val,this)}return b};IntType.prototype._read=function(tap){return tap.readInt()};IntType.prototype._skip=function(tap){tap.skipInt()};IntType.prototype._write=function(tap,val){if(val!==(val|0)){throwInvalidError(val,this)}tap.writeInt(val)};IntType.prototype._match=function(tap1,tap2){return tap1.matchInt(tap2)};IntType.prototype.typeName="int";IntType.prototype.random=function(){return RANDOM.nextInt(1e3)|0};function LongType(){PrimitiveType.call(this)}util.inherits(LongType,PrimitiveType);LongType.prototype._check=function(val,flags,hook){var b=typeof val=="number"&&val%1===0&&isSafeLong(val);if(!b&&hook){hook(val,this)}return b};LongType.prototype._read=function(tap){var n=tap.readLong();if(!isSafeLong(n)){throw new Error("potential precision loss")}return n};LongType.prototype._skip=function(tap){tap.skipLong()};LongType.prototype._write=function(tap,val){if(typeof val!="number"||val%1||!isSafeLong(val)){throwInvalidError(val,this)}tap.writeLong(val)};LongType.prototype._match=function(tap1,tap2){return tap1.matchLong(tap2)};LongType.prototype._update=function(resolver,type){switch(type.typeName){case"int":resolver._read=type._read;break;case"abstract:long":case"long":resolver._read=this._read}};LongType.prototype.typeName="long";LongType.prototype.random=function(){return RANDOM.nextInt()};LongType.__with=function(methods,noUnpack){methods=methods||{};var mapping={toBuffer:"_toBuffer",fromBuffer:"_fromBuffer",fromJSON:"_fromJSON",toJSON:"_toJSON",isValid:"_isValid",compare:"compare"};var type=new AbstractLongType(noUnpack);Object.keys(mapping).forEach((function(name){if(methods[name]===undefined){throw new Error(f("missing method implementation: %s",name))}type[mapping[name]]=methods[name]}));return Object.freeze(type)};function FloatType(){PrimitiveType.call(this)}util.inherits(FloatType,PrimitiveType);FloatType.prototype._check=function(val,flags,hook){var b=typeof val=="number";if(!b&&hook){hook(val,this)}return b};FloatType.prototype._read=function(tap){return tap.readFloat()};FloatType.prototype._skip=function(tap){tap.skipFloat()};FloatType.prototype._write=function(tap,val){if(typeof val!="number"){throwInvalidError(val,this)}tap.writeFloat(val)};FloatType.prototype._match=function(tap1,tap2){return tap1.matchFloat(tap2)};FloatType.prototype._update=function(resolver,type){switch(type.typeName){case"float":case"int":resolver._read=type._read;break;case"abstract:long":case"long":resolver._read=function(tap){return tap.readLong()}}};FloatType.prototype.typeName="float";FloatType.prototype.random=function(){return RANDOM.nextFloat(1e3)};function DoubleType(){PrimitiveType.call(this)}util.inherits(DoubleType,PrimitiveType);DoubleType.prototype._check=function(val,flags,hook){var b=typeof val=="number";if(!b&&hook){hook(val,this)}return b};DoubleType.prototype._read=function(tap){return tap.readDouble()};DoubleType.prototype._skip=function(tap){tap.skipDouble()};DoubleType.prototype._write=function(tap,val){if(typeof val!="number"){throwInvalidError(val,this)}tap.writeDouble(val)};DoubleType.prototype._match=function(tap1,tap2){return tap1.matchDouble(tap2)};DoubleType.prototype._update=function(resolver,type){switch(type.typeName){case"double":case"float":case"int":resolver._read=type._read;break;case"abstract:long":case"long":resolver._read=function(tap){return tap.readLong()}}};DoubleType.prototype.typeName="double";DoubleType.prototype.random=function(){return RANDOM.nextFloat()};function StringType(){PrimitiveType.call(this)}util.inherits(StringType,PrimitiveType);StringType.prototype._check=function(val,flags,hook){var b=typeof val=="string";if(!b&&hook){hook(val,this)}return b};StringType.prototype._read=function(tap){return tap.readString()};StringType.prototype._skip=function(tap){tap.skipString()};StringType.prototype._write=function(tap,val){if(typeof val!="string"){throwInvalidError(val,this)}tap.writeString(val)};StringType.prototype._match=function(tap1,tap2){return tap1.matchString(tap2)};StringType.prototype._update=function(resolver,type){switch(type.typeName){case"bytes":case"string":resolver._read=this._read}};StringType.prototype.typeName="string";StringType.prototype.random=function(){return RANDOM.nextString(RANDOM.nextInt(32))};function BytesType(){PrimitiveType.call(this)}util.inherits(BytesType,PrimitiveType);BytesType.prototype._check=function(val,flags,hook){var b=isBuffer(val);if(!b&&hook){hook(val,this)}return b};BytesType.prototype._read=function(tap){return tap.readBytes()};BytesType.prototype._skip=function(tap){tap.skipBytes()};BytesType.prototype._write=function(tap,val){if(!isBuffer(val)){throwInvalidError(val,this)}tap.writeBytes(val)};BytesType.prototype._match=function(tap1,tap2){return tap1.matchBytes(tap2)};BytesType.prototype._update=StringType.prototype._update;BytesType.prototype._copy=function(obj,opts){var buf;switch((opts&&opts.coerce)|0){case 3:this._check(obj,undefined,throwInvalidError);return obj.toString("binary");case 2:if(typeof obj!="string"){throw new Error(f("cannot coerce to buffer: %j",obj))}buf=utils.bufferFrom(obj,"binary");this._check(buf,undefined,throwInvalidError);return buf;case 1:if(!isJsonBuffer(obj)){throw new Error(f("cannot coerce to buffer: %j",obj))}buf=utils.bufferFrom(obj.data);this._check(buf,undefined,throwInvalidError);return buf;default:this._check(obj,undefined,throwInvalidError);return utils.bufferFrom(obj)}};BytesType.prototype.compare=Buffer.compare;BytesType.prototype.typeName="bytes";BytesType.prototype.random=function(){return RANDOM.nextBuffer(RANDOM.nextInt(32))};function UnionType(schema,opts){Type.call(this);if(!Array.isArray(schema)){throw new Error(f("non-array union schema: %j",schema))}if(!schema.length){throw new Error("empty union")}this.types=Object.freeze(schema.map((function(obj){return Type.forSchema(obj,opts)})));this._branchIndices={};this.types.forEach((function(type,i){if(Type.isType(type,"union")){throw new Error("unions cannot be directly nested")}var branch=type.branchName;if(this._branchIndices[branch]!==undefined){throw new Error(f("duplicate union branch name: %j",branch))}this._branchIndices[branch]=i}),this)}util.inherits(UnionType,Type);UnionType.prototype._branchConstructor=function(){throw new Error("unions cannot be directly wrapped")};UnionType.prototype._skip=function(tap){this.types[tap.readLong()]._skip(tap)};UnionType.prototype._match=function(tap1,tap2){var n1=tap1.readLong();var n2=tap2.readLong();if(n1===n2){return this.types[n1]._match(tap1,tap2)}else{return n1<n2?-1:1}};UnionType.prototype._deref=function(schema,opts){return this.types.map((function(t){return t._attrs(opts)}))};UnionType.prototype.getTypes=function(){return this.types};function UnwrappedUnionType(schema,opts){UnionType.call(this,schema,opts);this._dynamicBranches=null;this._bucketIndices={};this.types.forEach((function(type,index){if(Type.isType(type,"abstract","logical")){if(!this._dynamicBranches){this._dynamicBranches=[]}this._dynamicBranches.push({index:index,type:type})}else{var bucket=getTypeBucket(type);if(this._bucketIndices[bucket]!==undefined){throw new Error(f("ambiguous unwrapped union: %j",this))}this._bucketIndices[bucket]=index}}),this);Object.freeze(this)}util.inherits(UnwrappedUnionType,UnionType);UnwrappedUnionType.prototype._getIndex=function(val){var index=this._bucketIndices[getValueBucket(val)];if(this._dynamicBranches){index=this._getBranchIndex(val,index)}return index};UnwrappedUnionType.prototype._getBranchIndex=function(any,index){var logicalBranches=this._dynamicBranches;var i,l,branch;for(i=0,l=logicalBranches.length;i<l;i++){branch=logicalBranches[i];if(branch.type._check(any)){if(index===undefined){index=branch.index}else{throw new Error("ambiguous conversion")}}}return index};UnwrappedUnionType.prototype._check=function(val,flags,hook,path){var index=this._getIndex(val);var b=index!==undefined;if(b){return this.types[index]._check(val,flags,hook,path)}if(hook){hook(val,this)}return b};UnwrappedUnionType.prototype._read=function(tap){var index=tap.readLong();var branchType=this.types[index];if(branchType){return branchType._read(tap)}else{throw new Error(f("invalid union index: %s",index))}};UnwrappedUnionType.prototype._write=function(tap,val){var index=this._getIndex(val);if(index===undefined){throwInvalidError(val,this)}tap.writeLong(index);if(val!==null){this.types[index]._write(tap,val)}};UnwrappedUnionType.prototype._update=function(resolver,type,opts){var i,l,typeResolver;for(i=0,l=this.types.length;i<l;i++){try{typeResolver=this.types[i].createResolver(type,opts)}catch(err){continue}resolver._read=function(tap){return typeResolver._read(tap)};return}};UnwrappedUnionType.prototype._copy=function(val,opts){var coerce=opts&&opts.coerce|0;var wrap=opts&&opts.wrap|0;var index;if(wrap===2){index=0}else{switch(coerce){case 1:if(isJsonBuffer(val)&&this._bucketIndices.buffer!==undefined){index=this._bucketIndices.buffer}else{index=this._getIndex(val)}break;case 2:if(val===null){index=this._bucketIndices["null"]}else if(typeof val==="object"){var keys=Object.keys(val);if(keys.length===1){index=this._branchIndices[keys[0]];val=val[keys[0]]}}break;default:index=this._getIndex(val)}if(index===undefined){throwInvalidError(val,this)}}var type=this.types[index];if(val===null||wrap===3){return type._copy(val,opts)}else{switch(coerce){case 3:var obj={};obj[type.branchName]=type._copy(val,opts);return obj;default:return type._copy(val,opts)}}};UnwrappedUnionType.prototype.compare=function(val1,val2){var index1=this._getIndex(val1);var index2=this._getIndex(val2);if(index1===undefined){throwInvalidError(val1,this)}else if(index2===undefined){throwInvalidError(val2,this)}else if(index1===index2){return this.types[index1].compare(val1,val2)}else{return utils.compare(index1,index2)}};UnwrappedUnionType.prototype.typeName="union:unwrapped";UnwrappedUnionType.prototype.random=function(){var index=RANDOM.nextInt(this.types.length);return this.types[index].random()};function WrappedUnionType(schema,opts){UnionType.call(this,schema,opts);Object.freeze(this)}util.inherits(WrappedUnionType,UnionType);WrappedUnionType.prototype._check=function(val,flags,hook,path){var b=false;if(val===null){b=this._branchIndices["null"]!==undefined}else if(typeof val=="object"){var keys=Object.keys(val);if(keys.length===1){var name=keys[0];var index=this._branchIndices[name];if(index!==undefined){if(hook){path.push(name);b=this.types[index]._check(val[name],flags,hook,path);path.pop();return b}else{return this.types[index]._check(val[name],flags)}}}}if(!b&&hook){hook(val,this)}return b};WrappedUnionType.prototype._read=function(tap){var type=this.types[tap.readLong()];if(!type){throw new Error(f("invalid union index"))}var Branch=type._branchConstructor;if(Branch===null){return null}else{return new Branch(type._read(tap))}};WrappedUnionType.prototype._write=function(tap,val){var index,keys,name;if(val===null){index=this._branchIndices["null"];if(index===undefined){throwInvalidError(val,this)}tap.writeLong(index)}else{keys=Object.keys(val);if(keys.length===1){name=keys[0];index=this._branchIndices[name]}if(index===undefined){throwInvalidError(val,this)}tap.writeLong(index);this.types[index]._write(tap,val[name])}};WrappedUnionType.prototype._update=function(resolver,type,opts){var i,l,typeResolver,Branch;for(i=0,l=this.types.length;i<l;i++){try{typeResolver=this.types[i].createResolver(type,opts)}catch(err){continue}Branch=this.types[i]._branchConstructor;if(Branch){resolver._read=function(tap){return new Branch(typeResolver._read(tap))}}else{resolver._read=function(){return null}}return}};WrappedUnionType.prototype._copy=function(val,opts){var wrap=opts&&opts.wrap|0;if(wrap===2){var firstType=this.types[0];if(val===null&&firstType.typeName==="null"){return null}return new firstType._branchConstructor(firstType._copy(val,opts))}if(val===null&&this._branchIndices["null"]!==undefined){return null}var i,l,obj;if(typeof val=="object"){var keys=Object.keys(val);if(keys.length===1){var name=keys[0];i=this._branchIndices[name];if(i===undefined&&opts.qualifyNames){var j,type;for(j=0,l=this.types.length;j<l;j++){type=this.types[j];if(type.name&&name===unqualify(type.name)){i=j;break}}}if(i!==undefined){obj=this.types[i]._copy(val[name],opts)}}}if(wrap===1&&obj===undefined){i=0;l=this.types.length;while(i<l&&obj===undefined){try{obj=this.types[i]._copy(val,opts)}catch(err){i++}}}if(obj!==undefined){return wrap===3?obj:new this.types[i]._branchConstructor(obj)}throwInvalidError(val,this)};WrappedUnionType.prototype.compare=function(val1,val2){var name1=val1===null?"null":Object.keys(val1)[0];var name2=val2===null?"null":Object.keys(val2)[0];var index=this._branchIndices[name1];if(name1===name2){return name1==="null"?0:this.types[index].compare(val1[name1],val2[name1])}else{return utils.compare(index,this._branchIndices[name2])}};WrappedUnionType.prototype.typeName="union:wrapped";WrappedUnionType.prototype.random=function(){var index=RANDOM.nextInt(this.types.length);var type=this.types[index];var Branch=type._branchConstructor;if(!Branch){return null}return new Branch(type.random())};function EnumType(schema,opts){Type.call(this,schema,opts);if(!Array.isArray(schema.symbols)||!schema.symbols.length){throw new Error(f("invalid enum symbols: %j",schema.symbols))}this.symbols=Object.freeze(schema.symbols.slice());this._indices={};this.symbols.forEach((function(symbol,i){if(!isValidName(symbol)){throw new Error(f("invalid %s symbol: %j",this,symbol))}if(this._indices[symbol]!==undefined){throw new Error(f("duplicate %s symbol: %j",this,symbol))}this._indices[symbol]=i}),this);this._branchConstructor=this._createBranchConstructor();Object.freeze(this)}util.inherits(EnumType,Type);EnumType.prototype._check=function(val,flags,hook){var b=this._indices[val]!==undefined;if(!b&&hook){hook(val,this)}return b};EnumType.prototype._read=function(tap){var index=tap.readLong();var symbol=this.symbols[index];if(symbol===undefined){throw new Error(f("invalid %s enum index: %s",this.name,index))}return symbol};EnumType.prototype._skip=function(tap){tap.skipLong()};EnumType.prototype._write=function(tap,val){var index=this._indices[val];if(index===undefined){throwInvalidError(val,this)}tap.writeLong(index)};EnumType.prototype._match=function(tap1,tap2){return tap1.matchLong(tap2)};EnumType.prototype.compare=function(val1,val2){return utils.compare(this._indices[val1],this._indices[val2])};EnumType.prototype._update=function(resolver,type){var symbols=this.symbols;if(type.typeName==="enum"&&(!type.name||~getAliases(this).indexOf(type.name))&&type.symbols.every((function(s){return~symbols.indexOf(s)}))){resolver.symbols=type.symbols;resolver._read=type._read}};EnumType.prototype._copy=function(val){this._check(val,undefined,throwInvalidError);return val};EnumType.prototype._deref=function(schema){schema.symbols=this.symbols};EnumType.prototype.getSymbols=function(){return this.symbols};EnumType.prototype.typeName="enum";EnumType.prototype.random=function(){return RANDOM.choice(this.symbols)};function FixedType(schema,opts){Type.call(this,schema,opts);if(schema.size!==(schema.size|0)||schema.size<1){throw new Error(f("invalid %s size",this.branchName))}this.size=schema.size|0;this._branchConstructor=this._createBranchConstructor();Object.freeze(this)}util.inherits(FixedType,Type);FixedType.prototype._check=function(val,flags,hook){var b=isBuffer(val)&&val.length===this.size;if(!b&&hook){hook(val,this)}return b};FixedType.prototype._read=function(tap){return tap.readFixed(this.size)};FixedType.prototype._skip=function(tap){tap.skipFixed(this.size)};FixedType.prototype._write=function(tap,val){if(!isBuffer(val)||val.length!==this.size){throwInvalidError(val,this)}tap.writeFixed(val,this.size)};FixedType.prototype._match=function(tap1,tap2){return tap1.matchFixed(tap2,this.size)};FixedType.prototype.compare=Buffer.compare;FixedType.prototype._update=function(resolver,type){if(type.typeName==="fixed"&&this.size===type.size&&(!type.name||~getAliases(this).indexOf(type.name))){resolver.size=this.size;resolver._read=this._read}};FixedType.prototype._copy=BytesType.prototype._copy;FixedType.prototype._deref=function(schema){schema.size=this.size};FixedType.prototype.getSize=function(){return this.size};FixedType.prototype.typeName="fixed";FixedType.prototype.random=function(){return RANDOM.nextBuffer(this.size)};function MapType(schema,opts){Type.call(this);if(!schema.values){throw new Error(f("missing map values: %j",schema))}this.valuesType=Type.forSchema(schema.values,opts);this._branchConstructor=this._createBranchConstructor();Object.freeze(this)}util.inherits(MapType,Type);MapType.prototype._check=function(val,flags,hook,path){if(!val||typeof val!="object"||Array.isArray(val)){if(hook){hook(val,this)}return false}var keys=Object.keys(val);var b=true;var i,l,j,key;if(hook){j=path.length;path.push("");for(i=0,l=keys.length;i<l;i++){key=path[j]=keys[i];if(!this.valuesType._check(val[key],flags,hook,path)){b=false}}path.pop()}else{for(i=0,l=keys.length;i<l;i++){if(!this.valuesType._check(val[keys[i]],flags)){return false}}}return b};MapType.prototype._read=function(tap){var values=this.valuesType;var val={};var n;while(n=readArraySize(tap)){while(n--){var key=tap.readString();val[key]=values._read(tap)}}return val};MapType.prototype._skip=function(tap){var values=this.valuesType;var len,n;while(n=tap.readLong()){if(n<0){len=tap.readLong();tap.pos+=len}else{while(n--){tap.skipString();values._skip(tap)}}}};MapType.prototype._write=function(tap,val){if(!val||typeof val!="object"||Array.isArray(val)){throwInvalidError(val,this)}var values=this.valuesType;var keys=Object.keys(val);var n=keys.length;var i,key;if(n){tap.writeLong(n);for(i=0;i<n;i++){key=keys[i];tap.writeString(key);values._write(tap,val[key])}}tap.writeLong(0)};MapType.prototype._match=function(){throw new Error("maps cannot be compared")};MapType.prototype._update=function(rsv,type,opts){if(type.typeName==="map"){rsv.valuesType=this.valuesType.createResolver(type.valuesType,opts);rsv._read=this._read}};MapType.prototype._copy=function(val,opts){if(val&&typeof val=="object"&&!Array.isArray(val)){var values=this.valuesType;var keys=Object.keys(val);var i,l,key;var copy={};for(i=0,l=keys.length;i<l;i++){key=keys[i];copy[key]=values._copy(val[key],opts)}return copy}throwInvalidError(val,this)};MapType.prototype.compare=MapType.prototype._match;MapType.prototype.typeName="map";MapType.prototype.getValuesType=function(){return this.valuesType};MapType.prototype.random=function(){var val={};var i,l;for(i=0,l=RANDOM.nextInt(10);i<l;i++){val[RANDOM.nextString(RANDOM.nextInt(20))]=this.valuesType.random()}return val};MapType.prototype._deref=function(schema,opts){schema.values=this.valuesType._attrs(opts)};function ArrayType(schema,opts){Type.call(this);if(!schema.items){throw new Error(f("missing array items: %j",schema))}this.itemsType=Type.forSchema(schema.items,opts);this._branchConstructor=this._createBranchConstructor();Object.freeze(this)}util.inherits(ArrayType,Type);ArrayType.prototype._check=function(val,flags,hook,path){if(!Array.isArray(val)){if(hook){hook(val,this)}return false}var b=true;var i,l,j;if(hook){j=path.length;path.push("");for(i=0,l=val.length;i<l;i++){path[j]=""+i;if(!this.itemsType._check(val[i],flags,hook,path)){b=false}}path.pop()}else{for(i=0,l=val.length;i<l;i++){if(!this.itemsType._check(val[i],flags)){return false}}}return b};ArrayType.prototype._read=function(tap){var items=this.itemsType;var val=[];var n;while(n=tap.readLong()){if(n<0){n=-n;tap.skipLong()}while(n--){val.push(items._read(tap))}}return val};ArrayType.prototype._skip=function(tap){var len,n;while(n=tap.readLong()){if(n<0){len=tap.readLong();tap.pos+=len}else{while(n--){this.itemsType._skip(tap)}}}};ArrayType.prototype._write=function(tap,val){if(!Array.isArray(val)){throwInvalidError(val,this)}var n=val.length;var i;if(n){tap.writeLong(n);for(i=0;i<n;i++){this.itemsType._write(tap,val[i])}}tap.writeLong(0)};ArrayType.prototype._match=function(tap1,tap2){var n1=tap1.readLong();var n2=tap2.readLong();var f;while(n1&&n2){f=this.itemsType._match(tap1,tap2);if(f){return f}if(!--n1){n1=readArraySize(tap1)}if(!--n2){n2=readArraySize(tap2)}}return utils.compare(n1,n2)};ArrayType.prototype._update=function(resolver,type,opts){if(type.typeName==="array"){resolver.itemsType=this.itemsType.createResolver(type.itemsType,opts);resolver._read=this._read}};ArrayType.prototype._copy=function(val,opts){if(!Array.isArray(val)){throwInvalidError(val,this)}var items=new Array(val.length);var i,l;for(i=0,l=val.length;i<l;i++){items[i]=this.itemsType._copy(val[i],opts)}return items};ArrayType.prototype._deref=function(schema,opts){schema.items=this.itemsType._attrs(opts)};ArrayType.prototype.compare=function(val1,val2){var n1=val1.length;var n2=val2.length;var i,l,f;for(i=0,l=Math.min(n1,n2);i<l;i++){if(f=this.itemsType.compare(val1[i],val2[i])){return f}}return utils.compare(n1,n2)};ArrayType.prototype.getItemsType=function(){return this.itemsType};ArrayType.prototype.typeName="array";ArrayType.prototype.random=function(){var arr=[];var i,l;for(i=0,l=RANDOM.nextInt(10);i<l;i++){arr.push(this.itemsType.random())}return arr};function RecordType(schema,opts){opts=opts||{};var namespace=opts.namespace;if(schema.namespace!==undefined){opts.namespace=schema.namespace}else if(schema.name){var match=/^(.*)\.[^.]+$/.exec(schema.name);if(match){opts.namespace=match[1]}}Type.call(this,schema,opts);if(!Array.isArray(schema.fields)){throw new Error(f("non-array record fields: %j",schema.fields))}if(utils.hasDuplicates(schema.fields,(function(f){return f.name}))){throw new Error(f("duplicate field name: %j",schema.fields))}this._fieldsByName={};this.fields=Object.freeze(schema.fields.map((function(f){var field=new Field(f,opts);this._fieldsByName[field.name]=field;return field}),this));this._branchConstructor=this._createBranchConstructor();this._isError=schema.type==="error";this.recordConstructor=this._createConstructor(opts.errorStackTraces);this._read=this._createReader();this._skip=this._createSkipper();this._write=this._createWriter();this._check=this._createChecker();opts.namespace=namespace;Object.freeze(this)}util.inherits(RecordType,Type);RecordType.prototype._getConstructorName=function(){return this.name?utils.capitalize(unqualify(this.name)):this._isError?"Error$":"Record$"};RecordType.prototype._createConstructor=function(errorStackTraces){var outerArgs=[];var innerArgs=[];var ds=[];var innerBody="";var i,l,field,name,defaultValue,hasDefault,stackField;for(i=0,l=this.fields.length;i<l;i++){field=this.fields[i];defaultValue=field.defaultValue;hasDefault=defaultValue()!==undefined;name=field.name;if(errorStackTraces&&this._isError&&name==="stack"&&Type.isType(field.type,"string")&&!hasDefault){stackField=field}innerArgs.push("v"+i);innerBody+="  ";if(!hasDefault){innerBody+="this."+name+" = v"+i+";\n"}else{innerBody+="if (v"+i+" === undefined) { ";innerBody+="this."+name+" = d"+ds.length+"(); ";innerBody+="} else { this."+name+" = v"+i+"; }\n";outerArgs.push("d"+ds.length);ds.push(defaultValue)}}if(stackField){innerBody+="  if (this.stack === undefined) { ";if(typeof Error.captureStackTrace=="function"){innerBody+="Error.captureStackTrace(this, this.constructor);"}else{innerBody+="this.stack = Error().stack;"}innerBody+=" }\n"}var outerBody="return function "+this._getConstructorName()+"(";outerBody+=innerArgs.join()+") {\n"+innerBody+"};";var Record=new Function(outerArgs.join(),outerBody).apply(undefined,ds);var self=this;Record.getType=function(){return self};Record.type=self;if(this._isError){util.inherits(Record,Error);Record.prototype.name=this._getConstructorName()}Record.prototype.clone=function(o){return self.clone(this,o)};Record.prototype.compare=function(v){return self.compare(this,v)};Record.prototype.isValid=function(o){return self.isValid(this,o)};Record.prototype.toBuffer=function(){return self.toBuffer(this)};Record.prototype.toString=function(){return self.toString(this)};Record.prototype.wrap=function(){return self.wrap(this)};Record.prototype.wrapped=Record.prototype.wrap;return Record};RecordType.prototype._createChecker=function(){var names=[];var values=[];var name=this._getConstructorName();var body="return function check"+name+"(v, f, h, p) {\n";body+="  if (\n";body+="    v === null ||\n";body+="    typeof v != 'object' ||\n";body+="    (f && !this._checkFields(v))\n";body+="  ) {\n";body+="    if (h) { h(v, this); }\n";body+="    return false;\n";body+="  }\n";if(!this.fields.length){body+="  return true;\n"}else{for(i=0,l=this.fields.length;i<l;i++){field=this.fields[i];names.push("t"+i);values.push(field.type);if(field.defaultValue()!==undefined){body+="  var v"+i+" = v."+field.name+";\n"}}body+="  if (h) {\n";body+="    var b = 1;\n";body+="    var j = p.length;\n";body+="    p.push('');\n";var i,l,field;for(i=0,l=this.fields.length;i<l;i++){field=this.fields[i];body+="    p[j] = '"+field.name+"';\n";body+="    b &= ";if(field.defaultValue()===undefined){body+="t"+i+"._check(v."+field.name+", f, h, p);\n"}else{body+="v"+i+" === undefined || ";body+="t"+i+"._check(v"+i+", f, h, p);\n"}}body+="    p.pop();\n";body+="    return !!b;\n";body+="  } else {\n    return (\n      ";body+=this.fields.map((function(field,i){return field.defaultValue()===undefined?"t"+i+"._check(v."+field.name+", f)":"(v"+i+" === undefined || t"+i+"._check(v"+i+", f))"})).join(" &&\n      ");body+="\n    );\n  }\n"}body+="};";return new Function(names.join(),body).apply(undefined,values)};RecordType.prototype._createReader=function(){var names=[];var values=[this.recordConstructor];var i,l;for(i=0,l=this.fields.length;i<l;i++){names.push("t"+i);values.push(this.fields[i].type)}var name=this._getConstructorName();var body="return function read"+name+"(t) {\n";body+="  return new "+name+"(\n    ";body+=names.map((function(s){return s+"._read(t)"})).join(",\n    ");body+="\n  );\n};";names.unshift(name);return new Function(names.join(),body).apply(undefined,values)};RecordType.prototype._createSkipper=function(){var args=[];var body="return function skip"+this._getConstructorName()+"(t) {\n";var values=[];var i,l;for(i=0,l=this.fields.length;i<l;i++){args.push("t"+i);values.push(this.fields[i].type);body+="  t"+i+"._skip(t);\n"}body+="}";return new Function(args.join(),body).apply(undefined,values)};RecordType.prototype._createWriter=function(){var args=[];var name=this._getConstructorName();var body="return function write"+name+"(t, v) {\n";var values=[];var i,l,field,value;for(i=0,l=this.fields.length;i<l;i++){field=this.fields[i];args.push("t"+i);values.push(field.type);body+="  ";if(field.defaultValue()===undefined){body+="t"+i+"._write(t, v."+field.name+");\n"}else{value=field.type.toBuffer(field.defaultValue()).toString("binary");args.push("d"+i);values.push(value);body+="var v"+i+" = v."+field.name+";\n";body+="if (v"+i+" === undefined) {\n";body+="    t.writeBinary(d"+i+", "+value.length+");\n";body+="  } else {\n    t"+i+"._write(t, v"+i+");\n  }\n"}}body+="}";return new Function(args.join(),body).apply(undefined,values)};RecordType.prototype._update=function(resolver,type,opts){if(type.name&&!~getAliases(this).indexOf(type.name)){throw new Error(f("no alias found for %s",type.name))}var rFields=this.fields;var wFields=type.fields;var wFieldsMap=utils.toMap(wFields,(function(f){return f.name}));var innerArgs=[];var resolvers={};var i,j,field,name,names,matches,fieldResolver;for(i=0;i<rFields.length;i++){field=rFields[i];names=getAliases(field);matches=[];for(j=0;j<names.length;j++){name=names[j];if(wFieldsMap[name]){matches.push(name)}}if(matches.length>1){throw new Error(f("ambiguous aliasing for %s.%s (%s)",type.name,field.name,matches))}if(!matches.length){if(field.defaultValue()===undefined){throw new Error(f("no matching field for default-less %s.%s",type.name,field.name))}innerArgs.push("undefined")}else{name=matches[0];fieldResolver={resolver:field.type.createResolver(wFieldsMap[name].type,opts),name:"_"+field.name};if(!resolvers[name]){resolvers[name]=[fieldResolver]}else{resolvers[name].push(fieldResolver)}innerArgs.push(fieldResolver.name)}}var lazyIndex=-1;i=wFields.length;while(i&&resolvers[wFields[--i].name]===undefined){lazyIndex=i}var uname=this._getConstructorName();var args=[uname];var values=[this.recordConstructor];var body="  return function read"+uname+"(t, b) {\n";for(i=0;i<wFields.length;i++){if(i===lazyIndex){body+="  if (!b) {\n"}field=type.fields[i];name=field.name;if(resolvers[name]===undefined){body+=~lazyIndex&&i>=lazyIndex?"    ":"  ";args.push("r"+i);values.push(field.type);body+="r"+i+"._skip(t);\n"}else{j=resolvers[name].length;while(j--){body+=~lazyIndex&&i>=lazyIndex?"    ":"  ";args.push("r"+i+"f"+j);fieldResolver=resolvers[name][j];values.push(fieldResolver.resolver);body+="var "+fieldResolver.name+" = ";body+="r"+i+"f"+j+"._"+(j?"peek":"read")+"(t);\n"}}}if(~lazyIndex){body+="  }\n"}body+="  return new "+uname+"("+innerArgs.join()+");\n};";resolver._read=new Function(args.join(),body).apply(undefined,values)};RecordType.prototype._match=function(tap1,tap2){var fields=this.fields;var i,l,field,order,type;for(i=0,l=fields.length;i<l;i++){field=fields[i];order=field._order;type=field.type;if(order){order*=type._match(tap1,tap2);if(order){return order}}else{type._skip(tap1);type._skip(tap2)}}return 0};RecordType.prototype._checkFields=function(obj){var keys=Object.keys(obj);var i,l;for(i=0,l=keys.length;i<l;i++){if(!this._fieldsByName[keys[i]]){return false}}return true};RecordType.prototype._copy=function(val,opts){var hook=opts&&opts.fieldHook;var values=[undefined];var i,l,field,value;for(i=0,l=this.fields.length;i<l;i++){field=this.fields[i];value=val[field.name];if(value===undefined&&field.hasOwnProperty("defaultValue")){value=field.defaultValue()}if(opts&&!opts.skip||value!==undefined){value=field.type._copy(value,opts)}if(hook){value=hook(field,value,this)}values.push(value)}var Record=this.recordConstructor;return new(Record.bind.apply(Record,values))};RecordType.prototype._deref=function(schema,opts){schema.fields=this.fields.map((function(field){var fieldType=field.type;var fieldSchema={name:field.name,type:fieldType._attrs(opts)};if(opts.exportAttrs){var val=field.defaultValue();if(val!==undefined){fieldSchema["default"]=fieldType._copy(val,{coerce:3,wrap:3})}var fieldOrder=field.order;if(fieldOrder!=="ascending"){fieldSchema.order=fieldOrder}var fieldAliases=field.aliases;if(fieldAliases.length){fieldSchema.aliases=fieldAliases}var fieldDoc=field.doc;if(fieldDoc!==undefined){fieldSchema.doc=fieldDoc}}return fieldSchema}))};RecordType.prototype.compare=function(val1,val2){var fields=this.fields;var i,l,field,name,order,type;for(i=0,l=fields.length;i<l;i++){field=fields[i];name=field.name;order=field._order;type=field.type;if(order){order*=type.compare(val1[name],val2[name]);if(order){return order}}}return 0};RecordType.prototype.random=function(){var fields=this.fields.map((function(f){return f.type.random()}));fields.unshift(undefined);var Record=this.recordConstructor;return new(Record.bind.apply(Record,fields))};RecordType.prototype.field=function(name){return this._fieldsByName[name]};RecordType.prototype.getField=RecordType.prototype.field;RecordType.prototype.getFields=function(){return this.fields};RecordType.prototype.getRecordConstructor=function(){return this.recordConstructor};Object.defineProperty(RecordType.prototype,"typeName",{enumerable:true,get:function(){return this._isError?"error":"record"}});function LogicalType(schema,opts){this._logicalTypeName=schema.logicalType;Type.call(this);LOGICAL_TYPE=this;try{this._underlyingType=Type.forSchema(schema,opts)}finally{LOGICAL_TYPE=null;var l=UNDERLYING_TYPES.length;if(l&&UNDERLYING_TYPES[l-1][0]===this){UNDERLYING_TYPES.pop()}}if(Type.isType(this.underlyingType,"union")){this._branchConstructor=this.underlyingType._branchConstructor}else{this._branchConstructor=this.underlyingType._createBranchConstructor()}}util.inherits(LogicalType,Type);Object.defineProperty(LogicalType.prototype,"typeName",{enumerable:true,get:function(){return"logical:"+this._logicalTypeName}});Object.defineProperty(LogicalType.prototype,"underlyingType",{enumerable:true,get:function(){if(this._underlyingType){return this._underlyingType}var i,l,arr;for(i=0,l=UNDERLYING_TYPES.length;i<l;i++){arr=UNDERLYING_TYPES[i];if(arr[0]===this){return arr[1]}}}});LogicalType.prototype.getUnderlyingType=function(){return this.underlyingType};LogicalType.prototype._read=function(tap){return this._fromValue(this.underlyingType._read(tap))};LogicalType.prototype._write=function(tap,any){this.underlyingType._write(tap,this._toValue(any))};LogicalType.prototype._check=function(any,flags,hook,path){try{var val=this._toValue(any)}catch(err){}if(val===undefined){if(hook){hook(any,this)}return false}return this.underlyingType._check(val,flags,hook,path)};LogicalType.prototype._copy=function(any,opts){var type=this.underlyingType;switch(opts&&opts.coerce){case 3:return type._copy(this._toValue(any),opts);case 2:return this._fromValue(type._copy(any,opts));default:return this._fromValue(type._copy(this._toValue(any),opts))}};LogicalType.prototype._update=function(resolver,type,opts){var _fromValue=this._resolve(type,opts);if(_fromValue){resolver._read=function(tap){return _fromValue(type._read(tap))}}};LogicalType.prototype.compare=function(obj1,obj2){var val1=this._toValue(obj1);var val2=this._toValue(obj2);return this.underlyingType.compare(val1,val2)};LogicalType.prototype.random=function(){return this._fromValue(this.underlyingType.random())};LogicalType.prototype._deref=function(schema,opts){var type=this.underlyingType;var isVisited=type.name!==undefined&&opts.derefed[type.name];schema=type._attrs(opts);if(!isVisited&&opts.exportAttrs){if(typeof schema=="string"){schema={type:schema}}schema.logicalType=this._logicalTypeName;this._export(schema)}return schema};LogicalType.prototype._skip=function(tap){this.underlyingType._skip(tap)};LogicalType.prototype._export=function(){};LogicalType.prototype._fromValue=utils.abstractFunction;LogicalType.prototype._toValue=utils.abstractFunction;LogicalType.prototype._resolve=utils.abstractFunction;function AbstractLongType(noUnpack){this._concreteTypeName="long";PrimitiveType.call(this,true);this._noUnpack=!!noUnpack}util.inherits(AbstractLongType,LongType);AbstractLongType.prototype.typeName="abstract:long";AbstractLongType.prototype._check=function(val,flags,hook){var b=this._isValid(val);if(!b&&hook){hook(val,this)}return b};AbstractLongType.prototype._read=function(tap){var buf,pos;if(this._noUnpack){pos=tap.pos;tap.skipLong();buf=tap.buf.slice(pos,tap.pos)}else{buf=tap.unpackLongBytes(tap)}if(tap.isValid()){return this._fromBuffer(buf)}};AbstractLongType.prototype._write=function(tap,val){if(!this._isValid(val)){throwInvalidError(val,this)}var buf=this._toBuffer(val);if(this._noUnpack){tap.writeFixed(buf)}else{tap.packLongBytes(buf)}};AbstractLongType.prototype._copy=function(val,opts){switch(opts&&opts.coerce){case 3:return this._toJSON(val);case 2:return this._fromJSON(val);default:return this._fromJSON(this._toJSON(val))}};AbstractLongType.prototype._deref=function(){return"long"};AbstractLongType.prototype._update=function(resolver,type){var self=this;switch(type.typeName){case"int":resolver._read=function(tap){return self._fromJSON(type._read(tap))};break;case"abstract:long":case"long":resolver._read=function(tap){return self._read(tap)}}};AbstractLongType.prototype.random=function(){return this._fromJSON(LongType.prototype.random())};AbstractLongType.prototype._fromBuffer=utils.abstractFunction;AbstractLongType.prototype._toBuffer=utils.abstractFunction;AbstractLongType.prototype._fromJSON=utils.abstractFunction;AbstractLongType.prototype._toJSON=utils.abstractFunction;AbstractLongType.prototype._isValid=utils.abstractFunction;AbstractLongType.prototype.compare=utils.abstractFunction;function Field(schema,opts){var name=schema.name;if(typeof name!="string"||!isValidName(name)){throw new Error(f("invalid field name: %s",name))}this.name=name;this.type=Type.forSchema(schema.type,opts);this.aliases=schema.aliases||[];this.doc=schema.doc!==undefined?""+schema.doc:undefined;this._order=function(order){switch(order){case"ascending":return 1;case"descending":return-1;case"ignore":return 0;default:throw new Error(f("invalid order: %j",order))}}(schema.order===undefined?"ascending":schema.order);var value=schema["default"];if(value!==undefined){var type=this.type;var val=type._copy(value,{coerce:2,wrap:2});if(isPrimitive$1(type.typeName)&&type.typeName!=="bytes"){this.defaultValue=function(){return val}}else{this.defaultValue=function(){return type._copy(val)}}}Object.freeze(this)}Field.prototype.defaultValue=function(){};Object.defineProperty(Field.prototype,"order",{enumerable:true,get:function(){return["descending","ignore","ascending"][this._order+1]}});Field.prototype.getAliases=function(){return this.aliases};Field.prototype.getDefault=Field.prototype.defaultValue;Field.prototype.getName=function(){return this.name};Field.prototype.getOrder=function(){return this.order};Field.prototype.getType=function(){return this.type};function Resolver(readerType){this._readerType=readerType;this._read=null;this.itemsType=null;this.size=0;this.symbols=null;this.valuesType=null}Resolver.prototype._peek=Type.prototype._peek;Resolver.prototype.inspect=function(){return"<Resolver>"};function Hash(){this.str=undefined}function readValue(type,tap,resolver,lazy){if(resolver){if(resolver._readerType!==type){throw new Error("invalid resolver")}return resolver._read(tap,lazy)}else{return type._read(tap)}}function unqualify(name){var parts=name.split(".");return parts[parts.length-1]}function qualify(name,namespace){if(~name.indexOf(".")){name=name.replace(/^\./,"")}else if(namespace){name=namespace+"."+name}name.split(".").forEach((function(part){if(!isValidName(part)){throw new Error(f("invalid name: %j",name))}}));var tail=unqualify(name);return isPrimitive$1(tail)?tail:name}function getAliases(obj){var names={};if(obj.name){names[obj.name]=true}var aliases=obj.aliases;var i,l;for(i=0,l=aliases.length;i<l;i++){names[aliases[i]]=true}return Object.keys(names)}function isPrimitive$1(typeName){var type=TYPES[typeName];return type&&type.prototype instanceof PrimitiveType}function getClassName(typeName){if(typeName==="error"){typeName="record"}else{var match=/^([^:]+):(.*)$/.exec(typeName);if(match){if(match[1]==="union"){typeName=match[2]+"Union"}else{typeName=match[1]}}}return utils.capitalize(typeName)+"Type"}function readArraySize(tap){var n=tap.readLong();if(n<0){n=-n;tap.skipLong()}return n}function isSafeLong(n){return n>=-9007199254740990&&n<=9007199254740990}function isJsonBuffer(obj){return obj&&obj.type==="Buffer"&&Array.isArray(obj.data)}function isValidName(str){return NAME_PATTERN.test(str)}function throwInvalidError(val,type){throw new Error(f("invalid %j: %j",type.schema(),val))}function getTypeBucket(type){var typeName=type.typeName;switch(typeName){case"double":case"float":case"int":case"long":return"number";case"bytes":case"fixed":return"buffer";case"enum":return"string";case"map":case"error":case"record":return"object";default:return typeName}}function getValueBucket(val){if(val===null){return"null"}var bucket=typeof val;if(bucket==="object"){if(Array.isArray(val)){return"array"}else if(isBuffer(val)){return"buffer"}}return bucket}function isAmbiguous(types){var buckets={};var i,l,bucket,type;for(i=0,l=types.length;i<l;i++){type=types[i];if(!Type.isType(type,"logical")){bucket=getTypeBucket(type);if(buckets[bucket]){return true}buckets[bucket]=true}}return false}function combineNumbers(types){var typeNames=["int","long","float","double"];var superIndex=-1;var superType=null;var i,l,type,index;for(i=0,l=types.length;i<l;i++){type=types[i];index=typeNames.indexOf(type.typeName);if(index>superIndex){superIndex=index;superType=type}}return superType}function combineStrings(types,opts){var symbols={};var i,l,type,typeSymbols;for(i=0,l=types.length;i<l;i++){type=types[i];if(type.typeName==="string"){return type}typeSymbols=type.symbols;var j,m;for(j=0,m=typeSymbols.length;j<m;j++){symbols[typeSymbols[j]]=true}}return Type.forSchema({type:"enum",symbols:Object.keys(symbols)},opts)}function combineBuffers(types,opts){var size=-1;var i,l,type;for(i=0,l=types.length;i<l;i++){type=types[i];if(type.typeName==="bytes"){return type}if(size===-1){size=type.size}else if(type.size!==size){size=-2}}return size<0?Type.forSchema("bytes",opts):types[0]}function combineObjects(types,opts){var allTypes=[];var fieldTypes={};var fieldDefaults={};var isValidRecord=true;var i,l,type,fields;for(i=0,l=types.length;i<l;i++){type=types[i];if(type.typeName==="map"){isValidRecord=false;allTypes.push(type.valuesType)}else{fields=type.fields;var j,m,field,fieldDefault,fieldName,fieldType;for(j=0,m=fields.length;j<m;j++){field=fields[j];fieldName=field.name;fieldType=field.type;allTypes.push(fieldType);if(isValidRecord){if(!fieldTypes[fieldName]){fieldTypes[fieldName]=[]}fieldTypes[fieldName].push(fieldType);fieldDefault=field.defaultValue();if(fieldDefault!==undefined){fieldDefaults[fieldName]=fieldDefault}}}}}if(isValidRecord){var fieldNames=Object.keys(fieldTypes);for(i=0,l=fieldNames.length;i<l;i++){fieldName=fieldNames[i];if(fieldTypes[fieldName].length<types.length&&fieldDefaults[fieldName]===undefined){if(opts&&opts.strictDefaults){isValidRecord=false}else{fieldTypes[fieldName].unshift(Type.forSchema("null",opts));fieldDefaults[fieldName]=null}}}}var schema;if(isValidRecord){schema={type:"record",fields:fieldNames.map((function(s){var fieldType=Type.forTypes(fieldTypes[s],opts);var fieldDefault=fieldDefaults[s];if(fieldDefault!==undefined&&~fieldType.typeName.indexOf("union")){var unionTypes=fieldType.types.slice();var i,l;for(i=0,l=unionTypes.length;i<l;i++){if(unionTypes[i].isValid(fieldDefault)){break}}if(i>0){var unionType=unionTypes[0];unionTypes[0]=unionTypes[i];unionTypes[i]=unionType;fieldType=Type.forSchema(unionTypes,opts)}}return{name:s,type:fieldType,default:fieldDefaults[s]}}))}}else{schema={type:"map",values:Type.forTypes(allTypes,opts)}}return Type.forSchema(schema,opts)}var types={Type:Type,getTypeBucket:getTypeBucket,getValueBucket:getValueBucket,isPrimitive:isPrimitive$1,isValidName:isValidName,qualify:qualify,builtins:function(){var types={LogicalType:LogicalType,UnwrappedUnionType:UnwrappedUnionType,WrappedUnionType:WrappedUnionType};var typeNames=Object.keys(TYPES);var i,l,typeName;for(i=0,l=typeNames.length;i<l;i++){typeName=typeNames[i];types[getClassName(typeName)]=TYPES[typeName]}return types}()};var domain;function EventHandlers(){}EventHandlers.prototype=Object.create(null);function EventEmitter(){EventEmitter.init.call(this)}EventEmitter.EventEmitter=EventEmitter;EventEmitter.usingDomains=false;EventEmitter.prototype.domain=undefined;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.init=function(){this.domain=null;if(EventEmitter.usingDomains){if(domain.active);}if(!this._events||this._events===Object.getPrototypeOf(this)._events){this._events=new EventHandlers;this._eventsCount=0}this._maxListeners=this._maxListeners||undefined};EventEmitter.prototype.setMaxListeners=function setMaxListeners(n){if(typeof n!=="number"||n<0||isNaN(n))throw new TypeError('"n" argument must be a positive number');this._maxListeners=n;return this};function $getMaxListeners(that){if(that._maxListeners===undefined)return EventEmitter.defaultMaxListeners;return that._maxListeners}EventEmitter.prototype.getMaxListeners=function getMaxListeners(){return $getMaxListeners(this)};function emitNone(handler,isFn,self){if(isFn)handler.call(self);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)listeners[i].call(self)}}function emitOne(handler,isFn,self,arg1){if(isFn)handler.call(self,arg1);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)listeners[i].call(self,arg1)}}function emitTwo(handler,isFn,self,arg1,arg2){if(isFn)handler.call(self,arg1,arg2);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)listeners[i].call(self,arg1,arg2)}}function emitThree(handler,isFn,self,arg1,arg2,arg3){if(isFn)handler.call(self,arg1,arg2,arg3);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)listeners[i].call(self,arg1,arg2,arg3)}}function emitMany(handler,isFn,self,args){if(isFn)handler.apply(self,args);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)listeners[i].apply(self,args)}}EventEmitter.prototype.emit=function emit(type){var er,handler,len,args,i,events,domain;var doError=type==="error";events=this._events;if(events)doError=doError&&events.error==null;else if(!doError)return false;domain=this.domain;if(doError){er=arguments[1];if(domain){if(!er)er=new Error('Uncaught, unspecified "error" event');er.domainEmitter=this;er.domain=domain;er.domainThrown=false;domain.emit("error",er)}else if(er instanceof Error){throw er}else{var err=new Error('Uncaught, unspecified "error" event. ('+er+")");err.context=er;throw err}return false}handler=events[type];if(!handler)return false;var isFn=typeof handler==="function";len=arguments.length;switch(len){case 1:emitNone(handler,isFn,this);break;case 2:emitOne(handler,isFn,this,arguments[1]);break;case 3:emitTwo(handler,isFn,this,arguments[1],arguments[2]);break;case 4:emitThree(handler,isFn,this,arguments[1],arguments[2],arguments[3]);break;default:args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];emitMany(handler,isFn,this,args)}return true};function _addListener(target,type,listener,prepend){var m;var events;var existing;if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');events=target._events;if(!events){events=target._events=new EventHandlers;target._eventsCount=0}else{if(events.newListener){target.emit("newListener",type,listener.listener?listener.listener:listener);events=target._events}existing=events[type]}if(!existing){existing=events[type]=listener;++target._eventsCount}else{if(typeof existing==="function"){existing=events[type]=prepend?[listener,existing]:[existing,listener]}else{if(prepend){existing.unshift(listener)}else{existing.push(listener)}}if(!existing.warned){m=$getMaxListeners(target);if(m&&m>0&&existing.length>m){existing.warned=true;var w=new Error("Possible EventEmitter memory leak detected. "+existing.length+" "+type+" listeners added. "+"Use emitter.setMaxListeners() to increase limit");w.name="MaxListenersExceededWarning";w.emitter=target;w.type=type;w.count=existing.length;emitWarning(w)}}}return target}function emitWarning(e){typeof console.warn==="function"?console.warn(e):console.log(e)}EventEmitter.prototype.addListener=function addListener(type,listener){return _addListener(this,type,listener,false)};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.prependListener=function prependListener(type,listener){return _addListener(this,type,listener,true)};function _onceWrap(target,type,listener){var fired=false;function g(){target.removeListener(type,g);if(!fired){fired=true;listener.apply(target,arguments)}}g.listener=listener;return g}EventEmitter.prototype.once=function once(type,listener){if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');this.on(type,_onceWrap(this,type,listener));return this};EventEmitter.prototype.prependOnceListener=function prependOnceListener(type,listener){if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');this.prependListener(type,_onceWrap(this,type,listener));return this};EventEmitter.prototype.removeListener=function removeListener(type,listener){var list,events,position,i,originalListener;if(typeof listener!=="function")throw new TypeError('"listener" argument must be a function');events=this._events;if(!events)return this;list=events[type];if(!list)return this;if(list===listener||list.listener&&list.listener===listener){if(--this._eventsCount===0)this._events=new EventHandlers;else{delete events[type];if(events.removeListener)this.emit("removeListener",type,list.listener||listener)}}else if(typeof list!=="function"){position=-1;for(i=list.length;i-- >0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){originalListener=list[i].listener;position=i;break}}if(position<0)return this;if(list.length===1){list[0]=undefined;if(--this._eventsCount===0){this._events=new EventHandlers;return this}else{delete events[type]}}else{spliceOne(list,position)}if(events.removeListener)this.emit("removeListener",type,originalListener||listener)}return this};EventEmitter.prototype.removeAllListeners=function removeAllListeners(type){var listeners,events;events=this._events;if(!events)return this;if(!events.removeListener){if(arguments.length===0){this._events=new EventHandlers;this._eventsCount=0}else if(events[type]){if(--this._eventsCount===0)this._events=new EventHandlers;else delete events[type]}return this}if(arguments.length===0){var keys=Object.keys(events);for(var i=0,key;i<keys.length;++i){key=keys[i];if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events=new EventHandlers;this._eventsCount=0;return this}listeners=events[type];if(typeof listeners==="function"){this.removeListener(type,listeners)}else if(listeners){do{this.removeListener(type,listeners[listeners.length-1])}while(listeners[0])}return this};EventEmitter.prototype.listeners=function listeners(type){var evlistener;var ret;var events=this._events;if(!events)ret=[];else{evlistener=events[type];if(!evlistener)ret=[];else if(typeof evlistener==="function")ret=[evlistener.listener||evlistener];else ret=unwrapListeners(evlistener)}return ret};EventEmitter.listenerCount=function(emitter,type){if(typeof emitter.listenerCount==="function"){return emitter.listenerCount(type)}else{return listenerCount.call(emitter,type)}};EventEmitter.prototype.listenerCount=listenerCount;function listenerCount(type){var events=this._events;if(events){var evlistener=events[type];if(typeof evlistener==="function"){return 1}else if(evlistener){return evlistener.length}}return 0}EventEmitter.prototype.eventNames=function eventNames(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};function spliceOne(list,index){for(var i=index,k=i+1,n=list.length;k<n;i+=1,k+=1)list[i]=list[k];list.pop()}function arrayClone(arr,i){var copy=new Array(i);while(i--)copy[i]=arr[i];return copy}function unwrapListeners(arr){var ret=new Array(arr.length);for(var i=0;i<ret.length;++i){ret[i]=arr[i].listener||arr[i]}return ret}function BufferList(){this.head=null;this.tail=null;this.length=0}BufferList.prototype.push=function(v){var entry={data:v,next:null};if(this.length>0)this.tail.next=entry;else this.head=entry;this.tail=entry;++this.length};BufferList.prototype.unshift=function(v){var entry={data:v,next:this.head};if(this.length===0)this.tail=entry;this.head=entry;++this.length};BufferList.prototype.shift=function(){if(this.length===0)return;var ret=this.head.data;if(this.length===1)this.head=this.tail=null;else this.head=this.head.next;--this.length;return ret};BufferList.prototype.clear=function(){this.head=this.tail=null;this.length=0};BufferList.prototype.join=function(s){if(this.length===0)return"";var p=this.head;var ret=""+p.data;while(p=p.next){ret+=s+p.data}return ret};BufferList.prototype.concat=function(n){if(this.length===0)return Buffer.alloc(0);if(this.length===1)return this.head.data;var ret=Buffer.allocUnsafe(n>>>0);var p=this.head;var i=0;while(p){p.data.copy(ret,i);i+=p.data.length;p=p.next}return ret};var isBufferEncoding=Buffer.isEncoding||function(encoding){switch(encoding&&encoding.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return true;default:return false}};function assertEncoding(encoding){if(encoding&&!isBufferEncoding(encoding)){throw new Error("Unknown encoding: "+encoding)}}function StringDecoder(encoding){this.encoding=(encoding||"utf8").toLowerCase().replace(/[-_]/,"");assertEncoding(encoding);switch(this.encoding){case"utf8":this.surrogateSize=3;break;case"ucs2":case"utf16le":this.surrogateSize=2;this.detectIncompleteChar=utf16DetectIncompleteChar;break;case"base64":this.surrogateSize=3;this.detectIncompleteChar=base64DetectIncompleteChar;break;default:this.write=passThroughWrite;return}this.charBuffer=new Buffer(6);this.charReceived=0;this.charLength=0}StringDecoder.prototype.write=function(buffer){var charStr="";while(this.charLength){var available=buffer.length>=this.charLength-this.charReceived?this.charLength-this.charReceived:buffer.length;buffer.copy(this.charBuffer,this.charReceived,0,available);this.charReceived+=available;if(this.charReceived<this.charLength){return""}buffer=buffer.slice(available,buffer.length);charStr=this.charBuffer.slice(0,this.charLength).toString(this.encoding);var charCode=charStr.charCodeAt(charStr.length-1);if(charCode>=55296&&charCode<=56319){this.charLength+=this.surrogateSize;charStr="";continue}this.charReceived=this.charLength=0;if(buffer.length===0){return charStr}break}this.detectIncompleteChar(buffer);var end=buffer.length;if(this.charLength){buffer.copy(this.charBuffer,0,buffer.length-this.charReceived,end);end-=this.charReceived}charStr+=buffer.toString(this.encoding,0,end);var end=charStr.length-1;var charCode=charStr.charCodeAt(end);if(charCode>=55296&&charCode<=56319){var size=this.surrogateSize;this.charLength+=size;this.charReceived+=size;this.charBuffer.copy(this.charBuffer,size,0,size);buffer.copy(this.charBuffer,0,0,size);return charStr.substring(0,end)}return charStr};StringDecoder.prototype.detectIncompleteChar=function(buffer){var i=buffer.length>=3?3:buffer.length;for(;i>0;i--){var c=buffer[buffer.length-i];if(i==1&&c>>5==6){this.charLength=2;break}if(i<=2&&c>>4==14){this.charLength=3;break}if(i<=3&&c>>3==30){this.charLength=4;break}}this.charReceived=i};StringDecoder.prototype.end=function(buffer){var res="";if(buffer&&buffer.length)res=this.write(buffer);if(this.charReceived){var cr=this.charReceived;var buf=this.charBuffer;var enc=this.encoding;res+=buf.slice(0,cr).toString(enc)}return res};function passThroughWrite(buffer){return buffer.toString(this.encoding)}function utf16DetectIncompleteChar(buffer){this.charReceived=buffer.length%2;this.charLength=this.charReceived?2:0}function base64DetectIncompleteChar(buffer){this.charReceived=buffer.length%3;this.charLength=this.charReceived?3:0}Readable.ReadableState=ReadableState;var debug$1=debuglog("stream");inherits$1(Readable,EventEmitter);function prependListener(emitter,event,fn){if(typeof emitter.prependListener==="function"){return emitter.prependListener(event,fn)}else{if(!emitter._events||!emitter._events[event])emitter.on(event,fn);else if(Array.isArray(emitter._events[event]))emitter._events[event].unshift(fn);else emitter._events[event]=[fn,emitter._events[event]]}}function listenerCount$1(emitter,type){return emitter.listeners(type).length}function ReadableState(options,stream){options=options||{};this.objectMode=!!options.objectMode;if(stream instanceof Duplex)this.objectMode=this.objectMode||!!options.readableObjectMode;var hwm=options.highWaterMark;var defaultHwm=this.objectMode?16:16*1024;this.highWaterMark=hwm||hwm===0?hwm:defaultHwm;this.highWaterMark=~~this.highWaterMark;this.buffer=new BufferList;this.length=0;this.pipes=null;this.pipesCount=0;this.flowing=null;this.ended=false;this.endEmitted=false;this.reading=false;this.sync=true;this.needReadable=false;this.emittedReadable=false;this.readableListening=false;this.resumeScheduled=false;this.defaultEncoding=options.defaultEncoding||"utf8";this.ranOut=false;this.awaitDrain=0;this.readingMore=false;this.decoder=null;this.encoding=null;if(options.encoding){this.decoder=new StringDecoder(options.encoding);this.encoding=options.encoding}}function Readable(options){if(!(this instanceof Readable))return new Readable(options);this._readableState=new ReadableState(options,this);this.readable=true;if(options&&typeof options.read==="function")this._read=options.read;EventEmitter.call(this)}Readable.prototype.push=function(chunk,encoding){var state=this._readableState;if(!state.objectMode&&typeof chunk==="string"){encoding=encoding||state.defaultEncoding;if(encoding!==state.encoding){chunk=Buffer.from(chunk,encoding);encoding=""}}return readableAddChunk(this,state,chunk,encoding,false)};Readable.prototype.unshift=function(chunk){var state=this._readableState;return readableAddChunk(this,state,chunk,"",true)};Readable.prototype.isPaused=function(){return this._readableState.flowing===false};function readableAddChunk(stream,state,chunk,encoding,addToFront){var er=chunkInvalid(state,chunk);if(er){stream.emit("error",er)}else if(chunk===null){state.reading=false;onEofChunk(stream,state)}else if(state.objectMode||chunk&&chunk.length>0){if(state.ended&&!addToFront){var e=new Error("stream.push() after EOF");stream.emit("error",e)}else if(state.endEmitted&&addToFront){var _e=new Error("stream.unshift() after end event");stream.emit("error",_e)}else{var skipAdd;if(state.decoder&&!addToFront&&!encoding){chunk=state.decoder.write(chunk);skipAdd=!state.objectMode&&chunk.length===0}if(!addToFront)state.reading=false;if(!skipAdd){if(state.flowing&&state.length===0&&!state.sync){stream.emit("data",chunk);stream.read(0)}else{state.length+=state.objectMode?1:chunk.length;if(addToFront)state.buffer.unshift(chunk);else state.buffer.push(chunk);if(state.needReadable)emitReadable(stream)}}maybeReadMore(stream,state)}}else if(!addToFront){state.reading=false}return needMoreData(state)}function needMoreData(state){return!state.ended&&(state.needReadable||state.length<state.highWaterMark||state.length===0)}Readable.prototype.setEncoding=function(enc){this._readableState.decoder=new StringDecoder(enc);this._readableState.encoding=enc;return this};var MAX_HWM=8388608;function computeNewHighWaterMark(n){if(n>=MAX_HWM){n=MAX_HWM}else{n--;n|=n>>>1;n|=n>>>2;n|=n>>>4;n|=n>>>8;n|=n>>>16;n++}return n}function howMuchToRead(n,state){if(n<=0||state.length===0&&state.ended)return 0;if(state.objectMode)return 1;if(n!==n){if(state.flowing&&state.length)return state.buffer.head.data.length;else return state.length}if(n>state.highWaterMark)state.highWaterMark=computeNewHighWaterMark(n);if(n<=state.length)return n;if(!state.ended){state.needReadable=true;return 0}return state.length}Readable.prototype.read=function(n){debug$1("read",n);n=parseInt(n,10);var state=this._readableState;var nOrig=n;if(n!==0)state.emittedReadable=false;if(n===0&&state.needReadable&&(state.length>=state.highWaterMark||state.ended)){debug$1("read: emitReadable",state.length,state.ended);if(state.length===0&&state.ended)endReadable(this);else emitReadable(this);return null}n=howMuchToRead(n,state);if(n===0&&state.ended){if(state.length===0)endReadable(this);return null}var doRead=state.needReadable;debug$1("need readable",doRead);if(state.length===0||state.length-n<state.highWaterMark){doRead=true;debug$1("length less than watermark",doRead)}if(state.ended||state.reading){doRead=false;debug$1("reading or ended",doRead)}else if(doRead){debug$1("do read");state.reading=true;state.sync=true;if(state.length===0)state.needReadable=true;this._read(state.highWaterMark);state.sync=false;if(!state.reading)n=howMuchToRead(nOrig,state)}var ret;if(n>0)ret=fromList(n,state);else ret=null;if(ret===null){state.needReadable=true;n=0}else{state.length-=n}if(state.length===0){if(!state.ended)state.needReadable=true;if(nOrig!==n&&state.ended)endReadable(this)}if(ret!==null)this.emit("data",ret);return ret};function chunkInvalid(state,chunk){var er=null;if(!isBuffer(chunk)&&typeof chunk!=="string"&&chunk!==null&&chunk!==undefined&&!state.objectMode){er=new TypeError("Invalid non-string/buffer chunk")}return er}function onEofChunk(stream,state){if(state.ended)return;if(state.decoder){var chunk=state.decoder.end();if(chunk&&chunk.length){state.buffer.push(chunk);state.length+=state.objectMode?1:chunk.length}}state.ended=true;emitReadable(stream)}function emitReadable(stream){var state=stream._readableState;state.needReadable=false;if(!state.emittedReadable){debug$1("emitReadable",state.flowing);state.emittedReadable=true;if(state.sync)nextTick(emitReadable_,stream);else emitReadable_(stream)}}function emitReadable_(stream){debug$1("emit readable");stream.emit("readable");flow(stream)}function maybeReadMore(stream,state){if(!state.readingMore){state.readingMore=true;nextTick(maybeReadMore_,stream,state)}}function maybeReadMore_(stream,state){var len=state.length;while(!state.reading&&!state.flowing&&!state.ended&&state.length<state.highWaterMark){debug$1("maybeReadMore read 0");stream.read(0);if(len===state.length)break;else len=state.length}state.readingMore=false}Readable.prototype._read=function(n){this.emit("error",new Error("not implemented"))};Readable.prototype.pipe=function(dest,pipeOpts){var src=this;var state=this._readableState;switch(state.pipesCount){case 0:state.pipes=dest;break;case 1:state.pipes=[state.pipes,dest];break;default:state.pipes.push(dest);break}state.pipesCount+=1;debug$1("pipe count=%d opts=%j",state.pipesCount,pipeOpts);var doEnd=!pipeOpts||pipeOpts.end!==false;var endFn=doEnd?onend:cleanup;if(state.endEmitted)nextTick(endFn);else src.once("end",endFn);dest.on("unpipe",onunpipe);function onunpipe(readable){debug$1("onunpipe");if(readable===src){cleanup()}}function onend(){debug$1("onend");dest.end()}var ondrain=pipeOnDrain(src);dest.on("drain",ondrain);var cleanedUp=false;function cleanup(){debug$1("cleanup");dest.removeListener("close",onclose);dest.removeListener("finish",onfinish);dest.removeListener("drain",ondrain);dest.removeListener("error",onerror);dest.removeListener("unpipe",onunpipe);src.removeListener("end",onend);src.removeListener("end",cleanup);src.removeListener("data",ondata);cleanedUp=true;if(state.awaitDrain&&(!dest._writableState||dest._writableState.needDrain))ondrain()}var increasedAwaitDrain=false;src.on("data",ondata);function ondata(chunk){debug$1("ondata");increasedAwaitDrain=false;var ret=dest.write(chunk);if(false===ret&&!increasedAwaitDrain){if((state.pipesCount===1&&state.pipes===dest||state.pipesCount>1&&indexOf(state.pipes,dest)!==-1)&&!cleanedUp){debug$1("false write response, pause",src._readableState.awaitDrain);src._readableState.awaitDrain++;increasedAwaitDrain=true}src.pause()}}function onerror(er){debug$1("onerror",er);unpipe();dest.removeListener("error",onerror);if(listenerCount$1(dest,"error")===0)dest.emit("error",er)}prependListener(dest,"error",onerror);function onclose(){dest.removeListener("finish",onfinish);unpipe()}dest.once("close",onclose);function onfinish(){debug$1("onfinish");dest.removeListener("close",onclose);unpipe()}dest.once("finish",onfinish);function unpipe(){debug$1("unpipe");src.unpipe(dest)}dest.emit("pipe",src);if(!state.flowing){debug$1("pipe resume");src.resume()}return dest};function pipeOnDrain(src){return function(){var state=src._readableState;debug$1("pipeOnDrain",state.awaitDrain);if(state.awaitDrain)state.awaitDrain--;if(state.awaitDrain===0&&src.listeners("data").length){state.flowing=true;flow(src)}}}Readable.prototype.unpipe=function(dest){var state=this._readableState;if(state.pipesCount===0)return this;if(state.pipesCount===1){if(dest&&dest!==state.pipes)return this;if(!dest)dest=state.pipes;state.pipes=null;state.pipesCount=0;state.flowing=false;if(dest)dest.emit("unpipe",this);return this}if(!dest){var dests=state.pipes;var len=state.pipesCount;state.pipes=null;state.pipesCount=0;state.flowing=false;for(var _i=0;_i<len;_i++){dests[_i].emit("unpipe",this)}return this}var i=indexOf(state.pipes,dest);if(i===-1)return this;state.pipes.splice(i,1);state.pipesCount-=1;if(state.pipesCount===1)state.pipes=state.pipes[0];dest.emit("unpipe",this);return this};Readable.prototype.on=function(ev,fn){var res=EventEmitter.prototype.on.call(this,ev,fn);if(ev==="data"){if(this._readableState.flowing!==false)this.resume()}else if(ev==="readable"){var state=this._readableState;if(!state.endEmitted&&!state.readableListening){state.readableListening=state.needReadable=true;state.emittedReadable=false;if(!state.reading){nextTick(nReadingNextTick,this)}else if(state.length){emitReadable(this)}}}return res};Readable.prototype.addListener=Readable.prototype.on;function nReadingNextTick(self){debug$1("readable nexttick read 0");self.read(0)}Readable.prototype.resume=function(){var state=this._readableState;if(!state.flowing){debug$1("resume");state.flowing=true;resume(this,state)}return this};function resume(stream,state){if(!state.resumeScheduled){state.resumeScheduled=true;nextTick(resume_,stream,state)}}function resume_(stream,state){if(!state.reading){debug$1("resume read 0");stream.read(0)}state.resumeScheduled=false;state.awaitDrain=0;stream.emit("resume");flow(stream);if(state.flowing&&!state.reading)stream.read(0)}Readable.prototype.pause=function(){debug$1("call pause flowing=%j",this._readableState.flowing);if(false!==this._readableState.flowing){debug$1("pause");this._readableState.flowing=false;this.emit("pause")}return this};function flow(stream){var state=stream._readableState;debug$1("flow",state.flowing);while(state.flowing&&stream.read()!==null){}}Readable.prototype.wrap=function(stream){var state=this._readableState;var paused=false;var self=this;stream.on("end",(function(){debug$1("wrapped end");if(state.decoder&&!state.ended){var chunk=state.decoder.end();if(chunk&&chunk.length)self.push(chunk)}self.push(null)}));stream.on("data",(function(chunk){debug$1("wrapped data");if(state.decoder)chunk=state.decoder.write(chunk);if(state.objectMode&&(chunk===null||chunk===undefined))return;else if(!state.objectMode&&(!chunk||!chunk.length))return;var ret=self.push(chunk);if(!ret){paused=true;stream.pause()}}));for(var i in stream){if(this[i]===undefined&&typeof stream[i]==="function"){this[i]=function(method){return function(){return stream[method].apply(stream,arguments)}}(i)}}var events=["error","close","destroy","pause","resume"];forEach(events,(function(ev){stream.on(ev,self.emit.bind(self,ev))}));self._read=function(n){debug$1("wrapped _read",n);if(paused){paused=false;stream.resume()}};return self};Readable._fromList=fromList;function fromList(n,state){if(state.length===0)return null;var ret;if(state.objectMode)ret=state.buffer.shift();else if(!n||n>=state.length){if(state.decoder)ret=state.buffer.join("");else if(state.buffer.length===1)ret=state.buffer.head.data;else ret=state.buffer.concat(state.length);state.buffer.clear()}else{ret=fromListPartial(n,state.buffer,state.decoder)}return ret}function fromListPartial(n,list,hasStrings){var ret;if(n<list.head.data.length){ret=list.head.data.slice(0,n);list.head.data=list.head.data.slice(n)}else if(n===list.head.data.length){ret=list.shift()}else{ret=hasStrings?copyFromBufferString(n,list):copyFromBuffer(n,list)}return ret}function copyFromBufferString(n,list){var p=list.head;var c=1;var ret=p.data;n-=ret.length;while(p=p.next){var str=p.data;var nb=n>str.length?str.length:n;if(nb===str.length)ret+=str;else ret+=str.slice(0,n);n-=nb;if(n===0){if(nb===str.length){++c;if(p.next)list.head=p.next;else list.head=list.tail=null}else{list.head=p;p.data=str.slice(nb)}break}++c}list.length-=c;return ret}function copyFromBuffer(n,list){var ret=Buffer.allocUnsafe(n);var p=list.head;var c=1;p.data.copy(ret);n-=p.data.length;while(p=p.next){var buf=p.data;var nb=n>buf.length?buf.length:n;buf.copy(ret,ret.length-n,0,nb);n-=nb;if(n===0){if(nb===buf.length){++c;if(p.next)list.head=p.next;else list.head=list.tail=null}else{list.head=p;p.data=buf.slice(nb)}break}++c}list.length-=c;return ret}function endReadable(stream){var state=stream._readableState;if(state.length>0)throw new Error('"endReadable()" called on non-empty stream');if(!state.endEmitted){state.ended=true;nextTick(endReadableNT,state,stream)}}function endReadableNT(state,stream){if(!state.endEmitted&&state.length===0){state.endEmitted=true;stream.readable=false;stream.emit("end")}}function forEach(xs,f){for(var i=0,l=xs.length;i<l;i++){f(xs[i],i)}}function indexOf(xs,x){for(var i=0,l=xs.length;i<l;i++){if(xs[i]===x)return i}return-1}Writable.WritableState=WritableState;inherits$1(Writable,EventEmitter);function nop(){}function WriteReq(chunk,encoding,cb){this.chunk=chunk;this.encoding=encoding;this.callback=cb;this.next=null}function WritableState(options,stream){Object.defineProperty(this,"buffer",{get:deprecate((function(){return this.getBuffer()}),"_writableState.buffer is deprecated. Use _writableState.getBuffer "+"instead.")});options=options||{};this.objectMode=!!options.objectMode;if(stream instanceof Duplex)this.objectMode=this.objectMode||!!options.writableObjectMode;var hwm=options.highWaterMark;var defaultHwm=this.objectMode?16:16*1024;this.highWaterMark=hwm||hwm===0?hwm:defaultHwm;this.highWaterMark=~~this.highWaterMark;this.needDrain=false;this.ending=false;this.ended=false;this.finished=false;var noDecode=options.decodeStrings===false;this.decodeStrings=!noDecode;this.defaultEncoding=options.defaultEncoding||"utf8";this.length=0;this.writing=false;this.corked=0;this.sync=true;this.bufferProcessing=false;this.onwrite=function(er){onwrite(stream,er)};this.writecb=null;this.writelen=0;this.bufferedRequest=null;this.lastBufferedRequest=null;this.pendingcb=0;this.prefinished=false;this.errorEmitted=false;this.bufferedRequestCount=0;this.corkedRequestsFree=new CorkedRequest(this)}WritableState.prototype.getBuffer=function writableStateGetBuffer(){var current=this.bufferedRequest;var out=[];while(current){out.push(current);current=current.next}return out};function Writable(options){if(!(this instanceof Writable)&&!(this instanceof Duplex))return new Writable(options);this._writableState=new WritableState(options,this);this.writable=true;if(options){if(typeof options.write==="function")this._write=options.write;if(typeof options.writev==="function")this._writev=options.writev}EventEmitter.call(this)}Writable.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe, not readable"))};function writeAfterEnd(stream,cb){var er=new Error("write after end");stream.emit("error",er);nextTick(cb,er)}function validChunk(stream,state,chunk,cb){var valid=true;var er=false;if(chunk===null){er=new TypeError("May not write null values to stream")}else if(!Buffer.isBuffer(chunk)&&typeof chunk!=="string"&&chunk!==undefined&&!state.objectMode){er=new TypeError("Invalid non-string/buffer chunk")}if(er){stream.emit("error",er);nextTick(cb,er);valid=false}return valid}Writable.prototype.write=function(chunk,encoding,cb){var state=this._writableState;var ret=false;if(typeof encoding==="function"){cb=encoding;encoding=null}if(Buffer.isBuffer(chunk))encoding="buffer";else if(!encoding)encoding=state.defaultEncoding;if(typeof cb!=="function")cb=nop;if(state.ended)writeAfterEnd(this,cb);else if(validChunk(this,state,chunk,cb)){state.pendingcb++;ret=writeOrBuffer(this,state,chunk,encoding,cb)}return ret};Writable.prototype.cork=function(){var state=this._writableState;state.corked++};Writable.prototype.uncork=function(){var state=this._writableState;if(state.corked){state.corked--;if(!state.writing&&!state.corked&&!state.finished&&!state.bufferProcessing&&state.bufferedRequest)clearBuffer(this,state)}};Writable.prototype.setDefaultEncoding=function setDefaultEncoding(encoding){if(typeof encoding==="string")encoding=encoding.toLowerCase();if(!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((encoding+"").toLowerCase())>-1))throw new TypeError("Unknown encoding: "+encoding);this._writableState.defaultEncoding=encoding;return this};function decodeChunk(state,chunk,encoding){if(!state.objectMode&&state.decodeStrings!==false&&typeof chunk==="string"){chunk=Buffer.from(chunk,encoding)}return chunk}function writeOrBuffer(stream,state,chunk,encoding,cb){chunk=decodeChunk(state,chunk,encoding);if(Buffer.isBuffer(chunk))encoding="buffer";var len=state.objectMode?1:chunk.length;state.length+=len;var ret=state.length<state.highWaterMark;if(!ret)state.needDrain=true;if(state.writing||state.corked){var last=state.lastBufferedRequest;state.lastBufferedRequest=new WriteReq(chunk,encoding,cb);if(last){last.next=state.lastBufferedRequest}else{state.bufferedRequest=state.lastBufferedRequest}state.bufferedRequestCount+=1}else{doWrite(stream,state,false,len,chunk,encoding,cb)}return ret}function doWrite(stream,state,writev,len,chunk,encoding,cb){state.writelen=len;state.writecb=cb;state.writing=true;state.sync=true;if(writev)stream._writev(chunk,state.onwrite);else stream._write(chunk,encoding,state.onwrite);state.sync=false}function onwriteError(stream,state,sync,er,cb){--state.pendingcb;if(sync)nextTick(cb,er);else cb(er);stream._writableState.errorEmitted=true;stream.emit("error",er)}function onwriteStateUpdate(state){state.writing=false;state.writecb=null;state.length-=state.writelen;state.writelen=0}function onwrite(stream,er){var state=stream._writableState;var sync=state.sync;var cb=state.writecb;onwriteStateUpdate(state);if(er)onwriteError(stream,state,sync,er,cb);else{var finished=needFinish(state);if(!finished&&!state.corked&&!state.bufferProcessing&&state.bufferedRequest){clearBuffer(stream,state)}if(sync){nextTick(afterWrite,stream,state,finished,cb)}else{afterWrite(stream,state,finished,cb)}}}function afterWrite(stream,state,finished,cb){if(!finished)onwriteDrain(stream,state);state.pendingcb--;cb();finishMaybe(stream,state)}function onwriteDrain(stream,state){if(state.length===0&&state.needDrain){state.needDrain=false;stream.emit("drain")}}function clearBuffer(stream,state){state.bufferProcessing=true;var entry=state.bufferedRequest;if(stream._writev&&entry&&entry.next){var l=state.bufferedRequestCount;var buffer=new Array(l);var holder=state.corkedRequestsFree;holder.entry=entry;var count=0;while(entry){buffer[count]=entry;entry=entry.next;count+=1}doWrite(stream,state,true,state.length,buffer,"",holder.finish);state.pendingcb++;state.lastBufferedRequest=null;if(holder.next){state.corkedRequestsFree=holder.next;holder.next=null}else{state.corkedRequestsFree=new CorkedRequest(state)}}else{while(entry){var chunk=entry.chunk;var encoding=entry.encoding;var cb=entry.callback;var len=state.objectMode?1:chunk.length;doWrite(stream,state,false,len,chunk,encoding,cb);entry=entry.next;if(state.writing){break}}if(entry===null)state.lastBufferedRequest=null}state.bufferedRequestCount=0;state.bufferedRequest=entry;state.bufferProcessing=false}Writable.prototype._write=function(chunk,encoding,cb){cb(new Error("not implemented"))};Writable.prototype._writev=null;Writable.prototype.end=function(chunk,encoding,cb){var state=this._writableState;if(typeof chunk==="function"){cb=chunk;chunk=null;encoding=null}else if(typeof encoding==="function"){cb=encoding;encoding=null}if(chunk!==null&&chunk!==undefined)this.write(chunk,encoding);if(state.corked){state.corked=1;this.uncork()}if(!state.ending&&!state.finished)endWritable(this,state,cb)};function needFinish(state){return state.ending&&state.length===0&&state.bufferedRequest===null&&!state.finished&&!state.writing}function prefinish(stream,state){if(!state.prefinished){state.prefinished=true;stream.emit("prefinish")}}function finishMaybe(stream,state){var need=needFinish(state);if(need){if(state.pendingcb===0){prefinish(stream,state);state.finished=true;stream.emit("finish")}else{prefinish(stream,state)}}return need}function endWritable(stream,state,cb){state.ending=true;finishMaybe(stream,state);if(cb){if(state.finished)nextTick(cb);else stream.once("finish",cb)}state.ended=true;stream.writable=false}function CorkedRequest(state){var _this=this;this.next=null;this.entry=null;this.finish=function(err){var entry=_this.entry;_this.entry=null;while(entry){var cb=entry.callback;state.pendingcb--;cb(err);entry=entry.next}if(state.corkedRequestsFree){state.corkedRequestsFree.next=_this}else{state.corkedRequestsFree=_this}}}inherits$1(Duplex,Readable);var keys=Object.keys(Writable.prototype);for(var v=0;v<keys.length;v++){var method=keys[v];if(!Duplex.prototype[method])Duplex.prototype[method]=Writable.prototype[method]}function Duplex(options){if(!(this instanceof Duplex))return new Duplex(options);Readable.call(this,options);Writable.call(this,options);if(options&&options.readable===false)this.readable=false;if(options&&options.writable===false)this.writable=false;this.allowHalfOpen=true;if(options&&options.allowHalfOpen===false)this.allowHalfOpen=false;this.once("end",onend)}function onend(){if(this.allowHalfOpen||this._writableState.ended)return;nextTick(onEndNT,this)}function onEndNT(self){self.end()}inherits$1(Transform,Duplex);function TransformState(stream){this.afterTransform=function(er,data){return afterTransform(stream,er,data)};this.needTransform=false;this.transforming=false;this.writecb=null;this.writechunk=null;this.writeencoding=null}function afterTransform(stream,er,data){var ts=stream._transformState;ts.transforming=false;var cb=ts.writecb;if(!cb)return stream.emit("error",new Error("no writecb in Transform class"));ts.writechunk=null;ts.writecb=null;if(data!==null&&data!==undefined)stream.push(data);cb(er);var rs=stream._readableState;rs.reading=false;if(rs.needReadable||rs.length<rs.highWaterMark){stream._read(rs.highWaterMark)}}function Transform(options){if(!(this instanceof Transform))return new Transform(options);Duplex.call(this,options);this._transformState=new TransformState(this);var stream=this;this._readableState.needReadable=true;this._readableState.sync=false;if(options){if(typeof options.transform==="function")this._transform=options.transform;if(typeof options.flush==="function")this._flush=options.flush}this.once("prefinish",(function(){if(typeof this._flush==="function")this._flush((function(er){done(stream,er)}));else done(stream)}))}Transform.prototype.push=function(chunk,encoding){this._transformState.needTransform=false;return Duplex.prototype.push.call(this,chunk,encoding)};Transform.prototype._transform=function(chunk,encoding,cb){throw new Error("Not implemented")};Transform.prototype._write=function(chunk,encoding,cb){var ts=this._transformState;ts.writecb=cb;ts.writechunk=chunk;ts.writeencoding=encoding;if(!ts.transforming){var rs=this._readableState;if(ts.needTransform||rs.needReadable||rs.length<rs.highWaterMark)this._read(rs.highWaterMark)}};Transform.prototype._read=function(n){var ts=this._transformState;if(ts.writechunk!==null&&ts.writecb&&!ts.transforming){ts.transforming=true;this._transform(ts.writechunk,ts.writeencoding,ts.afterTransform)}else{ts.needTransform=true}};function done(stream,er){if(er)return stream.emit("error",er);var ws=stream._writableState;var ts=stream._transformState;if(ws.length)throw new Error("Calling transform done when ws.length != 0");if(ts.transforming)throw new Error("Calling transform done when still transforming");return stream.push(null)}inherits$1(PassThrough,Transform);function PassThrough(options){if(!(this instanceof PassThrough))return new PassThrough(options);Transform.call(this,options)}PassThrough.prototype._transform=function(chunk,encoding,cb){cb(null,chunk)};inherits$1(Stream,EventEmitter);Stream.Readable=Readable;Stream.Writable=Writable;Stream.Duplex=Duplex;Stream.Transform=Transform;Stream.PassThrough=PassThrough;Stream.Stream=Stream;function Stream(){EventEmitter.call(this)}Stream.prototype.pipe=function(dest,options){var source=this;function ondata(chunk){if(dest.writable){if(false===dest.write(chunk)&&source.pause){source.pause()}}}source.on("data",ondata);function ondrain(){if(source.readable&&source.resume){source.resume()}}dest.on("drain",ondrain);if(!dest._isStdio&&(!options||options.end!==false)){source.on("end",onend);source.on("close",onclose)}var didOnEnd=false;function onend(){if(didOnEnd)return;didOnEnd=true;dest.end()}function onclose(){if(didOnEnd)return;didOnEnd=true;if(typeof dest.destroy==="function")dest.destroy()}function onerror(er){cleanup();if(EventEmitter.listenerCount(this,"error")===0){throw er}}source.on("error",onerror);dest.on("error",onerror);function cleanup(){source.removeListener("data",ondata);dest.removeListener("drain",ondrain);source.removeListener("end",onend);source.removeListener("close",onclose);source.removeListener("error",onerror);dest.removeListener("error",onerror);source.removeListener("end",cleanup);source.removeListener("close",cleanup);dest.removeListener("close",cleanup)}source.on("end",cleanup);source.on("close",cleanup);dest.on("close",cleanup);dest.emit("pipe",source);return dest};var msg={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"};function ZStream(){this.input=null;this.next_in=0;this.avail_in=0;this.total_in=0;this.output=null;this.next_out=0;this.avail_out=0;this.total_out=0;this.msg="";this.state=null;this.data_type=2;this.adler=0}function arraySet(dest,src,src_offs,len,dest_offs){if(src.subarray&&dest.subarray){dest.set(src.subarray(src_offs,src_offs+len),dest_offs);return}for(var i=0;i<len;i++){dest[dest_offs+i]=src[src_offs+i]}}var Buf8=Uint8Array;var Buf16=Uint16Array;var Buf32=Int32Array;var Z_FIXED=4;var Z_BINARY=0;var Z_TEXT=1;var Z_UNKNOWN=2;function zero(buf){var len=buf.length;while(--len>=0){buf[len]=0}}var STORED_BLOCK=0;var STATIC_TREES=1;var DYN_TREES=2;var MIN_MATCH=3;var MAX_MATCH=258;var LENGTH_CODES=29;var LITERALS=256;var L_CODES=LITERALS+1+LENGTH_CODES;var D_CODES=30;var BL_CODES=19;var HEAP_SIZE=2*L_CODES+1;var MAX_BITS=15;var Buf_size=16;var MAX_BL_BITS=7;var END_BLOCK=256;var REP_3_6=16;var REPZ_3_10=17;var REPZ_11_138=18;var extra_lbits=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0];var extra_dbits=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];var extra_blbits=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7];var bl_order=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];var DIST_CODE_LEN=512;var static_ltree=new Array((L_CODES+2)*2);zero(static_ltree);var static_dtree=new Array(D_CODES*2);zero(static_dtree);var _dist_code=new Array(DIST_CODE_LEN);zero(_dist_code);var _length_code=new Array(MAX_MATCH-MIN_MATCH+1);zero(_length_code);var base_length=new Array(LENGTH_CODES);zero(base_length);var base_dist=new Array(D_CODES);zero(base_dist);function StaticTreeDesc(static_tree,extra_bits,extra_base,elems,max_length){this.static_tree=static_tree;this.extra_bits=extra_bits;this.extra_base=extra_base;this.elems=elems;this.max_length=max_length;this.has_stree=static_tree&&static_tree.length}var static_l_desc;var static_d_desc;var static_bl_desc;function TreeDesc(dyn_tree,stat_desc){this.dyn_tree=dyn_tree;this.max_code=0;this.stat_desc=stat_desc}function d_code(dist){return dist<256?_dist_code[dist]:_dist_code[256+(dist>>>7)]}function put_short(s,w){s.pending_buf[s.pending++]=w&255;s.pending_buf[s.pending++]=w>>>8&255}function send_bits(s,value,length){if(s.bi_valid>Buf_size-length){s.bi_buf|=value<<s.bi_valid&65535;put_short(s,s.bi_buf);s.bi_buf=value>>Buf_size-s.bi_valid;s.bi_valid+=length-Buf_size}else{s.bi_buf|=value<<s.bi_valid&65535;s.bi_valid+=length}}function send_code(s,c,tree){send_bits(s,tree[c*2],tree[c*2+1])}function bi_reverse(code,len){var res=0;do{res|=code&1;code>>>=1;res<<=1}while(--len>0);return res>>>1}function bi_flush(s){if(s.bi_valid===16){put_short(s,s.bi_buf);s.bi_buf=0;s.bi_valid=0}else if(s.bi_valid>=8){s.pending_buf[s.pending++]=s.bi_buf&255;s.bi_buf>>=8;s.bi_valid-=8}}function gen_bitlen(s,desc){var tree=desc.dyn_tree;var max_code=desc.max_code;var stree=desc.stat_desc.static_tree;var has_stree=desc.stat_desc.has_stree;var extra=desc.stat_desc.extra_bits;var base=desc.stat_desc.extra_base;var max_length=desc.stat_desc.max_length;var h;var n,m;var bits;var xbits;var f;var overflow=0;for(bits=0;bits<=MAX_BITS;bits++){s.bl_count[bits]=0}tree[s.heap[s.heap_max]*2+1]=0;for(h=s.heap_max+1;h<HEAP_SIZE;h++){n=s.heap[h];bits=tree[tree[n*2+1]*2+1]+1;if(bits>max_length){bits=max_length;overflow++}tree[n*2+1]=bits;if(n>max_code){continue}s.bl_count[bits]++;xbits=0;if(n>=base){xbits=extra[n-base]}f=tree[n*2];s.opt_len+=f*(bits+xbits);if(has_stree){s.static_len+=f*(stree[n*2+1]+xbits)}}if(overflow===0){return}do{bits=max_length-1;while(s.bl_count[bits]===0){bits--}s.bl_count[bits]--;s.bl_count[bits+1]+=2;s.bl_count[max_length]--;overflow-=2}while(overflow>0);for(bits=max_length;bits!==0;bits--){n=s.bl_count[bits];while(n!==0){m=s.heap[--h];if(m>max_code){continue}if(tree[m*2+1]!==bits){s.opt_len+=(bits-tree[m*2+1])*tree[m*2];tree[m*2+1]=bits}n--}}}function gen_codes(tree,max_code,bl_count){var next_code=new Array(MAX_BITS+1);var code=0;var bits;var n;for(bits=1;bits<=MAX_BITS;bits++){next_code[bits]=code=code+bl_count[bits-1]<<1}for(n=0;n<=max_code;n++){var len=tree[n*2+1];if(len===0){continue}tree[n*2]=bi_reverse(next_code[len]++,len)}}function tr_static_init(){var n;var bits;var length;var code;var dist;var bl_count=new Array(MAX_BITS+1);length=0;for(code=0;code<LENGTH_CODES-1;code++){base_length[code]=length;for(n=0;n<1<<extra_lbits[code];n++){_length_code[length++]=code}}_length_code[length-1]=code;dist=0;for(code=0;code<16;code++){base_dist[code]=dist;for(n=0;n<1<<extra_dbits[code];n++){_dist_code[dist++]=code}}dist>>=7;for(;code<D_CODES;code++){base_dist[code]=dist<<7;for(n=0;n<1<<extra_dbits[code]-7;n++){_dist_code[256+dist++]=code}}for(bits=0;bits<=MAX_BITS;bits++){bl_count[bits]=0}n=0;while(n<=143){static_ltree[n*2+1]=8;n++;bl_count[8]++}while(n<=255){static_ltree[n*2+1]=9;n++;bl_count[9]++}while(n<=279){static_ltree[n*2+1]=7;n++;bl_count[7]++}while(n<=287){static_ltree[n*2+1]=8;n++;bl_count[8]++}gen_codes(static_ltree,L_CODES+1,bl_count);for(n=0;n<D_CODES;n++){static_dtree[n*2+1]=5;static_dtree[n*2]=bi_reverse(n,5)}static_l_desc=new StaticTreeDesc(static_ltree,extra_lbits,LITERALS+1,L_CODES,MAX_BITS);static_d_desc=new StaticTreeDesc(static_dtree,extra_dbits,0,D_CODES,MAX_BITS);static_bl_desc=new StaticTreeDesc(new Array(0),extra_blbits,0,BL_CODES,MAX_BL_BITS)}function init_block(s){var n;for(n=0;n<L_CODES;n++){s.dyn_ltree[n*2]=0}for(n=0;n<D_CODES;n++){s.dyn_dtree[n*2]=0}for(n=0;n<BL_CODES;n++){s.bl_tree[n*2]=0}s.dyn_ltree[END_BLOCK*2]=1;s.opt_len=s.static_len=0;s.last_lit=s.matches=0}function bi_windup(s){if(s.bi_valid>8){put_short(s,s.bi_buf)}else if(s.bi_valid>0){s.pending_buf[s.pending++]=s.bi_buf}s.bi_buf=0;s.bi_valid=0}function copy_block(s,buf,len,header){bi_windup(s);if(header){put_short(s,len);put_short(s,~len)}arraySet(s.pending_buf,s.window,buf,len,s.pending);s.pending+=len}function smaller(tree,n,m,depth){var _n2=n*2;var _m2=m*2;return tree[_n2]<tree[_m2]||tree[_n2]===tree[_m2]&&depth[n]<=depth[m]}function pqdownheap(s,tree,k){var v=s.heap[k];var j=k<<1;while(j<=s.heap_len){if(j<s.heap_len&&smaller(tree,s.heap[j+1],s.heap[j],s.depth)){j++}if(smaller(tree,v,s.heap[j],s.depth)){break}s.heap[k]=s.heap[j];k=j;j<<=1}s.heap[k]=v}function compress_block(s,ltree,dtree){var dist;var lc;var lx=0;var code;var extra;if(s.last_lit!==0){do{dist=s.pending_buf[s.d_buf+lx*2]<<8|s.pending_buf[s.d_buf+lx*2+1];lc=s.pending_buf[s.l_buf+lx];lx++;if(dist===0){send_code(s,lc,ltree)}else{code=_length_code[lc];send_code(s,code+LITERALS+1,ltree);extra=extra_lbits[code];if(extra!==0){lc-=base_length[code];send_bits(s,lc,extra)}dist--;code=d_code(dist);send_code(s,code,dtree);extra=extra_dbits[code];if(extra!==0){dist-=base_dist[code];send_bits(s,dist,extra)}}}while(lx<s.last_lit)}send_code(s,END_BLOCK,ltree)}function build_tree(s,desc){var tree=desc.dyn_tree;var stree=desc.stat_desc.static_tree;var has_stree=desc.stat_desc.has_stree;var elems=desc.stat_desc.elems;var n,m;var max_code=-1;var node;s.heap_len=0;s.heap_max=HEAP_SIZE;for(n=0;n<elems;n++){if(tree[n*2]!==0){s.heap[++s.heap_len]=max_code=n;s.depth[n]=0}else{tree[n*2+1]=0}}while(s.heap_len<2){node=s.heap[++s.heap_len]=max_code<2?++max_code:0;tree[node*2]=1;s.depth[node]=0;s.opt_len--;if(has_stree){s.static_len-=stree[node*2+1]}}desc.max_code=max_code;for(n=s.heap_len>>1;n>=1;n--){pqdownheap(s,tree,n)}node=elems;do{n=s.heap[1];s.heap[1]=s.heap[s.heap_len--];pqdownheap(s,tree,1);m=s.heap[1];s.heap[--s.heap_max]=n;s.heap[--s.heap_max]=m;tree[node*2]=tree[n*2]+tree[m*2];s.depth[node]=(s.depth[n]>=s.depth[m]?s.depth[n]:s.depth[m])+1;tree[n*2+1]=tree[m*2+1]=node;s.heap[1]=node++;pqdownheap(s,tree,1)}while(s.heap_len>=2);s.heap[--s.heap_max]=s.heap[1];gen_bitlen(s,desc);gen_codes(tree,max_code,s.bl_count)}function scan_tree(s,tree,max_code){var n;var prevlen=-1;var curlen;var nextlen=tree[0*2+1];var count=0;var max_count=7;var min_count=4;if(nextlen===0){max_count=138;min_count=3}tree[(max_code+1)*2+1]=65535;for(n=0;n<=max_code;n++){curlen=nextlen;nextlen=tree[(n+1)*2+1];if(++count<max_count&&curlen===nextlen){continue}else if(count<min_count){s.bl_tree[curlen*2]+=count}else if(curlen!==0){if(curlen!==prevlen){s.bl_tree[curlen*2]++}s.bl_tree[REP_3_6*2]++}else if(count<=10){s.bl_tree[REPZ_3_10*2]++}else{s.bl_tree[REPZ_11_138*2]++}count=0;prevlen=curlen;if(nextlen===0){max_count=138;min_count=3}else if(curlen===nextlen){max_count=6;min_count=3}else{max_count=7;min_count=4}}}function send_tree(s,tree,max_code){var n;var prevlen=-1;var curlen;var nextlen=tree[0*2+1];var count=0;var max_count=7;var min_count=4;if(nextlen===0){max_count=138;min_count=3}for(n=0;n<=max_code;n++){curlen=nextlen;nextlen=tree[(n+1)*2+1];if(++count<max_count&&curlen===nextlen){continue}else if(count<min_count){do{send_code(s,curlen,s.bl_tree)}while(--count!==0)}else if(curlen!==0){if(curlen!==prevlen){send_code(s,curlen,s.bl_tree);count--}send_code(s,REP_3_6,s.bl_tree);send_bits(s,count-3,2)}else if(count<=10){send_code(s,REPZ_3_10,s.bl_tree);send_bits(s,count-3,3)}else{send_code(s,REPZ_11_138,s.bl_tree);send_bits(s,count-11,7)}count=0;prevlen=curlen;if(nextlen===0){max_count=138;min_count=3}else if(curlen===nextlen){max_count=6;min_count=3}else{max_count=7;min_count=4}}}function build_bl_tree(s){var max_blindex;scan_tree(s,s.dyn_ltree,s.l_desc.max_code);scan_tree(s,s.dyn_dtree,s.d_desc.max_code);build_tree(s,s.bl_desc);for(max_blindex=BL_CODES-1;max_blindex>=3;max_blindex--){if(s.bl_tree[bl_order[max_blindex]*2+1]!==0){break}}s.opt_len+=3*(max_blindex+1)+5+5+4;return max_blindex}function send_all_trees(s,lcodes,dcodes,blcodes){var rank;send_bits(s,lcodes-257,5);send_bits(s,dcodes-1,5);send_bits(s,blcodes-4,4);for(rank=0;rank<blcodes;rank++){send_bits(s,s.bl_tree[bl_order[rank]*2+1],3)}send_tree(s,s.dyn_ltree,lcodes-1);send_tree(s,s.dyn_dtree,dcodes-1)}function detect_data_type(s){var black_mask=4093624447;var n;for(n=0;n<=31;n++,black_mask>>>=1){if(black_mask&1&&s.dyn_ltree[n*2]!==0){return Z_BINARY}}if(s.dyn_ltree[9*2]!==0||s.dyn_ltree[10*2]!==0||s.dyn_ltree[13*2]!==0){return Z_TEXT}for(n=32;n<LITERALS;n++){if(s.dyn_ltree[n*2]!==0){return Z_TEXT}}return Z_BINARY}var static_init_done=false;function _tr_init(s){if(!static_init_done){tr_static_init();static_init_done=true}s.l_desc=new TreeDesc(s.dyn_ltree,static_l_desc);s.d_desc=new TreeDesc(s.dyn_dtree,static_d_desc);s.bl_desc=new TreeDesc(s.bl_tree,static_bl_desc);s.bi_buf=0;s.bi_valid=0;init_block(s)}function _tr_stored_block(s,buf,stored_len,last){send_bits(s,(STORED_BLOCK<<1)+(last?1:0),3);copy_block(s,buf,stored_len,true)}function _tr_align(s){send_bits(s,STATIC_TREES<<1,3);send_code(s,END_BLOCK,static_ltree);bi_flush(s)}function _tr_flush_block(s,buf,stored_len,last){var opt_lenb,static_lenb;var max_blindex=0;if(s.level>0){if(s.strm.data_type===Z_UNKNOWN){s.strm.data_type=detect_data_type(s)}build_tree(s,s.l_desc);build_tree(s,s.d_desc);max_blindex=build_bl_tree(s);opt_lenb=s.opt_len+3+7>>>3;static_lenb=s.static_len+3+7>>>3;if(static_lenb<=opt_lenb){opt_lenb=static_lenb}}else{opt_lenb=static_lenb=stored_len+5}if(stored_len+4<=opt_lenb&&buf!==-1){_tr_stored_block(s,buf,stored_len,last)}else if(s.strategy===Z_FIXED||static_lenb===opt_lenb){send_bits(s,(STATIC_TREES<<1)+(last?1:0),3);compress_block(s,static_ltree,static_dtree)}else{send_bits(s,(DYN_TREES<<1)+(last?1:0),3);send_all_trees(s,s.l_desc.max_code+1,s.d_desc.max_code+1,max_blindex+1);compress_block(s,s.dyn_ltree,s.dyn_dtree)}init_block(s);if(last){bi_windup(s)}}function _tr_tally(s,dist,lc){s.pending_buf[s.d_buf+s.last_lit*2]=dist>>>8&255;s.pending_buf[s.d_buf+s.last_lit*2+1]=dist&255;s.pending_buf[s.l_buf+s.last_lit]=lc&255;s.last_lit++;if(dist===0){s.dyn_ltree[lc*2]++}else{s.matches++;dist--;s.dyn_ltree[(_length_code[lc]+LITERALS+1)*2]++;s.dyn_dtree[d_code(dist)*2]++}return s.last_lit===s.lit_bufsize-1}function adler32(adler,buf,len,pos){var s1=adler&65535|0,s2=adler>>>16&65535|0,n=0;while(len!==0){n=len>2e3?2e3:len;len-=n;do{s1=s1+buf[pos++]|0;s2=s2+s1|0}while(--n);s1%=65521;s2%=65521}return s1|s2<<16|0}function makeTable(){var c,table=[];for(var n=0;n<256;n++){c=n;for(var k=0;k<8;k++){c=c&1?3988292384^c>>>1:c>>>1}table[n]=c}return table}var crcTable=makeTable();function crc32(crc,buf,len,pos){var t=crcTable,end=pos+len;crc^=-1;for(var i=pos;i<end;i++){crc=crc>>>8^t[(crc^buf[i])&255]}return crc^-1}var Z_NO_FLUSH=0;var Z_PARTIAL_FLUSH=1;var Z_FULL_FLUSH=3;var Z_FINISH=4;var Z_BLOCK=5;var Z_OK=0;var Z_STREAM_END=1;var Z_STREAM_ERROR=-2;var Z_DATA_ERROR=-3;var Z_BUF_ERROR=-5;var Z_DEFAULT_COMPRESSION=-1;var Z_FILTERED=1;var Z_HUFFMAN_ONLY=2;var Z_RLE=3;var Z_FIXED$1=4;var Z_UNKNOWN$1=2;var Z_DEFLATED=8;var MAX_MEM_LEVEL=9;var LENGTH_CODES$1=29;var LITERALS$1=256;var L_CODES$1=LITERALS$1+1+LENGTH_CODES$1;var D_CODES$1=30;var BL_CODES$1=19;var HEAP_SIZE$1=2*L_CODES$1+1;var MAX_BITS$1=15;var MIN_MATCH$1=3;var MAX_MATCH$1=258;var MIN_LOOKAHEAD=MAX_MATCH$1+MIN_MATCH$1+1;var PRESET_DICT=32;var INIT_STATE=42;var EXTRA_STATE=69;var NAME_STATE=73;var COMMENT_STATE=91;var HCRC_STATE=103;var BUSY_STATE=113;var FINISH_STATE=666;var BS_NEED_MORE=1;var BS_BLOCK_DONE=2;var BS_FINISH_STARTED=3;var BS_FINISH_DONE=4;var OS_CODE=3;function err(strm,errorCode){strm.msg=msg[errorCode];return errorCode}function rank(f){return(f<<1)-(f>4?9:0)}function zero$1(buf){var len=buf.length;while(--len>=0){buf[len]=0}}function flush_pending(strm){var s=strm.state;var len=s.pending;if(len>strm.avail_out){len=strm.avail_out}if(len===0){return}arraySet(strm.output,s.pending_buf,s.pending_out,len,strm.next_out);strm.next_out+=len;s.pending_out+=len;strm.total_out+=len;strm.avail_out-=len;s.pending-=len;if(s.pending===0){s.pending_out=0}}function flush_block_only(s,last){_tr_flush_block(s,s.block_start>=0?s.block_start:-1,s.strstart-s.block_start,last);s.block_start=s.strstart;flush_pending(s.strm)}function put_byte(s,b){s.pending_buf[s.pending++]=b}function putShortMSB(s,b){s.pending_buf[s.pending++]=b>>>8&255;s.pending_buf[s.pending++]=b&255}function read_buf(strm,buf,start,size){var len=strm.avail_in;if(len>size){len=size}if(len===0){return 0}strm.avail_in-=len;arraySet(buf,strm.input,strm.next_in,len,start);if(strm.state.wrap===1){strm.adler=adler32(strm.adler,buf,len,start)}else if(strm.state.wrap===2){strm.adler=crc32(strm.adler,buf,len,start)}strm.next_in+=len;strm.total_in+=len;return len}function longest_match(s,cur_match){var chain_length=s.max_chain_length;var scan=s.strstart;var match;var len;var best_len=s.prev_length;var nice_match=s.nice_match;var limit=s.strstart>s.w_size-MIN_LOOKAHEAD?s.strstart-(s.w_size-MIN_LOOKAHEAD):0;var _win=s.window;var wmask=s.w_mask;var prev=s.prev;var strend=s.strstart+MAX_MATCH$1;var scan_end1=_win[scan+best_len-1];var scan_end=_win[scan+best_len];if(s.prev_length>=s.good_match){chain_length>>=2}if(nice_match>s.lookahead){nice_match=s.lookahead}do{match=cur_match;if(_win[match+best_len]!==scan_end||_win[match+best_len-1]!==scan_end1||_win[match]!==_win[scan]||_win[++match]!==_win[scan+1]){continue}scan+=2;match++;do{}while(_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&scan<strend);len=MAX_MATCH$1-(strend-scan);scan=strend-MAX_MATCH$1;if(len>best_len){s.match_start=cur_match;best_len=len;if(len>=nice_match){break}scan_end1=_win[scan+best_len-1];scan_end=_win[scan+best_len]}}while((cur_match=prev[cur_match&wmask])>limit&&--chain_length!==0);if(best_len<=s.lookahead){return best_len}return s.lookahead}function fill_window(s){var _w_size=s.w_size;var p,n,m,more,str;do{more=s.window_size-s.lookahead-s.strstart;if(s.strstart>=_w_size+(_w_size-MIN_LOOKAHEAD)){arraySet(s.window,s.window,_w_size,_w_size,0);s.match_start-=_w_size;s.strstart-=_w_size;s.block_start-=_w_size;n=s.hash_size;p=n;do{m=s.head[--p];s.head[p]=m>=_w_size?m-_w_size:0}while(--n);n=_w_size;p=n;do{m=s.prev[--p];s.prev[p]=m>=_w_size?m-_w_size:0}while(--n);more+=_w_size}if(s.strm.avail_in===0){break}n=read_buf(s.strm,s.window,s.strstart+s.lookahead,more);s.lookahead+=n;if(s.lookahead+s.insert>=MIN_MATCH$1){str=s.strstart-s.insert;s.ins_h=s.window[str];s.ins_h=(s.ins_h<<s.hash_shift^s.window[str+1])&s.hash_mask;while(s.insert){s.ins_h=(s.ins_h<<s.hash_shift^s.window[str+MIN_MATCH$1-1])&s.hash_mask;s.prev[str&s.w_mask]=s.head[s.ins_h];s.head[s.ins_h]=str;str++;s.insert--;if(s.lookahead+s.insert<MIN_MATCH$1){break}}}}while(s.lookahead<MIN_LOOKAHEAD&&s.strm.avail_in!==0)}function deflate_stored(s,flush){var max_block_size=65535;if(max_block_size>s.pending_buf_size-5){max_block_size=s.pending_buf_size-5}for(;;){if(s.lookahead<=1){fill_window(s);if(s.lookahead===0&&flush===Z_NO_FLUSH){return BS_NEED_MORE}if(s.lookahead===0){break}}s.strstart+=s.lookahead;s.lookahead=0;var max_start=s.block_start+max_block_size;if(s.strstart===0||s.strstart>=max_start){s.lookahead=s.strstart-max_start;s.strstart=max_start;flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}if(s.strstart-s.block_start>=s.w_size-MIN_LOOKAHEAD){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}}s.insert=0;if(flush===Z_FINISH){flush_block_only(s,true);if(s.strm.avail_out===0){return BS_FINISH_STARTED}return BS_FINISH_DONE}if(s.strstart>s.block_start){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}return BS_NEED_MORE}function deflate_fast(s,flush){var hash_head;var bflush;for(;;){if(s.lookahead<MIN_LOOKAHEAD){fill_window(s);if(s.lookahead<MIN_LOOKAHEAD&&flush===Z_NO_FLUSH){return BS_NEED_MORE}if(s.lookahead===0){break}}hash_head=0;if(s.lookahead>=MIN_MATCH$1){s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+MIN_MATCH$1-1])&s.hash_mask;hash_head=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h];s.head[s.ins_h]=s.strstart}if(hash_head!==0&&s.strstart-hash_head<=s.w_size-MIN_LOOKAHEAD){s.match_length=longest_match(s,hash_head)}if(s.match_length>=MIN_MATCH$1){bflush=_tr_tally(s,s.strstart-s.match_start,s.match_length-MIN_MATCH$1);s.lookahead-=s.match_length;if(s.match_length<=s.max_lazy_match&&s.lookahead>=MIN_MATCH$1){s.match_length--;do{s.strstart++;s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+MIN_MATCH$1-1])&s.hash_mask;hash_head=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h];s.head[s.ins_h]=s.strstart}while(--s.match_length!==0);s.strstart++}else{s.strstart+=s.match_length;s.match_length=0;s.ins_h=s.window[s.strstart];s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+1])&s.hash_mask}}else{bflush=_tr_tally(s,0,s.window[s.strstart]);s.lookahead--;s.strstart++}if(bflush){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}}s.insert=s.strstart<MIN_MATCH$1-1?s.strstart:MIN_MATCH$1-1;if(flush===Z_FINISH){flush_block_only(s,true);if(s.strm.avail_out===0){return BS_FINISH_STARTED}return BS_FINISH_DONE}if(s.last_lit){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}return BS_BLOCK_DONE}function deflate_slow(s,flush){var hash_head;var bflush;var max_insert;for(;;){if(s.lookahead<MIN_LOOKAHEAD){fill_window(s);if(s.lookahead<MIN_LOOKAHEAD&&flush===Z_NO_FLUSH){return BS_NEED_MORE}if(s.lookahead===0){break}}hash_head=0;if(s.lookahead>=MIN_MATCH$1){s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+MIN_MATCH$1-1])&s.hash_mask;hash_head=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h];s.head[s.ins_h]=s.strstart}s.prev_length=s.match_length;s.prev_match=s.match_start;s.match_length=MIN_MATCH$1-1;if(hash_head!==0&&s.prev_length<s.max_lazy_match&&s.strstart-hash_head<=s.w_size-MIN_LOOKAHEAD){s.match_length=longest_match(s,hash_head);if(s.match_length<=5&&(s.strategy===Z_FILTERED||s.match_length===MIN_MATCH$1&&s.strstart-s.match_start>4096)){s.match_length=MIN_MATCH$1-1}}if(s.prev_length>=MIN_MATCH$1&&s.match_length<=s.prev_length){max_insert=s.strstart+s.lookahead-MIN_MATCH$1;bflush=_tr_tally(s,s.strstart-1-s.prev_match,s.prev_length-MIN_MATCH$1);s.lookahead-=s.prev_length-1;s.prev_length-=2;do{if(++s.strstart<=max_insert){s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+MIN_MATCH$1-1])&s.hash_mask;hash_head=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h];s.head[s.ins_h]=s.strstart}}while(--s.prev_length!==0);s.match_available=0;s.match_length=MIN_MATCH$1-1;s.strstart++;if(bflush){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}}else if(s.match_available){bflush=_tr_tally(s,0,s.window[s.strstart-1]);if(bflush){flush_block_only(s,false)}s.strstart++;s.lookahead--;if(s.strm.avail_out===0){return BS_NEED_MORE}}else{s.match_available=1;s.strstart++;s.lookahead--}}if(s.match_available){bflush=_tr_tally(s,0,s.window[s.strstart-1]);s.match_available=0}s.insert=s.strstart<MIN_MATCH$1-1?s.strstart:MIN_MATCH$1-1;if(flush===Z_FINISH){flush_block_only(s,true);if(s.strm.avail_out===0){return BS_FINISH_STARTED}return BS_FINISH_DONE}if(s.last_lit){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}return BS_BLOCK_DONE}function deflate_rle(s,flush){var bflush;var prev;var scan,strend;var _win=s.window;for(;;){if(s.lookahead<=MAX_MATCH$1){fill_window(s);if(s.lookahead<=MAX_MATCH$1&&flush===Z_NO_FLUSH){return BS_NEED_MORE}if(s.lookahead===0){break}}s.match_length=0;if(s.lookahead>=MIN_MATCH$1&&s.strstart>0){scan=s.strstart-1;prev=_win[scan];if(prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]){strend=s.strstart+MAX_MATCH$1;do{}while(prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&scan<strend);s.match_length=MAX_MATCH$1-(strend-scan);if(s.match_length>s.lookahead){s.match_length=s.lookahead}}}if(s.match_length>=MIN_MATCH$1){bflush=_tr_tally(s,1,s.match_length-MIN_MATCH$1);s.lookahead-=s.match_length;s.strstart+=s.match_length;s.match_length=0}else{bflush=_tr_tally(s,0,s.window[s.strstart]);s.lookahead--;s.strstart++}if(bflush){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}}s.insert=0;if(flush===Z_FINISH){flush_block_only(s,true);if(s.strm.avail_out===0){return BS_FINISH_STARTED}return BS_FINISH_DONE}if(s.last_lit){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}return BS_BLOCK_DONE}function deflate_huff(s,flush){var bflush;for(;;){if(s.lookahead===0){fill_window(s);if(s.lookahead===0){if(flush===Z_NO_FLUSH){return BS_NEED_MORE}break}}s.match_length=0;bflush=_tr_tally(s,0,s.window[s.strstart]);s.lookahead--;s.strstart++;if(bflush){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}}s.insert=0;if(flush===Z_FINISH){flush_block_only(s,true);if(s.strm.avail_out===0){return BS_FINISH_STARTED}return BS_FINISH_DONE}if(s.last_lit){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}return BS_BLOCK_DONE}function Config(good_length,max_lazy,nice_length,max_chain,func){this.good_length=good_length;this.max_lazy=max_lazy;this.nice_length=nice_length;this.max_chain=max_chain;this.func=func}var configuration_table;configuration_table=[new Config(0,0,0,0,deflate_stored),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)];function lm_init(s){s.window_size=2*s.w_size;zero$1(s.head);s.max_lazy_match=configuration_table[s.level].max_lazy;s.good_match=configuration_table[s.level].good_length;s.nice_match=configuration_table[s.level].nice_length;s.max_chain_length=configuration_table[s.level].max_chain;s.strstart=0;s.block_start=0;s.lookahead=0;s.insert=0;s.match_length=s.prev_length=MIN_MATCH$1-1;s.match_available=0;s.ins_h=0}function DeflateState(){this.strm=null;this.status=0;this.pending_buf=null;this.pending_buf_size=0;this.pending_out=0;this.pending=0;this.wrap=0;this.gzhead=null;this.gzindex=0;this.method=Z_DEFLATED;this.last_flush=-1;this.w_size=0;this.w_bits=0;this.w_mask=0;this.window=null;this.window_size=0;this.prev=null;this.head=null;this.ins_h=0;this.hash_size=0;this.hash_bits=0;this.hash_mask=0;this.hash_shift=0;this.block_start=0;this.match_length=0;this.prev_match=0;this.match_available=0;this.strstart=0;this.match_start=0;this.lookahead=0;this.prev_length=0;this.max_chain_length=0;this.max_lazy_match=0;this.level=0;this.strategy=0;this.good_match=0;this.nice_match=0;this.dyn_ltree=new Buf16(HEAP_SIZE$1*2);this.dyn_dtree=new Buf16((2*D_CODES$1+1)*2);this.bl_tree=new Buf16((2*BL_CODES$1+1)*2);zero$1(this.dyn_ltree);zero$1(this.dyn_dtree);zero$1(this.bl_tree);this.l_desc=null;this.d_desc=null;this.bl_desc=null;this.bl_count=new Buf16(MAX_BITS$1+1);this.heap=new Buf16(2*L_CODES$1+1);zero$1(this.heap);this.heap_len=0;this.heap_max=0;this.depth=new Buf16(2*L_CODES$1+1);zero$1(this.depth);this.l_buf=0;this.lit_bufsize=0;this.last_lit=0;this.d_buf=0;this.opt_len=0;this.static_len=0;this.matches=0;this.insert=0;this.bi_buf=0;this.bi_valid=0}function deflateResetKeep(strm){var s;if(!strm||!strm.state){return err(strm,Z_STREAM_ERROR)}strm.total_in=strm.total_out=0;strm.data_type=Z_UNKNOWN$1;s=strm.state;s.pending=0;s.pending_out=0;if(s.wrap<0){s.wrap=-s.wrap}s.status=s.wrap?INIT_STATE:BUSY_STATE;strm.adler=s.wrap===2?0:1;s.last_flush=Z_NO_FLUSH;_tr_init(s);return Z_OK}function deflateReset(strm){var ret=deflateResetKeep(strm);if(ret===Z_OK){lm_init(strm.state)}return ret}function deflateInit2(strm,level,method,windowBits,memLevel,strategy){if(!strm){return Z_STREAM_ERROR}var wrap=1;if(level===Z_DEFAULT_COMPRESSION){level=6}if(windowBits<0){wrap=0;windowBits=-windowBits}else if(windowBits>15){wrap=2;windowBits-=16}if(memLevel<1||memLevel>MAX_MEM_LEVEL||method!==Z_DEFLATED||windowBits<8||windowBits>15||level<0||level>9||strategy<0||strategy>Z_FIXED$1){return err(strm,Z_STREAM_ERROR)}if(windowBits===8){windowBits=9}var s=new DeflateState;strm.state=s;s.strm=strm;s.wrap=wrap;s.gzhead=null;s.w_bits=windowBits;s.w_size=1<<s.w_bits;s.w_mask=s.w_size-1;s.hash_bits=memLevel+7;s.hash_size=1<<s.hash_bits;s.hash_mask=s.hash_size-1;s.hash_shift=~~((s.hash_bits+MIN_MATCH$1-1)/MIN_MATCH$1);s.window=new Buf8(s.w_size*2);s.head=new Buf16(s.hash_size);s.prev=new Buf16(s.w_size);s.lit_bufsize=1<<memLevel+6;s.pending_buf_size=s.lit_bufsize*4;s.pending_buf=new Buf8(s.pending_buf_size);s.d_buf=1*s.lit_bufsize;s.l_buf=(1+2)*s.lit_bufsize;s.level=level;s.strategy=strategy;s.method=method;return deflateReset(strm)}function deflate(strm,flush){var old_flush,s;var beg,val;if(!strm||!strm.state||flush>Z_BLOCK||flush<0){return strm?err(strm,Z_STREAM_ERROR):Z_STREAM_ERROR}s=strm.state;if(!strm.output||!strm.input&&strm.avail_in!==0||s.status===FINISH_STATE&&flush!==Z_FINISH){return err(strm,strm.avail_out===0?Z_BUF_ERROR:Z_STREAM_ERROR)}s.strm=strm;old_flush=s.last_flush;s.last_flush=flush;if(s.status===INIT_STATE){if(s.wrap===2){strm.adler=0;put_byte(s,31);put_byte(s,139);put_byte(s,8);if(!s.gzhead){put_byte(s,0);put_byte(s,0);put_byte(s,0);put_byte(s,0);put_byte(s,0);put_byte(s,s.level===9?2:s.strategy>=Z_HUFFMAN_ONLY||s.level<2?4:0);put_byte(s,OS_CODE);s.status=BUSY_STATE}else{put_byte(s,(s.gzhead.text?1:0)+(s.gzhead.hcrc?2:0)+(!s.gzhead.extra?0:4)+(!s.gzhead.name?0:8)+(!s.gzhead.comment?0:16));put_byte(s,s.gzhead.time&255);put_byte(s,s.gzhead.time>>8&255);put_byte(s,s.gzhead.time>>16&255);put_byte(s,s.gzhead.time>>24&255);put_byte(s,s.level===9?2:s.strategy>=Z_HUFFMAN_ONLY||s.level<2?4:0);put_byte(s,s.gzhead.os&255);if(s.gzhead.extra&&s.gzhead.extra.length){put_byte(s,s.gzhead.extra.length&255);put_byte(s,s.gzhead.extra.length>>8&255)}if(s.gzhead.hcrc){strm.adler=crc32(strm.adler,s.pending_buf,s.pending,0)}s.gzindex=0;s.status=EXTRA_STATE}}else{var header=Z_DEFLATED+(s.w_bits-8<<4)<<8;var level_flags=-1;if(s.strategy>=Z_HUFFMAN_ONLY||s.level<2){level_flags=0}else if(s.level<6){level_flags=1}else if(s.level===6){level_flags=2}else{level_flags=3}header|=level_flags<<6;if(s.strstart!==0){header|=PRESET_DICT}header+=31-header%31;s.status=BUSY_STATE;putShortMSB(s,header);if(s.strstart!==0){putShortMSB(s,strm.adler>>>16);putShortMSB(s,strm.adler&65535)}strm.adler=1}}if(s.status===EXTRA_STATE){if(s.gzhead.extra){beg=s.pending;while(s.gzindex<(s.gzhead.extra.length&65535)){if(s.pending===s.pending_buf_size){if(s.gzhead.hcrc&&s.pending>beg){strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)}flush_pending(strm);beg=s.pending;if(s.pending===s.pending_buf_size){break}}put_byte(s,s.gzhead.extra[s.gzindex]&255);s.gzindex++}if(s.gzhead.hcrc&&s.pending>beg){strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)}if(s.gzindex===s.gzhead.extra.length){s.gzindex=0;s.status=NAME_STATE}}else{s.status=NAME_STATE}}if(s.status===NAME_STATE){if(s.gzhead.name){beg=s.pending;do{if(s.pending===s.pending_buf_size){if(s.gzhead.hcrc&&s.pending>beg){strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)}flush_pending(strm);beg=s.pending;if(s.pending===s.pending_buf_size){val=1;break}}if(s.gzindex<s.gzhead.name.length){val=s.gzhead.name.charCodeAt(s.gzindex++)&255}else{val=0}put_byte(s,val)}while(val!==0);if(s.gzhead.hcrc&&s.pending>beg){strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)}if(val===0){s.gzindex=0;s.status=COMMENT_STATE}}else{s.status=COMMENT_STATE}}if(s.status===COMMENT_STATE){if(s.gzhead.comment){beg=s.pending;do{if(s.pending===s.pending_buf_size){if(s.gzhead.hcrc&&s.pending>beg){strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)}flush_pending(strm);beg=s.pending;if(s.pending===s.pending_buf_size){val=1;break}}if(s.gzindex<s.gzhead.comment.length){val=s.gzhead.comment.charCodeAt(s.gzindex++)&255}else{val=0}put_byte(s,val)}while(val!==0);if(s.gzhead.hcrc&&s.pending>beg){strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)}if(val===0){s.status=HCRC_STATE}}else{s.status=HCRC_STATE}}if(s.status===HCRC_STATE){if(s.gzhead.hcrc){if(s.pending+2>s.pending_buf_size){flush_pending(strm)}if(s.pending+2<=s.pending_buf_size){put_byte(s,strm.adler&255);put_byte(s,strm.adler>>8&255);strm.adler=0;s.status=BUSY_STATE}}else{s.status=BUSY_STATE}}if(s.pending!==0){flush_pending(strm);if(strm.avail_out===0){s.last_flush=-1;return Z_OK}}else if(strm.avail_in===0&&rank(flush)<=rank(old_flush)&&flush!==Z_FINISH){return err(strm,Z_BUF_ERROR)}if(s.status===FINISH_STATE&&strm.avail_in!==0){return err(strm,Z_BUF_ERROR)}if(strm.avail_in!==0||s.lookahead!==0||flush!==Z_NO_FLUSH&&s.status!==FINISH_STATE){var bstate=s.strategy===Z_HUFFMAN_ONLY?deflate_huff(s,flush):s.strategy===Z_RLE?deflate_rle(s,flush):configuration_table[s.level].func(s,flush);if(bstate===BS_FINISH_STARTED||bstate===BS_FINISH_DONE){s.status=FINISH_STATE}if(bstate===BS_NEED_MORE||bstate===BS_FINISH_STARTED){if(strm.avail_out===0){s.last_flush=-1}return Z_OK}if(bstate===BS_BLOCK_DONE){if(flush===Z_PARTIAL_FLUSH){_tr_align(s)}else if(flush!==Z_BLOCK){_tr_stored_block(s,0,0,false);if(flush===Z_FULL_FLUSH){zero$1(s.head);if(s.lookahead===0){s.strstart=0;s.block_start=0;s.insert=0}}}flush_pending(strm);if(strm.avail_out===0){s.last_flush=-1;return Z_OK}}}if(flush!==Z_FINISH){return Z_OK}if(s.wrap<=0){return Z_STREAM_END}if(s.wrap===2){put_byte(s,strm.adler&255);put_byte(s,strm.adler>>8&255);put_byte(s,strm.adler>>16&255);put_byte(s,strm.adler>>24&255);put_byte(s,strm.total_in&255);put_byte(s,strm.total_in>>8&255);put_byte(s,strm.total_in>>16&255);put_byte(s,strm.total_in>>24&255)}else{putShortMSB(s,strm.adler>>>16);putShortMSB(s,strm.adler&65535)}flush_pending(strm);if(s.wrap>0){s.wrap=-s.wrap}return s.pending!==0?Z_OK:Z_STREAM_END}function deflateEnd(strm){var status;if(!strm||!strm.state){return Z_STREAM_ERROR}status=strm.state.status;if(status!==INIT_STATE&&status!==EXTRA_STATE&&status!==NAME_STATE&&status!==COMMENT_STATE&&status!==HCRC_STATE&&status!==BUSY_STATE&&status!==FINISH_STATE){return err(strm,Z_STREAM_ERROR)}strm.state=null;return status===BUSY_STATE?err(strm,Z_DATA_ERROR):Z_OK}var BAD=30;var TYPE=12;function inflate_fast(strm,start){var state;var _in;var last;var _out;var beg;var end;var dmax;var wsize;var whave;var wnext;var s_window;var hold;var bits;var lcode;var dcode;var lmask;var dmask;var here;var op;var len;var dist;var from;var from_source;var input,output;state=strm.state;_in=strm.next_in;input=strm.input;last=_in+(strm.avail_in-5);_out=strm.next_out;output=strm.output;beg=_out-(start-strm.avail_out);end=_out+(strm.avail_out-257);dmax=state.dmax;wsize=state.wsize;whave=state.whave;wnext=state.wnext;s_window=state.window;hold=state.hold;bits=state.bits;lcode=state.lencode;dcode=state.distcode;lmask=(1<<state.lenbits)-1;dmask=(1<<state.distbits)-1;top:do{if(bits<15){hold+=input[_in++]<<bits;bits+=8;hold+=input[_in++]<<bits;bits+=8}here=lcode[hold&lmask];dolen:for(;;){op=here>>>24;hold>>>=op;bits-=op;op=here>>>16&255;if(op===0){output[_out++]=here&65535}else if(op&16){len=here&65535;op&=15;if(op){if(bits<op){hold+=input[_in++]<<bits;bits+=8}len+=hold&(1<<op)-1;hold>>>=op;bits-=op}if(bits<15){hold+=input[_in++]<<bits;bits+=8;hold+=input[_in++]<<bits;bits+=8}here=dcode[hold&dmask];dodist:for(;;){op=here>>>24;hold>>>=op;bits-=op;op=here>>>16&255;if(op&16){dist=here&65535;op&=15;if(bits<op){hold+=input[_in++]<<bits;bits+=8;if(bits<op){hold+=input[_in++]<<bits;bits+=8}}dist+=hold&(1<<op)-1;if(dist>dmax){strm.msg="invalid distance too far back";state.mode=BAD;break top}hold>>>=op;bits-=op;op=_out-beg;if(dist>op){op=dist-op;if(op>whave){if(state.sane){strm.msg="invalid distance too far back";state.mode=BAD;break top}}from=0;from_source=s_window;if(wnext===0){from+=wsize-op;if(op<len){len-=op;do{output[_out++]=s_window[from++]}while(--op);from=_out-dist;from_source=output}}else if(wnext<op){from+=wsize+wnext-op;op-=wnext;if(op<len){len-=op;do{output[_out++]=s_window[from++]}while(--op);from=0;if(wnext<len){op=wnext;len-=op;do{output[_out++]=s_window[from++]}while(--op);from=_out-dist;from_source=output}}}else{from+=wnext-op;if(op<len){len-=op;do{output[_out++]=s_window[from++]}while(--op);from=_out-dist;from_source=output}}while(len>2){output[_out++]=from_source[from++];output[_out++]=from_source[from++];output[_out++]=from_source[from++];len-=3}if(len){output[_out++]=from_source[from++];if(len>1){output[_out++]=from_source[from++]}}}else{from=_out-dist;do{output[_out++]=output[from++];output[_out++]=output[from++];output[_out++]=output[from++];len-=3}while(len>2);if(len){output[_out++]=output[from++];if(len>1){output[_out++]=output[from++]}}}}else if((op&64)===0){here=dcode[(here&65535)+(hold&(1<<op)-1)];continue dodist}else{strm.msg="invalid distance code";state.mode=BAD;break top}break}}else if((op&64)===0){here=lcode[(here&65535)+(hold&(1<<op)-1)];continue dolen}else if(op&32){state.mode=TYPE;break top}else{strm.msg="invalid literal/length code";state.mode=BAD;break top}break}}while(_in<last&&_out<end);len=bits>>3;_in-=len;bits-=len<<3;hold&=(1<<bits)-1;strm.next_in=_in;strm.next_out=_out;strm.avail_in=_in<last?5+(last-_in):5-(_in-last);strm.avail_out=_out<end?257+(end-_out):257-(_out-end);state.hold=hold;state.bits=bits;return}var MAXBITS=15;var ENOUGH_LENS=852;var ENOUGH_DISTS=592;var CODES=0;var LENS=1;var DISTS=2;var lbase=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0];var lext=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78];var dbase=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0];var dext=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];function inflate_table(type,lens,lens_index,codes,table,table_index,work,opts){var bits=opts.bits;var len=0;var sym=0;var min=0,max=0;var root=0;var curr=0;var drop=0;var left=0;var used=0;var huff=0;var incr;var fill;var low;var mask;var next;var base=null;var base_index=0;var end;var count=new Buf16(MAXBITS+1);var offs=new Buf16(MAXBITS+1);var extra=null;var extra_index=0;var here_bits,here_op,here_val;for(len=0;len<=MAXBITS;len++){count[len]=0}for(sym=0;sym<codes;sym++){count[lens[lens_index+sym]]++}root=bits;for(max=MAXBITS;max>=1;max--){if(count[max]!==0){break}}if(root>max){root=max}if(max===0){table[table_index++]=1<<24|64<<16|0;table[table_index++]=1<<24|64<<16|0;opts.bits=1;return 0}for(min=1;min<max;min++){if(count[min]!==0){break}}if(root<min){root=min}left=1;for(len=1;len<=MAXBITS;len++){left<<=1;left-=count[len];if(left<0){return-1}}if(left>0&&(type===CODES||max!==1)){return-1}offs[1]=0;for(len=1;len<MAXBITS;len++){offs[len+1]=offs[len]+count[len]}for(sym=0;sym<codes;sym++){if(lens[lens_index+sym]!==0){work[offs[lens[lens_index+sym]]++]=sym}}if(type===CODES){base=extra=work;end=19}else if(type===LENS){base=lbase;base_index-=257;extra=lext;extra_index-=257;end=256}else{base=dbase;extra=dext;end=-1}huff=0;sym=0;len=min;next=table_index;curr=root;drop=0;low=-1;used=1<<root;mask=used-1;if(type===LENS&&used>ENOUGH_LENS||type===DISTS&&used>ENOUGH_DISTS){return 1}for(;;){here_bits=len-drop;if(work[sym]<end){here_op=0;here_val=work[sym]}else if(work[sym]>end){here_op=extra[extra_index+work[sym]];here_val=base[base_index+work[sym]]}else{here_op=32+64;here_val=0}incr=1<<len-drop;fill=1<<curr;min=fill;do{fill-=incr;table[next+(huff>>drop)+fill]=here_bits<<24|here_op<<16|here_val|0}while(fill!==0);incr=1<<len-1;while(huff&incr){incr>>=1}if(incr!==0){huff&=incr-1;huff+=incr}else{huff=0}sym++;if(--count[len]===0){if(len===max){break}len=lens[lens_index+work[sym]]}if(len>root&&(huff&mask)!==low){if(drop===0){drop=root}next+=min;curr=len-drop;left=1<<curr;while(curr+drop<max){left-=count[curr+drop];if(left<=0){break}curr++;left<<=1}used+=1<<curr;if(type===LENS&&used>ENOUGH_LENS||type===DISTS&&used>ENOUGH_DISTS){return 1}low=huff&mask;table[low]=root<<24|curr<<16|next-table_index|0}}if(huff!==0){table[next+huff]=len-drop<<24|64<<16|0}opts.bits=root;return 0}var CODES$1=0;var LENS$1=1;var DISTS$1=2;var Z_FINISH$1=4;var Z_BLOCK$1=5;var Z_TREES=6;var Z_OK$1=0;var Z_STREAM_END$1=1;var Z_NEED_DICT=2;var Z_STREAM_ERROR$1=-2;var Z_DATA_ERROR$1=-3;var Z_MEM_ERROR=-4;var Z_BUF_ERROR$1=-5;var Z_DEFLATED$1=8;var HEAD=1;var FLAGS=2;var TIME=3;var OS=4;var EXLEN=5;var EXTRA=6;var NAME=7;var COMMENT=8;var HCRC=9;var DICTID=10;var DICT=11;var TYPE$1=12;var TYPEDO=13;var STORED=14;var COPY_=15;var COPY=16;var TABLE=17;var LENLENS=18;var CODELENS=19;var LEN_=20;var LEN=21;var LENEXT=22;var DIST=23;var DISTEXT=24;var MATCH=25;var LIT=26;var CHECK=27;var LENGTH=28;var DONE=29;var BAD$1=30;var MEM=31;var SYNC=32;var ENOUGH_LENS$1=852;var ENOUGH_DISTS$1=592;function zswap32(q){return(q>>>24&255)+(q>>>8&65280)+((q&65280)<<8)+((q&255)<<24)}function InflateState(){this.mode=0;this.last=false;this.wrap=0;this.havedict=false;this.flags=0;this.dmax=0;this.check=0;this.total=0;this.head=null;this.wbits=0;this.wsize=0;this.whave=0;this.wnext=0;this.window=null;this.hold=0;this.bits=0;this.length=0;this.offset=0;this.extra=0;this.lencode=null;this.distcode=null;this.lenbits=0;this.distbits=0;this.ncode=0;this.nlen=0;this.ndist=0;this.have=0;this.next=null;this.lens=new Buf16(320);this.work=new Buf16(288);this.lendyn=null;this.distdyn=null;this.sane=0;this.back=0;this.was=0}function inflateResetKeep(strm){var state;if(!strm||!strm.state){return Z_STREAM_ERROR$1}state=strm.state;strm.total_in=strm.total_out=state.total=0;strm.msg="";if(state.wrap){strm.adler=state.wrap&1}state.mode=HEAD;state.last=0;state.havedict=0;state.dmax=32768;state.head=null;state.hold=0;state.bits=0;state.lencode=state.lendyn=new Buf32(ENOUGH_LENS$1);state.distcode=state.distdyn=new Buf32(ENOUGH_DISTS$1);state.sane=1;state.back=-1;return Z_OK$1}function inflateReset(strm){var state;if(!strm||!strm.state){return Z_STREAM_ERROR$1}state=strm.state;state.wsize=0;state.whave=0;state.wnext=0;return inflateResetKeep(strm)}function inflateReset2(strm,windowBits){var wrap;var state;if(!strm||!strm.state){return Z_STREAM_ERROR$1}state=strm.state;if(windowBits<0){wrap=0;windowBits=-windowBits}else{wrap=(windowBits>>4)+1;if(windowBits<48){windowBits&=15}}if(windowBits&&(windowBits<8||windowBits>15)){return Z_STREAM_ERROR$1}if(state.window!==null&&state.wbits!==windowBits){state.window=null}state.wrap=wrap;state.wbits=windowBits;return inflateReset(strm)}function inflateInit2(strm,windowBits){var ret;var state;if(!strm){return Z_STREAM_ERROR$1}state=new InflateState;strm.state=state;state.window=null;ret=inflateReset2(strm,windowBits);if(ret!==Z_OK$1){strm.state=null}return ret}var virgin=true;var lenfix,distfix;function fixedtables(state){if(virgin){var sym;lenfix=new Buf32(512);distfix=new Buf32(32);sym=0;while(sym<144){state.lens[sym++]=8}while(sym<256){state.lens[sym++]=9}while(sym<280){state.lens[sym++]=7}while(sym<288){state.lens[sym++]=8}inflate_table(LENS$1,state.lens,0,288,lenfix,0,state.work,{bits:9});sym=0;while(sym<32){state.lens[sym++]=5}inflate_table(DISTS$1,state.lens,0,32,distfix,0,state.work,{bits:5});virgin=false}state.lencode=lenfix;state.lenbits=9;state.distcode=distfix;state.distbits=5}function updatewindow(strm,src,end,copy){var dist;var state=strm.state;if(state.window===null){state.wsize=1<<state.wbits;state.wnext=0;state.whave=0;state.window=new Buf8(state.wsize)}if(copy>=state.wsize){arraySet(state.window,src,end-state.wsize,state.wsize,0);state.wnext=0;state.whave=state.wsize}else{dist=state.wsize-state.wnext;if(dist>copy){dist=copy}arraySet(state.window,src,end-copy,dist,state.wnext);copy-=dist;if(copy){arraySet(state.window,src,end-copy,copy,0);state.wnext=copy;state.whave=state.wsize}else{state.wnext+=dist;if(state.wnext===state.wsize){state.wnext=0}if(state.whave<state.wsize){state.whave+=dist}}}return 0}function inflate(strm,flush){var state;var input,output;var next;var put;var have,left;var hold;var bits;var _in,_out;var copy;var from;var from_source;var here=0;var here_bits,here_op,here_val;var last_bits,last_op,last_val;var len;var ret;var hbuf=new Buf8(4);var opts;var n;var order=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!strm||!strm.state||!strm.output||!strm.input&&strm.avail_in!==0){return Z_STREAM_ERROR$1}state=strm.state;if(state.mode===TYPE$1){state.mode=TYPEDO}put=strm.next_out;output=strm.output;left=strm.avail_out;next=strm.next_in;input=strm.input;have=strm.avail_in;hold=state.hold;bits=state.bits;_in=have;_out=left;ret=Z_OK$1;inf_leave:for(;;){switch(state.mode){case HEAD:if(state.wrap===0){state.mode=TYPEDO;break}while(bits<16){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if(state.wrap&2&&hold===35615){state.check=0;hbuf[0]=hold&255;hbuf[1]=hold>>>8&255;state.check=crc32(state.check,hbuf,2,0);hold=0;bits=0;state.mode=FLAGS;break}state.flags=0;if(state.head){state.head.done=false}if(!(state.wrap&1)||(((hold&255)<<8)+(hold>>8))%31){strm.msg="incorrect header check";state.mode=BAD$1;break}if((hold&15)!==Z_DEFLATED$1){strm.msg="unknown compression method";state.mode=BAD$1;break}hold>>>=4;bits-=4;len=(hold&15)+8;if(state.wbits===0){state.wbits=len}else if(len>state.wbits){strm.msg="invalid window size";state.mode=BAD$1;break}state.dmax=1<<len;strm.adler=state.check=1;state.mode=hold&512?DICTID:TYPE$1;hold=0;bits=0;break;case FLAGS:while(bits<16){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}state.flags=hold;if((state.flags&255)!==Z_DEFLATED$1){strm.msg="unknown compression method";state.mode=BAD$1;break}if(state.flags&57344){strm.msg="unknown header flags set";state.mode=BAD$1;break}if(state.head){state.head.text=hold>>8&1}if(state.flags&512){hbuf[0]=hold&255;hbuf[1]=hold>>>8&255;state.check=crc32(state.check,hbuf,2,0)}hold=0;bits=0;state.mode=TIME;case TIME:while(bits<32){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if(state.head){state.head.time=hold}if(state.flags&512){hbuf[0]=hold&255;hbuf[1]=hold>>>8&255;hbuf[2]=hold>>>16&255;hbuf[3]=hold>>>24&255;state.check=crc32(state.check,hbuf,4,0)}hold=0;bits=0;state.mode=OS;case OS:while(bits<16){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if(state.head){state.head.xflags=hold&255;state.head.os=hold>>8}if(state.flags&512){hbuf[0]=hold&255;hbuf[1]=hold>>>8&255;state.check=crc32(state.check,hbuf,2,0)}hold=0;bits=0;state.mode=EXLEN;case EXLEN:if(state.flags&1024){while(bits<16){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}state.length=hold;if(state.head){state.head.extra_len=hold}if(state.flags&512){hbuf[0]=hold&255;hbuf[1]=hold>>>8&255;state.check=crc32(state.check,hbuf,2,0)}hold=0;bits=0}else if(state.head){state.head.extra=null}state.mode=EXTRA;case EXTRA:if(state.flags&1024){copy=state.length;if(copy>have){copy=have}if(copy){if(state.head){len=state.head.extra_len-state.length;if(!state.head.extra){state.head.extra=new Array(state.head.extra_len)}arraySet(state.head.extra,input,next,copy,len)}if(state.flags&512){state.check=crc32(state.check,input,copy,next)}have-=copy;next+=copy;state.length-=copy}if(state.length){break inf_leave}}state.length=0;state.mode=NAME;case NAME:if(state.flags&2048){if(have===0){break inf_leave}copy=0;do{len=input[next+copy++];if(state.head&&len&&state.length<65536){state.head.name+=String.fromCharCode(len)}}while(len&&copy<have);if(state.flags&512){state.check=crc32(state.check,input,copy,next)}have-=copy;next+=copy;if(len){break inf_leave}}else if(state.head){state.head.name=null}state.length=0;state.mode=COMMENT;case COMMENT:if(state.flags&4096){if(have===0){break inf_leave}copy=0;do{len=input[next+copy++];if(state.head&&len&&state.length<65536){state.head.comment+=String.fromCharCode(len)}}while(len&&copy<have);if(state.flags&512){state.check=crc32(state.check,input,copy,next)}have-=copy;next+=copy;if(len){break inf_leave}}else if(state.head){state.head.comment=null}state.mode=HCRC;case HCRC:if(state.flags&512){while(bits<16){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if(hold!==(state.check&65535)){strm.msg="header crc mismatch";state.mode=BAD$1;break}hold=0;bits=0}if(state.head){state.head.hcrc=state.flags>>9&1;state.head.done=true}strm.adler=state.check=0;state.mode=TYPE$1;break;case DICTID:while(bits<32){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}strm.adler=state.check=zswap32(hold);hold=0;bits=0;state.mode=DICT;case DICT:if(state.havedict===0){strm.next_out=put;strm.avail_out=left;strm.next_in=next;strm.avail_in=have;state.hold=hold;state.bits=bits;return Z_NEED_DICT}strm.adler=state.check=1;state.mode=TYPE$1;case TYPE$1:if(flush===Z_BLOCK$1||flush===Z_TREES){break inf_leave}case TYPEDO:if(state.last){hold>>>=bits&7;bits-=bits&7;state.mode=CHECK;break}while(bits<3){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}state.last=hold&1;hold>>>=1;bits-=1;switch(hold&3){case 0:state.mode=STORED;break;case 1:fixedtables(state);state.mode=LEN_;if(flush===Z_TREES){hold>>>=2;bits-=2;break inf_leave}break;case 2:state.mode=TABLE;break;case 3:strm.msg="invalid block type";state.mode=BAD$1}hold>>>=2;bits-=2;break;case STORED:hold>>>=bits&7;bits-=bits&7;while(bits<32){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if((hold&65535)!==(hold>>>16^65535)){strm.msg="invalid stored block lengths";state.mode=BAD$1;break}state.length=hold&65535;hold=0;bits=0;state.mode=COPY_;if(flush===Z_TREES){break inf_leave}case COPY_:state.mode=COPY;case COPY:copy=state.length;if(copy){if(copy>have){copy=have}if(copy>left){copy=left}if(copy===0){break inf_leave}arraySet(output,input,next,copy,put);have-=copy;next+=copy;left-=copy;put+=copy;state.length-=copy;break}state.mode=TYPE$1;break;case TABLE:while(bits<14){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}state.nlen=(hold&31)+257;hold>>>=5;bits-=5;state.ndist=(hold&31)+1;hold>>>=5;bits-=5;state.ncode=(hold&15)+4;hold>>>=4;bits-=4;if(state.nlen>286||state.ndist>30){strm.msg="too many length or distance symbols";state.mode=BAD$1;break}state.have=0;state.mode=LENLENS;case LENLENS:while(state.have<state.ncode){while(bits<3){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}state.lens[order[state.have++]]=hold&7;hold>>>=3;bits-=3}while(state.have<19){state.lens[order[state.have++]]=0}state.lencode=state.lendyn;state.lenbits=7;opts={bits:state.lenbits};ret=inflate_table(CODES$1,state.lens,0,19,state.lencode,0,state.work,opts);state.lenbits=opts.bits;if(ret){strm.msg="invalid code lengths set";state.mode=BAD$1;break}state.have=0;state.mode=CODELENS;case CODELENS:while(state.have<state.nlen+state.ndist){for(;;){here=state.lencode[hold&(1<<state.lenbits)-1];here_bits=here>>>24;here_op=here>>>16&255;here_val=here&65535;if(here_bits<=bits){break}if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if(here_val<16){hold>>>=here_bits;bits-=here_bits;state.lens[state.have++]=here_val}else{if(here_val===16){n=here_bits+2;while(bits<n){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}hold>>>=here_bits;bits-=here_bits;if(state.have===0){strm.msg="invalid bit length repeat";state.mode=BAD$1;break}len=state.lens[state.have-1];copy=3+(hold&3);hold>>>=2;bits-=2}else if(here_val===17){n=here_bits+3;while(bits<n){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}hold>>>=here_bits;bits-=here_bits;len=0;copy=3+(hold&7);hold>>>=3;bits-=3}else{n=here_bits+7;while(bits<n){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}hold>>>=here_bits;bits-=here_bits;len=0;copy=11+(hold&127);hold>>>=7;bits-=7}if(state.have+copy>state.nlen+state.ndist){strm.msg="invalid bit length repeat";state.mode=BAD$1;break}while(copy--){state.lens[state.have++]=len}}}if(state.mode===BAD$1){break}if(state.lens[256]===0){strm.msg="invalid code -- missing end-of-block";state.mode=BAD$1;break}state.lenbits=9;opts={bits:state.lenbits};ret=inflate_table(LENS$1,state.lens,0,state.nlen,state.lencode,0,state.work,opts);state.lenbits=opts.bits;if(ret){strm.msg="invalid literal/lengths set";state.mode=BAD$1;break}state.distbits=6;state.distcode=state.distdyn;opts={bits:state.distbits};ret=inflate_table(DISTS$1,state.lens,state.nlen,state.ndist,state.distcode,0,state.work,opts);state.distbits=opts.bits;if(ret){strm.msg="invalid distances set";state.mode=BAD$1;break}state.mode=LEN_;if(flush===Z_TREES){break inf_leave}case LEN_:state.mode=LEN;case LEN:if(have>=6&&left>=258){strm.next_out=put;strm.avail_out=left;strm.next_in=next;strm.avail_in=have;state.hold=hold;state.bits=bits;inflate_fast(strm,_out);put=strm.next_out;output=strm.output;left=strm.avail_out;next=strm.next_in;input=strm.input;have=strm.avail_in;hold=state.hold;bits=state.bits;if(state.mode===TYPE$1){state.back=-1}break}state.back=0;for(;;){here=state.lencode[hold&(1<<state.lenbits)-1];here_bits=here>>>24;here_op=here>>>16&255;here_val=here&65535;if(here_bits<=bits){break}if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if(here_op&&(here_op&240)===0){last_bits=here_bits;last_op=here_op;last_val=here_val;for(;;){here=state.lencode[last_val+((hold&(1<<last_bits+last_op)-1)>>last_bits)];here_bits=here>>>24;here_op=here>>>16&255;here_val=here&65535;if(last_bits+here_bits<=bits){break}if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}hold>>>=last_bits;bits-=last_bits;state.back+=last_bits}hold>>>=here_bits;bits-=here_bits;state.back+=here_bits;state.length=here_val;if(here_op===0){state.mode=LIT;break}if(here_op&32){state.back=-1;state.mode=TYPE$1;break}if(here_op&64){strm.msg="invalid literal/length code";state.mode=BAD$1;break}state.extra=here_op&15;state.mode=LENEXT;case LENEXT:if(state.extra){n=state.extra;while(bits<n){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}state.length+=hold&(1<<state.extra)-1;hold>>>=state.extra;bits-=state.extra;state.back+=state.extra}state.was=state.length;state.mode=DIST;case DIST:for(;;){here=state.distcode[hold&(1<<state.distbits)-1];here_bits=here>>>24;here_op=here>>>16&255;here_val=here&65535;if(here_bits<=bits){break}if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if((here_op&240)===0){last_bits=here_bits;last_op=here_op;last_val=here_val;for(;;){here=state.distcode[last_val+((hold&(1<<last_bits+last_op)-1)>>last_bits)];here_bits=here>>>24;here_op=here>>>16&255;here_val=here&65535;if(last_bits+here_bits<=bits){break}if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}hold>>>=last_bits;bits-=last_bits;state.back+=last_bits}hold>>>=here_bits;bits-=here_bits;state.back+=here_bits;if(here_op&64){strm.msg="invalid distance code";state.mode=BAD$1;break}state.offset=here_val;state.extra=here_op&15;state.mode=DISTEXT;case DISTEXT:if(state.extra){n=state.extra;while(bits<n){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}state.offset+=hold&(1<<state.extra)-1;hold>>>=state.extra;bits-=state.extra;state.back+=state.extra}if(state.offset>state.dmax){strm.msg="invalid distance too far back";state.mode=BAD$1;break}state.mode=MATCH;case MATCH:if(left===0){break inf_leave}copy=_out-left;if(state.offset>copy){copy=state.offset-copy;if(copy>state.whave){if(state.sane){strm.msg="invalid distance too far back";state.mode=BAD$1;break}}if(copy>state.wnext){copy-=state.wnext;from=state.wsize-copy}else{from=state.wnext-copy}if(copy>state.length){copy=state.length}from_source=state.window}else{from_source=output;from=put-state.offset;copy=state.length}if(copy>left){copy=left}left-=copy;state.length-=copy;do{output[put++]=from_source[from++]}while(--copy);if(state.length===0){state.mode=LEN}break;case LIT:if(left===0){break inf_leave}output[put++]=state.length;left--;state.mode=LEN;break;case CHECK:if(state.wrap){while(bits<32){if(have===0){break inf_leave}have--;hold|=input[next++]<<bits;bits+=8}_out-=left;strm.total_out+=_out;state.total+=_out;if(_out){strm.adler=state.check=state.flags?crc32(state.check,output,_out,put-_out):adler32(state.check,output,_out,put-_out)}_out=left;if((state.flags?hold:zswap32(hold))!==state.check){strm.msg="incorrect data check";state.mode=BAD$1;break}hold=0;bits=0}state.mode=LENGTH;case LENGTH:if(state.wrap&&state.flags){while(bits<32){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if(hold!==(state.total&4294967295)){strm.msg="incorrect length check";state.mode=BAD$1;break}hold=0;bits=0}state.mode=DONE;case DONE:ret=Z_STREAM_END$1;break inf_leave;case BAD$1:ret=Z_DATA_ERROR$1;break inf_leave;case MEM:return Z_MEM_ERROR;case SYNC:default:return Z_STREAM_ERROR$1}}strm.next_out=put;strm.avail_out=left;strm.next_in=next;strm.avail_in=have;state.hold=hold;state.bits=bits;if(state.wsize||_out!==strm.avail_out&&state.mode<BAD$1&&(state.mode<CHECK||flush!==Z_FINISH$1)){if(updatewindow(strm,strm.output,strm.next_out,_out-strm.avail_out));}_in-=strm.avail_in;_out-=strm.avail_out;strm.total_in+=_in;strm.total_out+=_out;state.total+=_out;if(state.wrap&&_out){strm.adler=state.check=state.flags?crc32(state.check,output,_out,strm.next_out-_out):adler32(state.check,output,_out,strm.next_out-_out)}strm.data_type=state.bits+(state.last?64:0)+(state.mode===TYPE$1?128:0)+(state.mode===LEN_||state.mode===COPY_?256:0);if((_in===0&&_out===0||flush===Z_FINISH$1)&&ret===Z_OK$1){ret=Z_BUF_ERROR$1}return ret}function inflateEnd(strm){if(!strm||!strm.state){return Z_STREAM_ERROR$1}var state=strm.state;if(state.window){state.window=null}strm.state=null;return Z_OK$1}var NONE=0;var DEFLATE=1;var INFLATE=2;var GZIP=3;var GUNZIP=4;var DEFLATERAW=5;var INFLATERAW=6;var UNZIP=7;var Z_NO_FLUSH$1=0,Z_PARTIAL_FLUSH$1=1,Z_SYNC_FLUSH=2,Z_FULL_FLUSH$1=3,Z_FINISH$2=4,Z_BLOCK$2=5,Z_TREES$1=6,Z_OK$2=0,Z_STREAM_END$2=1,Z_NEED_DICT$1=2,Z_ERRNO=-1,Z_STREAM_ERROR$2=-2,Z_DATA_ERROR$2=-3,Z_BUF_ERROR$2=-5,Z_NO_COMPRESSION=0,Z_BEST_SPEED=1,Z_BEST_COMPRESSION=9,Z_DEFAULT_COMPRESSION$1=-1,Z_FILTERED$1=1,Z_HUFFMAN_ONLY$1=2,Z_RLE$1=3,Z_FIXED$2=4,Z_DEFAULT_STRATEGY=0,Z_BINARY$1=0,Z_TEXT$1=1,Z_UNKNOWN$2=2,Z_DEFLATED$2=8;function Zlib(mode){if(mode<DEFLATE||mode>UNZIP)throw new TypeError("Bad argument");this.mode=mode;this.init_done=false;this.write_in_progress=false;this.pending_close=false;this.windowBits=0;this.level=0;this.memLevel=0;this.strategy=0;this.dictionary=null}Zlib.prototype.init=function(windowBits,level,memLevel,strategy,dictionary){this.windowBits=windowBits;this.level=level;this.memLevel=memLevel;this.strategy=strategy;if(this.mode===GZIP||this.mode===GUNZIP)this.windowBits+=16;if(this.mode===UNZIP)this.windowBits+=32;if(this.mode===DEFLATERAW||this.mode===INFLATERAW)this.windowBits=-this.windowBits;this.strm=new ZStream;var status;switch(this.mode){case DEFLATE:case GZIP:case DEFLATERAW:status=deflateInit2(this.strm,this.level,Z_DEFLATED$2,this.windowBits,this.memLevel,this.strategy);break;case INFLATE:case GUNZIP:case INFLATERAW:case UNZIP:status=inflateInit2(this.strm,this.windowBits);break;default:throw new Error("Unknown mode "+this.mode)}if(status!==Z_OK$2){this._error(status);return}this.write_in_progress=false;this.init_done=true};Zlib.prototype.params=function(){throw new Error("deflateParams Not supported")};Zlib.prototype._writeCheck=function(){if(!this.init_done)throw new Error("write before init");if(this.mode===NONE)throw new Error("already finalized");if(this.write_in_progress)throw new Error("write already in progress");if(this.pending_close)throw new Error("close is pending")};Zlib.prototype.write=function(flush,input,in_off,in_len,out,out_off,out_len){this._writeCheck();this.write_in_progress=true;var self=this;nextTick((function(){self.write_in_progress=false;var res=self._write(flush,input,in_off,in_len,out,out_off,out_len);self.callback(res[0],res[1]);if(self.pending_close)self.close()}));return this};function bufferSet(data,offset){for(var i=0;i<data.length;i++){this[offset+i]=data[i]}}Zlib.prototype.writeSync=function(flush,input,in_off,in_len,out,out_off,out_len){this._writeCheck();return this._write(flush,input,in_off,in_len,out,out_off,out_len)};Zlib.prototype._write=function(flush,input,in_off,in_len,out,out_off,out_len){this.write_in_progress=true;if(flush!==Z_NO_FLUSH$1&&flush!==Z_PARTIAL_FLUSH$1&&flush!==Z_SYNC_FLUSH&&flush!==Z_FULL_FLUSH$1&&flush!==Z_FINISH$2&&flush!==Z_BLOCK$2){throw new Error("Invalid flush value")}if(input==null){input=new Buffer(0);in_len=0;in_off=0}if(out._set)out.set=out._set;else out.set=bufferSet;var strm=this.strm;strm.avail_in=in_len;strm.input=input;strm.next_in=in_off;strm.avail_out=out_len;strm.output=out;strm.next_out=out_off;var status;switch(this.mode){case DEFLATE:case GZIP:case DEFLATERAW:status=deflate(strm,flush);break;case UNZIP:case INFLATE:case GUNZIP:case INFLATERAW:status=inflate(strm,flush);break;default:throw new Error("Unknown mode "+this.mode)}if(status!==Z_STREAM_END$2&&status!==Z_OK$2){this._error(status)}this.write_in_progress=false;return[strm.avail_in,strm.avail_out]};Zlib.prototype.close=function(){if(this.write_in_progress){this.pending_close=true;return}this.pending_close=false;if(this.mode===DEFLATE||this.mode===GZIP||this.mode===DEFLATERAW){deflateEnd(this.strm)}else{inflateEnd(this.strm)}this.mode=NONE};var status;Zlib.prototype.reset=function(){switch(this.mode){case DEFLATE:case DEFLATERAW:status=deflateReset(this.strm);break;case INFLATE:case INFLATERAW:status=inflateReset(this.strm);break}if(status!==Z_OK$2){this._error(status)}};Zlib.prototype._error=function(status){this.onerror(msg[status]+": "+this.strm.msg,status);this.write_in_progress=false;if(this.pending_close)this.close()};var _binding=Object.freeze({__proto__:null,NONE:NONE,DEFLATE:DEFLATE,INFLATE:INFLATE,GZIP:GZIP,GUNZIP:GUNZIP,DEFLATERAW:DEFLATERAW,INFLATERAW:INFLATERAW,UNZIP:UNZIP,Z_NO_FLUSH:Z_NO_FLUSH$1,Z_PARTIAL_FLUSH:Z_PARTIAL_FLUSH$1,Z_SYNC_FLUSH:Z_SYNC_FLUSH,Z_FULL_FLUSH:Z_FULL_FLUSH$1,Z_FINISH:Z_FINISH$2,Z_BLOCK:Z_BLOCK$2,Z_TREES:Z_TREES$1,Z_OK:Z_OK$2,Z_STREAM_END:Z_STREAM_END$2,Z_NEED_DICT:Z_NEED_DICT$1,Z_ERRNO:Z_ERRNO,Z_STREAM_ERROR:Z_STREAM_ERROR$2,Z_DATA_ERROR:Z_DATA_ERROR$2,Z_BUF_ERROR:Z_BUF_ERROR$2,Z_NO_COMPRESSION:Z_NO_COMPRESSION,Z_BEST_SPEED:Z_BEST_SPEED,Z_BEST_COMPRESSION:Z_BEST_COMPRESSION,Z_DEFAULT_COMPRESSION:Z_DEFAULT_COMPRESSION$1,Z_FILTERED:Z_FILTERED$1,Z_HUFFMAN_ONLY:Z_HUFFMAN_ONLY$1,Z_RLE:Z_RLE$1,Z_FIXED:Z_FIXED$2,Z_DEFAULT_STRATEGY:Z_DEFAULT_STRATEGY,Z_BINARY:Z_BINARY$1,Z_TEXT:Z_TEXT$1,Z_UNKNOWN:Z_UNKNOWN$2,Z_DEFLATED:Z_DEFLATED$2,Zlib:Zlib});function assert(a,msg){if(!a){throw new Error(msg)}}var binding={};Object.keys(_binding).forEach((function(key){binding[key]=_binding[key]}));binding.Z_MIN_WINDOWBITS=8;binding.Z_MAX_WINDOWBITS=15;binding.Z_DEFAULT_WINDOWBITS=15;binding.Z_MIN_CHUNK=64;binding.Z_MAX_CHUNK=Infinity;binding.Z_DEFAULT_CHUNK=16*1024;binding.Z_MIN_MEMLEVEL=1;binding.Z_MAX_MEMLEVEL=9;binding.Z_DEFAULT_MEMLEVEL=8;binding.Z_MIN_LEVEL=-1;binding.Z_MAX_LEVEL=9;binding.Z_DEFAULT_LEVEL=binding.Z_DEFAULT_COMPRESSION;var codes={Z_OK:binding.Z_OK,Z_STREAM_END:binding.Z_STREAM_END,Z_NEED_DICT:binding.Z_NEED_DICT,Z_ERRNO:binding.Z_ERRNO,Z_STREAM_ERROR:binding.Z_STREAM_ERROR,Z_DATA_ERROR:binding.Z_DATA_ERROR,Z_MEM_ERROR:binding.Z_MEM_ERROR,Z_BUF_ERROR:binding.Z_BUF_ERROR,Z_VERSION_ERROR:binding.Z_VERSION_ERROR};Object.keys(codes).forEach((function(k){codes[codes[k]]=k}));function createDeflate(o){return new Deflate(o)}function createInflate(o){return new Inflate(o)}function createDeflateRaw(o){return new DeflateRaw(o)}function createInflateRaw(o){return new InflateRaw(o)}function createGzip(o){return new Gzip(o)}function createGunzip(o){return new Gunzip(o)}function createUnzip(o){return new Unzip(o)}function deflate$1(buffer,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}return zlibBuffer(new Deflate(opts),buffer,callback)}function deflateSync(buffer,opts){return zlibBufferSync(new Deflate(opts),buffer)}function gzip(buffer,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}return zlibBuffer(new Gzip(opts),buffer,callback)}function gzipSync(buffer,opts){return zlibBufferSync(new Gzip(opts),buffer)}function deflateRaw(buffer,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}return zlibBuffer(new DeflateRaw(opts),buffer,callback)}function deflateRawSync(buffer,opts){return zlibBufferSync(new DeflateRaw(opts),buffer)}function unzip(buffer,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}return zlibBuffer(new Unzip(opts),buffer,callback)}function unzipSync(buffer,opts){return zlibBufferSync(new Unzip(opts),buffer)}function inflate$1(buffer,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}return zlibBuffer(new Inflate(opts),buffer,callback)}function inflateSync(buffer,opts){return zlibBufferSync(new Inflate(opts),buffer)}function gunzip(buffer,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}return zlibBuffer(new Gunzip(opts),buffer,callback)}function gunzipSync(buffer,opts){return zlibBufferSync(new Gunzip(opts),buffer)}function inflateRaw(buffer,opts,callback){if(typeof opts==="function"){callback=opts;opts={}}return zlibBuffer(new InflateRaw(opts),buffer,callback)}function inflateRawSync(buffer,opts){return zlibBufferSync(new InflateRaw(opts),buffer)}function zlibBuffer(engine,buffer,callback){var buffers=[];var nread=0;engine.on("error",onError);engine.on("end",onEnd);engine.end(buffer);flow();function flow(){var chunk;while(null!==(chunk=engine.read())){buffers.push(chunk);nread+=chunk.length}engine.once("readable",flow)}function onError(err){engine.removeListener("end",onEnd);engine.removeListener("readable",flow);callback(err)}function onEnd(){var buf=Buffer.concat(buffers,nread);buffers=[];callback(null,buf);engine.close()}}function zlibBufferSync(engine,buffer){if(typeof buffer==="string")buffer=new Buffer(buffer);if(!isBuffer(buffer))throw new TypeError("Not a string or buffer");var flushFlag=binding.Z_FINISH;return engine._processChunk(buffer,flushFlag)}function Deflate(opts){if(!(this instanceof Deflate))return new Deflate(opts);Zlib$1.call(this,opts,binding.DEFLATE)}function Inflate(opts){if(!(this instanceof Inflate))return new Inflate(opts);Zlib$1.call(this,opts,binding.INFLATE)}function Gzip(opts){if(!(this instanceof Gzip))return new Gzip(opts);Zlib$1.call(this,opts,binding.GZIP)}function Gunzip(opts){if(!(this instanceof Gunzip))return new Gunzip(opts);Zlib$1.call(this,opts,binding.GUNZIP)}function DeflateRaw(opts){if(!(this instanceof DeflateRaw))return new DeflateRaw(opts);Zlib$1.call(this,opts,binding.DEFLATERAW)}function InflateRaw(opts){if(!(this instanceof InflateRaw))return new InflateRaw(opts);Zlib$1.call(this,opts,binding.INFLATERAW)}function Unzip(opts){if(!(this instanceof Unzip))return new Unzip(opts);Zlib$1.call(this,opts,binding.UNZIP)}function Zlib$1(opts,mode){this._opts=opts=opts||{};this._chunkSize=opts.chunkSize||binding.Z_DEFAULT_CHUNK;Transform.call(this,opts);if(opts.flush){if(opts.flush!==binding.Z_NO_FLUSH&&opts.flush!==binding.Z_PARTIAL_FLUSH&&opts.flush!==binding.Z_SYNC_FLUSH&&opts.flush!==binding.Z_FULL_FLUSH&&opts.flush!==binding.Z_FINISH&&opts.flush!==binding.Z_BLOCK){throw new Error("Invalid flush flag: "+opts.flush)}}this._flushFlag=opts.flush||binding.Z_NO_FLUSH;if(opts.chunkSize){if(opts.chunkSize<binding.Z_MIN_CHUNK||opts.chunkSize>binding.Z_MAX_CHUNK){throw new Error("Invalid chunk size: "+opts.chunkSize)}}if(opts.windowBits){if(opts.windowBits<binding.Z_MIN_WINDOWBITS||opts.windowBits>binding.Z_MAX_WINDOWBITS){throw new Error("Invalid windowBits: "+opts.windowBits)}}if(opts.level){if(opts.level<binding.Z_MIN_LEVEL||opts.level>binding.Z_MAX_LEVEL){throw new Error("Invalid compression level: "+opts.level)}}if(opts.memLevel){if(opts.memLevel<binding.Z_MIN_MEMLEVEL||opts.memLevel>binding.Z_MAX_MEMLEVEL){throw new Error("Invalid memLevel: "+opts.memLevel)}}if(opts.strategy){if(opts.strategy!=binding.Z_FILTERED&&opts.strategy!=binding.Z_HUFFMAN_ONLY&&opts.strategy!=binding.Z_RLE&&opts.strategy!=binding.Z_FIXED&&opts.strategy!=binding.Z_DEFAULT_STRATEGY){throw new Error("Invalid strategy: "+opts.strategy)}}if(opts.dictionary){if(!isBuffer(opts.dictionary)){throw new Error("Invalid dictionary: it should be a Buffer instance")}}this._binding=new binding.Zlib(mode);var self=this;this._hadError=false;this._binding.onerror=function(message,errno){self._binding=null;self._hadError=true;var error=new Error(message);error.errno=errno;error.code=binding.codes[errno];self.emit("error",error)};var level=binding.Z_DEFAULT_COMPRESSION;if(typeof opts.level==="number")level=opts.level;var strategy=binding.Z_DEFAULT_STRATEGY;if(typeof opts.strategy==="number")strategy=opts.strategy;this._binding.init(opts.windowBits||binding.Z_DEFAULT_WINDOWBITS,level,opts.memLevel||binding.Z_DEFAULT_MEMLEVEL,strategy,opts.dictionary);this._buffer=new Buffer(this._chunkSize);this._offset=0;this._closed=false;this._level=level;this._strategy=strategy;this.once("end",this.close)}inherits$1(Zlib$1,Transform);Zlib$1.prototype.params=function(level,strategy,callback){if(level<binding.Z_MIN_LEVEL||level>binding.Z_MAX_LEVEL){throw new RangeError("Invalid compression level: "+level)}if(strategy!=binding.Z_FILTERED&&strategy!=binding.Z_HUFFMAN_ONLY&&strategy!=binding.Z_RLE&&strategy!=binding.Z_FIXED&&strategy!=binding.Z_DEFAULT_STRATEGY){throw new TypeError("Invalid strategy: "+strategy)}if(this._level!==level||this._strategy!==strategy){var self=this;this.flush(binding.Z_SYNC_FLUSH,(function(){self._binding.params(level,strategy);if(!self._hadError){self._level=level;self._strategy=strategy;if(callback)callback()}}))}else{nextTick(callback)}};Zlib$1.prototype.reset=function(){return this._binding.reset()};Zlib$1.prototype._flush=function(callback){this._transform(new Buffer(0),"",callback)};Zlib$1.prototype.flush=function(kind,callback){var ws=this._writableState;if(typeof kind==="function"||kind===void 0&&!callback){callback=kind;kind=binding.Z_FULL_FLUSH}if(ws.ended){if(callback)nextTick(callback)}else if(ws.ending){if(callback)this.once("end",callback)}else if(ws.needDrain){var self=this;this.once("drain",(function(){self.flush(callback)}))}else{this._flushFlag=kind;this.write(new Buffer(0),"",callback)}};Zlib$1.prototype.close=function(callback){if(callback)nextTick(callback);if(this._closed)return;this._closed=true;this._binding.close();var self=this;nextTick((function(){self.emit("close")}))};Zlib$1.prototype._transform=function(chunk,encoding,cb){var flushFlag;var ws=this._writableState;var ending=ws.ending||ws.ended;var last=ending&&(!chunk||ws.length===chunk.length);if(!chunk===null&&!isBuffer(chunk))return cb(new Error("invalid input"));if(last)flushFlag=binding.Z_FINISH;else{flushFlag=this._flushFlag;if(chunk.length>=ws.length){this._flushFlag=this._opts.flush||binding.Z_NO_FLUSH}}this._processChunk(chunk,flushFlag,cb)};Zlib$1.prototype._processChunk=function(chunk,flushFlag,cb){var availInBefore=chunk&&chunk.length;var availOutBefore=this._chunkSize-this._offset;var inOff=0;var self=this;var async=typeof cb==="function";if(!async){var buffers=[];var nread=0;var error;this.on("error",(function(er){error=er}));do{var res=this._binding.writeSync(flushFlag,chunk,inOff,availInBefore,this._buffer,this._offset,availOutBefore)}while(!this._hadError&&callback(res[0],res[1]));if(this._hadError){throw error}var buf=Buffer.concat(buffers,nread);this.close();return buf}var req=this._binding.write(flushFlag,chunk,inOff,availInBefore,this._buffer,this._offset,availOutBefore);req.buffer=chunk;req.callback=callback;function callback(availInAfter,availOutAfter){if(self._hadError)return;var have=availOutBefore-availOutAfter;assert(have>=0,"have should not go down");if(have>0){var out=self._buffer.slice(self._offset,self._offset+have);self._offset+=have;if(async){self.push(out)}else{buffers.push(out);nread+=out.length}}if(availOutAfter===0||self._offset>=self._chunkSize){availOutBefore=self._chunkSize;self._offset=0;self._buffer=new Buffer(self._chunkSize)}if(availOutAfter===0){inOff+=availInBefore-availInAfter;availInBefore=availInAfter;if(!async)return true;var newReq=self._binding.write(flushFlag,chunk,inOff,availInBefore,self._buffer,self._offset,self._chunkSize);newReq.callback=callback;newReq.buffer=chunk;return}if(!async)return false;cb()}};inherits$1(Deflate,Zlib$1);inherits$1(Inflate,Zlib$1);inherits$1(Gzip,Zlib$1);inherits$1(Gunzip,Zlib$1);inherits$1(DeflateRaw,Zlib$1);inherits$1(InflateRaw,Zlib$1);inherits$1(Unzip,Zlib$1);var zlib={codes:codes,createDeflate:createDeflate,createInflate:createInflate,createDeflateRaw:createDeflateRaw,createInflateRaw:createInflateRaw,createGzip:createGzip,createGunzip:createGunzip,createUnzip:createUnzip,deflate:deflate$1,deflateSync:deflateSync,gzip:gzip,gzipSync:gzipSync,deflateRaw:deflateRaw,deflateRawSync:deflateRawSync,unzip:unzip,unzipSync:unzipSync,inflate:inflate$1,inflateSync:inflateSync,gunzip:gunzip,gunzipSync:gunzipSync,inflateRaw:inflateRaw,inflateRawSync:inflateRawSync,Deflate:Deflate,Inflate:Inflate,Gzip:Gzip,Gunzip:Gunzip,DeflateRaw:DeflateRaw,InflateRaw:InflateRaw,Unzip:Unzip,Zlib:Zlib$1};var OPTS={namespace:"org.apache.avro.file"};var LONG_TYPE=types.Type.forSchema("long",OPTS);var MAP_BYTES_TYPE=types.Type.forSchema({type:"map",values:"bytes"},OPTS);var HEADER_TYPE=types.Type.forSchema({name:"Header",type:"record",fields:[{name:"magic",type:{type:"fixed",name:"Magic",size:4}},{name:"meta",type:MAP_BYTES_TYPE},{name:"sync",type:{type:"fixed",name:"Sync",size:16}}]},OPTS);var BLOCK_TYPE=types.Type.forSchema({name:"Block",type:"record",fields:[{name:"count",type:"long"},{name:"data",type:"bytes"},{name:"sync",type:"Sync"}]},OPTS);var MAGIC_BYTES=utils.bufferFrom("Obj");var f$1=util.format;var Tap$2=utils.Tap;function RawDecoder(schema,opts){opts=opts||{};var noDecode=!!opts.noDecode;Stream.Duplex.call(this,{readableObjectMode:!noDecode,allowHalfOpen:false});this._type=types.Type.forSchema(schema);this._tap=new Tap$2(utils.newBuffer(0));this._writeCb=null;this._needPush=false;this._readValue=createReader(noDecode,this._type);this._finished=false;this.on("finish",(function(){this._finished=true;this._read()}))}util.inherits(RawDecoder,Stream.Duplex);RawDecoder.prototype._write=function(chunk,encoding,cb){this._writeCb=cb;var tap=this._tap;tap.buf=Buffer.concat([tap.buf.slice(tap.pos),chunk]);tap.pos=0;if(this._needPush){this._needPush=false;this._read()}};RawDecoder.prototype._read=function(){this._needPush=false;var tap=this._tap;var pos=tap.pos;var val=this._readValue(tap);if(tap.isValid()){this.push(val)}else if(!this._finished){tap.pos=pos;this._needPush=true;if(this._writeCb){this._writeCb()}}else{this.push(null)}};function BlockDecoder(opts){opts=opts||{};var noDecode=!!opts.noDecode;Stream.Duplex.call(this,{allowHalfOpen:true,readableObjectMode:!noDecode});this._rType=opts.readerSchema!==undefined?types.Type.forSchema(opts.readerSchema):undefined;this._wType=null;this._codecs=opts.codecs;this._codec=undefined;this._parseHook=opts.parseHook;this._tap=new Tap$2(utils.newBuffer(0));this._blockTap=new Tap$2(utils.newBuffer(0));this._syncMarker=null;this._readValue=null;this._noDecode=noDecode;this._queue=new utils.OrderedQueue;this._decompress=null;this._index=0;this._remaining=undefined;this._needPush=false;this._finished=false;this.on("finish",(function(){this._finished=true;if(this._needPush){this._read()}}))}util.inherits(BlockDecoder,Stream.Duplex);BlockDecoder.defaultCodecs=function(){return{null:function(buf,cb){cb(null,buf)},deflate:zlib.inflateRaw}};BlockDecoder.getDefaultCodecs=BlockDecoder.defaultCodecs;BlockDecoder.prototype._decodeHeader=function(){var tap=this._tap;if(tap.buf.length<MAGIC_BYTES.length){return false}if(!MAGIC_BYTES.equals(tap.buf.slice(0,MAGIC_BYTES.length))){this.emit("error",new Error("invalid magic bytes"));return false}var header=HEADER_TYPE._read(tap);if(!tap.isValid()){return false}this._codec=(header.meta["avro.codec"]||"null").toString();var codecs=this._codecs||BlockDecoder.getDefaultCodecs();this._decompress=codecs[this._codec];if(!this._decompress){this.emit("error",new Error(f$1("unknown codec: %s",this._codec)));return}try{var schema=JSON.parse(header.meta["avro.schema"].toString());if(this._parseHook){schema=this._parseHook(schema)}this._wType=types.Type.forSchema(schema)}catch(err){this.emit("error",err);return}try{this._readValue=createReader(this._noDecode,this._wType,this._rType)}catch(err){this.emit("error",err);return}this._syncMarker=header.sync;this.emit("metadata",this._wType,this._codec,header);return true};BlockDecoder.prototype._write=function(chunk,encoding,cb){var tap=this._tap;tap.buf=Buffer.concat([tap.buf,chunk]);tap.pos=0;if(!this._decodeHeader()){nextTick(cb);return}this._write=this._writeChunk;this._write(utils.newBuffer(0),encoding,cb)};BlockDecoder.prototype._writeChunk=function(chunk,encoding,cb){var tap=this._tap;tap.buf=Buffer.concat([tap.buf.slice(tap.pos),chunk]);tap.pos=0;var nBlocks=1;var block;while(block=tryReadBlock(tap)){if(!this._syncMarker.equals(block.sync)){this.emit("error",new Error("invalid sync marker"));return}nBlocks++;this._decompress(block.data,this._createBlockCallback(block.count,chunkCb))}chunkCb();function chunkCb(){if(!--nBlocks){cb()}}};BlockDecoder.prototype._createBlockCallback=function(count,cb){var self=this;var index=this._index++;return function(cause,data){if(cause){var err=new Error(f$1("%s codec decompression error",self._codec));err.cause=cause;self.emit("error",err);cb()}else{self._queue.push(new BlockData(index,data,cb,count));if(self._needPush){self._read()}}}};BlockDecoder.prototype._read=function(){this._needPush=false;var tap=this._blockTap;if(!this._remaining){var data=this._queue.pop();if(!data||!data.count){if(this._finished){this.push(null)}else{this._needPush=true}if(data){data.cb()}return}data.cb();this._remaining=data.count;tap.buf=data.buf;tap.pos=0}this._remaining--;var val;try{val=this._readValue(tap);if(!tap.isValid()){throw new Error("truncated block")}}catch(err){this._remaining=0;this.emit("error",err);return}this.push(val)};function RawEncoder(schema,opts){opts=opts||{};Stream.Transform.call(this,{writableObjectMode:true,allowHalfOpen:false});this._type=types.Type.forSchema(schema);this._writeValue=function(tap,val){try{this._type._write(tap,val)}catch(err){this.emit("typeError",err,val,this._type)}};this._tap=new Tap$2(utils.newBuffer(opts.batchSize||65536));this.on("typeError",(function(err){this.emit("error",err)}))}util.inherits(RawEncoder,Stream.Transform);RawEncoder.prototype._transform=function(val,encoding,cb){var tap=this._tap;var buf=tap.buf;var pos=tap.pos;this._writeValue(tap,val);if(!tap.isValid()){if(pos){this.push(copyBuffer(tap.buf,0,pos))}var len=tap.pos-pos;if(len>buf.length){tap.buf=utils.newBuffer(2*len)}tap.pos=0;this._writeValue(tap,val)}cb()};RawEncoder.prototype._flush=function(cb){var tap=this._tap;var pos=tap.pos;if(pos){this.push(tap.buf.slice(0,pos))}cb()};function BlockEncoder(schema,opts){opts=opts||{};Stream.Duplex.call(this,{allowHalfOpen:true,writableObjectMode:true});var type;if(types.Type.isType(schema)){type=schema;schema=undefined}else{type=types.Type.forSchema(schema)}this._schema=schema;this._type=type;this._writeValue=function(tap,val){try{this._type._write(tap,val)}catch(err){this.emit("typeError",err,val,this._type);return false}return true};this._blockSize=opts.blockSize||65536;this._tap=new Tap$2(utils.newBuffer(this._blockSize));this._codecs=opts.codecs;this._codec=opts.codec||"null";this._blockCount=0;this._syncMarker=opts.syncMarker||(new utils.Lcg).nextBuffer(16);this._queue=new utils.OrderedQueue;this._pending=0;this._finished=false;this._needHeader=false;this._needPush=false;this._metadata=opts.metadata||{};if(!MAP_BYTES_TYPE.isValid(this._metadata)){throw new Error("invalid metadata")}var codec=this._codec;this._compress=(this._codecs||BlockEncoder.getDefaultCodecs())[codec];if(!this._compress){throw new Error(f$1("unsupported codec: %s",codec))}if(opts.omitHeader!==undefined){opts.writeHeader=opts.omitHeader?"never":"auto"}switch(opts.writeHeader){case false:case"never":break;case undefined:case"auto":this._needHeader=true;break;default:this._writeHeader()}this.on("finish",(function(){this._finished=true;if(this._blockCount){this._flushChunk()}else if(this._finished&&this._needPush){this.push(null)}}));this.on("typeError",(function(err){this.emit("error",err)}))}util.inherits(BlockEncoder,Stream.Duplex);BlockEncoder.defaultCodecs=function(){return{null:function(buf,cb){cb(null,buf)},deflate:zlib.deflateRaw}};BlockEncoder.getDefaultCodecs=BlockEncoder.defaultCodecs;BlockEncoder.prototype._writeHeader=function(){var schema=JSON.stringify(this._schema?this._schema:this._type.getSchema({exportAttrs:true}));var meta=utils.copyOwnProperties(this._metadata,{"avro.schema":utils.bufferFrom(schema),"avro.codec":utils.bufferFrom(this._codec)},true);var Header=HEADER_TYPE.getRecordConstructor();var header=new Header(MAGIC_BYTES,meta,this._syncMarker);this.push(header.toBuffer())};BlockEncoder.prototype._write=function(val,encoding,cb){if(this._needHeader){this._writeHeader();this._needHeader=false}var tap=this._tap;var pos=tap.pos;var flushing=false;if(this._writeValue(tap,val)){if(!tap.isValid()){if(pos){this._flushChunk(pos,cb);flushing=true}var len=tap.pos-pos;if(len>this._blockSize){this._blockSize=len*2}tap.buf=utils.newBuffer(this._blockSize);tap.pos=0;this._writeValue(tap,val)}this._blockCount++}else{tap.pos=pos}if(!flushing){cb()}};BlockEncoder.prototype._flushChunk=function(pos,cb){var tap=this._tap;pos=pos||tap.pos;this._compress(tap.buf.slice(0,pos),this._createBlockCallback(cb));this._blockCount=0};BlockEncoder.prototype._read=function(){var self=this;var data=this._queue.pop();if(!data){if(this._finished&&!this._pending){nextTick((function(){self.push(null)}))}else{this._needPush=true}return}this.push(LONG_TYPE.toBuffer(data.count,true));this.push(LONG_TYPE.toBuffer(data.buf.length,true));this.push(data.buf);this.push(this._syncMarker);if(!this._finished){data.cb()}};BlockEncoder.prototype._createBlockCallback=function(cb){var self=this;var index=this._index++;var count=this._blockCount;this._pending++;return function(cause,data){if(cause){var err=new Error(f$1("%s codec compression error",self._codec));err.cause=cause;self.emit("error",err);return}self._pending--;self._queue.push(new BlockData(index,data,cb,count));if(self._needPush){self._needPush=false;self._read()}}};function BlockData(index,buf,cb,count){this.index=index;this.buf=buf;this.cb=cb;this.count=count|0}function tryReadBlock(tap){var pos=tap.pos;var block=BLOCK_TYPE._read(tap);if(!tap.isValid()){tap.pos=pos;return null}return block}function createReader(noDecode,writerType,readerType){if(noDecode){return function(skipper){return function(tap){var pos=tap.pos;skipper(tap);return tap.buf.slice(pos,tap.pos)}}(writerType._skip)}else if(readerType){var resolver=readerType.createResolver(writerType);return function(tap){return resolver._read(tap)}}else{return function(tap){return writerType._read(tap)}}}function copyBuffer(buf,pos,len){var copy=utils.newBuffer(len);buf.copy(copy,0,pos,pos+len);return copy}var containers={BLOCK_TYPE:BLOCK_TYPE,HEADER_TYPE:HEADER_TYPE,MAGIC_BYTES:MAGIC_BYTES,streams:{BlockDecoder:BlockDecoder,BlockEncoder:BlockEncoder,RawDecoder:RawDecoder,RawEncoder:RawEncoder}};var Tap$3=utils.Tap;var Type$1=types.Type;var debug$2=util.debuglog("avsc:services");var f$2=util.format;var OPTS$1={namespace:"org.apache.avro.ipc"};var BOOLEAN_TYPE=Type$1.forSchema("boolean",OPTS$1);var MAP_BYTES_TYPE$1=Type$1.forSchema({type:"map",values:"bytes"},OPTS$1);var STRING_TYPE=Type$1.forSchema("string",OPTS$1);var HANDSHAKE_REQUEST_TYPE=Type$1.forSchema({name:"HandshakeRequest",type:"record",fields:[{name:"clientHash",type:{name:"MD5",type:"fixed",size:16}},{name:"clientProtocol",type:["null","string"],default:null},{name:"serverHash",type:"MD5"},{name:"meta",type:["null",MAP_BYTES_TYPE$1],default:null}]},OPTS$1);var HANDSHAKE_RESPONSE_TYPE=Type$1.forSchema({name:"HandshakeResponse",type:"record",fields:[{name:"match",type:{name:"HandshakeMatch",type:"enum",symbols:["BOTH","CLIENT","NONE"]}},{name:"serverProtocol",type:["null","string"],default:null},{name:"serverHash",type:["null","MD5"],default:null},{name:"meta",type:["null",MAP_BYTES_TYPE$1],default:null}]},OPTS$1);var PREFIX_LENGTH=16;var PING_MESSAGE=new Message("",Type$1.forSchema({name:"PingRequest",type:"record",fields:[]},OPTS$1),Type$1.forSchema(["string"],OPTS$1),Type$1.forSchema("null",OPTS$1));function Message(name,reqType,errType,resType,oneWay,doc){this.name=name;if(!Type$1.isType(reqType,"record")){throw new Error("invalid request type")}this.requestType=reqType;if(!Type$1.isType(errType,"union")||!Type$1.isType(errType.getTypes()[0],"string")){throw new Error("invalid error type")}this.errorType=errType;if(oneWay){if(!Type$1.isType(resType,"null")||errType.getTypes().length>1){throw new Error("inapplicable one-way parameter")}}this.responseType=resType;this.oneWay=!!oneWay;this.doc=doc!==undefined?""+doc:undefined;Object.freeze(this)}Message.forSchema=function(name,schema,opts){opts=opts||{};if(!types.isValidName(name)){throw new Error(f$2("invalid message name: %s",name))}if(!Array.isArray(schema.request)){throw new Error(f$2("invalid message request: %s",name))}var recordName=f$2("%s.%sRequest",OPTS$1.namespace,utils.capitalize(name));var reqType=Type$1.forSchema({name:recordName,type:"record",namespace:opts.namespace||"",fields:schema.request},opts);delete opts.registry[recordName];if(!schema.response){throw new Error(f$2("invalid message response: %s",name))}var resType=Type$1.forSchema(schema.response,opts);if(schema.errors!==undefined&&!Array.isArray(schema.errors)){throw new Error(f$2("invalid message errors: %s",name))}var errType=Type$1.forSchema(["string"].concat(schema.errors||[]),opts);var oneWay=!!schema["one-way"];return new Message(name,reqType,errType,resType,oneWay,schema.doc)};Message.prototype.schema=Type$1.prototype.getSchema;Message.prototype._attrs=function(opts){var reqSchema=this.requestType._attrs(opts);var schema={request:reqSchema.fields,response:this.responseType._attrs(opts)};var msgDoc=this.doc;if(msgDoc!==undefined){schema.doc=msgDoc}var errSchema=this.errorType._attrs(opts);if(errSchema.length>1){schema.errors=errSchema.slice(1)}if(this.oneWay){schema["one-way"]=true}return schema};utils.addDeprecatedGetters(Message,["name","errorType","requestType","responseType"]);Message.prototype.isOneWay=util.deprecate((function(){return this.oneWay}),"use `.oneWay` directly instead of `.isOneWay()`");function Service(name,messages,types,ptcl,server){if(typeof name!="string"){return Service.forProtocol(name,messages)}this.name=name;this._messagesByName=messages||{};this.messages=Object.freeze(utils.objectValues(this._messagesByName));this._typesByName=types||{};this.types=Object.freeze(utils.objectValues(this._typesByName));this.protocol=ptcl;this._hashStr=utils.getHash(JSON.stringify(ptcl)).toString("binary");this.doc=ptcl.doc?""+ptcl.doc:undefined;this._server=server||this.createServer({silent:true});Object.freeze(this)}Service.Client=Client;Service.Server=Server;Service.compatible=function(clientSvc,serverSvc){try{createReaders(clientSvc,serverSvc)}catch(err){return false}return true};Service.forProtocol=function(ptcl,opts){opts=opts||{};var name=ptcl.protocol;if(!name){throw new Error("missing protocol name")}if(ptcl.namespace!==undefined){opts.namespace=ptcl.namespace}else{var match=/^(.*)\.[^.]+$/.exec(name);if(match){opts.namespace=match[1]}}name=types.qualify(name,opts.namespace);if(ptcl.types){ptcl.types.forEach((function(obj){Type$1.forSchema(obj,opts)}))}var msgs;if(ptcl.messages){msgs={};Object.keys(ptcl.messages).forEach((function(key){msgs[key]=Message.forSchema(key,ptcl.messages[key],opts)}))}return new Service(name,msgs,opts.registry,ptcl)};Service.isService=function(any){return!!any&&any.hasOwnProperty("_hashStr")};Service.prototype.createClient=function(opts){var client=new Client(this,opts);nextTick((function(){if(opts&&opts.server){var obj={objectMode:true};var pts=[new Stream.PassThrough(obj),new Stream.PassThrough(obj)];opts.server.createChannel({readable:pts[0],writable:pts[1]},obj);client.createChannel({readable:pts[1],writable:pts[0]},obj)}else if(opts&&opts.transport){client.createChannel(opts.transport)}}));return client};Service.prototype.createServer=function(opts){return new Server(this,opts)};Object.defineProperty(Service.prototype,"hash",{enumerable:true,get:function(){return utils.bufferFrom(this._hashStr,"binary")}});Service.prototype.message=function(name){return this._messagesByName[name]};Service.prototype.type=function(name){return this._typesByName[name]};Service.prototype.inspect=function(){return f$2("<Service %j>",this.name)};utils.addDeprecatedGetters(Service,["message","messages","name","type","types"]);Service.prototype.createEmitter=util.deprecate((function(transport,opts){opts=opts||{};var client=this.createClient({cache:opts.cache,buffering:false,strictTypes:opts.strictErrors,timeout:opts.timeout});var channel=client.createChannel(transport,opts);forwardErrors(client,channel);return channel}),"use `.createClient()` instead of `.createEmitter()`");Service.prototype.createListener=util.deprecate((function(transport,opts){if(opts&&opts.strictErrors){throw new Error("use `.createServer()` to support strict errors")}return this._server.createChannel(transport,opts)}),"use `.createServer().createChannel()` instead of `.createListener()`");Service.prototype.emit=util.deprecate((function(name,req,channel,cb){if(!channel||!this.equals(channel.client._svc$)){throw new Error("invalid emitter")}var client=channel.client;Client.prototype.emitMessage.call(client,name,req,cb&&cb.bind(this));return channel.getPending()}),"create a client via `.createClient()` to emit messages instead of `.emit()`");Service.prototype.equals=util.deprecate((function(any){return Service.isService(any)&&this.getFingerprint().equals(any.getFingerprint())}),"equality testing is deprecated, compare the `.protocol`s instead");Service.prototype.getFingerprint=util.deprecate((function(algorithm){return utils.getHash(JSON.stringify(this.protocol),algorithm)}),"use `.hash` instead of `.getFingerprint()`");Service.prototype.getSchema=util.deprecate(Type$1.prototype.getSchema,"use `.protocol` instead of `.getSchema()`");Service.prototype.on=util.deprecate((function(name,handler){var self=this;this._server.onMessage(name,(function(req,cb){return handler.call(self,req,this.channel,cb)}));return this}),"use `.createServer().onMessage()` instead of `.on()`");Service.prototype.subprotocol=util.deprecate((function(){var parent=this._server;var opts={strictTypes:parent._strict,cache:parent._cache};var server=new Server(parent.service,opts);server._handlers=Object.create(parent._handlers);return new Service(this.name,this._messagesByName,this._typesByName,this.protocol,server)}),"`.subprotocol()` will be removed in 5.1");Service.prototype._attrs=function(opts){var ptcl={protocol:this.name};var types=[];this.types.forEach((function(t){if(t.getName()===undefined){return}var typeSchema=t._attrs(opts);if(typeof typeSchema!="string"){types.push(typeSchema)}}));if(types.length){ptcl.types=types}var msgNames=Object.keys(this._messagesByName);if(msgNames.length){ptcl.messages={};msgNames.forEach((function(name){ptcl.messages[name]=this._messagesByName[name]._attrs(opts)}),this)}if(opts&&opts.exportAttrs&&this.doc!==undefined){ptcl.doc=this.doc}return ptcl};function discoverProtocol(transport,opts,cb){if(cb===undefined&&typeof opts=="function"){cb=opts;opts=undefined}var svc=new Service({protocol:"Empty"},OPTS$1);var ptclStr;svc.createClient({timeout:opts&&opts.timeout}).createChannel(transport,{scope:opts&&opts.scope,endWritable:typeof transport=="function"}).once("handshake",(function(hreq,hres){ptclStr=hres.serverProtocol;this.destroy(true)})).once("eot",(function(pending,err){if(err&&!/interrupted/.test(err)){cb(err)}else{cb(null,JSON.parse(ptclStr))}}))}function Client(svc,opts){opts=opts||{};EventEmitter.EventEmitter.call(this);this._svc$=svc;this._channels$=[];this._fns$=[];this._buffering$=!!opts.buffering;this._cache$=opts.cache||{};this._policy$=opts.channelPolicy;this._strict$=!!opts.strictTypes;this._timeout$=utils.getOption(opts,"timeout",1e4);if(opts.remoteProtocols){insertRemoteProtocols(this._cache$,opts.remoteProtocols,svc,true)}this._svc$.messages.forEach((function(msg){this[msg.name]=this._createMessageHandler$(msg)}),this)}util.inherits(Client,EventEmitter.EventEmitter);Client.prototype.activeChannels=function(){return this._channels$.slice()};Client.prototype.createChannel=function(transport,opts){var objectMode=opts&&opts.objectMode;var channel;if(typeof transport=="function"){var writableFactory;if(objectMode){writableFactory=transport}else{writableFactory=function(cb){var encoder=new FrameEncoder;var writable=transport((function(err,readable){if(err){cb(err);return}var decoder=(new FrameDecoder).once("error",(function(err){channel.destroy(err)}));cb(null,readable.pipe(decoder))}));if(writable){encoder.pipe(writable);return encoder}}}channel=new StatelessClientChannel(this,writableFactory,opts)}else{var readable,writable;if(isStream(transport)){readable=writable=transport}else{readable=transport.readable;writable=transport.writable}if(!objectMode){var decoder=new NettyDecoder;readable=readable.pipe(decoder);var encoder=new NettyEncoder;encoder.pipe(writable);writable=encoder}channel=new StatefulClientChannel(this,readable,writable,opts);if(!objectMode){channel.once("eot",(function(){readable.unpipe(decoder);encoder.unpipe(writable)}));decoder.once("error",(function(err){channel.destroy(err)}))}}var channels=this._channels$;channels.push(channel);channel.once("_drain",(function(){channels.splice(channels.indexOf(this),1)}));this._buffering$=false;this.emit("channel",channel);return channel};Client.prototype.destroyChannels=function(opts){this._channels$.forEach((function(channel){channel.destroy(opts&&opts.noWait)}))};Client.prototype.emitMessage=function(name,req,opts,cb){var msg=getExistingMessage(this._svc$,name);var wreq=new WrappedRequest(msg,{},req);this._emitMessage$(wreq,opts,cb)};Client.prototype.remoteProtocols=function(){return getRemoteProtocols(this._cache$,true)};Object.defineProperty(Client.prototype,"service",{enumerable:true,get:function(){return this._svc$}});Client.prototype.use=function(){var i,l,fn;for(i=0,l=arguments.length;i<l;i++){fn=arguments[i];this._fns$.push(fn.length<3?fn(this):fn)}return this};Client.prototype._emitMessage$=function(wreq,opts,cb){if(!cb&&typeof opts==="function"){cb=opts;opts=undefined}var self=this;var channels=this._channels$;var numChannels=channels.length;if(!numChannels){if(this._buffering$){debug$2("no active client channels, buffering call");this.once("channel",(function(){this._emitMessage$(wreq,opts,cb)}))}else{var err=new Error("no active channels");nextTick((function(){if(cb){cb.call(new CallContext(wreq._msg),err)}else{self.emit("error",err)}}))}return}opts=opts||{};if(opts.timeout===undefined){opts.timeout=this._timeout$}var channel;if(numChannels===1){channel=channels[0]}else if(this._policy$){channel=this._policy$(this._channels$.slice());if(!channel){debug$2("policy returned no channel, skipping call");return}}else{channel=channels[Math.floor(Math.random()*numChannels)]}channel._emit(wreq,opts,(function(err,wres){var ctx=this;var errType=ctx.message.errorType;if(err){if(self._strict$){err=errType.clone(err.message,{wrapUnions:true})}done(err);return}if(!wres){done();return}err=wres.error;if(!self._strict$){if(err===undefined){err=null}else{if(Type$1.isType(errType,"union:unwrapped")){if(typeof err=="string"){err=new Error(err)}}else if(err&&err.string&&typeof err.string=="string"){err=new Error(err.string)}}}done(err,wres.response);function done(err,res){if(cb){cb.call(ctx,err,res)}else if(err){self.emit("error",err)}}}))};Client.prototype._createMessageHandler$=function(msg){var fields=msg.requestType.getFields();var names=fields.map((function(f){return f.getName()}));var body="return function "+msg.name+"(";if(names.length){body+=names.join(", ")+", "}body+="opts, cb) {\n";body+="  var req = {";body+=names.map((function(n){return n+": "+n})).join(", ");body+="};\n";body+="  return this.emitMessage('"+msg.name+"', req, opts, cb);\n";body+="};";return new Function(body)()};function Server(svc,opts){opts=opts||{};EventEmitter.EventEmitter.call(this);this.service=svc;this._handlers={};this._fns=[];this._channels={};this._nextChannelId=1;this._cache=opts.cache||{};this._defaultHandler=opts.defaultHandler;this._sysErrFormatter=opts.systemErrorFormatter;this._silent=!!opts.silent;this._strict=!!opts.strictTypes;if(opts.remoteProtocols){insertRemoteProtocols(this._cache,opts.remoteProtocols,svc,false)}svc.messages.forEach((function(msg){var name=msg.name;if(!opts.noCapitalize){name=utils.capitalize(name)}this["on"+name]=this._createMessageHandler(msg)}),this)}util.inherits(Server,EventEmitter.EventEmitter);Server.prototype.activeChannels=function(){return utils.objectValues(this._channels)};Server.prototype.createChannel=function(transport,opts){var objectMode=opts&&opts.objectMode;var channel;if(typeof transport=="function"){var readableFactory;if(objectMode){readableFactory=transport}else{readableFactory=function(cb){var decoder=(new FrameDecoder).once("error",(function(err){channel.destroy(err)}));return transport((function(err,writable){if(err){cb(err);return}var encoder=new FrameEncoder;encoder.pipe(writable);cb(null,encoder)})).pipe(decoder)}}channel=new StatelessServerChannel(this,readableFactory,opts)}else{var readable,writable;if(isStream(transport)){readable=writable=transport}else{readable=transport.readable;writable=transport.writable}if(!objectMode){var decoder=new NettyDecoder;readable=readable.pipe(decoder);var encoder=new NettyEncoder;encoder.pipe(writable);writable=encoder}channel=new StatefulServerChannel(this,readable,writable,opts);if(!objectMode){channel.once("eot",(function(){readable.unpipe(decoder);encoder.unpipe(writable)}));decoder.once("error",(function(err){channel.destroy(err)}))}}if(!this.listeners("error").length){this.on("error",this._onError)}var channelId=this._nextChannelId++;var channels=this._channels;channels[channelId]=channel.once("eot",(function(){delete channels[channelId]}));this.emit("channel",channel);return channel};Server.prototype.onMessage=function(name,handler){getExistingMessage(this.service,name);this._handlers[name]=handler;return this};Server.prototype.remoteProtocols=function(){return getRemoteProtocols(this._cache,false)};Server.prototype.use=function(){var i,l,fn;for(i=0,l=arguments.length;i<l;i++){fn=arguments[i];this._fns.push(fn.length<3?fn(this):fn)}return this};Server.prototype._createMessageHandler=function(msg){var name=msg.name;var fields=msg.requestType.fields;var numArgs=fields.length;var args=fields.length?", "+fields.map((function(f){return"req."+f.name})).join(", "):"";var body="return function (handler) {\n";body+="  if (handler.length > "+numArgs+") {\n";body+="    return this.onMessage('"+name+"', function (req, cb) {\n";body+="      return handler.call(this"+args+", cb);\n";body+="    });\n";body+="  } else {\n";body+="    return this.onMessage('"+name+"', function (req) {\n";body+="      return handler.call(this"+args+");\n";body+="    });\n";body+="  }\n";body+="};\n";return new Function(body)()};Server.prototype._onError=function(err){if(!this._silent&&err.rpcCode!=="UNKNOWN_PROTOCOL"){console.error();if(err.rpcCode){console.error(err.rpcCode);console.error(err.cause)}else{console.error("INTERNAL_SERVER_ERROR");console.error(err)}}};function ClientChannel(client,opts){opts=opts||{};EventEmitter.EventEmitter.call(this);this.client=client;this.timeout=utils.getOption(opts,"timeout",client._timeout$);this._endWritable=!!utils.getOption(opts,"endWritable",true);this._prefix=normalizedPrefix(opts.scope);var cache=client._cache$;var clientSvc=client._svc$;var hash=opts.serverHash;if(!hash){hash=clientSvc.hash}var adapter=cache[hash];if(!adapter){hash=clientSvc.hash;adapter=cache[hash]=new Adapter(clientSvc,clientSvc,hash)}this._adapter=adapter;this._registry=new Registry(this,PREFIX_LENGTH);this.pending=0;this.destroyed=false;this.draining=false;this.once("_eot",(function(pending,err){debug$2("client channel EOT");this.destroyed=true;this.emit("eot",pending,err)}))}util.inherits(ClientChannel,EventEmitter.EventEmitter);ClientChannel.prototype.destroy=function(noWait){debug$2("destroying client channel");if(!this.draining){this.draining=true;this.emit("_drain")}var registry=this._registry;var pending=this.pending;if(noWait){registry.clear()}if(noWait||!pending){if(isError$1(noWait)){debug$2("fatal client channel error: %s",noWait);this.emit("_eot",pending,noWait)}else{this.emit("_eot",pending)}}else{debug$2("client channel entering drain mode (%s pending)",pending)}};ClientChannel.prototype.ping=function(timeout,cb){if(!cb&&typeof timeout=="function"){cb=timeout;timeout=undefined}var self=this;var wreq=new WrappedRequest(PING_MESSAGE);this._emit(wreq,{timeout:timeout},(function(err){if(cb){cb.call(self,err)}else if(err){self.destroy(err)}}))};ClientChannel.prototype._createHandshakeRequest=function(adapter,noSvc){var svc=this.client._svc$;return{clientHash:svc.hash,clientProtocol:noSvc?null:JSON.stringify(svc.protocol),serverHash:adapter._hash}};ClientChannel.prototype._emit=function(wreq,opts,cb){var msg=wreq._msg;var wres=msg.oneWay?undefined:new WrappedResponse(msg,{});var ctx=new CallContext(msg,this);var self=this;this.pending++;nextTick((function(){if(!msg.name){onTransition(wreq,wres,onCompletion)}else{self.emit("outgoingCall",ctx,opts);var fns=self.client._fns$;debug$2("starting client middleware chain (%s middleware)",fns.length);chainMiddleware({fns:fns,ctx:ctx,wreq:wreq,wres:wres,onTransition:onTransition,onCompletion:onCompletion,onError:onError})}}));function onTransition(wreq,wres,prev){var err,reqBuf;if(self.destroyed){err=new Error("channel destroyed")}else{try{reqBuf=wreq.toBuffer()}catch(cause){err=serializationError(f$2("invalid %j request",msg.name),wreq,[{name:"headers",type:MAP_BYTES_TYPE$1},{name:"request",type:msg.requestType}])}}if(err){prev(err);return}var timeout=opts&&opts.timeout!==undefined?opts.timeout:self.timeout;var id=self._registry.add(timeout,(function(err,resBuf,adapter){if(!err&&!msg.oneWay){try{adapter._decodeResponse(resBuf,wres,msg)}catch(cause){err=cause}}prev(err)}));id|=self._prefix;debug$2("sending message %s",id);self._send(id,reqBuf,!!msg&&msg.oneWay)}function onCompletion(err){self.pending--;cb.call(ctx,err,wres);if(self.draining&&!self.destroyed&&!self.pending){self.destroy()}}function onError(err){self.client.emit("error",err,self)}};ClientChannel.prototype._getAdapter=function(hres){var hash=hres.serverHash;var cache=this.client._cache$;var adapter=cache[hash];if(adapter){return adapter}var ptcl=JSON.parse(hres.serverProtocol);var serverSvc=Service.forProtocol(ptcl);adapter=new Adapter(this.client._svc$,serverSvc,hash,true);return cache[hash]=adapter};ClientChannel.prototype._matchesPrefix=function(id){return matchesPrefix(id,this._prefix)};ClientChannel.prototype._send=utils.abstractFunction;utils.addDeprecatedGetters(ClientChannel,["pending","timeout"]);ClientChannel.prototype.getCache=util.deprecate((function(){return this.client._cache$}),"use `.remoteProtocols()` instead of `.getCache()`");ClientChannel.prototype.getProtocol=util.deprecate((function(){return this.client._svc$}),"use `.service` instead or `.getProtocol()`");ClientChannel.prototype.isDestroyed=util.deprecate((function(){return this.destroyed}),"use `.destroyed` instead of `.isDestroyed`");function StatelessClientChannel(client,writableFactory,opts){ClientChannel.call(this,client,opts);this._writableFactory=writableFactory;if(!opts||!opts.noPing){debug$2("emitting ping request");this.ping()}}util.inherits(StatelessClientChannel,ClientChannel);StatelessClientChannel.prototype._send=function(id,reqBuf){var cb=this._registry.get(id);var adapter=this._adapter;var self=this;nextTick(emit);return true;function emit(retry){if(self.destroyed){return}var hreq=self._createHandshakeRequest(adapter,!retry);var writable=self._writableFactory.call(self,(function(err,readable){if(err){cb(err);return}readable.on("data",(function(obj){debug$2("received response %s",obj.id);var buf=Buffer.concat(obj.payload);try{var parts=readHead(HANDSHAKE_RESPONSE_TYPE,buf);var hres=parts.head;if(hres.serverHash){adapter=self._getAdapter(hres)}}catch(cause){cb(cause);return}var match=hres.match;debug$2("handshake match: %s",match);self.emit("handshake",hreq,hres);if(match==="NONE"){nextTick((function(){emit(true)}))}else{self._adapter=adapter;cb(null,parts.tail,adapter)}}))}));if(!writable){cb(new Error("invalid writable stream"));return}writable.write({id:id,payload:[HANDSHAKE_REQUEST_TYPE.toBuffer(hreq),reqBuf]});if(self._endWritable){writable.end()}}};function StatefulClientChannel(client,readable,writable,opts){ClientChannel.call(this,client,opts);this._readable=readable;this._writable=writable;this._connected=!!(opts&&opts.noPing);this._readable.on("end",onEnd);this._writable.on("finish",onFinish);var self=this;var timer=null;this.once("eot",(function(){if(timer){clearTimeout(timer);timer=null}if(!self._connected){self.emit("_ready")}this._writable.removeListener("finish",onFinish);if(this._endWritable){debug$2("ending transport");this._writable.end()}this._readable.removeListener("data",onPing).removeListener("data",onMessage).removeListener("end",onEnd)}));var hreq;if(this._connected){this._readable.on("data",onMessage)}else{this._readable.on("data",onPing);nextTick(ping);if(self.timeout){timer=setTimeout((function(){self.destroy(new Error("timeout"))}),self.timeout)}}function ping(retry){if(self.destroyed){return}hreq=self._createHandshakeRequest(self._adapter,!retry);var payload=[HANDSHAKE_REQUEST_TYPE.toBuffer(hreq),utils.bufferFrom([0,0])];self._writable.write({id:self._prefix,payload:payload})}function onPing(obj){if(!self._matchesPrefix(obj.id)){debug$2("discarding unscoped response %s (still connecting)",obj.id);return}var buf=Buffer.concat(obj.payload);try{var hres=readHead(HANDSHAKE_RESPONSE_TYPE,buf).head;if(hres.serverHash){self._adapter=self._getAdapter(hres)}}catch(cause){self.destroy(cause);return}var match=hres.match;debug$2("handshake match: %s",match);self.emit("handshake",hreq,hres);if(match==="NONE"){nextTick((function(){ping(true)}))}else{debug$2("successfully connected");if(timer){clearTimeout(timer);timer=null}self._readable.removeListener("data",onPing).on("data",onMessage);self._connected=true;self.emit("_ready");hreq=null}}function onMessage(obj){var id=obj.id;if(!self._matchesPrefix(id)){debug$2("discarding unscoped message %s",id);return}var cb=self._registry.get(id);if(cb){nextTick((function(){debug$2("received message %s",id);cb(null,Buffer.concat(obj.payload),self._adapter)}))}}function onEnd(){self.destroy(true)}function onFinish(){self.destroy()}}util.inherits(StatefulClientChannel,ClientChannel);StatefulClientChannel.prototype._emit=function(){if(this._connected||this.draining){ClientChannel.prototype._emit.apply(this,arguments)}else{debug$2("queuing request");var args=[];var i,l;for(i=0,l=arguments.length;i<l;i++){args.push(arguments[i])}this.once("_ready",(function(){this._emit.apply(this,args)}))}};StatefulClientChannel.prototype._send=function(id,reqBuf,oneWay){if(oneWay){var self=this;nextTick((function(){self._registry.get(id)(null,utils.bufferFrom([0,0,0]),self._adapter)}))}return this._writable.write({id:id,payload:[reqBuf]})};function ServerChannel(server,opts){opts=opts||{};EventEmitter.EventEmitter.call(this);this.server=server;this._endWritable=!!utils.getOption(opts,"endWritable",true);this._prefix=normalizedPrefix(opts.scope);var cache=server._cache;var svc=server.service;var hash=svc.hash;if(!cache[hash]){cache[hash]=new Adapter(svc,svc,hash)}this._adapter=null;this.destroyed=false;this.draining=false;this.pending=0;this.once("_eot",(function(pending,err){debug$2("server channel EOT");this.emit("eot",pending,err)}))}util.inherits(ServerChannel,EventEmitter.EventEmitter);ServerChannel.prototype.destroy=function(noWait){if(!this.draining){this.draining=true;this.emit("_drain")}if(noWait||!this.pending){this.destroyed=true;if(isError$1(noWait)){debug$2("fatal server channel error: %s",noWait);this.emit("_eot",this.pending,noWait)}else{this.emit("_eot",this.pending)}}};ServerChannel.prototype._createHandshakeResponse=function(err,hreq){var svc=this.server.service;var buf=svc.hash;var serverMatch=hreq&&hreq.serverHash.equals(buf);return{match:err?"NONE":serverMatch?"BOTH":"CLIENT",serverProtocol:serverMatch?null:JSON.stringify(svc.protocol),serverHash:serverMatch?null:buf}};ServerChannel.prototype._getAdapter=function(hreq){var hash=hreq.clientHash;var adapter=this.server._cache[hash];if(adapter){return adapter}if(!hreq.clientProtocol){throw toRpcError("UNKNOWN_PROTOCOL")}var ptcl=JSON.parse(hreq.clientProtocol);var clientSvc=Service.forProtocol(ptcl);adapter=new Adapter(clientSvc,this.server.service,hash,true);return this.server._cache[hash]=adapter};ServerChannel.prototype._matchesPrefix=function(id){return matchesPrefix(id,this._prefix)};ServerChannel.prototype._receive=function(reqBuf,adapter,cb){var self=this;var wreq;try{wreq=adapter._decodeRequest(reqBuf)}catch(cause){cb(self._encodeSystemError(toRpcError("INVALID_REQUEST",cause)));return}var msg=wreq._msg;var wres=new WrappedResponse(msg,{});if(!msg.name){wres.response=null;cb(wres.toBuffer(),false);return}var ctx=new CallContext(msg,this);self.emit("incomingCall",ctx);var fns=this.server._fns;debug$2("starting server middleware chain (%s middleware)",fns.length);self.pending++;chainMiddleware({fns:fns,ctx:ctx,wreq:wreq,wres:wres,onTransition:onTransition,onCompletion:onCompletion,onError:onError});function onTransition(wreq,wres,prev){var handler=self.server._handlers[msg.name];if(!handler){var defaultHandler=self.server._defaultHandler;if(defaultHandler){defaultHandler.call(ctx,wreq,wres,prev)}else{var cause=new Error(f$2("no handler for %s",msg.name));prev(toRpcError("NOT_IMPLEMENTED",cause))}}else{var pending=!msg.oneWay;try{if(pending){handler.call(ctx,wreq.request,(function(err,res){pending=false;wres.error=err;wres.response=res;prev()}))}else{handler.call(ctx,wreq.request);prev()}}catch(err){if(pending){pending=false;prev(err)}else{onError(err)}}}}function onCompletion(err){self.pending--;var server=self.server;var resBuf;if(!err){var resErr=wres.error;var isStrict=server._strict;if(!isStrict){if(isError$1(resErr)){wres.error=msg.errorType.clone(resErr.message,{wrapUnions:true})}else if(resErr===null){resErr=wres.error=undefined}if(resErr===undefined&&wres.response===undefined&&msg.responseType.isValid(null)){wres.response=null}}try{resBuf=wres.toBuffer()}catch(cause){if(wres.error!==undefined){err=serializationError(f$2("invalid %j error",msg.name),wres,[{name:"headers",type:MAP_BYTES_TYPE$1},{name:"error",type:msg.errorType}])}else{err=serializationError(f$2("invalid %j response",msg.name),wres,[{name:"headers",type:MAP_BYTES_TYPE$1},{name:"response",type:msg.responseType}])}}}if(!resBuf){resBuf=self._encodeSystemError(err,wres.headers)}else if(resErr!==undefined){server.emit("error",toRpcError("APPLICATION_ERROR",resErr))}cb(resBuf,msg.oneWay);if(self.draining&&!self.pending){self.destroy()}}function onError(err){self.server.emit("error",err,self)}};utils.addDeprecatedGetters(ServerChannel,["pending"]);ServerChannel.prototype.getCache=util.deprecate((function(){return this.server._cache}),"use `.remoteProtocols()` instead of `.getCache()`");ServerChannel.prototype.getProtocol=util.deprecate((function(){return this.server.service}),"use `.service` instead of `.getProtocol()`");ServerChannel.prototype.isDestroyed=util.deprecate((function(){return this.destroyed}),"use `.destroyed` instead of `.isDestroyed`");ServerChannel.prototype._encodeSystemError=function(err,header){var server=this.server;server.emit("error",err,this);var errStr;if(server._sysErrFormatter){errStr=server._sysErrFormatter.call(this,err)}else if(err.rpcCode){errStr=err.message}var hdrBuf;if(header){try{hdrBuf=MAP_BYTES_TYPE$1.toBuffer(header)}catch(cause){server.emit("error",cause,this)}}return Buffer.concat([hdrBuf||utils.bufferFrom([0]),utils.bufferFrom([1,0]),STRING_TYPE.toBuffer(errStr||"internal server error")])};function StatelessServerChannel(server,readableFactory,opts){ServerChannel.call(this,server,opts);this._writable=undefined;var self=this;var readable;nextTick((function(){readable=readableFactory.call(self,(function(err,writable){nextTick((function(){if(err){onFinish(err);return}self._writable=writable.on("finish",onFinish);self.emit("_writable")}))})).on("data",onRequest).on("end",onEnd)}));function onRequest(obj){var id=obj.id;var buf=Buffer.concat(obj.payload);var err;try{var parts=readHead(HANDSHAKE_REQUEST_TYPE,buf);var hreq=parts.head;var adapter=self._getAdapter(hreq)}catch(cause){err=toRpcError("INVALID_HANDSHAKE_REQUEST",cause)}var hres=self._createHandshakeResponse(err,hreq);self.emit("handshake",hreq,hres);if(err){done(self._encodeSystemError(err))}else{self._receive(parts.tail,adapter,done)}function done(resBuf){if(!self.destroyed){if(!self._writable){self.once("_writable",(function(){done(resBuf)}));return}self._writable.write({id:id,payload:[HANDSHAKE_RESPONSE_TYPE.toBuffer(hres),resBuf]})}if(self._writable&&self._endWritable){self._writable.end()}}}function onEnd(){self.destroy()}function onFinish(err){readable.removeListener("data",onRequest).removeListener("end",onEnd);self.destroy(err||true)}}util.inherits(StatelessServerChannel,ServerChannel);function StatefulServerChannel(server,readable,writable,opts){ServerChannel.call(this,server,opts);this._adapter=undefined;this._writable=writable.on("finish",onFinish);this._readable=readable.on("data",onHandshake).on("end",onEnd);this.once("_drain",(function(){this._readable.removeListener("data",onHandshake).removeListener("data",onRequest).removeListener("end",onEnd)})).once("eot",(function(){this._writable.removeListener("finish",onFinish);if(this._endWritable){this._writable.end()}}));var self=this;function onHandshake(obj){var id=obj.id;if(!self._matchesPrefix(id)){return}var buf=Buffer.concat(obj.payload);var err;try{var parts=readHead(HANDSHAKE_REQUEST_TYPE,buf);var hreq=parts.head;self._adapter=self._getAdapter(hreq)}catch(cause){err=toRpcError("INVALID_HANDSHAKE_REQUEST",cause)}var hres=self._createHandshakeResponse(err,hreq);self.emit("handshake",hreq,hres);if(err){done(self._encodeSystemError(err))}else{self._readable.removeListener("data",onHandshake).on("data",onRequest);self._receive(parts.tail,self._adapter,done)}function done(resBuf){if(self.destroyed){return}self._writable.write({id:id,payload:[HANDSHAKE_RESPONSE_TYPE.toBuffer(hres),resBuf]})}}function onRequest(obj){var id=obj.id;if(!self._matchesPrefix(id)){return}var reqBuf=Buffer.concat(obj.payload);self._receive(reqBuf,self._adapter,(function(resBuf,oneWay){if(self.destroyed||oneWay){return}self._writable.write({id:id,payload:[resBuf]})}))}function onEnd(){self.destroy()}function onFinish(){self.destroy(true)}}util.inherits(StatefulServerChannel,ServerChannel);function WrappedRequest(msg,hdrs,req){this._msg=msg;this.headers=hdrs||{};this.request=req||{}}WrappedRequest.prototype.toBuffer=function(){var msg=this._msg;return Buffer.concat([MAP_BYTES_TYPE$1.toBuffer(this.headers),STRING_TYPE.toBuffer(msg.name),msg.requestType.toBuffer(this.request)])};function WrappedResponse(msg,hdr,err,res){this._msg=msg;this.headers=hdr;this.error=err;this.response=res}WrappedResponse.prototype.toBuffer=function(){var hdr=MAP_BYTES_TYPE$1.toBuffer(this.headers);var hasError=this.error!==undefined;return Buffer.concat([hdr,BOOLEAN_TYPE.toBuffer(hasError),hasError?this._msg.errorType.toBuffer(this.error):this._msg.responseType.toBuffer(this.response)])};function CallContext(msg,channel){this.channel=channel;this.locals={};this.message=msg;Object.freeze(this)}function Registry(ctx,prefixLength){this._ctx=ctx;this._mask=~0>>>(prefixLength|0);this._id=0;this._n=0;this._cbs={}}Registry.prototype.get=function(id){return this._cbs[id&this._mask]};Registry.prototype.add=function(timeout,fn){this._id=this._id+1&this._mask;var self=this;var id=this._id;var timer;if(timeout>0){timer=setTimeout((function(){cb(new Error("timeout"))}),timeout)}this._cbs[id]=cb;this._n++;return id;function cb(){if(!self._cbs[id]){return}delete self._cbs[id];self._n--;if(timer){clearTimeout(timer)}fn.apply(self._ctx,arguments)}};Registry.prototype.clear=function(){Object.keys(this._cbs).forEach((function(id){this._cbs[id](new Error("interrupted"))}),this)};function Adapter(clientSvc,serverSvc,hash,isRemote){this._clientSvc=clientSvc;this._serverSvc=serverSvc;this._hash=hash;this._isRemote=!!isRemote;this._readers=createReaders(clientSvc,serverSvc)}Adapter.prototype._decodeRequest=function(buf){var tap=new Tap$3(buf);var hdr=MAP_BYTES_TYPE$1._read(tap);var name=STRING_TYPE._read(tap);var msg,req;if(name){msg=this._serverSvc.message(name);req=this._readers[name+"?"]._read(tap)}else{msg=PING_MESSAGE}if(!tap.isValid()){throw new Error(f$2("truncated %s request",name||"ping$"))}return new WrappedRequest(msg,hdr,req)};Adapter.prototype._decodeResponse=function(buf,wres,msg){var tap=new Tap$3(buf);utils.copyOwnProperties(MAP_BYTES_TYPE$1._read(tap),wres.headers,true);var isError=BOOLEAN_TYPE._read(tap);var name=msg.name;if(name){var reader=this._readers[name+(isError?"*":"!")];msg=this._clientSvc.message(name);if(isError){wres.error=reader._read(tap)}else{wres.response=reader._read(tap)}if(!tap.isValid()){throw new Error(f$2("truncated %s response",name))}}else{msg=PING_MESSAGE}};function FrameDecoder(){Stream.Transform.call(this,{readableObjectMode:true});this._id=undefined;this._buf=utils.newBuffer(0);this._bufs=[];this.on("finish",(function(){this.push(null)}))}util.inherits(FrameDecoder,Stream.Transform);FrameDecoder.prototype._transform=function(buf,encoding,cb){buf=Buffer.concat([this._buf,buf]);var frameLength;while(buf.length>=4&&buf.length>=(frameLength=buf.readInt32BE(0))+4){if(frameLength){this._bufs.push(buf.slice(4,frameLength+4))}else{var bufs=this._bufs;this._bufs=[];this.push({id:null,payload:bufs})}buf=buf.slice(frameLength+4)}this._buf=buf;cb()};FrameDecoder.prototype._flush=function(){if(this._buf.length||this._bufs.length){var bufs=this._bufs.slice();bufs.unshift(this._buf);var err=toRpcError("TRAILING_DATA");err.trailingData=Buffer.concat(bufs).toString();this.emit("error",err)}};function FrameEncoder(){Stream.Transform.call(this,{writableObjectMode:true});this.on("finish",(function(){this.push(null)}))}util.inherits(FrameEncoder,Stream.Transform);FrameEncoder.prototype._transform=function(obj,encoding,cb){var bufs=obj.payload;var i,l,buf;for(i=0,l=bufs.length;i<l;i++){buf=bufs[i];this.push(intBuffer(buf.length));this.push(buf)}this.push(intBuffer(0));cb()};function NettyDecoder(){Stream.Transform.call(this,{readableObjectMode:true});this._id=undefined;this._frameCount=0;this._buf=utils.newBuffer(0);this._bufs=[];this.on("finish",(function(){this.push(null)}))}util.inherits(NettyDecoder,Stream.Transform);NettyDecoder.prototype._transform=function(buf,encoding,cb){buf=Buffer.concat([this._buf,buf]);while(true){if(this._id===undefined){if(buf.length<8){this._buf=buf;cb();return}this._id=buf.readInt32BE(0);this._frameCount=buf.readInt32BE(4);buf=buf.slice(8)}var frameLength;while(this._frameCount&&buf.length>=4&&buf.length>=(frameLength=buf.readInt32BE(0))+4){this._frameCount--;this._bufs.push(buf.slice(4,frameLength+4));buf=buf.slice(frameLength+4)}if(this._frameCount){this._buf=buf;cb();return}else{var obj={id:this._id,payload:this._bufs};this._bufs=[];this._id=undefined;this.push(obj)}}};NettyDecoder.prototype._flush=FrameDecoder.prototype._flush;function NettyEncoder(){Stream.Transform.call(this,{writableObjectMode:true});this.on("finish",(function(){this.push(null)}))}util.inherits(NettyEncoder,Stream.Transform);NettyEncoder.prototype._transform=function(obj,encoding,cb){var bufs=obj.payload;var l=bufs.length;var buf;buf=utils.newBuffer(8);buf.writeInt32BE(obj.id,0);buf.writeInt32BE(l,4);this.push(buf);var i;for(i=0;i<l;i++){buf=bufs[i];this.push(intBuffer(buf.length));this.push(buf)}cb()};function intBuffer(n){var buf=utils.newBuffer(4);buf.writeInt32BE(n);return buf}function readHead(type,buf){var tap=new Tap$3(buf);var head=type._read(tap);if(!tap.isValid()){throw new Error(f$2("truncated %j",type.schema()))}return{head:head,tail:tap.buf.slice(tap.pos)}}function createReader$1(rtype,wtype){return rtype.equals(wtype)?rtype:rtype.createResolver(wtype)}function createReaders(clientSvc,serverSvc){var obj={};clientSvc.messages.forEach((function(c){var n=c.name;var s=serverSvc.message(n);try{if(!s){throw new Error(f$2("missing server message: %s",n))}if(s.oneWay!==c.oneWay){throw new Error(f$2("inconsistent one-way message: %s",n))}obj[n+"?"]=createReader$1(s.requestType,c.requestType);obj[n+"*"]=createReader$1(c.errorType,s.errorType);obj[n+"!"]=createReader$1(c.responseType,s.responseType)}catch(cause){throw toRpcError("INCOMPATIBLE_PROTOCOL",cause)}}));return obj}function insertRemoteProtocols(cache,ptcls,svc,isClient){Object.keys(ptcls).forEach((function(hash){var ptcl=ptcls[hash];var clientSvc,serverSvc;if(isClient){clientSvc=svc;serverSvc=Service.forProtocol(ptcl)}else{clientSvc=Service.forProtocol(ptcl);serverSvc=svc}cache[hash]=new Adapter(clientSvc,serverSvc,hash,true)}))}function getRemoteProtocols(cache,isClient){var ptcls={};Object.keys(cache).forEach((function(hs){var adapter=cache[hs];if(adapter._isRemote){var svc=isClient?adapter._serverSvc:adapter._clientSvc;ptcls[hs]=svc.protocol}}));return ptcls}function isError$1(any){return!!any&&Object.prototype.toString.call(any)==="[object Error]"}function forwardErrors(src,dst){return src.on("error",(function(err){dst.emit("error",err,src)}))}function toError(msg,cause){var err=new Error(msg);err.cause=cause;return err}function toRpcError(rpcCode,cause){var err=toError(rpcCode.toLowerCase().replace(/_/g," "),cause);err.rpcCode=cause&&cause.rpcCode?cause.rpcCode:rpcCode;return err}function serializationError(msg,obj,fields){var details=[];var i,l,field;for(i=0,l=fields.length;i<l;i++){field=fields[i];field.type.isValid(obj[field.name],{errorHook:errorHook})}var detailsStr=details.map((function(obj){return f$2("%s = %j but expected %s",obj.path,obj.value,obj.type)})).join(", ");var err=new Error(f$2("%s (%s)",msg,detailsStr));err.details=details;return err;function errorHook(parts,any,type){var strs=[];var i,l,part;for(i=0,l=parts.length;i<l;i++){part=parts[i];if(isNaN(part)){strs.push("."+part)}else{strs.push("["+part+"]")}}details.push({path:field.name+strs.join(""),value:any,type:type})}}function normalizedPrefix(scope){return scope?utils.getHash(scope).readInt16BE(0)<<32-PREFIX_LENGTH:0}function matchesPrefix(id,prefix){return(id^prefix)>>32-PREFIX_LENGTH===0}function isStream(any){return!!(any&&any.pipe)}function getExistingMessage(svc,name){var msg=svc.message(name);if(!msg){throw new Error(f$2("unknown message: %s",name))}return msg}function chainMiddleware(params){var args=[params.wreq,params.wres];var cbs=[];var cause;forward(0);function forward(pos){var isDone=false;if(pos<params.fns.length){params.fns[pos].apply(params.ctx,args.concat((function(err,cb){if(isDone){params.onError(toError("duplicate forward middleware call",err));return}isDone=true;if(err||params.wres&&(params.wres.error!==undefined||params.wres.response!==undefined)){cause=err;backward();return}if(cb){cbs.push(cb)}forward(++pos)})))}else{params.onTransition.apply(params.ctx,args.concat((function(err){if(isDone){params.onError(toError("duplicate handler call",err));return}isDone=true;cause=err;nextTick(backward)})))}}function backward(){var cb=cbs.pop();if(cb){var isDone=false;cb.call(params.ctx,cause,(function(err){if(isDone){params.onError(toError("duplicate backward middleware call",err));return}cause=err;isDone=true;backward()}))}else{params.onCompletion.call(params.ctx,cause)}}}var services={Adapter:Adapter,HANDSHAKE_REQUEST_TYPE:HANDSHAKE_REQUEST_TYPE,HANDSHAKE_RESPONSE_TYPE:HANDSHAKE_RESPONSE_TYPE,Message:Message,Registry:Registry,Service:Service,discoverProtocol:discoverProtocol,streams:{FrameDecoder:FrameDecoder,FrameEncoder:FrameEncoder,NettyDecoder:NettyDecoder,NettyEncoder:NettyEncoder}};function normalizeArray(parts,allowAboveRoot){var up=0;for(var i=parts.length-1;i>=0;i--){var last=parts[i];if(last==="."){parts.splice(i,1)}else if(last===".."){parts.splice(i,1);up++}else if(up){parts.splice(i,1);up--}}if(allowAboveRoot){for(;up--;up){parts.unshift("..")}}return parts}var splitPathRe=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/;var splitPath=function(filename){return splitPathRe.exec(filename).slice(1)};function resolve(){var resolvedPath="",resolvedAbsolute=false;for(var i=arguments.length-1;i>=-1&&!resolvedAbsolute;i--){var path=i>=0?arguments[i]:"/";if(typeof path!=="string"){throw new TypeError("Arguments to path.resolve must be strings")}else if(!path){continue}resolvedPath=path+"/"+resolvedPath;resolvedAbsolute=path.charAt(0)==="/"}resolvedPath=normalizeArray(filter(resolvedPath.split("/"),(function(p){return!!p})),!resolvedAbsolute).join("/");return(resolvedAbsolute?"/":"")+resolvedPath||"."}function normalize(path){var isPathAbsolute=isAbsolute(path),trailingSlash=substr(path,-1)==="/";path=normalizeArray(filter(path.split("/"),(function(p){return!!p})),!isPathAbsolute).join("/");if(!path&&!isPathAbsolute){path="."}if(path&&trailingSlash){path+="/"}return(isPathAbsolute?"/":"")+path}function isAbsolute(path){return path.charAt(0)==="/"}function join(){var paths=Array.prototype.slice.call(arguments,0);return normalize(filter(paths,(function(p,index){if(typeof p!=="string"){throw new TypeError("Arguments to path.join must be strings")}return p})).join("/"))}function relative(from,to){from=resolve(from).substr(1);to=resolve(to).substr(1);function trim(arr){var start=0;for(;start<arr.length;start++){if(arr[start]!=="")break}var end=arr.length-1;for(;end>=0;end--){if(arr[end]!=="")break}if(start>end)return[];return arr.slice(start,end-start+1)}var fromParts=trim(from.split("/"));var toParts=trim(to.split("/"));var length=Math.min(fromParts.length,toParts.length);var samePartsLength=length;for(var i=0;i<length;i++){if(fromParts[i]!==toParts[i]){samePartsLength=i;break}}var outputParts=[];for(var i=samePartsLength;i<fromParts.length;i++){outputParts.push("..")}outputParts=outputParts.concat(toParts.slice(samePartsLength));return outputParts.join("/")}var sep="/";var delimiter=":";function dirname(path){var result=splitPath(path),root=result[0],dir=result[1];if(!root&&!dir){return"."}if(dir){dir=dir.substr(0,dir.length-1)}return root+dir}function basename(path,ext){var f=splitPath(path)[2];if(ext&&f.substr(-1*ext.length)===ext){f=f.substr(0,f.length-ext.length)}return f}function extname(path){return splitPath(path)[3]}var path={extname:extname,basename:basename,dirname:dirname,sep:sep,delimiter:delimiter,relative:relative,join:join,isAbsolute:isAbsolute,normalize:normalize,resolve:resolve};function filter(xs,f){if(xs.filter)return xs.filter(f);var res=[];for(var i=0;i<xs.length;i++){if(f(xs[i],i,xs))res.push(xs[i])}return res}var substr="ab".substr(-1)==="b"?function(str,start,len){return str.substr(start,len)}:function(str,start,len){if(start<0)start=str.length+start;return str.substr(start,len)};function createImportHook(){var imports={};return function(fpath,kind,cb){fpath=path.resolve(fpath);if(imports[fpath]){nextTick(cb);return}imports[fpath]=true;fs.readFile(fpath,{encoding:"utf8"},cb)}}function createSyncImportHook(){var imports={};return function(fpath,kind,cb){fpath=path.resolve(fpath);if(imports[fpath]){cb()}else{imports[fpath]=true;cb(null,fs.readFileSync(fpath,{encoding:"utf8"}))}}}var files={createImportHook:createImportHook,createSyncImportHook:createSyncImportHook,existsSync:fs.existsSync,readFileSync:fs.readFileSync};var f$3=util.format;var TYPE_REFS={date:{type:"int",logicalType:"date"},decimal:{type:"bytes",logicalType:"decimal"},time_ms:{type:"long",logicalType:"time-millis"},timestamp_ms:{type:"long",logicalType:"timestamp-millis"}};function assembleProtocol(fpath,opts,cb){if(!cb&&typeof opts=="function"){cb=opts;opts=undefined}opts=opts||{};if(!opts.importHook){opts.importHook=files.createImportHook()}importFile(fpath,(function(err,protocol){if(err){cb(err);return}if(!protocol){cb(new Error("empty root import"));return}var schemas=protocol.types;if(schemas){var namespace=protocolNamespace(protocol)||"";schemas.forEach((function(schema){if(schema.namespace===namespace){delete schema.namespace}}))}cb(null,protocol)}));function importFile(fpath,cb){opts.importHook(fpath,"idl",(function(err,str){if(err){cb(err);return}if(str===undefined){cb();return}try{var reader=new Reader(str,opts);var obj=reader._readProtocol(str,opts)}catch(err){err.path=fpath;cb(err);return}fetchImports(obj.protocol,obj.imports,cb)}))}function fetchImports(protocol,imports,cb){var importedProtocols=[];next();function next(){var info=imports.shift();if(!info){importedProtocols.reverse();try{importedProtocols.forEach((function(imported){mergeImport(protocol,imported)}))}catch(err){cb(err);return}cb(null,protocol);return}var importPath=path.join(path.dirname(fpath),info.name);if(info.kind==="idl"){importFile(importPath,(function(err,imported){if(err){cb(err);return}if(imported){importedProtocols.push(imported)}next()}))}else{opts.importHook(importPath,info.kind,(function(err,str){if(err){cb(err);return}switch(info.kind){case"protocol":case"schema":if(str===undefined){next();return}try{var obj=JSON.parse(str)}catch(err){err.path=importPath;cb(err);return}var imported=info.kind==="schema"?{types:[obj]}:obj;importedProtocols.push(imported);next();return;default:cb(new Error(f$3("invalid import kind: %s",info.kind)))}}))}}}function mergeImport(protocol,imported){var schemas=imported.types||[];schemas.reverse();schemas.forEach((function(schema){if(!protocol.types){protocol.types=[]}if(schema.namespace===undefined){schema.namespace=protocolNamespace(imported)||""}protocol.types.unshift(schema)}));Object.keys(imported.messages||{}).forEach((function(name){if(!protocol.messages){protocol.messages={}}if(protocol.messages[name]){throw new Error(f$3("duplicate message: %s",name))}protocol.messages[name]=imported.messages[name]}))}}function read$1(str){var schema;if(typeof str=="string"&&~str.indexOf(path.sep)&&files.existsSync(str)){var contents=files.readFileSync(str,{encoding:"utf8"});try{return JSON.parse(contents)}catch(err){var opts={importHook:files.createSyncImportHook()};assembleProtocol(str,opts,(function(err,protocolSchema){schema=err?contents:protocolSchema}))}}else{schema=str}if(typeof schema!="string"||schema==="null"){return schema}try{return JSON.parse(schema)}catch(err){try{return Reader.readProtocol(schema)}catch(err){try{return Reader.readSchema(schema)}catch(err){return schema}}}}function Reader(str,opts){opts=opts||{};this._tk=new Tokenizer(str);this._ackVoidMessages=!!opts.ackVoidMessages;this._implicitTags=!opts.delimitedCollections;this._typeRefs=opts.typeRefs||TYPE_REFS}Reader.readProtocol=function(str,opts){var reader=new Reader(str,opts);var protocol=reader._readProtocol();if(protocol.imports.length){throw new Error("unresolvable import")}return protocol.protocol};Reader.readSchema=function(str,opts){var reader=new Reader(str,opts);var doc=reader._readJavadoc();var schema=reader._readType(doc===undefined?{}:{doc:doc},true);reader._tk.next({id:"(eof)"});return schema};Reader.prototype._readProtocol=function(){var tk=this._tk;var imports=[];var types=[];var messages={};var pos;this._readImports(imports);var protocolSchema={};var protocolJavadoc=this._readJavadoc();if(protocolJavadoc!==undefined){protocolSchema.doc=protocolJavadoc}this._readAnnotations(protocolSchema);tk.next({val:"protocol"});if(!tk.next({val:"{",silent:true})){protocolSchema.protocol=tk.next({id:"name"}).val;tk.next({val:"{"})}while(!tk.next({val:"}",silent:true})){if(!this._readImports(imports)){var javadoc=this._readJavadoc();var typeSchema=this._readType({},true);var numImports=this._readImports(imports,true);var message=undefined;pos=tk.pos;if(!numImports&&(message=this._readMessage(typeSchema))){if(javadoc!==undefined&&message.schema.doc===undefined){message.schema.doc=javadoc}var oneWay=false;if(message.schema.response==="void"||message.schema.response.type==="void"){oneWay=!this._ackVoidMessages&&!message.schema.errors;if(message.schema.response==="void"){message.schema.response="null"}else{message.schema.response.type="null"}}if(oneWay){message.schema["one-way"]=true}if(messages[message.name]){throw new Error(f$3("duplicate message: %s",message.name))}messages[message.name]=message.schema}else{if(javadoc){if(typeof typeSchema=="string"){typeSchema={doc:javadoc,type:typeSchema}}else if(typeSchema.doc===undefined){typeSchema.doc=javadoc}}types.push(typeSchema);tk.pos=pos;tk.next({val:";",silent:true})}javadoc=undefined}}tk.next({id:"(eof)"});if(types.length){protocolSchema.types=types}if(Object.keys(messages).length){protocolSchema.messages=messages}return{protocol:protocolSchema,imports:imports}};Reader.prototype._readAnnotations=function(schema){var tk=this._tk;while(tk.next({val:"@",silent:true})){var parts=[];while(!tk.next({val:"(",silent:true})){parts.push(tk.next().val)}schema[parts.join("")]=tk.next({id:"json"}).val;tk.next({val:")"})}};Reader.prototype._readMessage=function(responseSchema){var tk=this._tk;var schema={request:[],response:responseSchema};this._readAnnotations(schema);var name=tk.next().val;if(tk.next().val!=="("){return}if(!tk.next({val:")",silent:true})){do{schema.request.push(this._readField())}while(!tk.next({val:")",silent:true})&&tk.next({val:","}))}var token=tk.next();switch(token.val){case"throws":schema.errors=[];do{schema.errors.push(this._readType())}while(!tk.next({val:";",silent:true})&&tk.next({val:","}));break;case"oneway":schema["one-way"]=true;tk.next({val:";"});break;case";":break;default:throw tk.error("invalid message suffix",token)}return{name:name,schema:schema}};Reader.prototype._readJavadoc=function(){var token=this._tk.next({id:"javadoc",emitJavadoc:true,silent:true});if(token){return token.val}};Reader.prototype._readField=function(){var tk=this._tk;var javadoc=this._readJavadoc();var schema={type:this._readType()};if(javadoc!==undefined&&schema.doc===undefined){schema.doc=javadoc}this._readAnnotations(schema);schema.name=tk.next({id:"name"}).val;if(tk.next({val:"=",silent:true})){schema["default"]=tk.next({id:"json"}).val}return schema};Reader.prototype._readType=function(schema,top){schema=schema||{};this._readAnnotations(schema);schema.type=this._tk.next({id:"name"}).val;switch(schema.type){case"record":case"error":return this._readRecord(schema);case"fixed":return this._readFixed(schema);case"enum":return this._readEnum(schema,top);case"map":return this._readMap(schema);case"array":return this._readArray(schema);case"union":if(Object.keys(schema).length>1){throw new Error("union annotations are not supported")}return this._readUnion();default:var ref=this._typeRefs[schema.type];if(ref){delete schema.type;utils.copyOwnProperties(ref,schema)}return Object.keys(schema).length>1?schema:schema.type}};Reader.prototype._readFixed=function(schema){var tk=this._tk;if(!tk.next({val:"(",silent:true})){schema.name=tk.next({id:"name"}).val;tk.next({val:"("})}schema.size=parseInt(tk.next({id:"number"}).val);tk.next({val:")"});return schema};Reader.prototype._readMap=function(schema){var tk=this._tk;var silent=this._implicitTags;var implicitTags=tk.next({val:"<",silent:silent})===undefined;schema.values=this._readType();tk.next({val:">",silent:implicitTags});return schema};Reader.prototype._readArray=function(schema){var tk=this._tk;var silent=this._implicitTags;var implicitTags=tk.next({val:"<",silent:silent})===undefined;schema.items=this._readType();tk.next({val:">",silent:implicitTags});return schema};Reader.prototype._readEnum=function(schema,top){var tk=this._tk;if(!tk.next({val:"{",silent:true})){schema.name=tk.next({id:"name"}).val;tk.next({val:"{"})}schema.symbols=[];do{schema.symbols.push(tk.next().val)}while(!tk.next({val:"}",silent:true})&&tk.next({val:","}));if(top&&tk.next({val:"=",silent:true})){schema.default=tk.next().val;tk.next({val:";"})}return schema};Reader.prototype._readUnion=function(){var tk=this._tk;var arr=[];tk.next({val:"{"});do{arr.push(this._readType())}while(!tk.next({val:"}",silent:true})&&tk.next({val:","}));return arr};Reader.prototype._readRecord=function(schema){var tk=this._tk;if(!tk.next({val:"{",silent:true})){schema.name=tk.next({id:"name"}).val;tk.next({val:"{"})}schema.fields=[];while(!tk.next({val:"}",silent:true})){schema.fields.push(this._readField());tk.next({val:";"})}return schema};Reader.prototype._readImports=function(imports,maybeMessage){var tk=this._tk;var numImports=0;var pos=tk.pos;while(tk.next({val:"import",silent:true})){if(!numImports&&maybeMessage&&tk.next({val:"(",silent:true})){tk.pos=pos;return}var kind=tk.next({id:"name"}).val;var fname=JSON.parse(tk.next({id:"string"}).val);tk.next({val:";"});imports.push({kind:kind,name:fname});numImports++}return numImports};function Tokenizer(str){this._str=str;this.pos=0}Tokenizer.prototype.next=function(opts){var token={pos:this.pos,id:undefined,val:undefined};var javadoc=this._skip(opts&&opts.emitJavadoc);if(javadoc){token.id="javadoc";token.val=javadoc}else{var pos=this.pos;var str=this._str;var c=str.charAt(pos);if(!c){token.id="(eof)"}else{if(opts&&opts.id==="json"){token.id="json";this.pos=this._endOfJson()}else if(c==='"'){token.id="string";this.pos=this._endOfString()}else if(/[0-9]/.test(c)){token.id="number";this.pos=this._endOf(/[0-9]/)}else if(/[`A-Za-z_.]/.test(c)){token.id="name";this.pos=this._endOf(/[`A-Za-z0-9_.]/)}else{token.id="operator";this.pos=pos+1}token.val=str.slice(pos,this.pos);if(token.id==="json"){try{token.val=JSON.parse(token.val)}catch(err){throw this.error("invalid JSON",token)}}else if(token.id==="name"){token.val=token.val.replace(/`/g,"")}}}var err;if(opts&&opts.id&&opts.id!==token.id){err=this.error(f$3("expected ID %s",opts.id),token)}else if(opts&&opts.val&&opts.val!==token.val){err=this.error(f$3("expected value %s",opts.val),token)}if(!err){return token}else if(opts&&opts.silent){this.pos=token.pos;return undefined}else{throw err}};Tokenizer.prototype.error=function(reason,context){var isToken=typeof context!="number";var pos=isToken?context.pos:context;var str=this._str;var lineNum=1;var lineStart=0;var i;for(i=0;i<pos;i++){if(str.charAt(i)==="\n"){lineNum++;lineStart=i}}var msg=isToken?f$3("invalid token %j: %s",context,reason):reason;var err=new Error(msg);err.token=isToken?context:undefined;err.lineNum=lineNum;err.colNum=pos-lineStart;return err};Tokenizer.prototype._skip=function(emitJavadoc){var str=this._str;var isJavadoc=false;var pos,c;while((c=str.charAt(this.pos))&&/\s/.test(c)){this.pos++}pos=this.pos;if(c==="/"){switch(str.charAt(this.pos+1)){case"/":this.pos+=2;while((c=str.charAt(this.pos))&&c!=="\n"){this.pos++}return this._skip(emitJavadoc);case"*":this.pos+=2;if(str.charAt(this.pos)==="*"){isJavadoc=true}while(c=str.charAt(this.pos++)){if(c==="*"&&str.charAt(this.pos)==="/"){this.pos++;if(isJavadoc&&emitJavadoc){return extractJavadoc(str.slice(pos+3,this.pos-2))}return this._skip(emitJavadoc)}}throw this.error("unterminated comment",pos)}}};Tokenizer.prototype._endOf=function(pat){var pos=this.pos;var str=this._str;while(pat.test(str.charAt(pos))){pos++}return pos};Tokenizer.prototype._endOfString=function(){var pos=this.pos+1;var str=this._str;var c;while(c=str.charAt(pos)){if(c==='"'){return pos+1}if(c==="\\"){pos+=2}else{pos++}}throw this.error("unterminated string",pos-1)};Tokenizer.prototype._endOfJson=function(){var pos=utils.jsonEnd(this._str,this.pos);if(pos<0){throw this.error("invalid JSON",pos)}return pos};function extractJavadoc(str){var lines=str.replace(/^[ \t]+|[ \t]+$/g,"").split("\n").map((function(line,i){return i?line.replace(/^\s*\*\s?/,""):line}));while(!lines[0]){lines.shift()}while(!lines[lines.length-1]){lines.pop()}return lines.join("\n")}function protocolNamespace(protocol){if(protocol.namespace){return protocol.namespace}var match=/^(.*)\.[^.]+$/.exec(protocol.protocol);return match?match[1]:undefined}var specs={Tokenizer:Tokenizer,assembleProtocol:assembleProtocol,read:read$1,readProtocol:Reader.readProtocol,readSchema:Reader.readSchema};function parse(any,opts){var schemaOrProtocol=specs.read(any);return schemaOrProtocol.protocol?services.Service.forProtocol(schemaOrProtocol,opts):types.Type.forSchema(schemaOrProtocol,opts)}function extractFileHeader(path,opts){opts=opts||{};var decode=opts.decode===undefined?true:!!opts.decode;var size=Math.max(opts.size||4096,4);var buf=utils.newBuffer(size);var fd=fs.openSync(path,"r");try{var pos=fs.readSync(fd,buf,0,size);if(pos<4||!containers.MAGIC_BYTES.equals(buf.slice(0,4))){return null}var tap=new utils.Tap(buf);var header=null;do{header=containers.HEADER_TYPE._read(tap)}while(!isValid());if(decode!==false){var meta=header.meta;meta["avro.schema"]=JSON.parse(meta["avro.schema"].toString());if(meta["avro.codec"]!==undefined){meta["avro.codec"]=meta["avro.codec"].toString()}}return header}finally{fs.closeSync(fd)}function isValid(){if(tap.isValid()){return true}var len=2*tap.buf.length;var buf=utils.newBuffer(len);len=fs.readSync(fd,buf,0,len);tap.buf=Buffer.concat([tap.buf,buf]);tap.pos=0;return false}}function createFileDecoder(path,opts){return fs.createReadStream(path).pipe(new containers.streams.BlockDecoder(opts))}function createFileEncoder(path,schema,opts){var encoder=new containers.streams.BlockEncoder(schema,opts);encoder.pipe(fs.createWriteStream(path,{defaultEncoding:"binary"}));return encoder}var lib={Service:services.Service,Type:types.Type,assembleProtocol:specs.assembleProtocol,createFileDecoder:createFileDecoder,createFileEncoder:createFileEncoder,discoverProtocol:services.discoverProtocol,extractFileHeader:extractFileHeader,parse:parse,readProtocol:specs.readProtocol,readSchema:specs.readSchema,streams:containers.streams,types:types.builtins,Protocol:services.Service,assemble:util.deprecate(specs.assembleProtocol,"use `assembleProtocol` instead"),combine:util.deprecate(types.Type.forTypes,"use `Type.forTypes` intead"),infer:util.deprecate(types.Type.forValue,"use `Type.forValue` instead")};let intervalID=null;let objList=[];let onceList=[];let updateOnce=false;function add(obj){let state=false;if(obj&&obj.update){if(!Object.prototype.hasOwnProperty.call(obj,"__updateIndex")){obj.__updateIndex=objList.length;objList.push(obj);state=true}else{console.log("[updateManager] add error !")}}return state}function remove(obj){let idx;let length=objList.length;let tmp;if(typeof obj.__updateIndex==="number"){idx=obj.__updateIndex;if(idx>=0&&idx<length){let lastIdx=length-1;tmp=objList[lastIdx];objList[idx]=tmp;tmp.__updateIndex=idx;objList.splice(lastIdx,1)}delete obj.__updateIndex}}function setTimeout$1(func,seconds){let t={currentTime:0,func:func};t.update=offsetTime=>{if(t.currentTime>=seconds){remove(t);if(t.func){t.func(t.currentTime)}}t.currentTime+=offsetTime};add(t);return t}function clearTimeout$1(t){remove(t)}function setInterval(func,seconds){let t={currentTime:0,func:func};t.update=offsetTime=>{t.currentTime+=offsetTime;if(t.currentTime>=seconds){if(t.func){t.func(t.currentTime)}t.currentTime=0}};add(t);return t}function clearInterval(t){remove(t)}function once(obj){if(obj&&obj.update){onceList.push(obj);updateOnce=true}}function reset(){objList.forEach(obj=>{delete obj.__updateIndex});objList=[]}function update(offsetTime){if(updateOnce){onceList.forEach(obj=>{obj.update(offsetTime);if(obj.pause){obj.pause()}});onceList=[];updateOnce=false}objList.forEach(obj=>{obj.update(offsetTime)})}let lastTime=-1;function refresh(){let currentTime=performance.now()*.001;let offsetTime;if(!isPlay){return}if(lastTime<0){offsetTime=0;lastTime=currentTime}else{offsetTime=currentTime-lastTime;lastTime=currentTime}update(offsetTime)}let isPlay=false;let isInit=false;function init$1(config){console.log("[updateManager] init");if(isInit){return}isInit=true;intervalID=self.setInterval(refresh,1e3/60);console.log(intervalID);reset();play()}function play(){if(!isPlay){isPlay=true;lastTime=-1}}function pause(){if(isPlay){isPlay=false}}var updateManager=Object.freeze({__proto__:null,add:add,remove:remove,setTimeout:setTimeout$1,clearTimeout:clearTimeout$1,setInterval:setInterval,clearInterval:clearInterval,once:once,reset:reset,init:init$1,play:play,pause:pause});let objectList=[];objectList[0]={aaaa:"bbbb"};let counts=0;function add$1(obj){let funcIndex=parseInt(obj.funcIndex)||0;if(funcIndex<=0){return funcIndex}obj._t=setTimeout$1(()=>{console.error(`(funcIndex:${obj.funcIndex}) ${obj.name} timeout`);get(obj);obj.reject("timeout")},30);if(objectList.length===1){counts=0}counts+=1;obj.funcIndex=counts;objectList.push(obj);return obj.funcIndex}function get(funcIndex){let obj=null;let currentIndex=0;if(funcIndex<=0){return obj}objectList.some((object,index)=>{if(object&&object.funcIndex===funcIndex){obj=object;currentIndex=index;return true}return false});if(currentIndex===0){return obj}if(obj){remove$1(obj)}return obj}function remove$1(obj){let index=objectList.length-1;let currentIndex=obj.funcIndex;if(currentIndex<index){let last=objectList[index];objectList[currentIndex]=last}objectList.pop();if(obj._t){clearTimeout$1(obj._t);delete obj._t}}var namespace="game.agent.avro";var name="LoginRequest";var type="record";var doc="登入命令 (傳送)";var fields=[{doc:"索引",name:"funcIndex",type:"int"},{doc:"認證碼",name:"fingerprint",type:"string"},{doc:"指紋",name:"token",type:"string"},{doc:"視訊用",name:"tablekey",type:["null","string"],default:null}];var LoginRequest={namespace:namespace,name:name,type:type,doc:doc,fields:fields};var namespace$1="game.agent.avro";var name$1="LoginResponseGti";var type$1="record";var doc$1="登入命令 (接收)";var fields$1=[{doc:"玩家資訊 (目前沒使用)",name:"userInfo",type:["null",{name:"UserInfo",type:"record",fields:[{name:"nickname",type:"string"},{name:"coin",type:["null","int"],default:null}]}],default:null},{doc:"索引",name:"funcIndex",type:"int"},{doc:"認證碼",name:"token",type:["null","string"],default:null},{doc:"結果代碼",name:"resultCode",type:"int"}];var LoginResponseGti={namespace:namespace$1,name:name$1,type:type$1,doc:doc$1,fields:fields$1};var namespace$2="game.agent.avro";var name$2="LoginResponseVideo";var type$2="record";var doc$2="登入命令 (接收)";var fields$2=[{name:"resultCode",type:"int"},{name:"loginKey",type:"string"},{name:"userInfo",type:{type:"record",fields:[{name:"id",type:"string"},{name:"platform",type:"string"},{name:"currency",type:"string"},{name:"userID",type:"string"},{name:"nickname",type:"string"},{name:"house",type:"string"},{name:"agent",type:"string"},{name:"gameData",type:{type:"record",fields:[{name:"roomID",type:"string"}]}},{name:"aboId",type:"string"}]}},{name:"funcIndex",type:"int"}];var LoginResponseVideo={namespace:namespace$2,name:name$2,type:type$2,doc:doc$2,fields:fields$2};const typeRequest=lib.Type.forSchema(LoginRequest);const typeResponseGti=lib.Type.forSchema(LoginResponseGti);const typeResponseVideo=lib.Type.forSchema(LoginResponseVideo);var namespace$3="game.agent.avro";var name$3="InGameRequest";var type$3="record";var doc$3="進入遊戲 (傳送)";var fields$3=[{doc:"索引",name:"funcIndex",type:"int"},{doc:"名稱",name:"name",type:"string"},{doc:"群組",name:"group",type:"string"},{doc:"遊戲代碼",name:"gid",type:"string"}];var InGameRequest={namespace:namespace$3,name:name$3,type:type$3,doc:doc$3,fields:fields$3};var namespace$4="game.agent.avro";var name$4="InGameResponse";var type$4="record";var doc$4="進入遊戲 (接收)";var fields$4=[{doc:"遊戲代碼",name:"gid",type:"string"},{doc:"索引",name:"funcIndex",type:"int"},{name:"updateSchemaList",type:{type:"array",items:{name:"UpdateSchemaRequest",type:"record",fields:[{doc:"名稱",name:"name",type:"string"},{doc:"群組",name:"group",type:"string"},{doc:"訂閱",name:"sub",type:{type:"enum",symbols:["request","response"]}},{name:"schemas",type:{type:"array",items:"string"}}]}}},{name:"resultCode",type:"int"}];var InGameResponse={namespace:namespace$4,name:name$4,type:type$4,doc:doc$4,fields:fields$4};const typeRequest$1=lib.Type.forSchema(InGameRequest);const typeResponse=lib.Type.forSchema(InGameResponse);var namespace$5="game.agent.avro";var name$5="ToGameRequest";var type$5="record";var doc$5="遊戲命令 (傳送)";var fields$5=[{doc:"索引",name:"funcIndex",type:"int"},{doc:"遊戲代碼",name:"gid",type:"string"},{doc:"封包",name:"packet",type:{name:"packet",type:"record",fields:[{doc:"命令",name:"command",type:["string","null"]},{doc:"資料",name:"data",type:["bytes","string"]}]}}];var ToGameRequest={namespace:namespace$5,name:name$5,type:type$5,doc:doc$5,fields:fields$5};var namespace$6="game.agent.avro";var name$6="ToGameResponse";var type$6="record";var doc$6="遊戲命令 (接收)";var fields$6=[{doc:"索引",name:"funcIndex",type:"int"},{doc:"遊戲代碼",name:"gid",type:"string"},{doc:"結果代碼",name:"resultCode",type:"int"},{doc:"資料",name:"packet",type:["null","bytes"]},{name:"schemas",doc:"資料描述",type:{type:"array",items:{name:"schema",type:"record",fields:[{name:"name",type:"string"},{name:"hash",type:"string"}]}}}];var ToGameResponse={namespace:namespace$6,name:name$6,type:type$6,doc:doc$6,fields:fields$6};const typeRequest$2=lib.Type.forSchema(ToGameRequest);const typeResponse$1=lib.Type.forSchema(ToGameResponse);var cmdToGameBase=Object.freeze({__proto__:null,typeRequest:typeRequest$2,typeResponse:typeResponse$1});var namespace$7="game.agent.avro";var name$7="BroadcastResponse";var doc$7="廣播用 (接收)";var type$7="record";var fields$7=[{doc:"種類",name:"proto",type:"string"},{doc:"內容",name:"json",type:"string"}];var BroadcastResponse={namespace:namespace$7,name:name$7,doc:doc$7,type:type$7,fields:fields$7};const typeResponse$2=lib.Type.forSchema(BroadcastResponse);var namespace$8="game.agent.avro";var name$8="UpdateSchemaRequest";var type$8="record";var doc$8=" 更新 schema (請求)";var fields$8=[{doc:"索引",name:"funcIndex",type:"int"},{doc:"名稱",name:"name",type:"string"},{doc:"群組",name:"group",type:"string"},{doc:"訂閱",name:"sub",type:{type:"enum",symbols:["request","response"]}},{name:"schemas",type:{type:"array",items:"string"}}];var UpdateSchemaRequest={namespace:namespace$8,name:name$8,type:type$8,doc:doc$8,fields:fields$8};var namespace$9="game.agent.avro";var name$9="UpdateSchemaResponse";var type$9="record";var doc$9=" 更新 schema (回應)";var fields$9=[{doc:"索引",name:"funcIndex",type:"int"},{doc:"名稱",name:"name",type:"string"},{doc:"群組",name:"group",type:"string"},{doc:"訂閱",name:"sub",type:{type:"enum",symbols:["request","response"]}},{name:"schemas",doc:"資料描述",type:{type:"array",items:{name:"schema",type:"record",fields:[{name:"json",type:"string"},{name:"id",type:"string"}]}}}];var UpdateSchemaResponse={namespace:namespace$9,name:name$9,type:type$9,doc:doc$9,fields:fields$9};const typeRequest$3=lib.Type.forSchema(UpdateSchemaRequest);const typeResponse$3=lib.Type.forSchema(UpdateSchemaResponse);let currentFormat="unknown";let currentGame=null;let currentSocket=null;let typesCache={};let schemasCache={};let current={};var SUB;(function(SUB){const REQUEST="request";SUB["REQUEST"]=REQUEST;const RESPONSE="response";SUB["RESPONSE"]=RESPONSE})(SUB||(SUB={}));let cmdToGame=null;async function updateSchema(info){return new Promise((resolve,reject)=>{let type=typeRequest$3;console.log("[檢查]更新命令");console.info(info);info.funcIndex=-1;let state=type.isValid(info,{noUndeclaredFields:true});if(state&&currentSocket){let obj={};obj.name="updateSchema";obj.reject=reject;obj.resolve=resolve;info.funcIndex=add$1(obj);let buffer=type.toBuffer(info);console.log(`[send ${info.funcIndex}]${obj.name} data : ${JSON.stringify(info).length}  ,buf : ${buffer.length}`);currentSocket.send(buffer)}else{console.error("[updateSchema] 格式錯誤");reject()}})}async function procUpdateSchema(updateSchemaList){if(updateSchemaList.length>0){for(let i=0;i<updateSchemaList.length;i+=1){let info=updateSchemaList[i];if(info.schemas.length>0){await updateSchema(info)}}}}function getCache(caches,value){let cache=null;if(!(value.group&&value.name)){return cache}let group=caches[value.group];if(!group){group={};caches[value.group]=group}cache=group[value.name];if(!cache){cache={};group[value.name]=cache}return cache}async function checkSchema(value){let id=`${value.group}${value.name}`;console.log(`[checkSchema] ${id}`);let schemaCache=getCache(schemasCache,value);let typeCache=getCache(typesCache,value);if(!schemaCache.requests){schemaCache.requests={};schemaCache.responses={}}if(!typeCache.requests){typeCache.requests={};typeCache.responses={}}if(!(typeCache&&schemaCache)){console.error("schemaCache");console.error(schemaCache);console.error("typeCache");console.error(typeCache);return}current[id]=typeCache;if(value.sub==="request"){let idList=[];for(let i=0;i<value.schemas.length;i+=1){let schema=value.schemas[i];if(schema.id&&schema.json){let id=schema.id;let obj=JSON.parse(schema.json);if(!obj.name){obj.name=`${value.name}${schema.id}`}schemaCache.requests[id]=obj;idList.push(id)}}console.log(`[${value.sub}] check types`);for(let i=0;i<idList.length;i+=1){let id=idList[i];let obj=schemaCache.requests[id];if(typeof obj!=="string"){try{if(!typeCache.requests[id]){console.log(`[type id]${id}`);let type=lib.Type.forSchema(obj);typeCache.requests[id]=type}else{console.log("  已經存在")}}catch(e){console.error(e)}}else{console.error("schema is string");console.log(obj)}}}else if(value.sub==="response"){let idList=[];for(let i=0;i<value.schemas.length;i+=1){let schema=value.schemas[i];if(schema.id&&schema.json){let id=schema.id;let obj=JSON.parse(schema.json);if(!obj.name){obj.name=`${value.name}${schema.id}`}schemaCache.responses[id]=obj;idList.push(id)}}console.log(`[${value.sub}] check types`);for(let i=0;i<idList.length;i+=1){let id=idList[i];let obj=schemaCache.responses[id];if(typeof obj!=="string"){try{if(!typeCache.responses[id]){console.log(`[type id]${id}`);let type=lib.Type.forSchema(obj);typeCache.responses[id]=type}else{console.log("  已經存在")}}catch(e){console.error(e)}}else{console.log("schema is string");console.log(obj)}}}}function checkData(bytes,info){console.log(`[checkData] ${info.group} ${info.name} ${info.hash}`);let id=`${info.group}${info.name}`;let types=current[id];let obj=null;if(types&&types.responses){let type=types.responses[info.hash];if(type){try{obj=type.fromBuffer(bytes)}catch(e){console.log(e)}}}return obj}function removeNullKey(obj,lv=0){lv+=1;if(lv>5){return}let names=Object.getOwnPropertyNames(obj);names.forEach(name=>{let child=obj[name];if(child===null){delete obj[name]}else if(Array.isArray(child)){if(typeof child[0]==="object"){child.forEach((value,index)=>{if(typeof value==="object"){removeNullKey(value,lv)}})}}else if(typeof child==="object"){removeNullKey(child,lv)}})}async function onMessage(event,proxy){let array=new Uint8Array(event.data);let buf=new Buffer(array);let onmessage=proxy.onmessage;let ontogame=proxy.ontogame;let onbroadcast=proxy.onbroadcast;let onerror=proxy.onerror;if(onmessage){try{let type=cmdToGame.typeResponse;let value=type.fromBuffer(buf);console.log(`[recv]toGame buf : ${buf.length}  data : ${JSON.stringify(value).length}`);console.info(value);let packet=value.packet;let schemas=value.schemas;if(packet){let bytes=null;let obj=null;let schema=null;schema=schemas[schemas.length-1];let info={group:currentGame.group,name:schema.name,hash:schema.hash};obj=checkData(packet,info);if(!obj){await updateSchema({group:info.group,name:info.name,sub:SUB.RESPONSE,schemas:[info.hash]});obj=checkData(packet,info);if(!obj){console.error(`${info.group} ${info.name} ${info.hash} 沒找到匹配的格式`)}}packet=obj;if(packet){let bytes=null;for(let i=0;i<schemas.length-1;i+=1){schema=schemas[i];let name=schema.name;bytes=packet[schema.name];if(bytes&&bytes.BYTES_PER_ELEMENT===1){if(name==="data"){name=currentGame.name}info.name=name;info.hash=schema.hash;obj=checkData(bytes,info);if(!obj){await updateSchema({group:info.group,name:info.name,sub:SUB.RESPONSE,schemas:[info.hash]});obj=checkData(packet,info);if(!obj){console.error(`${info.group} ${info.name} ${info.hash} 沒找到匹配的格式`)}}packet[schema.name]=obj}}console.log(packet);if(currentFormat==="gti"){if(packet.data){removeNullKey(packet.data);packet.data=JSON.stringify(packet.data)}if(packet.jackpot){packet.jackpot=JSON.stringify(packet.jackpot)}else{delete packet.jackpot}if(packet.info){packet.info=JSON.stringify(packet.info)}else{delete packet.info}if(packet.setting){packet.setting=JSON.stringify(packet.setting)}else{delete packet.setting}}else{if(packet.data){packet.data=JSON.stringify(packet.data)}}value.packet=packet}}ontogame(value);return}catch(e){}try{let type=typeResponse$3;let value=type.fromBuffer(buf);console.log(`[recv ${value.funcIndex}]updateSchema buf : ${buf.length}  data : ${JSON.stringify(value).length}`);console.info(value);await checkSchema(value);let obj=get(value.funcIndex);if(obj&&obj.resolve){obj.resolve(value)}return}catch(e){}try{let type=typeResponse;let value=type.fromBuffer(buf);console.log(`[recv ${value.funcIndex}]inGame buf : ${buf.length}  data : ${JSON.stringify(value).length}`);console.info(value);let obj=get(value.funcIndex);if(obj&&obj.resolve){obj.resolve(value)}else{onmessage(value)}return}catch(e){}try{let type=typeResponse$2;let value=type.fromBuffer(buf);console.log(`[recv]broadcast buf : ${buf.length}  data : ${JSON.stringify(value).length}`);console.log(value);onbroadcast(value);return}catch(e){}try{let type=typeResponseVideo;let value=type.fromBuffer(buf);console.log(`[recv ${value.funcIndex}]login buf : ${buf.length}  data : ${JSON.stringify(value).length}`);console.info(value);let obj=get(value.funcIndex);if(obj&&obj.resolve){obj.resolve(value)}else{onmessage(value)}return}catch(e){}try{let type=typeResponseGti;let value=type.fromBuffer(buf);console.log(`[recv ${value.funcIndex}]login buf : ${buf.length}  data : ${JSON.stringify(value).length}`);console.info(value);let obj=get(value.funcIndex);if(obj){obj.resolve(value)}else{onmessage(value)}return}catch(e){}}console.error("[avro recv] !!!! unknown format !!!!");console.log(buf)}async function connect(config,onmessage,onerror,onbroadcast,onclose,ontogame){return new Promise((resolve,reject)=>{let hostname=config.hostname;currentSocket=new WebSocket(hostname);currentSocket.binaryType="arraybuffer";let proxy={onmessage:onmessage,onerror:onerror,onbroadcast:onbroadcast,onclose:onclose,ontogame:ontogame};currentSocket.onopen=()=>{console.log("[socket open]");resolve()};currentSocket.onclose=()=>{console.log("[websocket onclose]");onclose()};currentSocket.onerror=()=>{console.log("[websocket onerror]");onerror("[websocket onerror]")};currentSocket.onmessage=event=>{onMessage(event,proxy)}})}function send(){console.log("[send] data")}async function login(info){return new Promise((resolve,reject)=>{let type=typeRequest;console.log(`[檢查]登入命令`);console.info(info);info.funcIndex=-1;let state=type.isValid(info,{noUndeclaredFields:true});if(state&&currentSocket){let obj={};obj.name="login";obj.reject=reject;obj.resolve=resolve;info.funcIndex=add$1(obj);let buffer=type.toBuffer(info);currentSocket.send(buffer);console.log(`[send ${info.funcIndex}]${obj.name} data : ${JSON.stringify(info).length}  , buf : ${buffer.length}`)}else{console.error("格式錯誤");reject()}})}async function ingame(info){currentGame={name:info.name,group:info.group};let data=await sendInGame(info);if(!data){return Promise.reject("error : ingame")}let updateSchemaList=null;let typeCache=getCache(typesCache,info);let schemaCache=getCache(schemasCache,info);typeCache.requests={};schemaCache.requests={};typeCache.responses={};schemaCache.responses={};let id=`${info.group}${info.name}`;current[id]=typeCache;updateSchemaList=data.updateSchemaList||[];if(updateSchemaList.length>0){console.log("========== 更新 schema ==========");await procUpdateSchema(updateSchemaList);console.log("========== 更新 schema ==========")}return Promise.resolve(data)}async function sendInGame(info){return new Promise((resolve,reject)=>{let type=typeRequest$1;console.log(`[檢查]進入遊戲命令`);console.info(info);info.funcIndex=-1;let state=type.isValid(info,{noUndeclaredFields:true});if(state&&currentSocket){let obj={};obj.name="ingame";obj.reject=reject;obj.resolve=resolve;info.funcIndex=add$1(obj);let buffer=type.toBuffer(info);console.log(`[send ${info.funcIndex}]${obj.name} data : ${JSON.stringify(info).length}  ,buf : ${buffer.length}`);currentSocket.send(buffer)}else{console.error("格式錯誤");reject()}})}async function togame(info){let type=cmdToGame.typeRequest;let obj=info.packet.data;if(!info.packet.command){info.packet.command=null}if(obj){if(typeof obj==="string"){if(obj[0]==="{"){obj=JSON.parse(obj)}}if(typeof obj==="object"){let id=`${currentGame.group}${currentGame.name}`;let types=current[id].requests;let state=false;if(types&&Object.getOwnPropertyNames(obj).length>0){let ids=Object.getOwnPropertyNames(types);ids.some(id=>{let type=types[id];if(type){state=type.isValid(obj,{noUndeclaredFields:true});if(state){console.log(`[schema id] ${id}`);try{let buf=type.toBuffer(obj);info.packet.data=buf}catch(e){console.error(e)}}}return state})}else{info.packet.data="{}"}}}else{info.packet.data=null}info.funcIndex=-1;let state=type.isValid(info);console.log(`[檢查]遊戲命令`);console.info(info);if(state&&currentSocket){let obj={};obj.name="togame";try{let buf=type.toBuffer(info);currentSocket.send(buf);console.log(`[send]${obj.name} data : ${JSON.stringify(info).length}  ,buf : ${buf.length}`)}catch(e){console.error(e)}}else{console.error("格式錯誤")}return null}function init$2(config){let gameFormat=config.gameFormat||"gti";if(gameFormat!=="gti"&&gameFormat!=="video"){gameFormat="gti"}currentFormat=gameFormat;cmdToGame=cmdToGameBase}async function register$1(config){console.log("[avro register]");console.log(config)}var avro=Object.freeze({__proto__:null,typesCache:typesCache,schemasCache:schemasCache,register:register$1,init:init$2,connect:connect,login:login,ingame:ingame,togame:togame,send:send});var nested={Game:{nested:{Agent:{nested:{ActionType:{values:{LOGIN:0,INGAME:1,TOGAME:2,BROADCAST:3}},CheckAction:{fields:{actionType:{type:"ActionType",id:1}},reserved:[[2,2]]},BroadcastResponse:{fields:{actionType:{type:"ActionType",id:1},format:{type:"CustomFormat",id:2},proto:{type:"string",id:3},json:{type:"string",id:4},data:{type:"bytes",id:5}},reserved:[[6,6]]},LoginRequest:{fields:{actionType:{type:"ActionType",id:1},funcIndex:{type:"int32",id:3},token:{type:"string",id:4},tablekey:{type:"string",id:5},fingerprint:{type:"string",id:6},formatBroadcast:{type:"CustomFormat",id:7}},reserved:[[2,2]]},LoginResponse:{fields:{actionType:{type:"ActionType",id:1},funcIndex:{type:"int32",id:3},userInfo:{type:"UserInfo",id:4},token:{type:"string",id:5},resultCode:{type:"int32",id:7}},reserved:[[2,2],[6,6]]},UserInfo:{fields:{nickname:{type:"string",id:1},coin:{type:"int64",id:3}},reserved:[[2,2],[6,6]]},InGameRequest:{fields:{actionType:{type:"ActionType",id:1},funcIndex:{type:"int32",id:3},gid:{type:"string",id:4},name:{type:"string",id:6},group:{type:"string",id:7}},reserved:[[2,2],[5,5]]},Custom:{fields:{name:{type:"string",id:1}}},InGameResponse:{fields:{actionType:{type:"ActionType",id:1},funcIndex:{type:"int32",id:3},gid:{type:"string",id:4},resultCode:{type:"int32",id:5}},reserved:[[2,2]]},CustomFormat:{values:{JSON:0,RAW:1,PROTOBUF:2}},CustomType:{values:{A:0,B:1}},ToGameRequest:{fields:{actionType:{type:"ActionType",id:1},funcIndex:{type:"int32",id:3},gid:{type:"string",id:4},packet:{type:"GameRequest",id:5}},reserved:[[2,2],[6,6]]},GameRequest:{fields:{format:{type:"CustomFormat",id:1},funcIndex:{type:"int32",id:2},command:{type:"string",id:3},data:{type:"bytes",id:4}},reserved:[[6,6]]},ToGameResponse:{fields:{actionType:{type:"ActionType",id:1},funcIndex:{type:"int32",id:3},gid:{type:"string",id:4},resultCode:{type:"int32",id:5},packet:{type:"GameResponse",id:7}},reserved:[[2,2],[6,6]]},GameResponse:{fields:{format:{type:"CustomFormat",id:1},funcIndex:{type:"int32",id:2},command:{type:"string",id:3},data:{type:"bytes",id:4},jackpot:{type:"Jackpot",id:6},info:{type:"Info",id:7},setting:{type:"Setting",id:8},errorCode:{type:"string",id:9}},reserved:[[5,5]]},Jackpot:{fields:{format:{type:"CustomFormat",id:1},data:{type:"bytes",id:3}},reserved:[[2,2]]},Setting:{fields:{format:{type:"CustomFormat",id:1},data:{type:"bytes",id:3}},reserved:[[2,2]]},Info:{fields:{format:{type:"CustomFormat",id:1},data:{type:"bytes",id:3}},reserved:[[2,2]]}}}}}};var protocol={nested:nested};function _optionalChain(ops){let lastAccessLHS=undefined;let value=ops[0];let i=1;while(i<ops.length){const op=ops[i];const fn=ops[i+1];i+=2;if((op==="optionalAccess"||op==="optionalCall")&&value==null){return undefined}if(op==="access"||op==="optionalAccess"){lastAccessLHS=value;value=fn(value)}else if(op==="call"||op==="optionalCall"){value=fn((...args)=>value.call(lastAccessLHS,...args));lastAccessLHS=undefined}}return value}console.log("[protocol] begin");console.log(protocol);console.log("[protocol] end");let ActionType=null;let CustomFormat=null;let Agent=null;let currentSocket$1=null;let CheckAction=null;let LoginRequest$1=null;let LoginResponse=null;let InGameRequest$1=null;let InGameResponse$1=null;let ToGameRequest$1=null;let ToGameResponse$1=null;let BroadcastResponse$1=null;let handleList=[];let utf8Decoder=null;let utf8Encoder=null;let gameManager={};let useObjectToGame=false;async function connect$1(config,onmessage,onerror,onbroadcast,onclose,ontogame){let root=protobuf.Root.fromJSON(protocol);Agent=root.Game.Agent;ActionType=Agent.ActionType;CustomFormat=Agent.CustomFormat;CheckAction=Agent.CheckAction;LoginRequest$1=Agent.LoginRequest;LoginResponse=Agent.LoginResponse;InGameRequest$1=Agent.InGameRequest;InGameResponse$1=Agent.InGameResponse;ToGameRequest$1=Agent.ToGameRequest;ToGameResponse$1=Agent.ToGameResponse;BroadcastResponse$1=Agent.BroadcastResponse;let hostname=config.hostname;return new Promise((resolve,reject)=>{currentSocket$1=new WebSocket(hostname);currentSocket$1.binaryType="arraybuffer";currentSocket$1.onopen=()=>{console.log("[socket open]");resolve()};async function eventClose(){await onclose()}currentSocket$1.onclose=()=>{console.log("[websocket onclose]");eventClose()};async function eventError(msg){console.log(`[eventError] ${msg}`);await onerror(msg)}currentSocket$1.onerror=()=>{eventError("websocket error")};async function eventMessage(data){await onmessage(data)}async function eventBroadcast(data){await onbroadcast(data)}async function eventToGame(data){await ontogame(data)}function cmdLogin(buf){try{let value=LoginResponse.decode(buf);let obj=LoginResponse.toObject(value,{defaults:true,arrays:false,objects:false,oneofs:false});console.log(`[recv ${obj.funcIndex}]login buf : ${buf.length}  data : ${JSON.stringify(obj).length}`);console.info(obj);let object=get(obj.funcIndex);if(object){object.resolve(obj)}else{eventMessage(obj)}}catch(e){console.error(e)}}function cmdInGame(buf){try{let value=InGameResponse$1.decode(buf);let obj=InGameResponse$1.toObject(value,{defaults:true,arrays:false,objects:false,oneofs:false});console.log(`[recv ${obj.funcIndex}]ingame buf : ${buf.length}  data : ${JSON.stringify(obj).length}`);console.info(obj);let object=get(obj.funcIndex);if(object){object.resolve(obj)}else{eventMessage(obj)}}catch(e){console.error(e)}}function cmdToGame(buf){try{let value=ToGameResponse$1.decode(buf);let obj=ToGameResponse$1.toObject(value,{defaults:true,arrays:false,objects:false,oneofs:false});console.log(`[recv]togame buf : ${buf.length}  data : ${JSON.stringify(obj).length}`);let game=gameManager[obj.gid];if(obj.packet){let packet=obj.packet;try{if(_optionalChain([packet,"access",_=>_.data,"optionalAccess",_2=>_2.length])&&packet.data.length>0){switch(packet.format){case CustomFormat.JSON:packet.data=utf8Decoder.decode(packet.data);break;case CustomFormat.PROTOBUF:if(_optionalChain([game,"optionalAccess",_3=>_3.data,"optionalAccess",_4=>_4.cmdList])&&game.check){let check=game.check.decode(packet.data);let field=game.data.cmdList[check.actionType];if(field){let value=field.decode(packet.data);let data=field.toObject(value,{defaults:true,arrays:false,objects:false,oneofs:false});if(useObjectToGame){packet.data=data}else{packet.data=JSON.stringify(data)}}else{console.error(`無法找到封包物件 check.actionType:${check.actionType}`)}}break}}else{delete packet.data}if(packet.errorCode===null||packet.errorCode.length===0){delete packet.errorCode}if(_optionalChain([packet,"access",_5=>_5.jackpot,"optionalAccess",_6=>_6.data,"optionalAccess",_7=>_7.length])&&packet.jackpot.data.length>0){switch(packet.jackpot.format){case CustomFormat.JSON:packet.jackpot=utf8Decoder.decode(packet.jackpot.data);break;case CustomFormat.PROTOBUF:if(_optionalChain([game,"optionalAccess",_8=>_8.jackpot,"optionalAccess",_9=>_9.cmdList])&&game.check){let check=game.check.decode(packet.jackpot.data);let field=game.jackpot.cmdList[check.actionType];if(field){let value=field.decode(packet.jackpot.data);let data=field.toObject(value,{defaults:true,arrays:false,objects:false,oneofs:false});if(useObjectToGame){packet.jackpot=data}else{packet.jackpot=JSON.stringify(data)}}else{console.error(`無法找到封包物件 check.actionType:${check.actionType}`)}}break}}else{delete obj.packet.jackpot}if(_optionalChain([packet,"access",_10=>_10.setting,"optionalAccess",_11=>_11.data,"optionalAccess",_12=>_12.length])&&packet.setting.data.length>0){switch(packet.setting.format){case CustomFormat.JSON:packet.setting=utf8Decoder.decode(packet.setting.data);break;case CustomFormat.PROTOBUF:if(_optionalChain([game,"optionalAccess",_13=>_13.setting,"optionalAccess",_14=>_14.cmdList])&&game.check){let check=game.check.decode(packet.setting.data);let field=game.setting.cmdList[check.actionType];if(field){let value=field.decode(packet.setting.data);let data=field.toObject(value,{defaults:true,arrays:false,objects:false,oneofs:false});if(useObjectToGame){packet.setting=data}else{if(data.betForm&&Array.isArray(data.betForm)){let betForm="";for(let i=0;i<data.betForm.length;i+=1){if(i===data.betForm.length-1){betForm+=`${data.betForm[i]}`}else{betForm+=`${data.betForm[i]},`}}data.betForm=betForm}packet.setting=JSON.stringify(data)}}else{console.error(`無法找到封包物件 check.actionType:${check.actionType}`)}}break}}else{delete packet.setting}if(_optionalChain([packet,"access",_15=>_15.info,"optionalAccess",_16=>_16.data,"optionalAccess",_17=>_17.length])&&packet.info.data.length>0){switch(packet.info.format){case CustomFormat.JSON:packet.info=utf8Decoder.decode(packet.info.data);break;case CustomFormat.PROTOBUF:if(_optionalChain([game,"optionalAccess",_18=>_18.info,"optionalAccess",_19=>_19.cmdList])&&game.check){let check=game.check.decode(packet.info.data);let field=game.info.cmdList[check.actionType];if(field){let value=field.decode(packet.info.data);let data=field.toObject(value,{defaults:true,arrays:false,objects:false,oneofs:false});if(useObjectToGame){packet.info=data}else{packet.info=JSON.stringify(data)}}else{console.error(`無法找到封包物件 check.actionType:${check.actionType}`)}}break}}else{delete packet.info}}catch(e){console.log(e)}}console.info(obj);let object=get(obj.funcIndex);if(object){object.resolve(obj)}eventToGame(obj)}catch(e){}}function cmdBroadcast(buf){try{console.log("[處理廣播]");let value=BroadcastResponse$1.decode(buf);let obj=BroadcastResponse$1.toObject(value,{defaults:true,arrays:false,objects:false,oneofs:false});console.log(`[recv]broadcast buf : ${buf.length} data : ${JSON.stringify(obj).length}`);console.info(obj);eventBroadcast(obj)}catch(e){console.error(e)}}if(ActionType){handleList[ActionType.LOGIN]=cmdLogin;handleList[ActionType.INGAME]=cmdInGame;handleList[ActionType.TOGAME]=cmdToGame;handleList[ActionType.BROADCAST]=cmdBroadcast}currentSocket$1.onmessage=event=>{let array=new Uint8Array(event.data);let buf=new Buffer(array);let act=-1;try{let value=CheckAction.decode(buf);let obj=CheckAction.toObject(value,{defaults:true,arrays:false,objects:false,oneofs:false});act=obj.actionType}catch(e){eventError("[recv]無法確認命令種類");console.error(e);return}if(act<0){console.error("actionType 小於 0");return}let handle=handleList[act];if(handle){handle(buf)}}})}function send$1(data){console.log(data)}async function login$1(info){return new Promise((resolve,reject)=>{info.actionType=ActionType.LOGIN;let err=LoginRequest$1.verify(info);console.log("[檢查]登入命令");if(err){console.log(err);reject()}else{let obj={};obj.name="login";obj.reject=reject;obj.resolve=resolve;obj.funcIndex=9;info.funcIndex=add$1(obj);console.info(info);let value=LoginRequest$1.create(info);let buffer=LoginRequest$1.encode(value).finish();currentSocket$1.send(buffer);console.log(`[send ${info.funcIndex}]${obj.name} data : ${JSON.stringify(info).length}  ,send : ${buffer.length}`)}})}async function ingame$1(info){return new Promise((resolve,reject)=>{info.actionType=ActionType.INGAME;let err=InGameRequest$1.verify(info);console.log("[檢查]進入遊戲命令");if(err){console.log(err);reject()}else{let obj={};obj.name="ingame";obj.reject=reject;obj.resolve=resolve;obj.funcIndex=9;info.funcIndex=add$1(obj);console.info(info);let value=InGameRequest$1.create(info);let buffer=InGameRequest$1.encode(value).finish();currentSocket$1.send(buffer);console.log(`[send ${info.funcIndex}]${obj.name} data : ${JSON.stringify(info).length}  ,send : ${buffer.length}`)}})}async function togame$1(info){return new Promise((resolve,reject)=>{info.actionType=ActionType.TOGAME;let game=gameManager[info.gid];let packet=info.packet;if(_optionalChain([packet,"optionalAccess",_20=>_20.data])){packet.format=parseInt(packet.format)||0;switch(packet.format){case CustomFormat.JSON:if(typeof packet.data==="string"){packet.data=utf8Encoder.encode(packet.data)}break;case CustomFormat.PROTOBUF:packet.data.actionType=parseInt(packet.data.actionType)||0;if(game){console.log(game);let field=game.data.cmdList[packet.data.actionType];if(field){let err=field.verify(packet.data);if(err){console.error(err)}else{let value=field.create(packet.data);const buffer=field.encode(value).finish();packet.data=buffer}}else{console.error(`無法找到封包物件 (actionType): ${packet.data.actionType}`)}}break}}console.log("[檢查]遊戲命令");let err=ToGameRequest$1.verify(info);if(err){throw new Error(err)}else{let obj={};obj.name="togame";obj.reject=reject;obj.resolve=resolve;obj.funcIndex=parseInt(info.funcIndex)||parseInt(packet.funcIndex)||0;info.funcIndex=add$1(obj);packet.funcIndex=info.funcIndex;console.info(info);let value=ToGameRequest$1.create(info);let buffer=ToGameRequest$1.encode(value).finish();currentSocket$1.send(buffer);console.log(`[send]${obj.name} data : ${JSON.stringify(info).length}  ,send : ${buffer.length}`)}})}function init$3(){importScripts("/dependence/protobuf/protobuf.min.6.9.0.js");utf8Decoder=new TextDecoder;utf8Encoder=new TextEncoder}function getTypes(root,names){let group=root,subGroup,nameList=names.split(".");nameList.every(name=>{subGroup=group[name];if(subGroup){group=subGroup;return true}else{return false}});return group}async function register$2(config){console.log("[protobuf register]");console.log(config);let root=protobuf.Root.fromJSON(config.schema);console.log(root);if(!config.gid){throw new Error("沒有設定 gid")}useObjectToGame=!!config.useObjectToGame;let game={};game.gid=config.gid;if(config.checkName){game.check=getTypes(root,config.checkName)}gameManager[config.gid]=game;let actionTypes={};let fields=config.fields;if(fields){fields.forEach(field=>{console.log("--------------------------");console.log(`[欄位] ${field.name}`);let parent=getTypes(root,field.rootName);let type=getTypes(parent,field.typeName);if(field.checkName){getTypes(parent,field.checkName)}let obj={};game[field.name]=obj;actionTypes[field.name]=type;obj.type=type;obj.cmdList=[];let cmdList=field.cmdList;if(cmdList){console.log("[命令清單]");for(let i=0;i<cmdList.length;i+=1){let cmd=cmdList[i];let types=getTypes(parent,cmd);obj.cmdList.push(types)}console.log(obj)}})}return Promise.resolve(actionTypes)}var protobuf$1=Object.freeze({__proto__:null,getTypes:getTypes,register:register$2,connect:connect$1,login:login$1,ingame:ingame$1,togame:togame$1,send:send$1,init:init$3});var MESSAGE_TYPE;(function(MESSAGE_TYPE){const INIT="init";MESSAGE_TYPE["INIT"]=INIT;const CONNECT="connect";MESSAGE_TYPE["CONNECT"]=CONNECT;const LOGIN="login";MESSAGE_TYPE["LOGIN"]=LOGIN;const INGAME="ingame";MESSAGE_TYPE["INGAME"]=INGAME;const TOGAME="togame";MESSAGE_TYPE["TOGAME"]=TOGAME;const REGISTER="register";MESSAGE_TYPE["REGISTER"]=REGISTER;const ON_REFRESH="onrefresh";MESSAGE_TYPE["ON_REFRESH"]=ON_REFRESH;const ON_MESSAGE="onmessage";MESSAGE_TYPE["ON_MESSAGE"]=ON_MESSAGE;const ON_ERROR="onerror";MESSAGE_TYPE["ON_ERROR"]=ON_ERROR;const ON_BROADCAST="onbroadcast";MESSAGE_TYPE["ON_BROADCAST"]=ON_BROADCAST;const ON_CLOSE="onclose";MESSAGE_TYPE["ON_CLOSE"]=ON_CLOSE;const ON_TOGAME="ontogame";MESSAGE_TYPE["ON_TOGAME"]=ON_TOGAME})(MESSAGE_TYPE||(MESSAGE_TYPE={}));let client=null;async function onrefresh(offsetTime){self.postMessage({type:MESSAGE_TYPE.ON_REFRESH,offsetTime:offsetTime})}async function onmessage(data){self.postMessage({type:MESSAGE_TYPE.ON_MESSAGE,data:data})}async function onerror(data){self.postMessage({type:MESSAGE_TYPE.ON_ERROR,data:data})}async function onbroadcast(data){self.postMessage({type:MESSAGE_TYPE.ON_BROADCAST,data:data})}async function onclose(){self.postMessage({type:MESSAGE_TYPE.ON_CLOSE})}async function ontogame(data){self.postMessage({type:MESSAGE_TYPE.ON_TOGAME,data:data})}function init$4(config){let state=true;let protocol=config.protocol;if(protocol==="protobuf"){client=protobuf$1}else if(protocol==="avro"){client=avro}else{state=false}init$1();client.init(config);let obj={update(offsetTime){onrefresh(offsetTime)}};add(obj);return state}self.addEventListener("message",(function(e){if(!Array.isArray(e.data)){console.log("self.addEventListener(message)");console.log(e.data)}}));register(message=>{switch(message.type){case MESSAGE_TYPE.INIT:let config=message.config;if(init$4(config)){return"!!!!"}return new Error("undefined protocol name "+config.protocol);case MESSAGE_TYPE.REGISTER:return client.register(message.config);case MESSAGE_TYPE.CONNECT:return client.connect(message.config,onmessage,onerror,onbroadcast,onclose,ontogame);case MESSAGE_TYPE.LOGIN:return client.login(message.info);case MESSAGE_TYPE.INGAME:return client.ingame(message.info);case MESSAGE_TYPE.TOGAME:return client.togame(message.info)}});self.onoffline=function(){onerror("Your worker is now offline")};let com={updateManager:updateManager,protobuf:protobuf$1,avro:avro};exports.com=com;return exports}({});
